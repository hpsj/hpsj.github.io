<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>文件管理 | Hp's blog</title><meta name="description" content="文件管理"><meta name="author" content="Hp's blog"><meta name="copyright" content="Hp's blog"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="文件管理"><meta name="twitter:description" content="文件管理"><meta name="twitter:image" content="http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg"><meta property="og:type" content="article"><meta property="og:title" content="文件管理"><meta property="og:url" content="https://hpsj.github.io/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/"><meta property="og:site_name" content="Hp's blog"><meta property="og:description" content="文件管理"><meta property="og:image" content="http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://hpsj.github.io/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/"><link rel="prev" title="问题管理" href="https://hpsj.github.io/2020/08/02/12%20%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86/"><link rel="next" title="WiKi" href="https://hpsj.github.io/2020/08/02/10%20WiKi/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">35</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-文件管理"><span class="toc-number">1.</span> <span class="toc-text">11 文件管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-功能介绍"><span class="toc-number">1.1.</span> <span class="toc-text">11.1 功能介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-数据表设计"><span class="toc-number">1.2.</span> <span class="toc-text">11.2 数据表设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-知识点（与项目结合）"><span class="toc-number">1.3.</span> <span class="toc-text">11.3 知识点（与项目结合）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-URL传参-amp-不传参"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. URL传参 &amp; 不传参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-获取导航条"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 获取导航条</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-cos上传文件：js-直接上传【不推荐使用】（该项目没使用该方法）"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. cos上传文件：js 直接上传【不推荐使用】（该项目没使用该方法）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-cos上传文件：临时秘钥【推荐】（该项目使用的方法）"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.cos上传文件：临时秘钥【推荐】（该项目使用的方法）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-创建文件夹-amp-编辑文件夹"><span class="toc-number">1.4.</span> <span class="toc-text">11.4 创建文件夹 &amp; 编辑文件夹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-1file-html模板"><span class="toc-number">1.4.1.</span> <span class="toc-text">11.4.1file.html模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-2-给新建模态框的确定绑定事件"><span class="toc-number">1.4.2.</span> <span class="toc-text">11.4.2 给新建模态框的确定绑定事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-3-视图函数代码"><span class="toc-number">1.4.3.</span> <span class="toc-text">11.4.3 视图函数代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-5-新建form表单"><span class="toc-number">1.4.4.</span> <span class="toc-text">11.4.5 新建form表单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-文件列表-amp-进入文件夹"><span class="toc-number">1.5.</span> <span class="toc-text">11.5 文件列表 &amp; 进入文件夹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#"><span class="toc-number">1.6.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-6-删除文件夹（级联删除-amp-删除cos文件）"><span class="toc-number">1.7.</span> <span class="toc-text">11.6 删除文件夹（级联删除 &amp; 删除cos文件）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-6-1-构造删除文件夹的url地址"><span class="toc-number">1.7.1.</span> <span class="toc-text">11.6.1 构造删除文件夹的url地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-6-2-构造ajax请求，获取要删除文件的id"><span class="toc-number">1.7.2.</span> <span class="toc-text">11.6.2 构造ajax请求，获取要删除文件的id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-6-3-删除文件的视图函数"><span class="toc-number">1.7.3.</span> <span class="toc-text">11.6.3 删除文件的视图函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-6-4-删除cos"><span class="toc-number">1.7.4.</span> <span class="toc-text">11.6.4 删除cos</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-7-上传文件"><span class="toc-number">1.8.</span> <span class="toc-text">11.7 上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-7-1-构造上传文件的url地址"><span class="toc-number">1.8.1.</span> <span class="toc-text">11.7.1 构造上传文件的url地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-7-2-获取临时秘钥-amp-上传文件进度条构建"><span class="toc-number">1.8.2.</span> <span class="toc-text">11.7.2 获取临时秘钥 &amp; 上传文件进度条构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-7-3-cos上传文件-amp-cos临时凭证"><span class="toc-number">1.8.3.</span> <span class="toc-text">11.7.3 cos上传文件 &amp; cos临时凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-7-4-form表单对临时凭证进行校验"><span class="toc-number">1.8.4.</span> <span class="toc-text">11.7.4 form表单对临时凭证进行校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-7-5-上传文件的视图函数"><span class="toc-number">1.8.5.</span> <span class="toc-text">11.7.5 上传文件的视图函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-8-下载文件"><span class="toc-number">1.9.</span> <span class="toc-text">11.8 下载文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#知识点"><span class="toc-number">1.9.1.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-8-1-构造下载文件的url地址"><span class="toc-number">1.9.2.</span> <span class="toc-text">11.8.1 构造下载文件的url地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-8-2-下载文件的视图函数"><span class="toc-number">1.9.3.</span> <span class="toc-text">11.8.2 下载文件的视图函数</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Hp's blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">文件管理</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-08-02 15:54:45"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-08-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-08-02 16:22:11"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-08-02</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SaaS%E5%B9%B3%E5%8F%B0/">SaaS平台</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="11-文件管理"><a href="#11-文件管理" class="headerlink" title="11 文件管理"></a>11 文件管理</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86.jpg"  alt="文件管理"></p>
<p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9.jpg"  alt="新建文件夹"></p>
<p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA.jpg"  alt="上传图片进度显示"></p>
<h3 id="11-1-功能介绍"><a href="#11-1-功能介绍" class="headerlink" title="11.1 功能介绍"></a>11.1 功能介绍</h3><p>创建删除文件夹，及上传下载文件。</p>
<p><strong>相关知识点：</strong></p>
<ul>
<li>模态框 &amp; ajax请求 &amp; 后台modelForm校验</li>
<li>目录切换：展示当前文件下的文件夹 &amp; 文件</li>
<li>删除文件夹：删除嵌套的子文件夹 &amp; 子文件</li>
<li>js上传文件到cos （wiki使用的是python上传文件）</li>
<li>进度条显示</li>
<li>删除文件：数据库中删除 &amp; cos中也要删除</li>
<li>下载文件</li>
</ul>
<h3 id="11-2-数据表设计"><a href="#11-2-数据表设计" class="headerlink" title="11.2 数据表设计"></a>11.2 数据表设计</h3><table>
<thead>
<tr>
<th>ID</th>
<th>项目ID</th>
<th>文件<br />文件夹</th>
<th>类型</th>
<th>大小</th>
<th>父目录</th>
<th>更新者</th>
<th>更新时间</th>
<th>key</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>python</td>
<td>2</td>
<td>null</td>
<td>null</td>
<td></td>
<td></td>
<td>null</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>mysql</td>
<td>2</td>
<td>null</td>
<td>null</td>
<td></td>
<td></td>
<td>null</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>1.jpg</td>
<td>1</td>
<td>1000</td>
<td>null</td>
<td></td>
<td></td>
<td>xxx.jpg</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>2.png</td>
<td>1</td>
<td>1000</td>
<td>2</td>
<td></td>
<td></td>
<td>ccsca.png</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>Django</td>
<td>2</td>
<td>null</td>
<td>1</td>
<td></td>
<td></td>
<td>null</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileRespository</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""文件库"""</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>,to=<span class="string">'Project'</span>)</span><br><span class="line">    file_type_choices = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">'文件'</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">'文件夹'</span>),</span><br><span class="line">    )</span><br><span class="line">    file_type = models.SmallIntegerField(verbose_name=<span class="string">'类型'</span>,choices=file_type_choices)</span><br><span class="line">    name = models.CharField(verbose_name=<span class="string">'文件夹名称'</span>, max_length=<span class="number">32</span>, help_text=<span class="string">"文件/文件夹名"</span>)</span><br><span class="line">    key = models.CharField(verbose_name=<span class="string">'文件存储在cos中的key'</span>, max_length=<span class="number">128</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    file_size = models.IntegerField(verbose_name=<span class="string">'文件大小'</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    file_path = models.CharField(verbose_name=<span class="string">'文件路径'</span>,max_length=<span class="number">255</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    parent = models.ForeignKey(verbose_name=<span class="string">'父级目录'</span>,to=<span class="string">'self'</span>,related_name=<span class="string">'child'</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    update_user = models.ForeignKey(verbose_name=<span class="string">'更新者'</span>,to=<span class="string">'UserInfo'</span>)</span><br><span class="line">    update_datetime = models.DateTimeField(verbose_name=<span class="string">'更新时间'</span>,auto_now=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="11-3-知识点（与项目结合）"><a href="#11-3-知识点（与项目结合）" class="headerlink" title="11.3 知识点（与项目结合）"></a>11.3 知识点（与项目结合）</h3><h4 id="1-URL传参-amp-不传参"><a href="#1-URL传参-amp-不传参" class="headerlink" title="1. URL传参 &amp; 不传参"></a>1. URL传参 &amp; 不传参</h4><p>构造文件管理的 url 地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    url(<span class="string">r'^file/$'</span>, file.file, name=<span class="string">'file'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure>

<p>传参 &amp; 不传参</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不传参  得到的就是 /file/</span></span><br><span class="line"><span class="comment"># 传参 	/file/?folder_id=50</span></span><br><span class="line">传参可以通过get请求获取url后面的参数</span><br></pre></td></tr></table></figure>

<p>创建<code>file.py</code>文件用于存放文件函数的相关代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder_id'</span>)</span><br></pre></td></tr></table></figure>



<h4 id="2-获取导航条"><a href="#2-获取导航条" class="headerlink" title="2. 获取导航条"></a>2. 获取导航条</h4><p>文件路径的导航条</p>
<p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E5%AF%BC%E8%88%AA%E6%9D%A1.jpg"  alt="导航条"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder_id'</span>)</span><br><span class="line">    </span><br><span class="line">    url_list = []	<span class="comment"># 导航条列表</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> folder_id:	<span class="comment"># 判断是否传参，没有则不做任何操作</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        file_obj = models.FileRespository.object.filter(id=folder_id,file_type=<span class="number">2</span>).first()</span><br><span class="line">        <span class="comment"># 找到id为folder_id，并且格式是文件夹的对象</span></span><br><span class="line">        </span><br><span class="line">      	row_obj = file_obj</span><br><span class="line">        <span class="keyword">while</span> row_obj:	<span class="comment"># 判断给对象存不存在</span></span><br><span class="line">            <span class="comment"># 如果对象存在，把带对象的id和该对象文件夹名添加到导航条列表的第一位</span></span><br><span class="line">            url_list.insert(<span class="number">0</span>,&#123;<span class="string">'id'</span>:row_obj.id,<span class="string">'name'</span>:row_object.name&#125;)</span><br><span class="line">            <span class="comment"># 把该对象的父目录赋值到row_obj继续循环判断</span></span><br><span class="line">            row_obj = row_obj.parent</span><br></pre></td></tr></table></figure>



<h4 id="3-cos上传文件：js-直接上传【不推荐使用】（该项目没使用该方法）"><a href="#3-cos上传文件：js-直接上传【不推荐使用】（该项目没使用该方法）" class="headerlink" title="3. cos上传文件：js 直接上传【不推荐使用】（该项目没使用该方法）"></a>3. cos上传文件：js 直接上传【不推荐使用】（该项目没使用该方法）</h4><ul>
<li><p>下载 js （前端SDK）</p>
<p>地址：<a href="https://github.com/tencentyun/cos-js-sdk-v5/tree/master/dist" target="_blank" rel="noopener">https://github.com/tencentyun/cos-js-sdk-v5/tree/master/dist</a></p>
<p>引用 ： <code>&lt;script src=&quot;./cos-js-sdk-v5.min.js&quot;&gt;&lt;/script&gt;</code></p>
</li>
<li><p>前端代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>示例：直接通过秘钥进行上传文件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"upload_file"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span> <span class="attr">multiple</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/cos-js-sdk-v5.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cos;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">            initCOS();</span><br><span class="line">            bindChangeFileInput();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initCOS</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            cos = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                SecretId:<span class="string">'自己的cos的id'</span>，</span></span><br><span class="line"><span class="actionscript">                SecretKey:<span class="string">'自己的cos的key'</span>，</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">bindChangeFileInput</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要上传的所有文件对象列表</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// $(this)[0] = document.getElementById('uploadFile')</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> files = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;</span></span><br><span class="line"><span class="javascript">                $.each(files,<span class="function"><span class="keyword">function</span>(<span class="params">index,fileObject</span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">//上传文件</span></span></span><br><span class="line">                    cos.putObject(&#123;</span><br><span class="line"><span class="actionscript">                        Bucket:<span class="string">'xxxxxxx'</span>,	<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                        Region:<span class="string">'ap-nanjing'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                        Key:fileName,</span><br><span class="line"><span class="actionscript">                        Body:fileObject,	<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                        onProgress:<span class="function"><span class="keyword">function</span><span class="params">(progressData)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//进度条</span></span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.log(<span class="string">"文件上传精度--&gt;"</span>,fileName,<span class="built_in">JSON</span>.stringify(progressData));</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err,data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">         				<span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>跨域问题（游览器导致）</p>
<p>在cos服务端设置特殊的响应头：<code>allow.origin：*</code></p>
<p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/cos%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE.jpg"  alt="cos跨域访问"></p>
</li>
</ul>
<h4 id="4-cos上传文件：临时秘钥【推荐】（该项目使用的方法）"><a href="#4-cos上传文件：临时秘钥【推荐】（该项目使用的方法）" class="headerlink" title="4.cos上传文件：临时秘钥【推荐】（该项目使用的方法）"></a>4.cos上传文件：临时秘钥【推荐】（该项目使用的方法）</h4><ul>
<li><p>构造临时秘钥的 url 地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    url(<span class="string">r'^cos/credential/$'</span>, file.cos_credential, name=<span class="string">'cos_credential'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure>
</li>
<li><p>临时秘钥的视图函数<strong>（以下为知识点，不在项目范围）</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cos_credential</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 生成一个临时凭证，并返回前端</span></span><br><span class="line">    <span class="comment"># 1. 安装一个临时凭证python模块</span></span><br><span class="line">    <span class="comment"># pip install -U qcloud-python-sts</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2.写代码</span></span><br><span class="line">    <span class="keyword">from</span> sts.sts <span class="keyword">import</span> Sts</span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="comment"># 临时秘钥有效时长，单位是秒（30分钟=1800秒）</span></span><br><span class="line">        <span class="string">'duration_seconds'</span>:<span class="number">1800</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 id</span></span><br><span class="line">        <span class="string">'secret_id'</span>: <span class="string">"自己的cos的id"</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 key</span></span><br><span class="line">        <span class="string">'secret_key'</span>: <span class="string">"自己的cos的key"</span>,</span><br><span class="line">        <span class="comment"># 换成你的 bucket</span></span><br><span class="line">        <span class="string">'bucket'</span>:<span class="string">'xxxxx'</span>,</span><br><span class="line">        <span class="comment"># 换成 bucket 所在的地区</span></span><br><span class="line">        <span class="string">'region'</span>: <span class="string">'ap-nanjing'</span>,</span><br><span class="line">        <span class="comment"># 允许的路径前缀，可以根据自己的网站用户登录状态判断允许上传的具体路径</span></span><br><span class="line">        <span class="comment"># 例子：a.jpg 或者 a/* 或者 * (使用通配符*存在重大的安全风险)</span></span><br><span class="line">        <span class="string">'allow_prefix'</span>:<span class="string">'*'</span>,</span><br><span class="line">        <span class="comment"># 秘钥的权限列表。简单的上传和分片需一下的权限，其他权限查看https://cloud.tencent.com/document/product/436/31923</span></span><br><span class="line">        <span class="string">'allow_actions'</span>:[</span><br><span class="line">            <span class="comment"># 简单上传操作 </span></span><br><span class="line">            <span class="string">"name/cos:PutObject"</span>,</span><br><span class="line">            <span class="comment"># 表单上传对象 </span></span><br><span class="line">            <span class="comment"># "name/cos:PostObject",</span></span><br><span class="line">            <span class="comment"># 分块上传：初始化分块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:InitiateMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 进行中的分块上传</span></span><br><span class="line">            <span class="comment"># "name/cos:ListMultipartUploads",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 已上传分块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:ListParts",</span></span><br><span class="line">            <span class="comment"># 分块上传：上传分块块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:UploadPart",</span></span><br><span class="line">            <span class="comment"># 分块上传：完成所有分块上传操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:CompleteMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 取消分块上传操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:AbortMultipartUpload"</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    sts = Sts(config)</span><br><span class="line">    result_dict = sts.get_credential()</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(result_dict)</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端代码<strong>（以下为知识点，不在项目范围）</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>示例：直接通过秘钥进行上传文件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"upload_file"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span> <span class="attr">multiple</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/cos-js-sdk-v5.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cos;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">            initCOS();</span><br><span class="line">            bindChangeFileInput();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initCOS</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            cos = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                getAuthorization:<span class="function"><span class="keyword">function</span><span class="params">(options,callback)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 想django后台发送请求，获取临时凭证</span></span></span><br><span class="line"><span class="javascript">                    $.<span class="keyword">get</span>('/cos/credential/',&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 可从 options 取需要的参数</span></span></span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> credentials = data &amp;&amp; data.credentials;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span>(!data || !credentials) <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'credentials invalid'</span>);</span></span><br><span class="line">                        callback(&#123;</span><br><span class="line">                            TmpSecretId:credentials.tmpSecretId,</span><br><span class="line">                            TmpSecretKey:credentials.tmpSecretKey,</span><br><span class="line">                            XCosSecurityToken:credentials.sessionToken,</span><br><span class="line">                            StartTime:data.startTime,</span><br><span class="line">                            ExpiredTime:data.expiredTime,</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">bindChangeFileInput</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要上传的所有文件对象列表</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// $(this)[0] = document.getElementById('uploadFile')</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> files = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;</span></span><br><span class="line"><span class="javascript">                $.each(files,<span class="function"><span class="keyword">function</span>(<span class="params">index,fileObject</span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">//上传文件</span></span></span><br><span class="line">                    cos.putObject(&#123;</span><br><span class="line"><span class="actionscript">                        Bucket:<span class="string">'xxxxxxx'</span>,	<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                        Region:<span class="string">'ap-nanjing'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                        Key:fileName,</span><br><span class="line"><span class="actionscript">                        Body:fileObject,	<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                        onProgress:<span class="function"><span class="keyword">function</span><span class="params">(progressData)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//进度条</span></span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.log(<span class="string">"文件上传精度--&gt;"</span>,fileName,<span class="built_in">JSON</span>.stringify(progressData));</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err,data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">         				<span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>跨域问题，与上面方法相同</p>
</li>
</ul>
<h3 id="11-4-创建文件夹-amp-编辑文件夹"><a href="#11-4-创建文件夹-amp-编辑文件夹" class="headerlink" title="11.4 创建文件夹 &amp; 编辑文件夹"></a>11.4 创建文件夹 &amp; 编辑文件夹</h3><h4 id="11-4-1file-html模板"><a href="#11-4-1file-html模板" class="headerlink" title="11.4.1file.html模板"></a>11.4.1<code>file.html</code>模板</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            flex-direction: row;</span><br><span class="line">        &#123;# 以行为单位 #&#125; justify-content: space-between;</span><br><span class="line">        &#123;# 该标签下的div左右排列 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-tag">span</span> &#123;</span></span><br><span class="line">            padding: 0 5px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-class">.function</span> <span class="selector-class">.upload</span> &#123;</span></span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#123;# 超出大小隐藏 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-class">.function</span> <span class="selector-tag">input</span> &#123;</span></span><br><span class="line">            opacity: 0;</span><br><span class="line">        &#123;# 透明度为0，隐藏 #&#125; position: absolute;</span><br><span class="line">        &#123;# 绝对定位 #&#125; top: 0;</span><br><span class="line">            bottom: 0;</span><br><span class="line">            width: 76px;</span><br><span class="line">            left: -2px;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.upload-progress</span> &#123;</span></span><br><span class="line">            position: fixed;</span><br><span class="line">            right: 2px;</span><br><span class="line">            bottom: 2px;</span><br><span class="line">            width: 400px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.upload-progress</span> <span class="selector-class">.progress-error</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-home"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 文件库</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% for record in breadcrumb_list %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;?folder=&#123;&#123; record.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-caret-right"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; record.name &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"function"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-xs upload"</span> <span class="attr">style</span>=<span class="string">"position: relative"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-upload"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 上传文件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">multiple</span> <span class="attr">name</span>=<span class="string">"uploadFile"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-success btn-xs"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#addModal"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-whatever</span>=<span class="string">"新建文件夹"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建文件夹</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>文件大小<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>更新者<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>更新时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">"rowList"</span>&gt;</span></span><br><span class="line">                &#123;% for item in file_object_list %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 2 %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;?folder=&#123;&#123; item.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-folder"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; item.name &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-file"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                &#123;&#123; item.name &#125;&#125;</span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 1 %&#125;</span><br><span class="line">                                &#123;&#123; item.file_size &#125;&#125;</span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                -</span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; item.update_user.username &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; item.update_datetime &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 2 %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-target</span>=<span class="string">"#addModal"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-name</span>=<span class="string">"&#123;&#123; item.name &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-fileid</span>=<span class="string">"&#123;&#123; item.id &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-whatever</span>=<span class="string">"编辑文件夹"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-pencil-square-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 编辑</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file_download' project_id=request.tracer.project.id file_id=item.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-download"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 下载</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-xs"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-target</span>=<span class="string">"#delModal"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-fileid</span>=<span class="string">"&#123;&#123; item.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-trash-o fa-lg"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Modal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade"</span> <span class="attr">id</span>=<span class="string">"addModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span> <span class="attr">aria-labelledby</span>=<span class="string">"myModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span> <span class="attr">id</span>=<span class="string">"myModalLabel"</span>&gt;</span>Modal title<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"hide"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"fileid"</span> <span class="attr">id</span>=<span class="string">"fileid"</span>&gt;</span></span><br><span class="line">                        &#123;% for field in form %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        &#123;% endfor %&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btnFormSubmit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade bs-example-modal-sm"</span> <span class="attr">id</span>=<span class="string">"delModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">aria-labelledby</span>=<span class="string">"mySmallModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog modal-sm"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-danger alert-dismissible fade in"</span> <span class="attr">role</span>=<span class="string">"alert"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>×<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span>&gt;</span>是否确定要删除!<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"padding-top: 20px;padding-bottom: 20px"</span>&gt;</span></span><br><span class="line">                    文件夹中包含的所有文件都会被删除！</span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"text-align: right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-sm"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btnDelete"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-sm"</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"uploadProgress"</span> <span class="attr">class</span>=<span class="string">"upload-progress hide "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-primary"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-upload"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 上传进度</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">"progressList"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span>=<span class="string">"progressTemplate"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress-bar progress-bar-success progress-bar-striped"</span> <span class="attr">role</span>=<span class="string">"progressbar"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuenow</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuemin</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuemax</span>=<span class="string">"100"</span> <span class="attr">style</span>=<span class="string">"width: 0"</span>&gt;</span></span><br><span class="line">                            0%</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress-error"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span>=<span class="string">"rowTpl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-file"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"file_size"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"datetime"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs download"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-download"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 下载</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-xs delete"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-target</span>=<span class="string">"#delModal"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-trash-o fa-lg"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">   	<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 新建与编辑</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>



<h4 id="11-4-2-给新建模态框的确定绑定事件"><a href="#11-4-2-给新建模态框的确定绑定事件" class="headerlink" title="11.4.2 给新建模态框的确定绑定事件"></a>11.4.2 给新建模态框的确定绑定事件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        initAddModal();</span><br><span class="line">        bindModelSubmit();</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initAddModal</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#addModal'</span>).on(<span class="string">'show.bs.modal'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> button = $(event.relatedTarget); <span class="comment">// Button that triggered the modal</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> recipient = button.data(<span class="string">'whatever'</span>); <span class="comment">// Extract info from data-* attributes</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> name = button.data(<span class="string">'name'</span>); <span class="comment">// 获取编辑文件夹的文件名，data-name的值</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> fileid = button.data(<span class="string">'fileid'</span>); <span class="comment">// 获取编辑的文件夹名的id值，data-fileid的值</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> modal = $(<span class="keyword">this</span>);</span></span><br><span class="line"><span class="actionscript">            modal.find(<span class="string">'.modal-title'</span>).text(recipient);</span></span><br><span class="line"></span><br><span class="line">            if (fileid) &#123;</span><br><span class="line"><span class="actionscript">                <span class="comment">// 编辑</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'#id_name'</span>).val(name); <span class="comment">// 打开模态框后，有该文件夹名的值</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'#fileid'</span>).val(fileid);</span></span><br><span class="line"><span class="actionscript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 新建</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'.error-msg'</span>).empty();   <span class="comment">// 清空错误信息</span></span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#form'</span>)[<span class="number">0</span>].reset(); <span class="comment">// 重置form表单，用于每次点击弹出模态框里面的值都为空</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="actionscript">    <span class="comment">// 绑定模态框的确定按钮事件，用于编辑和新建</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindModelSubmit</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#btnFormSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                    url: location.href, <span class="comment">// 向自己发送</span></span></span><br><span class="line"><span class="actionscript">                    type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="javascript">                    data: $(<span class="string">'#form'</span>).serialize(),</span></span><br><span class="line"><span class="actionscript">                    dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">                    success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line">                            location.href = location.href</span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                            $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#id_'</span> + key).next().text(value[<span class="number">0</span>])</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h4 id="11-4-3-视图函数代码"><a href="#11-4-3-视图函数代码" class="headerlink" title="11.4.3 视图函数代码"></a>11.4.3 视图函数代码</h4><p> 由于上面的知识点已经为文件管理创建了url路径，下面直接书写file的视图函数代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> model_to_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> delete_file, delete_file_list</span><br><span class="line"><span class="keyword">from</span> web.forms.file <span class="keyword">import</span> FolderModelForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 文件列表 &amp; 添加文件夹"""</span></span><br><span class="line">    parent_obj = <span class="literal">None</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder'</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> folder_id.isdecimal():</span><br><span class="line">        parent_obj = models.FileRespository.objects.filter(file_type=<span class="number">2</span>, project=request.tracer.project,id=int(folder_id)).first()</span><br><span class="line"></span><br><span class="line">   	<span class="comment">##########  文件列表 &amp; 进入文件夹 ###########</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># POST 添加文件夹 &amp; 文件夹的修改</span></span><br><span class="line">    fileid = request.POST.get(<span class="string">'fileid'</span>, <span class="string">''</span>)</span><br><span class="line">    edit_object = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> fileid.isdecimal():</span><br><span class="line">        edit_object = models.FileRespository.objects.filter(id=int(fileid), project=request.tracer.project,file_type=<span class="number">2</span>).first()</span><br><span class="line">    <span class="keyword">if</span> edit_object:</span><br><span class="line">        form = FolderModelForm(request, folder_id, data=request.POST, instance=edit_object)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = FolderModelForm(request, folder_id, data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        form.instance.project = request.tracer.project</span><br><span class="line">        form.instance.file_type = <span class="number">2</span></span><br><span class="line">        form.instance.update_user = request.tracer.user</span><br><span class="line">        form.instance.parent = parent_obj</span><br><span class="line"></span><br><span class="line">        form.save()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="11-4-5-新建form表单"><a href="#11-4-5-新建form表单" class="headerlink" title="11.4.5 新建form表单"></a>11.4.5 新建form表单</h4><p>在forms文件夹下创建<code>file.py</code>文件用于存放文件管理的form表单。</p>
<p>form表单判断同一级下的文件夹是否同名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> web.forms.bootstrap <span class="keyword">import</span> BootSrtapForm</span><br><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> check_file</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FolderModelForm</span><span class="params">(BootSrtapForm, forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.FileRespository</span><br><span class="line">        fields = [<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, parent_obj, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.parent_obj = parent_obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        name = self.cleaned_data[<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 数据库判断 当前目录下 此文件夹是否已存在</span></span><br><span class="line">        queryset = models.FileRespository.objects.filter(file_type=<span class="number">2</span>, name=name, project=self.request.tracer.project)</span><br><span class="line">        <span class="keyword">if</span> self.parent_obj:</span><br><span class="line">            exists = queryset.filter(parent=self.parent_obj).exists()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exists = queryset.filter(parent__isnull=<span class="literal">True</span>).exists()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'文件夹已存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br></pre></td></tr></table></figure>





<h3 id="11-5-文件列表-amp-进入文件夹"><a href="#11-5-文件列表-amp-进入文件夹" class="headerlink" title="11.5 文件列表 &amp; 进入文件夹"></a>11.5 文件列表 &amp; 进入文件夹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 文件列表 &amp; 添加文件夹"""</span></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">######## 文件列表 &amp; 进入文件夹  #####</span></span><br><span class="line">    <span class="comment"># GET 查看页面</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">            <span class="comment"># 导航条</span></span><br><span class="line">            breadcrumb_list = []</span><br><span class="line">            parent = parent_obj</span><br><span class="line">            <span class="keyword">while</span> parent:</span><br><span class="line">                <span class="comment"># breadcrumb_list.insert(0,&#123;'id':parent.id,'name':parent.name&#125;)</span></span><br><span class="line">                breadcrumb_list.insert(<span class="number">0</span>, model_to_dict(parent, [<span class="string">'id'</span>, <span class="string">'name'</span>]))</span><br><span class="line">                parent = parent.parent</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 当前目录下的所有文件 &amp; 文件夹获取即可</span></span><br><span class="line">            queryset = models.FileRespository.objects.filter(project=request.tracer.project).order_by(<span class="string">'-file_type'</span>)</span><br><span class="line">            <span class="keyword">if</span> folder_id:</span><br><span class="line">                <span class="comment"># 进入到某个目录</span></span><br><span class="line">                file_object_list = queryset.filter(parent=parent_obj)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 根目录</span></span><br><span class="line">                file_object_list = queryset.filter(parent__isnull=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            form = FolderModelForm(request, folder_id)</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'manage/file.html'</span>,&#123;<span class="string">'form'</span>: form, <span class="string">'file_object_list'</span>: file_object_list, <span class="string">'breadcrumb_list'</span>: breadcrumb_list,<span class="string">'folder_obj'</span>: parent_obj&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># POST 添加文件夹 &amp; 文件夹的修改</span></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="11-6-删除文件夹（级联删除-amp-删除cos文件）"><a href="#11-6-删除文件夹（级联删除-amp-删除cos文件）" class="headerlink" title="11.6 删除文件夹（级联删除 &amp; 删除cos文件）"></a>11.6 删除文件夹（级联删除 &amp; 删除cos文件）</h3><h4 id="11-6-1-构造删除文件夹的url地址"><a href="#11-6-1-构造删除文件夹的url地址" class="headerlink" title="11.6.1 构造删除文件夹的url地址"></a>11.6.1 构造删除文件夹的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    url(<span class="string">r'^file/delete$'</span>, file.file_delete, name=<span class="string">'file_delete'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure>

<h4 id="11-6-2-构造ajax请求，获取要删除文件的id"><a href="#11-6-2-构造ajax请求，获取要删除文件的id" class="headerlink" title="11.6.2 构造ajax请求，获取要删除文件的id"></a>11.6.2 构造ajax请求，获取要删除文件的id</h4><p>给删除按钮绑定事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> FILE_DELETE_URL = <span class="string">"&#123;% url 'file_delete' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            bindDeleteSubmit();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">	<span class="function"><span class="keyword">function</span> <span class="title">bindDeleteSubmit</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#btnDelete'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要删除的ID</span></span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line">                    url: FILE_DELETE_URL,</span><br><span class="line"><span class="actionscript">                    type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="javascript">                    data: &#123;<span class="attr">fileid</span>: $(<span class="keyword">this</span>).attr(<span class="string">'fileid'</span>)&#125;,</span></span><br><span class="line"><span class="actionscript">                    success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line">                            location.href = location.href;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="11-6-3-删除文件的视图函数"><a href="#11-6-3-删除文件的视图函数" class="headerlink" title="11.6.3 删除文件的视图函数"></a>11.6.3 删除文件的视图函数</h4><p>前端获取要删除的文件的id，发送到后台进行处理。</p>
<p>删除包括数据库删除以及cos删除，所有引用cos删除的相关函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> delete_file, delete_file_list </span><br><span class="line"></span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/manage/7/file/delete/?fileid=1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_delete</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 删除文件"""</span></span><br><span class="line">    fileid = request.GET.get(<span class="string">'fileid'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除数据库中的  文件 &amp; 文件夹（级联删除）</span></span><br><span class="line">    delete_obj = models.FileRespository.objects.filter(id=fileid, project=request.tracer.project.id).first()</span><br><span class="line">    <span class="keyword">if</span> delete_obj.file_type == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 删除文件(数据库文件删除、cos删除、项目已使用的空间容量还回去)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 删除文件时，将容量还给当前项目的已使用空间</span></span><br><span class="line">        request.tracer.project.use_space -= delete_obj.file_size</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cos中删除文件</span></span><br><span class="line">        delete_file(request.tracer.project.bucket, request.tracer.project.region, delete_obj.key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 数据库中删除当前文件</span></span><br><span class="line">        delete_obj.delete()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件夹（找到文件夹下的所有文件-&gt;数据库文件删除、cos删除、项目已使用的空间容量还回去)</span></span><br><span class="line">    <span class="comment"># 找到文件夹下面的 文件 &amp; 文件夹</span></span><br><span class="line">    <span class="comment"># models.FileRespository.objects.filter(parent=delete_obj.parent)</span></span><br><span class="line"></span><br><span class="line">    total_size = <span class="number">0</span></span><br><span class="line">    folder_list = [delete_obj, ]</span><br><span class="line">    key_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> folder <span class="keyword">in</span> folder_list:</span><br><span class="line">        child_list = models.FileRespository.objects.filter(project=request.tracer.project, parent=folder).order_by(</span><br><span class="line">            <span class="string">'-file_type'</span>)</span><br><span class="line">        <span class="keyword">for</span> child <span class="keyword">in</span> child_list:</span><br><span class="line">            <span class="keyword">if</span> child.file_type == <span class="number">2</span>:</span><br><span class="line">                folder_list.append(child)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 文件大小汇总</span></span><br><span class="line">                total_size += child.file_size</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 删除文件</span></span><br><span class="line">                <span class="comment"># cos中删除文件</span></span><br><span class="line">                key_list.append(&#123;<span class="string">"Key"</span>: child.key&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cos批量删除文件</span></span><br><span class="line">    <span class="keyword">if</span> key_list:</span><br><span class="line">        delete_file_list(request.tracer.project.bucket, request.tracer.project.region, key_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> total_size:</span><br><span class="line">        <span class="comment"># 删除文件时，将容量还给当前项目的已使用空间</span></span><br><span class="line">        request.tracer.project.use_space -= total_size</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库中删除当前文件</span></span><br><span class="line">    delete_obj.delete()</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="11-6-4-删除cos"><a href="#11-6-4-删除cos" class="headerlink" title="11.6.4 删除cos"></a>11.6.4 删除cos</h4><p>在之前的操作中，utils文件夹下的tencent文件夹下的cos.py文件写入cos的相关操作，所以把cos删除操作写入到该文件夹。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span><span class="params">(bucket, region, key)</span>:</span></span><br><span class="line">    <span class="string">""" 单独删除文件 """</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件</span></span><br><span class="line">    client.delete_object(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要删除桶的名称</span></span><br><span class="line">        Key=key,  <span class="comment"># 桶要删除的文件名</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file_list</span><span class="params">(bucket, region, key_list)</span>:</span></span><br><span class="line">    <span class="string">""" 批量删除文件 """</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line">    objects = &#123;</span><br><span class="line">        <span class="string">"Quiet"</span>: <span class="string">"true"</span>,</span><br><span class="line">        <span class="string">"Object"</span>: key_list</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件</span></span><br><span class="line">    client.delete_objects(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要删除桶的名称</span></span><br><span class="line">        Delete=objects,  <span class="comment"># 桶要删除的文件名</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<h3 id="11-7-上传文件"><a href="#11-7-上传文件" class="headerlink" title="11.7 上传文件"></a>11.7 上传文件</h3><h4 id="11-7-1-构造上传文件的url地址"><a href="#11-7-1-构造上传文件的url地址" class="headerlink" title="11.7.1 构造上传文件的url地址"></a>11.7.1 构造上传文件的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    url(<span class="string">r'^cos/credential/$'</span>, file.cos_credential, name=<span class="string">'cos_credential'</span>),</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    url(<span class="string">r'^file/post/$'</span>, file.file_post, name=<span class="string">'file_post'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure>

<h4 id="11-7-2-获取临时秘钥-amp-上传文件进度条构建"><a href="#11-7-2-获取临时秘钥-amp-上传文件进度条构建" class="headerlink" title="11.7.2 获取临时秘钥 &amp; 上传文件进度条构建"></a>11.7.2 获取临时秘钥 &amp; 上传文件进度条构建</h4><p>前端给上传文件绑定事件，获取临时凭证。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> COS_CREDENTIAL = <span class="string">"&#123;% url 'cos_credential' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> FILE_POST = <span class="string">"&#123;% url 'file_post' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindUploadFile();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindUploadFile</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 清空上传进度条</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#progressList'</span>).empty();</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> fileList = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;    <span class="comment">//通过获取文件元素对象的集合files</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取本次要上传的每个文件名称大小</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> checkFileList = [];</span></span><br><span class="line"><span class="javascript">            $.each(fileList, <span class="function"><span class="keyword">function</span> (<span class="params">index, fileobject</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                checkFileList.push(&#123;<span class="string">'name'</span>: fileobject.name, <span class="string">'size'</span>: fileobject.size&#125;)</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 把数据发送到后台，后台进行内容校验</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 如果没有问题发送临时凭证，否则发送错误信息</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取临时凭证，规定好的无需修改</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> cos_obj = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                getAuthorization: <span class="function"><span class="keyword">function</span> <span class="params">(options, callback)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 向django后台发送请求，获取临时凭证</span></span></span><br><span class="line"><span class="javascript">                    $.post(COS_CREDENTIAL, <span class="built_in">JSON</span>.stringify(checkFileList),</span></span><br><span class="line"><span class="actionscript">                           <span class="comment">// 可从 options 取需要的参数</span></span></span><br><span class="line"><span class="actionscript">                           <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line"><span class="actionscript">                            <span class="comment">// 通过验证，获取临时凭证</span></span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">var</span> credentials = res.data &amp;&amp; res.data.credentials;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (!res.data || !credentials) <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'credentials invalid'</span>);</span></span><br><span class="line">                            callback(&#123;</span><br><span class="line">                                TmpSecretId: credentials.tmpSecretId,</span><br><span class="line">                                TmpSecretKey: credentials.tmpSecretKey,</span><br><span class="line">                                XCosSecurityToken: credentials.sessionToken,</span><br><span class="line">                                StartTime: res.data.startTime,</span><br><span class="line">                                ExpiredTime: res.data.expiredTime,</span><br><span class="line">                            &#125;);</span><br><span class="line"><span class="actionscript">                            <span class="comment">// 清除uploadProgress 的 class="hide" 属性，显示上传信息</span></span></span><br><span class="line"><span class="javascript">                            $(<span class="string">'#uploadProgress'</span>).removeClass(<span class="string">'hide'</span>);</span></span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 没通过，弹窗展示错误信息</span></span></span><br><span class="line">                            alert(res.error);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 上传文件前先获取临时凭证</span></span></span><br><span class="line"><span class="javascript">            $.each(fileList, <span class="function"><span class="keyword">function</span> (<span class="params">index, fileobject</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> fileName = fileobject.name;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> fileSize = fileobject.size;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> key = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + <span class="string">"_"</span> + fileName;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="comment">// 构造进度条</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> tr = $(<span class="string">'#progressTemplate'</span>).find(<span class="string">'tr'</span>).clone();</span></span><br><span class="line"><span class="actionscript">                tr.find(<span class="string">'.name'</span>).text(fileName);</span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#progressList'</span>).append(tr);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="comment">//上传文件</span></span></span><br><span class="line">                cos_obj.putObject(&#123;</span><br><span class="line"><span class="actionscript">                    Bucket: <span class="string">'&#123;&#123; request.tracer.project.bucket &#125;&#125;'</span>,	<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                    Region: <span class="string">'&#123;&#123; request.tracer.project.region &#125;&#125;'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                    Key: key,</span><br><span class="line"><span class="actionscript">                    Body: fileobject,	<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                    onProgress: <span class="function"><span class="keyword">function</span> <span class="params">(progressData)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">//进度条</span></span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> percent = progressData.percent * <span class="number">100</span> + <span class="string">'%'</span>;</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-bar'</span>).text(percent);</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-bar'</span>).css(<span class="string">'width'</span>, percent);</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="actionscript">                &#125;, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    if (data &amp;&amp; data.statusCode === 200) &#123;</span><br><span class="line"><span class="actionscript">                        <span class="comment">// 上传成功之后，将本次上传的文件提交给后台，并写入数据库</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 当前文件上传成功</span></span></span><br><span class="line"><span class="javascript">                        $.post(FILE_POST, &#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'name'</span>: fileName,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'key'</span>: key,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'file_size'</span>: fileSize,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'file_path'</span>: data.Location,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'parent'</span>: CURRENT_FOLDER_ID,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'etag'</span>: data.ETag,</span></span><br><span class="line"><span class="actionscript">                        &#125;, <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 数据库中写入成功，动态显示</span></span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> newTr = $(<span class="string">'#rowTpl'</span>).find(<span class="string">'tr'</span>).clone();</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.name'</span>).text(res.data.name);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.file_size'</span>).text(res.data.file_size);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.username'</span>).text(res.data.username);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.datetime'</span>).text(res.data.datetime);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.delete'</span>).attr(<span class="string">'data-fileid'</span>, res.data.id);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.download'</span>).attr(<span class="string">'href'</span>, res.data.download_url);</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">'#rowList'</span>).append(newTr);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 上传完成后进度条删除</span></span></span><br><span class="line">                            tr.remove();</span><br><span class="line">                        &#125;)</span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-error'</span>).text(<span class="string">'上传失败'</span>);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="11-7-3-cos上传文件-amp-cos临时凭证"><a href="#11-7-3-cos上传文件-amp-cos临时凭证" class="headerlink" title="11.7.3 cos上传文件 &amp; cos临时凭证"></a>11.7.3 cos上传文件 &amp; cos临时凭证</h4><p>cos相关代码写在cos.py文件中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">credential</span><span class="params">(bucket, region)</span>:</span></span><br><span class="line">    <span class="string">""" 获取临时凭证 """</span></span><br><span class="line">    <span class="comment"># 生成一个临时凭证，并返回前端</span></span><br><span class="line">    <span class="comment"># 1. 安装一个临时凭证python模块 pip install -U qcloud-python-sts</span></span><br><span class="line">    <span class="comment"># 2.写代码</span></span><br><span class="line">    <span class="keyword">from</span> sts.sts <span class="keyword">import</span> Sts</span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="comment"># 临时秘钥有效时长，单位是秒（30分钟=1800秒）</span></span><br><span class="line">        <span class="string">'duration_seconds'</span>: <span class="number">1800</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 id</span></span><br><span class="line">        <span class="string">'secret_id'</span>: settings.TENCENT_COS_ID,</span><br><span class="line">        <span class="comment"># 固定秘钥 key</span></span><br><span class="line">        <span class="string">'secret_key'</span>: settings.TENCENT_COS_KEY,</span><br><span class="line">        <span class="comment"># 换成你的 bucket</span></span><br><span class="line">        <span class="string">'bucket'</span>: bucket,</span><br><span class="line">        <span class="comment"># 换成 bucket 所在的地区</span></span><br><span class="line">        <span class="string">'region'</span>: region,</span><br><span class="line">        <span class="comment"># 允许的路径前缀，可以根据自己的网站用户登录状态判断允许上传的具体路径</span></span><br><span class="line">        <span class="comment"># 例子：a.jpg 或者 a/* 或者 * (使用通配符*存在重大的安全风险)</span></span><br><span class="line">        <span class="string">'allow_prefix'</span>: <span class="string">'*'</span>,</span><br><span class="line">        <span class="comment"># 秘钥的权限列表。简单的上传和分片需一下的权限，其他权限查看https://cloud.tencent.com/document/product/436/31923</span></span><br><span class="line">        <span class="string">'allow_actions'</span>: [</span><br><span class="line">            <span class="comment"># 简单上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:PutObject",</span></span><br><span class="line">            <span class="comment"># 表单上传对象</span></span><br><span class="line">            <span class="comment"># "name/cos:PostObject",</span></span><br><span class="line">            <span class="comment"># 分块上传：初始化分块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:InitiateMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 进行中的分块上传</span></span><br><span class="line">            <span class="comment"># "name/cos:ListMultipartUploads",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 已上传分块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:ListParts",</span></span><br><span class="line">            <span class="comment"># 分块上传：上传分块块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:UploadPart",</span></span><br><span class="line">            <span class="comment"># 分块上传：完成所有分块上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:CompleteMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 取消分块上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:AbortMultipartUpload",</span></span><br><span class="line">            <span class="string">"*"</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sts = Sts(config)</span><br><span class="line">    result_dict = sts.get_credential()</span><br><span class="line">    <span class="keyword">return</span> result_dict</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_bucket</span><span class="params">(bucket, region, file_object, key)</span>:</span></span><br><span class="line">    <span class="comment"># 将文件对象上传到当前项目的桶中</span></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    response = client.upload_file_from_buffer(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要上传桶的名称</span></span><br><span class="line">        Body=file_object,  <span class="comment"># 本地文件对象</span></span><br><span class="line">        Key=key,  <span class="comment"># 上传到桶之后的文件名</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://&#123;&#125;.cos.&#123;&#125;.myqcloud.com/&#123;&#125;"</span>.format(bucket, region, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_file</span><span class="params">(bucket, region, key)</span>:</span></span><br><span class="line">    <span class="comment"># 校验上传文件的ETag</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对文件的ETag进行校验</span></span><br><span class="line">    data = client.head_object(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 桶的名称</span></span><br><span class="line">        Key=key,  <span class="comment"># 桶要的文件名</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>



<h4 id="11-7-4-form表单对临时凭证进行校验"><a href="#11-7-4-form表单对临时凭证进行校验" class="headerlink" title="11.7.4 form表单对临时凭证进行校验"></a>11.7.4 form表单对临时凭证进行校验</h4><p>上传文件的form表单写在file.py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileModelForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    etag = forms.CharField(label=<span class="string">'ETag'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.FileRespository</span><br><span class="line">        exclude = [<span class="string">'project'</span>, <span class="string">'file_type'</span>, <span class="string">'update_user'</span>, <span class="string">'update_datetime'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_file_path</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"https://&#123;&#125;"</span>.format(self.cleaned_data[<span class="string">'file_path'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        key = self.cleaned_data[<span class="string">'key'</span>]</span><br><span class="line">        etag = self.cleaned_data[<span class="string">'etag'</span>]</span><br><span class="line">        size = self.cleaned_data[<span class="string">'file_size'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">or</span> <span class="keyword">not</span> etag:</span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br><span class="line">        <span class="comment"># 向COS校验是否合法</span></span><br><span class="line">        <span class="comment"># SDK的功能</span></span><br><span class="line">        <span class="comment"># 如果上传的文件不存在会抛出CosServiceError异常</span></span><br><span class="line">        <span class="keyword">from</span> qcloud_cos.cos_exception <span class="keyword">import</span> CosServiceError</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = check_file(</span><br><span class="line">                bucket=self.request.tracer.project.bucket,</span><br><span class="line">                region=self.request.tracer.project.region,</span><br><span class="line">                key=key,</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> CosServiceError <span class="keyword">as</span> e:</span><br><span class="line">            self.add_error(<span class="string">'key'</span>,<span class="string">'文件不存在'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br><span class="line"></span><br><span class="line">        cos_etag = result.get(<span class="string">'ETag'</span>)</span><br><span class="line">        <span class="keyword">if</span> etag != cos_etag:</span><br><span class="line">            self.add_error(<span class="string">'etag'</span>,<span class="string">'ETag错误'</span>)</span><br><span class="line"></span><br><span class="line">        cos_length = result.get(<span class="string">'Content-Length'</span>)</span><br><span class="line">        <span class="keyword">if</span> size != int(cos_length):</span><br><span class="line">            self.add_error(<span class="string">'size'</span>, <span class="string">'文件大小错误'</span>)</span><br></pre></td></tr></table></figure>



<h4 id="11-7-5-上传文件的视图函数"><a href="#11-7-5-上传文件的视图函数" class="headerlink" title="11.7.5 上传文件的视图函数"></a>11.7.5 上传文件的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_post</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 将上传成功的文件写入到数据库 """</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    'name':fileName,</span></span><br><span class="line"><span class="string">    'key':key,</span></span><br><span class="line"><span class="string">    'file_size':fileSize,</span></span><br><span class="line"><span class="string">    'file_path':data.Location,</span></span><br><span class="line"><span class="string">    'parent':CURRENT_FOLDER_ID,</span></span><br><span class="line"><span class="string">    'etag':data.ETag,</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># print(request.POST)</span></span><br><span class="line">    <span class="comment"># 根据key再去cos获取ETag进行比较</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据写入到数据库中</span></span><br><span class="line">    form = FileModelForm(request, data=request.POST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 校验通过：数据写入数据库</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通过ModelForm.save存储到的数据库中的数据返回的instance对象，无法通过get_xx_display获取choice到中文</span></span><br><span class="line">        <span class="comment"># form.instance.file_type = 1</span></span><br><span class="line">        <span class="comment"># form.update_user = request.tracer.user</span></span><br><span class="line">        <span class="comment"># instance = form.save()  # 添加成功之后，获取新添加的对象</span></span><br><span class="line"></span><br><span class="line">        data_dict = form.cleaned_data</span><br><span class="line">        data_dict.pop(<span class="string">'etag'</span>)</span><br><span class="line">        data_dict.update(&#123;<span class="string">'project'</span>: request.tracer.project, <span class="string">'file_type'</span>: <span class="number">1</span>, <span class="string">'update_user'</span>: request.tracer.user&#125;)</span><br><span class="line">        instance = models.FileRespository.objects.create(**data_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 项目的已使用空间更新</span></span><br><span class="line">        request.tracer.project.use_space += data_dict[<span class="string">'file_size'</span>]</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">        result = &#123;</span><br><span class="line">            <span class="string">'id'</span>: instance.id,</span><br><span class="line">            <span class="string">'name'</span>: instance.name,</span><br><span class="line">            <span class="string">'file_size'</span>: instance.file_size,</span><br><span class="line">            <span class="string">'username'</span>: instance.update_user.username,</span><br><span class="line">            <span class="string">'datetime'</span>: instance.update_datetime.strftime(<span class="string">"%Y&#123;y&#125;-%m&#123;m&#125;-%d&#123;d&#125; %H:%M"</span>).format(y=<span class="string">'年'</span>, m=<span class="string">'月'</span>, d=<span class="string">'日'</span>),</span><br><span class="line">            <span class="string">'download_url'</span>: reverse(<span class="string">'file_download'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id, <span class="string">'file_id'</span>: instance.id&#125;),</span><br><span class="line">            <span class="comment"># 'file_type':instance.get_file_type_display()</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: result&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'data'</span>: <span class="string">'文件错误'</span>&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="11-8-下载文件"><a href="#11-8-下载文件" class="headerlink" title="11.8 下载文件"></a>11.8 下载文件</h3><h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment"># 打开开文件，获取文件内容</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,mode=<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    </span><br><span class="line">    response = HttpResponse(data)</span><br><span class="line">    <span class="comment"># 设置响应头</span></span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">"attachment;filename=xxx.png"</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>



<h4 id="11-8-1-构造下载文件的url地址"><a href="#11-8-1-构造下载文件的url地址" class="headerlink" title="11.8.1 构造下载文件的url地址"></a>11.8.1 构造下载文件的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 下载文件</span></span><br><span class="line">    url(<span class="string">r'^file/download/(?P&lt;file_id&gt;\d+)$'</span>, file.file_download, name=<span class="string">'file_download'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure>

<h4 id="11-8-2-下载文件的视图函数"><a href="#11-8-2-下载文件的视图函数" class="headerlink" title="11.8.2 下载文件的视图函数"></a>11.8.2 下载文件的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_download</span><span class="params">(request, project_id, file_id)</span>:</span></span><br><span class="line">    <span class="string">""" 下载文件 """</span></span><br><span class="line">    <span class="comment"># 文件内容</span></span><br><span class="line">    <span class="comment"># 响应头</span></span><br><span class="line">    <span class="comment"># 代开文件，获取文件内容;去cos获取文件内容</span></span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">    file_obj = models.FileRespository.objects.filter(id=file_id, project=request.tracer.project).first()</span><br><span class="line">    res = requests.get(file_obj.file_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文件分块处理（适用大文件）</span></span><br><span class="line">    data = res.iter_content()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置content_type="application/octet-stream" 用于提示下载弹框</span></span><br><span class="line">    response = HttpResponse(data,content_type=<span class="string">"application/octet-stream"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置响应头：中文文件名转义</span></span><br><span class="line">    <span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> escape_uri_path</span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">"attachment;filename=&#123;&#125;"</span>.format(escape_uri_path(file_obj.name))</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Hp's blog</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hpsj.github.io/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/">https://hpsj.github.io/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hpsj.github.io" target="_blank">Hp's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/08/02/12%20%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86/"><img class="prev_cover lazyload" data-src="http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">问题管理</div></div></a></div><div class="next-post pull_right"><a href="/2020/08/02/10%20WiKi/"><img class="next_cover lazyload" data-src="http://hp256.gitee.io/blog/Django图片/SaaS平台.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WiKi</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTkxNy8yNjQwOA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Hp's blog</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>